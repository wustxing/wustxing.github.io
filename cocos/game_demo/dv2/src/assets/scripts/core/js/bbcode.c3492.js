(function(){"use strict";function t(){this.name="",this.length=0}function e(){this.stack=[],this.length=0}var n,s,i,r;t.duptags=["div","span"],t.headingtags=["h1","h2","h3","h4","h5","h6"],t.selfendtags=["!doctype","meta","link","img","br"],t.newlinetags=["div","p","br","li","tr"].concat(t.headingtags),t.noemptytags=["head","style","script","span","a","font","color","size","face","strong","b","em","i","del","s","ins","u"],t.noemptyattrtags=["img"],t.prototype.findquoteend=function(t,e,n){var s=-1,i=e||0,r=t.length,o='"'===t[i];for(i++;i<r;)if("\\"===t[i])switch(t[++i]){case"u":i+=5;break;case"x":i+=3;break;default:i++}else{if(o&&'"'===t[i]||!o&&"'"===t[i]){s=i;break}if("\n"===t[i]&&!n)break;i++}return s},t.prototype.findscriptend=function(t,e){for(var n=-1,s=e||0,i=t.length,r=/(['"]|<\s*?\/\s*?script\s*?>)/gi;s<i;)if('"'===t[s]||"'"===t[s]){var o=this.findquoteend(t,s,!0);if(-1===o)break;s=o+1}else{r.lastIndex=s;var a=r.exec(t);if(!a||a.length<=0)break;if("<"===a[0][0]){n=r.lastIndex-a[0].length;break}s=r.lastIndex-1}return n},t.prototype.quote=function(t){if("'"===t[0]){for(var e='"',n=1,s=t.length-1,i=n;n<s;)if("\\"===t[n])switch(t[++n]){case"u":n+=5;break;case"x":n+=3;break;default:n++}else{if('"'===t[n]){e+=t.substr(i,n-i),e+='\\"',i=++n;break}n++}return i<s&&(e+=t.substr(i,s-i)),e+'"'}return t},t.prototype.parseStyle=function(t){for(var e=t.split(";"),n={},s=0,i=0;i<e.length;i++){var r=e[i].split(":");if(r.length>=2){var o;if(s++,"'"===(o=r.length>2?r.slice(1).join(":").trim():r[1].trim())[0]&&"'"===o[o.length-1])try{o=JSON.parse(this.quote(o))}catch(a){}n[r[0].trim().toLowerCase()]=o}}return s>0?n:void 0},t.prototype.parseAttributes=function(t){for(var e=/\s/,n=0,s=(t=t.trim()).length,i=n,r=null,o=!1,a={},c=function(t,e){void 0===e&&(e=null),t=t.trim().toLowerCase(),a[t]=e};n<s;){if("="===t[n])r=t.substr(i,n-i),o=!1;else if(e.test(t[n]))r&&o?(c(r,t.substr(i,n-i)),o=!1,r=null):n-i>0&&(c(r=t.substr(i,n-i)),r=null),i=n+1;else if(r&&!o)if(i=n,'"'===t[n]||"'"===t[n]){var f="'"===t[n];if(-1===(n=this.findquoteend(t,n)))break;var l=t.substr(i,n+1-i);f&&(l=this.quote(l));try{l=JSON.parse(l)}catch(g){}c(r,l),r=null,i=n+1}else o=!0;n++}if(i<s){var h=t.substr(i);r?c(r,h):c(h),r=null}var p=0;for(var u in a)p++;p>0&&(a.style&&(a.style=this.parseStyle(a.style)),this.attr=a)},t.prototype.parse=function(n){var s=0;if("<"!==n[s])throw new Error("not a tag");for(var i=n.length,r=/\s/;s<i;)if("<"===n[s])s++;else{if(">"===n[s])return this.length=s+1,this;if(!r.test(n[s]))break;s++}if(s>=i)return this.length=i,this;for(var o=s,a=!1;s<i&&!r.test(n[s]);){if(">"===n[s]){a=!0;break}if("/"===n[s])break;s++}if(s>=i)return this.length=s,this;if(this.name=n.substr(o,s-o).trim().toLowerCase(),this.name.length>0&&"/"===this.name[0])return this.length=s,this.name=this.name.substr(1),this.selfend=!0,this;if(t.selfendtags.indexOf(this.name)>=0&&(this.selfend=!0),!a){for(o=s;s<i&&">"!==n[s];)s++;if(s>=i)return this.length=s,this;if(s-o>0){var c=n.substr(o,s-o).trim(),f=c.length;f>0&&"/"===c[f-1]&&(this.selfend=!0,c=c.substr(0,f-1)),this.parseAttributes(c)}}if(s++,this.selfend)return this.length=s,this;var l=this,h=function(t){var n=(new e).parse(t);return l.content?l.content.append(n):l.content=n,n.length};if("script"===this.name){var p=this.findscriptend(n.substr(s));if(p<0)return this.length=i,this;this.content=new e;var u=n.substr(s,p);return this.content.length=p,this.content.stack=[u],s+=p,(o=n.indexOf(">",s))<0?(this.length=i,this):(this.length=o+1,this)}for(;s<i;){for(o=s;s<i&&r.test(n[s]);)s++;for(;s<i&&"<"!==n[s];)s++;var g=s;for(s++;s<i&&r.test(n[s]);)s++;if(s>=i)return this.content=(new e).parse(n.substr(o)),this.length=i,this;if(s<i&&"/"===n[s]){for(s++;s<i&&r.test(n[s]);)s++;if(s>=i)return s+=h(n.substr(o)),this.length=i,this;for(var d=s,v=!1;s<i&&!r.test(n[s]);){if(">"===n[s]){v=!0;break}s++}if(s>d){if(!v)for(;s<i&&">"!==n[s];)s++;return n.substr(d,s-d).trim().toLowerCase(),s++,this.length=s,g>o&&h(n.substr(o,g-o)),this}}s=o+h(n.substr(o))}return this.length=s,this},e.prototype.parse=function(e){if(!e)return this;for(var n=0,s=e.length,i=0,r=/\s/,o=this,a=function(t,n){t<n&&o.push(e.substr(t,n-t))};n<s;)switch(e[n]){case"<":a(i,n);for(var c=n+1;c<s&&r.test(e[c]);)c++;if(c<s&&"/"===e[c])return this;var f=(new t).parse(e.substr(n));this.push(f),i=n+=f.length;break;case">":default:n++}return a(i,s),this},e.prototype.push=function(t){this.length+=t.length,this.stack.push(t)},e.prototype.pop=function(){return this.stack.pop()},e.prototype.append=function(t){this.stack=this.stack.concat(t.stack),this.length+=t.length},n=new RegExp("<\\s*?("+t.duptags.join("|")+")\\s*?>\\s*?<\\s*?\\1\\s*?>(((?!<\\s*?\\1\\s*?>)[\\S\\s])*?)<\\s*?/\\s*?\\1\\s*?>\\s*?<\\s*?/\\s*?\\1\\s*?>","ig"),s=new RegExp("(<\\s*?("+t.newlinetags.join("|")+")(\\s[^>]*?)?>)\\s+","ig"),i=new RegExp("\\s+(<\\s*?/\\s*?("+t.newlinetags.join("|")+")\\s*?>)","ig"),r=new RegExp("<\\s*?("+t.noemptytags.join("|")+")(\\s[^>]*?)?><\\s*?/\\s*?\\1\\s*?>","ig"),e.minify=function(t){var e,o=/<pre(\s.*?)?>/gi,a=/<\/pre>/gi,c=/\s{2,}/g,f="",l=-1;for(t=(t=(t=t.replace(r,"")).replace(s,"$1")).replace(i,"$1");o.exec(t);)l<0&&(l=0),f+=t.substr(l,o.lastIndex-l).replace(c," "),l=o.lastIndex,a.lastIndex=o.lastIndex,(e=a.exec(t))&&(o.lastIndex=a.lastIndex,f+=t.substr(l,e.index-l),l=e.index);for(t=l>=0?f+t.substr(l).replace(c," "):t.replace(c," ");n.test(t);)t=t.replace(n,"<$1>$2</$1>");return t};var o={nbsp:" ",amp:"&",lt:"<",gt:">",quot:'"'};function a(){this.s="",this.weaknewline=!0,this.stack=[]}function c(t){this.opts=t||{}}e.unescape=function(t,e){var n="&([a-zA-Z]+?|#[xX][\\da-fA-F]+?|#\\d+?);";if(new RegExp(n).test(t)){var s=new RegExp(n,"g");t=t.replace(s,function(t,n){if(n=n.toLowerCase(),e&&"nbsp"===n)return"&nbsp;";var s=o[n];if(s)return s;if("#"===n[0]){var i;if(i="x"==n[1]?parseInt(n.substr(2),16):parseInt(n.substr(1)))return String.fromCharCode(i)}return""})}return t},e.prototype.decode=function(n){for(var s=0;s<this.stack.length;s++){var i=this.stack[s];"string"==typeof i?this.stack[s]=e.unescape(i,n):i instanceof t&&i.content&&i.content.decode(n)}return this},e.prototype.dedup=function(){for(var e=0;e<this.stack.length;e++){var n=this.stack[e];if(n instanceof t&&n.content){if(t.duptags.indexOf(n.name)>=0&&!n.attr&&1===n.content.stack.length){var s=n.content.stack[0];if(s.name===n.name){this.stack[e]=s,e--;continue}}n.content.dedup()}}return this},e.prototype.strip=function(e,n){n||(n=!(e&&!n)||t.newlinetags.indexOf(e.name)>=0);for(var s=/^\s*$/,i=0,r=!0,o=0;o<this.stack.length;o++){if((l=this.stack[o])instanceof t){if(r=!0,l.content){var a;if(i<=0)a=n;else{a=!1;for(var c=o-1;c>=0;c--){var f=this.stack[c];if(f instanceof t){a=t.newlinetags.indexOf(f.name)>=0;break}if("string"!=typeof f||!s.test(f))break}}l.content.strip(l,a)}}else if("string"==typeof l&&s.test(l)&&r)continue;i++}r=!0;var l,h=[],p=0;for(o=0;o<this.stack.length;o++){if("string"==typeof(l=this.stack[o])&&s.test(l)&&n){if(r)continue;n=!1}else if(l instanceof t){if(r=!0,t.noemptyattrtags.indexOf(l.name)>=0){if(!l.attr)continue;var u=!1;for(var g in l.attr)if(l.attr[g]){u=!0;break}if(!u)continue}if(t.noemptytags.indexOf(l.name)>=0&&!l.content)continue;n=t.newlinetags.indexOf(l.name)>=0}else{if(n&&!(l=l.replace(/^\s+/g,"")))continue;l=l.replace(/\s+/g," "),r=!1,n=!1}p++,h.push(l)}if("string"==typeof(l=h[p-1])&&(p>=2&&s.test(l)?(h.splice(p-1,1),p--):/\S\s+$/.test(l)&&(h[p-1]=l.replace(/\s+$/,""))),!(p<=0&&e))return this.stack=h,this;delete e.content},e.prototype.showtree=function(e,n){e||(e=""),n||(n=0);for(var s=0;s<this.stack.length;s++){var i=this.stack[s];i instanceof t?(console.log(e,i.name,i.attr?JSON.stringify(i.attr):""),i.content&&i.content.showtree(e+"--",n+1)):"string"==typeof i&&console.log(e,JSON.stringify(i))}},a.maps={a:{section:"url",attr:"href"},img:{section:"img",data:"src",empty:!0},em:{section:"i"},i:{section:"i"},strong:{section:"b"},b:{section:"b"},del:{section:"s"},s:{section:"s"},ins:{section:"u"},u:{section:"u"},center:{section:"center"},ul:{section:"ul"},ol:{section:"ol"},li:{section:"li",newline:1},blockquote:{section:"quote"},code:{section:"code"},pre:{section:"code"},font:{extend:["color","face","size"]},span:{extend:["color","face","size"]},color:{section:"color",attr:"color"},size:{section:"size",attr:"size"},face:{section:"font",attr:"face"},h1:{section:"h1",newline:1},h2:{section:"h2",newline:1},h3:{section:"h3",newline:1},h4:{section:"h4",newline:1},h5:{section:"h5",newline:1},h6:{section:"h6",newline:1},p:{newline:1},br:{newline:2,empty:!0},table:{newline:1},tr:{newline:1},div:{newline:0},"!doctype":{ignore:!0},head:{ignore:!0},style:{ignore:!0},script:{ignore:!0},meta:{ignore:!0},link:{ignore:!0}},a.prototype.open=function(t,e,n){t&&(t instanceof Array?this.stack=this.stack.concat(t):this.stack.push({section:t,attr:e,data:n}))},a.prototype.append=function(t){this.solidify(),this._append(t)},a.prototype._append=function(t){t&&(this.s+=t,this.weaknewline=!1)},a.prototype.solidify=function(){var t;for(t=0;t<this.stack.length;t++){var e=this.stack[t],n=e.section,s=e.attr,i=e.data,r="["+n;if("string"==typeof s)r+="="+s;else for(var o in s)r+=" "+o+"="+s[o];r+="]",i&&(r+=i),this._append(r)}t>0&&(this.stack=[])},a.prototype.close=function(t){t&&(this.solidify(),this._append("[/"+t+"]"))},a.prototype.rollback=function(){this.stack=[]},a.prototype.newline=function(t){2===t?(this.append("\n"),this.weaknewline=!0):this.weaknewline||(this.append("\n"),this.weaknewline=!0)},a.prototype.toString=function(){return this.s},c.prototype.color=function(t){if(t){var e=/rgba?\s*?\(\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?,\s*?(\d{1,3})\s*?.*?\)/i;if(e.test(t)){var n=function(t){return t.length<2&&(t="0"+t),t};t=t.replace(e,function(t,e,s,i){return"#"+(e=n(parseInt(e).toString(16)))+(s=n(parseInt(s).toString(16)))+n(parseInt(i).toString(16))})}return t}},c.prototype.size=function(t){if(t){var e=[0,12,14,16,18,24,32,48];if(/^\d+$/.test(t))return t;if(!/^\d+?px$/.test(t)){var n=[null,"smaller","small","medium","large","x-large","xx-large","-webkit-xxx-large"].indexOf(t);return n>0?this.opts.transsize?n.toString():e[n].toString():void 0}if((t=parseInt(t))&&!(t<0)){if(!this.opts.transsize)return t.toString();for(var s=e.length;s>=0;s--){if(0===s)return"1";if(t>=e[s])return s.toString()}return t?t.toString():void 0}}},c.prototype.px=function(t){if(t)return(t=parseInt(t))?t.toString():void 0},c.prototype.convertStyle=function(t,e){if(e){var n,s=[],i=this,r=this.opts,o=function(e){if(e&&!e.ignore&&(e.section||e.extend&&e.extend.length>0)){var n={section:e.section};if(e.attr){if(!t.attr)return;switch(e.section){case"size":n.attr=i.size(t.attr[e.attr]);break;case"color":n.attr=i.color(t.attr[e.attr]);break;default:n.attr=t.attr[e.attr]}if(t.attr.style){var o;switch(e.section){case"size":(o=t.attr.style["font-size"])&&(o=i.size(o));break;case"color":(o=t.attr.style.color)&&(o=i.color(o));break;case"font":o=t.attr.style["font-family"]}o&&(n.attr=o)}if(!n.attr)return}else if("img"===e.section&&r.imagescale){var a,c,f,l;if(t.attr)a=i.px(t.attr.width),c=i.px(t.attr.height),t.attr.style&&((f=i.px(t.attr.style.width))&&(a=f),(l=i.px(t.attr.style.height))&&(c=l)),a&&c?n.attr=a+"x"+c:(a||c)&&(n.attr=a?{width:a}:{height:c})}e.data&&(n.data=t.attr[e.data]),s.push(n)}};if(t.attr&&t.attr.style)"b"!==t.name&&"strong"!==t.name&&("bold"===(n=t.attr.style["font-weight"])||/^\d+$/.test(n)&&parseInt(n)>=700)&&o(a.maps.b),"center"!==t.name&&("center"!==(n=t.attr.style["text-align"])||r.noalign||o(a.maps.center)),"em"!==t.name&&"i"!==t.name&&("italic"!==(n=t.attr.style["font-style"])&&"oblique"!==n||o(a.maps.i));if("list"===e.section||"ul"===e.section||"ol"===e.section||"li"===e.section){if(r.nolist)return[]}else if("center"===e.section){if(r.noalign)return[]}else if(/^h\d+$/.test(e.section)&&r.noheadings){var c=[null,"32px","24px","19px","16px","14px","12px"],f=e.section.match(/^h(\d+)$/),l=parseInt(f[1]);return l<=0?[]:(l>=c.length&&(l=c.length),s.push({section:"size",attr:i.size(c[l])}),s)}if("extend"in e)for(var h=0;h<e.extend.length;h++){var p=e.extend[h];o(a.maps[p])}else o(e);return s}},c.prototype.convert=function(e){var n=new a;if(!e)return n;var s=this,i=function(e){for(var r=0;r<e.length;r++){var o=e[r];if(o instanceof t)if(o.name in a.maps){var c=0,f=a.maps[o.name];if(f.ignore)continue;if("newline"in f&&(c=f.newline,n.newline(f.newline)),!o.content&&!f.empty)continue;var l=s.convertStyle(o,f);n.open(l),o.content&&i(o.content.stack,c);for(var h=l.length-1;h>=0;h--)n.close(l[h].section);c&&n.newline()}else o.content&&i(o.content.stack);else"string"==typeof o&&n.append(o)}};return i(e.stack),n},c.prototype.parse=function(t){return(new e).parse(t).strip().dedup().decode()},c.prototype.feed=function(t){var e=this.parse(t);return this.opts.debug&&e.showtree(),this.convert(e)},console.log("HTML2BBCode"),window.HTML2BBCode=c})();