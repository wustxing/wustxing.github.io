<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>electron多窗口状态同步 插件pinia-plugin-electron-share升级版</title>
      <link href="/2025/12/16/%E5%89%8D%E7%AB%AF/electron/pinia-plugin-electron-share%E5%8D%87%E7%BA%A7%E7%89%88/"/>
      <url>/2025/12/16/%E5%89%8D%E7%AB%AF/electron/pinia-plugin-electron-share%E5%8D%87%E7%BA%A7%E7%89%88/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>通过indexDb存储pinia的相关数据。传输的时候不用传输整个数据</p><p><strong>核心思想转变：</strong><br>之前的模式是 <strong>“数据跟随消息” (Push Data)</strong>，现在的模式是 <strong>“消息通知，数据自取” (Signal &amp; Pull)</strong>。</p><ol><li><strong>写入方</strong>：Store 变更 -&gt; 写入 IndexedDB -&gt; 发送 “数据已更新” 的信号（不带数据）。</li><li><strong>接收方</strong>：收到信号 -&gt; 从 IndexedDB 读取最新数据 -&gt; 更新 Store。</li><li><strong>初始化</strong>：新窗口启动 -&gt; 请求初始化 -&gt; 老窗口强制将内存数据刷入 IndexedDB -&gt; 发送 “准备好了” -&gt; 新窗口从 DB 读取。</li></ol><p>这样做的好处是 <code>BroadcastChannel</code> 极其轻量，不再受数据大小限制，且数据持久化由 IndexedDB 承担。</p><p>下面是完整的实现方案。</p><h3 id="1-封装-IndexedDB-工具类-src-utils-db-ts"><a href="#1-封装-IndexedDB-工具类-src-utils-db-ts" class="headerlink" title="1. 封装 IndexedDB 工具类 (src/utils/db.ts)"></a>1. 封装 IndexedDB 工具类 (<code>src/utils/db.ts</code>)</h3><p>首先我们需要一个极简的 IDB 包装器，用于存取 Pinia 的 State。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/utils/db.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DB_NAME</span> = <span class="string">&#x27;pinia-electron-db&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DB_VERSION</span> = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">STORE_NAME</span> = <span class="string">&#x27;pinia-state&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">SimpleIDB</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">dbRequest</span>: <span class="title class_">Promise</span>&lt;<span class="title class_">IDBDatabase</span>&gt;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dbRequest</span> = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> request = indexedDB.<span class="title function_">open</span>(<span class="variable constant_">DB_NAME</span>, <span class="variable constant_">DB_VERSION</span>)</span><br><span class="line">      </span><br><span class="line">      request.<span class="property">onerror</span> = <span class="function">() =&gt;</span> <span class="title function_">reject</span>(request.<span class="property">error</span>)</span><br><span class="line">      request.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> <span class="title function_">resolve</span>(request.<span class="property">result</span>)</span><br><span class="line">      </span><br><span class="line">      request.<span class="property">onupgradeneeded</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> db = (event.<span class="property">target</span> <span class="keyword">as</span> <span class="title class_">IDBOpenDBRequest</span>).<span class="property">result</span></span><br><span class="line">        <span class="keyword">if</span> (!db.<span class="property">objectStoreNames</span>.<span class="title function_">contains</span>(<span class="variable constant_">STORE_NAME</span>)) &#123;</span><br><span class="line">          db.<span class="title function_">createObjectStore</span>(<span class="variable constant_">STORE_NAME</span>) <span class="comment">// keyPath 为 storeId</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">setItem</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span>, <span class="attr">value</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> db = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">dbRequest</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt;(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> tx = db.<span class="title function_">transaction</span>(<span class="variable constant_">STORE_NAME</span>, <span class="string">&#x27;readwrite&#x27;</span>)</span><br><span class="line">      <span class="keyword">const</span> store = tx.<span class="title function_">objectStore</span>(<span class="variable constant_">STORE_NAME</span>)</span><br><span class="line">      <span class="keyword">const</span> req = store.<span class="title function_">put</span>(value, key)</span><br><span class="line">      </span><br><span class="line">      req.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> <span class="title function_">resolve</span>()</span><br><span class="line">      req.<span class="property">onerror</span> = <span class="function">() =&gt;</span> <span class="title function_">reject</span>(req.<span class="property">error</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getItem</span>(<span class="params"><span class="attr">key</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> db = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">dbRequest</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt;(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> tx = db.<span class="title function_">transaction</span>(<span class="variable constant_">STORE_NAME</span>, <span class="string">&#x27;readonly&#x27;</span>)</span><br><span class="line">      <span class="keyword">const</span> store = tx.<span class="title function_">objectStore</span>(<span class="variable constant_">STORE_NAME</span>)</span><br><span class="line">      <span class="keyword">const</span> req = store.<span class="title function_">get</span>(key)</span><br><span class="line">      </span><br><span class="line">      req.<span class="property">onsuccess</span> = <span class="function">() =&gt;</span> <span class="title function_">resolve</span>(req.<span class="property">result</span>)</span><br><span class="line">      req.<span class="property">onerror</span> = <span class="function">() =&gt;</span> <span class="title function_">reject</span>(req.<span class="property">error</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导出单例</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> idb = <span class="keyword">new</span> <span class="title class_">SimpleIDB</span>()</span><br></pre></td></tr></table></figure><hr><h3 id="2-改造-Pinia-插件-src-index-ts"><a href="#2-改造-Pinia-插件-src-index-ts" class="headerlink" title="2. 改造 Pinia 插件 (src/index.ts)"></a>2. 改造 Pinia 插件 (<code>src/index.ts</code>)</h3><p><strong>关键改动点：</strong></p><ol><li><code>SyncPayload</code> 中的 <code>data</code> 字段被移除（或设为可选，这里直接移除）。</li><li><code>$subscribe</code> 不再直接发消息，而是先 <code>idb.setItem</code>，成功后再发 <code>notify</code>。</li><li>接收端收到消息后，执行 <code>idb.getItem</code>。</li><li>增加了<strong>异步锁</strong>逻辑，防止 IDB 读写期间产生冲突。</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PiniaPluginContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; idb &#125; <span class="keyword">from</span> <span class="string">&#x27;./utils/db&#x27;</span> <span class="comment">// 引入上面的工具</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;pinia&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">DefineStoreOptionsBase</span>&lt;S, <span class="title class_">Store</span>&gt; &#123;</span><br><span class="line">    <span class="attr">share</span>?: <span class="built_in">boolean</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ElectronShareOptions</span> &#123;</span><br><span class="line">  <span class="attr">channelName</span>?: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✨ 载荷不再包含 data，只包含通知信号</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">SyncPayload</span> = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;NOTIFY_UPDATE&#x27;</span> | <span class="string">&#x27;REQUEST_INIT&#x27;</span> | <span class="string">&#x27;RESPONSE_READY&#x27;</span></span><br><span class="line">  <span class="attr">storeId</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">timestamp</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">srcId</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">generateId</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substr</span>(<span class="number">2</span>, <span class="number">9</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createElectronSharePlugin</span>(<span class="params"><span class="attr">globalOptions</span>: <span class="title class_">ElectronShareOptions</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">CHANNEL_NAME</span> = globalOptions.<span class="property">channelName</span> || <span class="string">&#x27;pinia-electron-share&#x27;</span></span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(<span class="variable constant_">CHANNEL_NAME</span>)</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">WINDOW_ID</span> = <span class="title function_">generateId</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">&#123; store, options &#125;: <span class="title class_">PiniaPluginContext</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!options.<span class="property">share</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 状态标志 ---</span></span><br><span class="line">    <span class="keyword">let</span> isExternalUpdate = <span class="literal">false</span> <span class="comment">// 正在应用外部数据</span></span><br><span class="line">    <span class="keyword">let</span> isInitialized = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">initInterval</span>: <span class="built_in">any</span> = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">replyDebounceTimer</span>: <span class="built_in">any</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 核心：从 DB 读取并应用数据 ---</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">applyStateFromDB</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> idb.<span class="title function_">getItem</span>(store.<span class="property">$id</span>)</span><br><span class="line">        <span class="keyword">if</span> (data) &#123;</span><br><span class="line">          <span class="comment">// 标记为外部更新，防止触发 subscribe 再次写入 DB</span></span><br><span class="line">          isExternalUpdate = <span class="literal">true</span></span><br><span class="line">          store.$patch(data)</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 给一点缓冲时间让 Vue Reactivity 完成，防止立刻触发 subscribe</span></span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; isExternalUpdate = <span class="literal">false</span> &#125;, <span class="number">50</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> !!data</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[Share] Read DB failed:`</span>, err)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 消息处理 ---</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">messageHandler</span> = <span class="keyword">async</span> (<span class="params"><span class="attr">event</span>: <span class="title class_">MessageEvent</span>&lt;<span class="title class_">SyncPayload</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="keyword">type</span>, storeId, srcId &#125; = event.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (storeId !== store.<span class="property">$id</span> || srcId === <span class="variable constant_">WINDOW_ID</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;NOTIFY_UPDATE&#x27;</span>:</span><br><span class="line">          <span class="comment">// 收到别人的更新通知 -&gt; 去查 DB</span></span><br><span class="line">          <span class="keyword">if</span> (!isExternalUpdate) &#123;</span><br><span class="line">             <span class="keyword">await</span> <span class="title function_">applyStateFromDB</span>()</span><br><span class="line">             </span><br><span class="line">             <span class="comment">// 如果我是刚启动的窗口，收到这个也算初始化完成</span></span><br><span class="line">             <span class="keyword">if</span> (!isInitialized) &#123;</span><br><span class="line">               isInitialized = <span class="literal">true</span></span><br><span class="line">               <span class="built_in">clearInterval</span>(initInterval)</span><br><span class="line">             &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;REQUEST_INIT&#x27;</span>:</span><br><span class="line">          <span class="comment">// 别人在请求初始化</span></span><br><span class="line">          <span class="keyword">if</span> (isInitialized) &#123;</span><br><span class="line">            <span class="comment">// 竞态抑制：随机延迟回复</span></span><br><span class="line">            <span class="keyword">const</span> delay = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">90</span>) + <span class="number">10</span></span><br><span class="line">            replyDebounceTimer = <span class="built_in">setTimeout</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">              <span class="comment">// ✨ 关键：先把我也许还没保存的内存状态，强制刷入 DB</span></span><br><span class="line">              <span class="comment">// 确保新窗口读到的是最新的</span></span><br><span class="line">              <span class="keyword">await</span> idb.<span class="title function_">setItem</span>(storeId, <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(store.<span class="property">$state</span>)))</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 发送 &quot;数据已就绪&quot; 信号 (不带数据)</span></span><br><span class="line">              channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">                <span class="attr">type</span>: <span class="string">&#x27;RESPONSE_READY&#x27;</span>,</span><br><span class="line">                <span class="attr">storeId</span>: store.<span class="property">$id</span>,</span><br><span class="line">                <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">                <span class="attr">srcId</span>: <span class="variable constant_">WINDOW_ID</span></span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;, delay)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;RESPONSE_READY&#x27;</span>:</span><br><span class="line">          <span class="comment">// 收到 &quot;数据已就绪&quot; 信号</span></span><br><span class="line">          <span class="keyword">if</span> (replyDebounceTimer) &#123;</span><br><span class="line">            <span class="built_in">clearTimeout</span>(replyDebounceTimer)</span><br><span class="line">            replyDebounceTimer = <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!isInitialized) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[Share] DB Ready signal received from <span class="subst">$&#123;srcId&#125;</span>`</span>)</span><br><span class="line">            <span class="comment">// 去 DB 拉取数据</span></span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">applyStateFromDB</span>()</span><br><span class="line">            </span><br><span class="line">            isInitialized = <span class="literal">true</span></span><br><span class="line">            <span class="built_in">clearInterval</span>(initInterval)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    channel.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, messageHandler)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 监听状态变化 (写入方) ---</span></span><br><span class="line">    store.$subscribe(<span class="title function_">async</span> (mutation, state) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (isExternalUpdate) <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">if</span> (!isInitialized) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 先写入 IndexedDB</span></span><br><span class="line">        <span class="keyword">const</span> rawState = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state))</span><br><span class="line">        <span class="keyword">await</span> idb.<span class="title function_">setItem</span>(store.<span class="property">$id</span>, rawState)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 写入成功后，发送轻量级通知</span></span><br><span class="line">        channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;NOTIFY_UPDATE&#x27;</span>,</span><br><span class="line">          <span class="attr">storeId</span>: store.<span class="property">$id</span>,</span><br><span class="line">          <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">          <span class="attr">srcId</span>: <span class="variable constant_">WINDOW_ID</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[Share] Save to DB error`</span>, e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 初始化流程 ---</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 尝试直接从 DB 读取一次 (也许是刷新页面，DB里已经有数据了)</span></span><br><span class="line">    <span class="title function_">applyStateFromDB</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">hasData</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasData) &#123;</span><br><span class="line">            <span class="comment">// 只要 DB 有数据，就算初始化完成，但也可能数据是旧的</span></span><br><span class="line">            <span class="comment">// 所以我们仍然可以发 REQUEST_INIT 确认一下有没有更权威的窗口</span></span><br><span class="line">            <span class="comment">// 但为了简单，如果 DB 有数据，通常认为是持久化的结果</span></span><br><span class="line">            isInitialized = <span class="literal">true</span></span><br><span class="line">            <span class="comment">// 这里看策略：</span></span><br><span class="line">            <span class="comment">// 策略A: 信任 DB，直接完成。</span></span><br><span class="line">            <span class="comment">// 策略B: 即使 DB 有，也问一下其他窗口有没有更新的内存数据。</span></span><br><span class="line">            <span class="comment">// 下面代码采用策略 B，继续轮询一会</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    initInterval = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isInitialized) &#123;</span><br><span class="line">        <span class="built_in">clearInterval</span>(initInterval)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 喊话：谁有最新数据？请刷入 DB 并告诉我</span></span><br><span class="line">      channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;REQUEST_INIT&#x27;</span>,</span><br><span class="line">        <span class="attr">storeId</span>: store.<span class="property">$id</span>,</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">        <span class="attr">srcId</span>: <span class="variable constant_">WINDOW_ID</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;, <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 兜底</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isInitialized) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;[Share] Init timeout, using local/DB state.&#x27;</span>)</span><br><span class="line">        isInitialized = <span class="literal">true</span></span><br><span class="line">        <span class="built_in">clearInterval</span>(initInterval)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方案解析"><a href="#方案解析" class="headerlink" title="方案解析"></a>方案解析</h3><ol><li><p><strong>数据流向</strong>：</p><ul><li><strong>旧方案</strong>：<code>Memory (Window A)</code> -&gt; <code>BroadcastChannel (Huge String)</code> -&gt; <code>Memory (Window B)</code></li><li><strong>新方案</strong>：<code>Memory (Window A)</code> -&gt; <code>IndexedDB</code> -&gt; <code>BroadcastChannel (Notify)</code> -&gt; <code>Memory (Window B) reads IndexedDB</code></li></ul></li><li><p><strong>异步处理 (<code>isExternalUpdate</code> 的微妙之处)</strong>：</p><ul><li>因为 <code>idb.getItem</code> 是异步的，从发出读取请求到数据 patch 到 store 之间有时间差。</li><li>我们在 <code>applyStateFromDB</code> 里设置 <code>isExternalUpdate = true</code>，并在 patch 完成后稍微 <code>setTimeout</code> 延迟释放。</li><li>这确保了：<strong>从 DB 读出来的数据应用到 Store 时，不会再次触发 <code>$subscribe</code> 导致回写 DB 和死循环。</strong></li></ul></li><li><p><strong>初始化逻辑增强</strong>：</p><ul><li>当新窗口发送 <code>REQUEST_INIT</code> 时，老窗口不能只回个“收到”。</li><li>老窗口必须执行 <code>await idb.setItem(...)</code>，<strong>强制把自己内存里的最新状态刷入磁盘</strong>。</li><li>因为 IndexedDB 可能比内存稍微滞后（如果你在 subscribe 里做了防抖），这一步强制刷新保证了新窗口读到的一定是内存里最新的。</li></ul></li><li><p><strong>性能优势</strong>：</p><ul><li><strong>传输极快</strong>：IPC 消息体只有几十字节（ID + Timestamp），无论 Store 有多大（比如存了 1MB 的文本），通信都不会卡顿。</li><li><strong>自动持久化</strong>：你的应用关掉再打开，数据还在 IndexedDB 里（只要你在代码里处理了启动读取），天然支持了数据持久化需求。</li></ul></li></ol><p>这个方案非常适合 Electron 应用，因为它规避了 IPC 传输大数据序列化的性能瓶颈。</p>]]></content>
      
      
      <categories>
          
          <category> electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BroadcastChannel 握手机制的方法</title>
      <link href="/2025/12/14/%E5%89%8D%E7%AB%AF/electron/BroadcastChannel%20%E6%8F%A1%E6%89%8B%E6%9C%BA%E5%88%B6%E7%9A%84%E6%96%B9%E6%B3%95/"/>
      <url>/2025/12/14/%E5%89%8D%E7%AB%AF/electron/BroadcastChannel%20%E6%8F%A1%E6%89%8B%E6%9C%BA%E5%88%B6%E7%9A%84%E6%96%B9%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<h2 id="BroadcastChannel-握手机制的方法实现"><a href="#BroadcastChannel-握手机制的方法实现" class="headerlink" title="BroadcastChannel 握手机制的方法实现"></a>BroadcastChannel 握手机制的方法实现</h2><p>使用场景，dokeview tab拖出来窗口外第一次创建窗口的时候传递参数。</p><p>将这种“握手”逻辑封装成通用的工具函数，可以大大减少重复代码，并保证逻辑的健壮性。</p><p>封装了一个类型安全、支持超时控制的 <strong><code>WindowSync</code></strong> 工具库。</p><h3 id="1-创建工具文件-src-utils-window-sync-ts"><a href="#1-创建工具文件-src-utils-window-sync-ts" class="headerlink" title="1. 创建工具文件 (src/utils/window-sync.ts)"></a>1. 创建工具文件 (<code>src/utils/window-sync.ts</code>)</h3><p>这个工具包含两个核心函数：</p><ol><li><code>sendToChild</code>: 父窗口调用，等待子窗口就绪后发送数据。</li><li><code>receiveFromParent</code>: 子窗口调用，发送就绪信号并等待数据。</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/utils/window-sync.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义消息协议</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">SyncMessage</span>&lt;T = <span class="built_in">any</span>&gt; = </span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">&#x27;CHILD_READY&#x27;</span>; <span class="attr">id</span>: <span class="built_in">string</span> &#125;</span><br><span class="line">  | &#123; <span class="attr">type</span>: <span class="string">&#x27;PARENT_DATA&#x27;</span>; <span class="attr">id</span>: <span class="built_in">string</span>; <span class="attr">payload</span>: T &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">SyncOptions</span> &#123;</span><br><span class="line">  <span class="attr">timeout</span>?: <span class="built_in">number</span>; <span class="comment">// 超时时间，默认 5000ms</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 【父窗口用】发送数据给新开的子窗口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> channelName 频道名称 (必须与子窗口一致)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> targetId 目标窗口/面板的唯一ID (用于过滤)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data 要发送的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> options 配置项</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> sendToChild&lt;T&gt;(</span><br><span class="line">  <span class="attr">channelName</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">targetId</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">data</span>: T,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">SyncOptions</span> = &#123;&#125;</span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; timeout = <span class="number">5000</span> &#125; = options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(channelName);</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">timer</span>: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理函数</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">cleanup</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      channel.<span class="title function_">close</span>();</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 设置超时机制 (防止子窗口没打开，一直卡死在这里)</span></span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">cleanup</span>();</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`[WindowSync] Send timeout: Child window &quot;<span class="subst">$&#123;targetId&#125;</span>&quot; did not respond in <span class="subst">$&#123;timeout&#125;</span>ms`</span>));</span><br><span class="line">    &#125;, timeout);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 监听消息</span></span><br><span class="line">    channel.<span class="property">onmessage</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="title class_">MessageEvent</span>&lt;<span class="title class_">SyncMessage</span>&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="keyword">type</span>, id &#125; = event.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 等待 &quot;CHILD_READY&quot; 信号，且 ID 必须匹配</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">&#x27;CHILD_READY&#x27;</span> &amp;&amp; id === targetId) &#123;</span><br><span class="line">        <span class="comment">// 3. 发送数据</span></span><br><span class="line">        channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;PARENT_DATA&#x27;</span>,</span><br><span class="line">          <span class="attr">id</span>: targetId,</span><br><span class="line">          <span class="attr">payload</span>: data,</span><br><span class="line">        &#125; <span class="keyword">as</span> <span class="title class_">SyncMessage</span>&lt;T&gt;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 完成</span></span><br><span class="line">        <span class="title function_">cleanup</span>();</span><br><span class="line">        <span class="title function_">resolve</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 【子窗口用】接收来自父窗口的数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> channelName 频道名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> myId 自己的唯一ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> options 配置项</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> receiveFromParent&lt;T&gt;(</span><br><span class="line">  <span class="attr">channelName</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">myId</span>: <span class="built_in">string</span>,</span><br><span class="line">  <span class="attr">options</span>: <span class="title class_">SyncOptions</span> = &#123;&#125;</span><br><span class="line">): <span class="title class_">Promise</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; timeout = <span class="number">5000</span> &#125; = options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(channelName);</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">timer</span>: <span class="built_in">any</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">cleanup</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      channel.<span class="title function_">close</span>();</span><br><span class="line">      <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 设置超时</span></span><br><span class="line">    timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">cleanup</span>();</span><br><span class="line">      <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`[WindowSync] Receive timeout: Parent did not send data for &quot;<span class="subst">$&#123;myId&#125;</span>&quot;`</span>));</span><br><span class="line">    &#125;, timeout);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 监听父窗口发来的数据</span></span><br><span class="line">    channel.<span class="property">onmessage</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="title class_">MessageEvent</span>&lt;<span class="title class_">SyncMessage</span>&lt;T&gt;&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="keyword">type</span>, id, payload &#125; = event.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">type</span> === <span class="string">&#x27;PARENT_DATA&#x27;</span> &amp;&amp; id === myId &amp;&amp; payload !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="title function_">cleanup</span>();</span><br><span class="line">        <span class="title function_">resolve</span>(payload);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 主动发送 &quot;我准备好了&quot; 信号</span></span><br><span class="line">    <span class="comment">// 稍微延迟一点，确保父窗口的监听器已经 ready (虽然通常父窗口早就 ready 了)</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;CHILD_READY&#x27;</span>,</span><br><span class="line">        <span class="attr">id</span>: myId,</span><br><span class="line">      &#125; <span class="keyword">as</span> <span class="title class_">SyncMessage</span>);</span><br><span class="line">    &#125;, <span class="number">50</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="2-在父窗口中使用-CustomTab-vue"><a href="#2-在父窗口中使用-CustomTab-vue" class="headerlink" title="2. 在父窗口中使用 (CustomTab.vue)"></a>2. 在父窗口中使用 (<code>CustomTab.vue</code>)</h3><p>现在你的业务代码会变得非常简洁。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; sendToChild &#125; from &#x27;../utils/window-sync&#x27; // 引入工具</span><br><span class="line"></span><br><span class="line">// ... </span><br><span class="line"></span><br><span class="line">const performPopout = async () =&gt; &#123;</span><br><span class="line">  const panelId = props.params.api.id</span><br><span class="line">  const title = props.params.api.title</span><br><span class="line"></span><br><span class="line">  // 1. 准备大对象数据</span><br><span class="line">  const bigData = &#123;</span><br><span class="line">    panelId,</span><br><span class="line">    title,</span><br><span class="line">    userInfo: &#123; name: &#x27;Admin&#x27;, role: &#x27;SuperUser&#x27; &#125;,</span><br><span class="line">    heavyList: Array.from(&#123; length: 1000 &#125;, (_, i) =&gt; i)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 2. 打开窗口 (只传基本 ID)</span><br><span class="line">  const url = `?popout=true&amp;panelId=$&#123;panelId&#125;&amp;title=$&#123;encodeURIComponent(title)&#125;`</span><br><span class="line">  window.open(url, &#x27;_blank&#x27;)</span><br><span class="line"></span><br><span class="line">  // 3. 关闭当前面板 (UI上立即响应)</span><br><span class="line">  props.params.api.group.api.closePanel(props.params.api.panel)</span><br><span class="line"></span><br><span class="line">  // 4. 【关键】调用封装好的发送方法</span><br><span class="line">  // 不用管什么 addEventListener，一行代码搞定</span><br><span class="line">  try &#123;</span><br><span class="line">    await sendToChild(&#x27;dockview-popout&#x27;, panelId, bigData)</span><br><span class="line">    console.log(&#x27;✅ 数据发送成功！&#x27;)</span><br><span class="line">  &#125; catch (err) &#123;</span><br><span class="line">    console.error(&#x27;❌ 发送失败 (可能是窗口被拦截或关闭了):&#x27;, err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><hr><h3 id="3-在子窗口中使用-App-vue"><a href="#3-在子窗口中使用-App-vue" class="headerlink" title="3. 在子窗口中使用 (App.vue)"></a>3. 在子窗口中使用 (<code>App.vue</code>)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; receiveFromParent &#125; from &#x27;./utils/window-sync&#x27; // 引入工具</span><br><span class="line"></span><br><span class="line">const onReady = async (event: DockviewReadyEvent) =&gt; &#123;</span><br><span class="line">  const api = event.api</span><br><span class="line">  const urlParams = new URLSearchParams(window.location.search)</span><br><span class="line">  const isPopout = urlParams.get(&#x27;popout&#x27;) === &#x27;true&#x27;</span><br><span class="line">  const myPanelId = urlParams.get(&#x27;panelId&#x27;)</span><br><span class="line"></span><br><span class="line">  if (isPopout &amp;&amp; myPanelId) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">      // 1. 【关键】调用封装好的接收方法</span><br><span class="line">      // 这里支持泛型，会有代码提示</span><br><span class="line">      const data = await receiveFromParent&lt;any&gt;(&#x27;dockview-popout&#x27;, myPanelId)</span><br><span class="line">      </span><br><span class="line">      console.log(&#x27;👶 收到父窗口投喂:&#x27;, data)</span><br><span class="line"></span><br><span class="line">      // 2. 创建面板</span><br><span class="line">      api.addPanel(&#123;</span><br><span class="line">        id: myPanelId,</span><br><span class="line">        component: &#x27;default&#x27;,</span><br><span class="line">        tabComponent: &#x27;myTab&#x27;,</span><br><span class="line">        params: &#123; </span><br><span class="line">          title: data.title,</span><br><span class="line">          extra: data.userInfo // 使用接收到的数据</span><br><span class="line">        &#125;,</span><br><span class="line">        title: data.title</span><br><span class="line">      &#125;)</span><br><span class="line">      </span><br><span class="line">    &#125; catch (err) &#123;</span><br><span class="line">      console.error(&#x27;❌ 获取数据失败:&#x27;, err)</span><br><span class="line">      // 降级处理：比如显示一个错误提示或者默认空面板</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // 主窗口逻辑...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h3 id="封装后的优势"><a href="#封装后的优势" class="headerlink" title="封装后的优势"></a>封装后的优势</h3><ol><li><strong>代码解耦</strong>：业务组件不需要关心 <code>BroadcastChannel</code> 的创建、销毁、事件监听逻辑。</li><li><strong>资源自动回收</strong>：封装内自动调用了 <code>channel.close()</code>，防止开发者忘记关闭导致内存泄漏。</li><li><strong>健壮性</strong>：增加了 <code>timeout</code> 超时处理。如果新窗口被浏览器拦截了，或者加载失败了，父窗口的 <code>await</code> 不会一直卡死。</li><li><strong>类型安全</strong>：支持 TypeScript 泛型，接收到的 data 直接有类型提示。</li></ol>]]></content>
      
      
      <categories>
          
          <category> electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>单例 Tab 策略” (Singleton Tab Strategy)</title>
      <link href="/2025/12/14/%E5%89%8D%E7%AB%AF/electron/%E5%8D%95%E4%BE%8B%20Tab%20%E7%AD%96%E7%95%A5/"/>
      <url>/2025/12/14/%E5%89%8D%E7%AB%AF/electron/%E5%8D%95%E4%BE%8B%20Tab%20%E7%AD%96%E7%95%A5/</url>
      
        <content type="html"><![CDATA[<h1 id="单例-Tab-策略”-Singleton-Tab-Strategy"><a href="#单例-Tab-策略”-Singleton-Tab-Strategy" class="headerlink" title="单例 Tab 策略” (Singleton Tab Strategy)"></a>单例 Tab 策略” (Singleton Tab Strategy)</h1><p>核心逻辑可以概括为：<strong>“先问一圈，有人有吗？有就让他弹出来，没人有我就自己造。”</strong></p><p>我们需要解决三个技术点：</p><ol><li><strong>全局查询</strong>：利用 <code>BroadcastChannel</code> 询问所有窗口（包括自己）。</li><li><strong>窗口激活</strong>：如果别的窗口有，那个窗口需要把自己置顶（Focus）。</li><li><strong>Tab 激活</strong>：那个窗口需要把对应的 Tab 设为当前活动 Tab。</li></ol><p>下面是系统性的实现方案。</p><hr><h3 id="第一步：主进程支持“窗口激活”-src-main-ipc-window-ipc-ts"><a href="#第一步：主进程支持“窗口激活”-src-main-ipc-window-ipc-ts" class="headerlink" title="第一步：主进程支持“窗口激活” (src/main/ipc/window-ipc.ts)"></a>第一步：主进程支持“窗口激活” (<code>src/main/ipc/window-ipc.ts</code>)</h3><p>前端渲染进程不能直接强制操作系统把窗口置顶，这必须由主进程（Main Process）来做。</p><p>修改 <code>src/main/ipc/window-ipc.ts</code>，增加一个让窗口“激活自己”的 IPC 接口。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main/ipc/window-ipc.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; ipcMain, <span class="title class_">BrowserWindow</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setupWindowIPC</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// ... 之前的 check-cursor-outside-window 代码 ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ✅ 新增：激活（置顶/聚焦）发送请求的那个窗口</span></span><br><span class="line">  ipcMain.<span class="title function_">handle</span>(<span class="string">&#x27;activate-current-window&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 找到触发事件的窗口</span></span><br><span class="line">    <span class="keyword">const</span> win = <span class="title class_">BrowserWindow</span>.<span class="title function_">fromWebContents</span>(event.<span class="property">sender</span>)</span><br><span class="line">    <span class="keyword">if</span> (win) &#123;</span><br><span class="line">      <span class="comment">// 如果最小化了，先还原</span></span><br><span class="line">      <span class="keyword">if</span> (win.<span class="title function_">isMinimized</span>()) win.<span class="title function_">restore</span>()</span><br><span class="line">      <span class="comment">// 聚焦窗口 (Windows/Mac/Linux 通用)</span></span><br><span class="line">      win.<span class="title function_">show</span>()</span><br><span class="line">      win.<span class="title function_">focus</span>()</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>(别忘了在 <code>src/preload/index.ts</code> 里把这个方法暴露给前端，类似于之前的 <code>checkCursorOutside</code>)</em></p><hr><h3 id="第二步：封装“Tab-查询工具”-src-utils-tab-manager-ts"><a href="#第二步：封装“Tab-查询工具”-src-utils-tab-manager-ts" class="headerlink" title="第二步：封装“Tab 查询工具” (src/utils/tab-manager.ts)"></a>第二步：封装“Tab 查询工具” (<code>src/utils/tab-manager.ts</code>)</h3><p>我们需要一个工具函数，利用 <code>BroadcastChannel</code> 发出询问，并等待回复。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/utils/tab-manager.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TAB_CHANNEL_NAME</span> = <span class="string">&#x27;dockview-tab-manager&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">TabMessage</span> &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;CHECK_TAB_EXIST&#x27;</span> | <span class="string">&#x27;TAB_FOUND&#x27;</span></span><br><span class="line">  <span class="attr">tabId</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 尝试查找并激活已存在的 Tab</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tabId 要查找的 Tab ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> Promise&lt;boolean&gt; true 表示找到了并已激活，false 表示没找到</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">findAndActivateTab</span>(<span class="params"><span class="attr">tabId</span>: <span class="built_in">string</span></span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(<span class="variable constant_">TAB_CHANNEL_NAME</span>)</span><br><span class="line">    <span class="keyword">let</span> isFound = <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 监听回复</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handler</span> = (<span class="params"><span class="attr">event</span>: <span class="title class_">MessageEvent</span>&lt;<span class="title class_">TabMessage</span>&gt;</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (event.<span class="property">data</span>.<span class="property">type</span> === <span class="string">&#x27;TAB_FOUND&#x27;</span> &amp;&amp; event.<span class="property">data</span>.<span class="property">tabId</span> === tabId) &#123;</span><br><span class="line">        isFound = <span class="literal">true</span></span><br><span class="line">        <span class="title function_">cleanup</span>()</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="literal">true</span>) <span class="comment">// 找到了！</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">cleanup</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      channel.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;message&#x27;</span>, handler)</span><br><span class="line">      channel.<span class="title function_">close</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    channel.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, handler)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 发出询问广播</span></span><br><span class="line">    <span class="comment">// &quot;嘿！大家注意，有人有点名要找 [tabId]，有的请吱一声并跳出来！&quot;</span></span><br><span class="line">    channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;CHECK_TAB_EXIST&#x27;</span>,</span><br><span class="line">      tabId</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 设置超时</span></span><br><span class="line">    <span class="comment">// 如果 200ms 内没人回复，就认为不存在</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!isFound) &#123;</span><br><span class="line">        <span class="title function_">cleanup</span>()</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="literal">false</span>) <span class="comment">// 没找到</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">200</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 【在 App.vue 初始化时调用】</span></span><br><span class="line"><span class="comment"> * 注册监听器：响应别人的查询</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> dockAPI Dockview 的 API 实例</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">registerTabManager</span>(<span class="params"><span class="attr">dockAPI</span>: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(<span class="variable constant_">TAB_CHANNEL_NAME</span>)</span><br><span class="line"></span><br><span class="line">  channel.<span class="property">onmessage</span> = <span class="title function_">async</span> (<span class="attr">event</span>: <span class="title class_">MessageEvent</span>&lt;<span class="title class_">TabMessage</span>&gt;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (event.<span class="property">data</span>.<span class="property">type</span> === <span class="string">&#x27;CHECK_TAB_EXIST&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> targetId = event.<span class="property">data</span>.<span class="property">tabId</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 1. 检查我这个窗口有没有这个 Tab</span></span><br><span class="line">      <span class="keyword">const</span> panel = dockAPI.<span class="title function_">getPanel</span>(targetId)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (panel) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`🙋‍♂️ 我这里有 Tab [<span class="subst">$&#123;targetId&#125;</span>]，正在激活...`</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 告诉发起者：我找到了！</span></span><br><span class="line">        channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;TAB_FOUND&#x27;</span>,</span><br><span class="line">          <span class="attr">tabId</span>: targetId</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 激活 Dockview 里的 Tab (让它显示出来)</span></span><br><span class="line">        panel.<span class="property">api</span>.<span class="title function_">setActive</span>()</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 调用主进程：把自己这个窗口置顶</span></span><br><span class="line">        <span class="comment">// 假设你在 preload 里暴露了 activateWindow</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">electronAPI</span> &amp;&amp; (<span class="variable language_">window</span>.<span class="property">electronAPI</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="property">activateWindow</span>) &#123;</span><br><span class="line">           <span class="title function_">await</span> (<span class="variable language_">window</span>.<span class="property">electronAPI</span> <span class="keyword">as</span> <span class="built_in">any</span>).<span class="title function_">activateWindow</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="comment">// 兼容写法，如果 preload 没配好，用 window.focus 试试 (有时候会被浏览器拦截)</span></span><br><span class="line">           <span class="variable language_">window</span>.<span class="title function_">focus</span>() </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回清理函数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> channel.<span class="title function_">close</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="第三步：Preload-补充-src-preload-index-ts"><a href="#第三步：Preload-补充-src-preload-index-ts" class="headerlink" title="第三步：Preload 补充 (src/preload/index.ts)"></a>第三步：Preload 补充 (<code>src/preload/index.ts</code>)</h3><p>为了让 <code>activateWindow</code> 生效，我们需要在 preload 里补上这个 API。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/preload/index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; contextBridge, ipcRenderer &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> api = &#123;</span><br><span class="line">  <span class="attr">checkCursorOutside</span>: <span class="function">() =&gt;</span> ipcRenderer.<span class="title function_">invoke</span>(<span class="string">&#x27;check-cursor-outside-window&#x27;</span>),</span><br><span class="line">  <span class="comment">// ✅ 新增：请求主进程激活当前窗口</span></span><br><span class="line">  <span class="attr">activateWindow</span>: <span class="function">() =&gt;</span> ipcRenderer.<span class="title function_">invoke</span>(<span class="string">&#x27;activate-current-window&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... exposeInMainWorld 逻辑同前 ...</span></span><br></pre></td></tr></table></figure><p><em>(记得更新 <code>src/env.d.ts</code> 或 <code>window</code> 类型定义，加上 <code>activateWindow</code>)</em></p><hr><h3 id="第四步：在-App-vue-注册监听-src-App-vue"><a href="#第四步：在-App-vue-注册监听-src-App-vue" class="headerlink" title="第四步：在 App.vue 注册监听 (src/App.vue)"></a>第四步：在 App.vue 注册监听 (<code>src/App.vue</code>)</h3><p>所有窗口（主窗口和子窗口）都运行 <code>App.vue</code>，所以它们都需要“监听别人的查询”。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- src/App.vue --&gt;</span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; onUnmounted &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; registerTabManager &#125; from &#x27;./utils/tab-manager&#x27; // 引入刚才写的工具</span><br><span class="line"></span><br><span class="line">// ... 你的其他代码 ...</span><br><span class="line"></span><br><span class="line">let cleanupTabManager: Function | null = null</span><br><span class="line"></span><br><span class="line">const onReady = (event: DockviewReadyEvent) =&gt; &#123;</span><br><span class="line">  const api = event.api</span><br><span class="line">  </span><br><span class="line">  // ✅ 1. 注册全局 Tab 管理器</span><br><span class="line">  // 一旦 dockview 准备好，我就开始监听 &quot;有没有人找 Tab&quot;</span><br><span class="line">  cleanupTabManager = registerTabManager(api)</span><br><span class="line"></span><br><span class="line">  // ... 原有的逻辑 ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onUnmounted(() =&gt; &#123;</span><br><span class="line">  // 销毁时清理监听</span><br><span class="line">  if (cleanupTabManager) cleanupTabManager()</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><hr><h3 id="第五步：使用功能-在创建-Tab-的地方"><a href="#第五步：使用功能-在创建-Tab-的地方" class="headerlink" title="第五步：使用功能 (在创建 Tab 的地方)"></a>第五步：使用功能 (在创建 Tab 的地方)</h3><p>假设你有一个侧边栏菜单或者按钮用来打开 Tab，现在把 <code>dockAPI.addPanel</code> 替换为下面的逻辑。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 假设这是你的 Sidebar.vue 或者某个业务组件 --&gt;</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;button @click=&quot;openSettings&quot;&gt;打开设置 (唯一)&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; findAndActivateTab &#125; from &#x27;../utils/tab-manager&#x27;</span><br><span class="line"></span><br><span class="line">// 假设你能获取到 dockAPI (通过 Provide/Inject 或者 Store)</span><br><span class="line">// 如果是在 App.vue 内部直接调用就更简单了</span><br><span class="line">const props = defineProps&lt;&#123; dockAPI: any &#125;&gt;() </span><br><span class="line"></span><br><span class="line">const openSettings = async () =&gt; &#123;</span><br><span class="line">  const tabId = &#x27;settings_panel&#x27;</span><br><span class="line">  const tabTitle = &#x27;设置中心&#x27;</span><br><span class="line"></span><br><span class="line">  // 1. ✨ 核心步骤：先问一圈</span><br><span class="line">  const exists = await findAndActivateTab(tabId)</span><br><span class="line"></span><br><span class="line">  if (exists) &#123;</span><br><span class="line">    console.log(&#x27;✅ Tab 已存在于某个窗口，已自动激活，无需创建。&#x27;)</span><br><span class="line">    return // 直接结束</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 2. 如果没找到，就在当前窗口创建</span><br><span class="line">  console.log(&#x27;✨ Tab 不存在，正在当前窗口创建...&#x27;)</span><br><span class="line">  props.dockAPI.addPanel(&#123;</span><br><span class="line">    id: tabId,</span><br><span class="line">    component: &#x27;default&#x27;, // 替换为你的组件名</span><br><span class="line">    tabComponent: &#x27;myTab&#x27;,</span><br><span class="line">    params: &#123; title: tabTitle &#125;,</span><br><span class="line">    title: tabTitle</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><hr><h3 id="场景演示"><a href="#场景演示" class="headerlink" title="场景演示"></a>场景演示</h3><ol><li><p><strong>场景 A：同窗口切换</strong></p><ul><li><strong>现状</strong>：主窗口有“设置”Tab，但被“首页”Tab 挡住了。</li><li><strong>操作</strong>：点击“打开设置”。</li><li><strong>流程</strong>：<code>findAndActivateTab</code> 广播 -&gt; 主窗口收到 -&gt; 发现自己有 -&gt; <code>panel.api.setActive()</code> 切换到设置 Tab -&gt; 激活窗口 -&gt; 回复 <code>TAB_FOUND</code>。</li><li><strong>结果</strong>：主窗口直接切到了设置页。</li></ul></li><li><p><strong>场景 B：跨窗口激活</strong></p><ul><li><strong>现状</strong>：你把“设置”Tab 拖拽到了一个<strong>独立的新窗口</strong>（子窗口），并且把这个子窗口最小化了。</li><li><strong>操作</strong>：在<strong>主窗口</strong>点击“打开设置”。</li><li><strong>流程</strong>：主窗口广播 -&gt; 子窗口收到 -&gt; 发现自己有 -&gt; 调用 <code>ipc: activate-current-window</code> -&gt; <strong>主进程把子窗口还原并置顶</strong> -&gt; 子窗口回复 <code>TAB_FOUND</code>。</li><li><strong>结果</strong>：原本最小化的子窗口弹到了屏幕最前面，显示着设置页。主窗口不会创建重复的 Tab。</li></ul></li><li><p><strong>场景 C：不存在</strong></p><ul><li><strong>现状</strong>：所有窗口都关闭了“设置”。</li><li><strong>操作</strong>：点击“打开设置”。</li><li><strong>流程</strong>：广播 -&gt; 200ms 内没人回 -&gt; 返回 <code>false</code> -&gt; 执行 <code>addPanel</code>。</li><li><strong>结果</strong>：在当前窗口新开一个设置 Tab。</li></ul></li></ol><p>这个方案利用了你现有的 <code>BroadcastChannel</code> 架构，非常轻量且高效。</p>]]></content>
      
      
      <categories>
          
          <category> electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>监听窗口创建完成</title>
      <link href="/2025/12/13/%E5%89%8D%E7%AB%AF/electron/%E7%9B%91%E5%90%AC%E7%AA%97%E5%8F%A3%E5%88%9B%E5%BB%BA%E5%AE%8C%E6%88%90/"/>
      <url>/2025/12/13/%E5%89%8D%E7%AB%AF/electron/%E7%9B%91%E5%90%AC%E7%AA%97%E5%8F%A3%E5%88%9B%E5%BB%BA%E5%AE%8C%E6%88%90/</url>
      
        <content type="html"><![CDATA[<span id="more"></span><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main/index.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 监听新窗口创建请求 (拦截层)</span></span><br><span class="line">mainWindow.<span class="property">webContents</span>.<span class="title function_">setWindowOpenHandler</span>(<span class="function">(<span class="params">details</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// details.url 包含了新窗口的 URL</span></span><br><span class="line">  <span class="comment">// details.frameName 可能是 dockview 指定的名字</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;⚡️ 检测到 Tab 被拖出，正在请求创建窗口:&#x27;</span>, details.<span class="property">url</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 你可以在这里判断 url 是否包含特定的 query 参数，来确定这是 dockview 的弹窗</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123; </span><br><span class="line">    <span class="attr">action</span>: <span class="string">&#x27;allow&#x27;</span>,</span><br><span class="line">    <span class="attr">overrideBrowserWindowOptions</span>: &#123;</span><br><span class="line">      <span class="comment">// 在这里强制指定新窗口的样式</span></span><br><span class="line">      <span class="attr">autoHideMenuBar</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">webPreferences</span>: &#123;</span><br><span class="line">        <span class="attr">preload</span>: <span class="title function_">join</span>(__dirname, <span class="string">&#x27;../preload/index.js&#x27;</span>), <span class="comment">// 别忘了 preload</span></span><br><span class="line">        <span class="attr">backgroundThrottling</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="comment">// ...其他配置</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 监听窗口创建完成 (结果层)</span></span><br><span class="line">mainWindow.<span class="property">webContents</span>.<span class="title function_">on</span>(<span class="string">&#x27;did-create-window&#x27;</span>, <span class="function">(<span class="params">childWindow, details</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;✅ 新窗口实例已创建 (Tab 弹出成功)&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 业务场景：你可能想告诉主渲染进程“有个子窗口诞生了”</span></span><br><span class="line">  mainWindow.<span class="property">webContents</span>.<span class="title function_">send</span>(<span class="string">&#x27;popout-window-created&#x27;</span>, &#123;</span><br><span class="line">    <span class="attr">id</span>: childWindow.<span class="property">id</span>,</span><br><span class="line">    <span class="attr">title</span>: childWindow.<span class="title function_">getTitle</span>()</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 业务场景：监听子窗口的关闭，做一些清理工作</span></span><br><span class="line">  childWindow.<span class="title function_">on</span>(<span class="string">&#x27;closed&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;❌ 子窗口已关闭&#x27;</span>)</span><br><span class="line">    mainWindow.<span class="property">webContents</span>.<span class="title function_">send</span>(<span class="string">&#x27;popout-window-closed&#x27;</span>, &#123; <span class="attr">id</span>: childWindow.<span class="property">id</span> &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>上传到npm仓库</title>
      <link href="/2025/12/13/%E5%89%8D%E7%AB%AF/electron/%E5%A6%82%E4%BD%95%E5%B0%86%E9%A1%B9%E7%9B%AE%E6%8F%92%E4%BB%B6%E4%BC%A0%E5%88%B0npm%E4%BB%93%E5%BA%93/"/>
      <url>/2025/12/13/%E5%89%8D%E7%AB%AF/electron/%E5%A6%82%E4%BD%95%E5%B0%86%E9%A1%B9%E7%9B%AE%E6%8F%92%E4%BB%B6%E4%BC%A0%E5%88%B0npm%E4%BB%93%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<p>发布 npm 包不仅仅是把代码放上去，还需要考虑 <strong>构建规范 (ESM&#x2F;CJS)</strong>、<strong>类型定义 (TypeScript .d.ts)</strong>、<strong>Peer Dependencies</strong> 以及 <strong>扩展性</strong>。</p><p>既然我们要把它做成一个通用的 <code>pinia-plugin-electron-share</code>，我们需要让它支持配置（比如自定义 Channel 名称），并且具备完善的工程化结构。</p><p>这里是<strong>可以直接 <code>npm publish</code> 的完整工程代码结构</strong>。</p><hr><h3 id="1-项目目录结构"><a href="#1-项目目录结构" class="headerlink" title="1. 项目目录结构"></a>1. 项目目录结构</h3><p>你需要创建一个新的文件夹（例如 <code>pinia-plugin-electron-share</code>），结构如下：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pinia-plugin-electron-share/</span><br><span class="line">├── src/</span><br><span class="line">│   └── index.ts        # 核心源码</span><br><span class="line">├── dist/               # 构建产物 (自动生成)</span><br><span class="line">├── package.json        # 依赖与元数据</span><br><span class="line">├── tsconfig.json       # TS 配置</span><br><span class="line">├── vite.config.ts      # 构建脚本 (使用 Vite 库模式)</span><br><span class="line">└── README.md           # 说明文档</span><br></pre></td></tr></table></figure><hr><h3 id="2-核心代码-src-index-ts"><a href="#2-核心代码-src-index-ts" class="headerlink" title="2. 核心代码 (src/index.ts)"></a>2. 核心代码 (<code>src/index.ts</code>)</h3><p>这里我做了一些增强：</p><ol><li><strong>支持插件级配置</strong>：可以在 <code>pinia.use()</code> 时传入全局配置。</li><li><strong>类型声明增强</strong>：完美的 TypeScript 类型提示。</li><li><strong>序列化保护</strong>：增加了对序列化异常的基础捕获。</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PiniaPluginContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 扩展 Pinia 类型定义</span></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;pinia&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">DefineStoreOptionsBase</span>&lt;S, <span class="title class_">Store</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Enable state synchronization across Electron windows.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@default</span> <span class="variable">false</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="attr">share</span>?: <span class="built_in">boolean</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 插件配置接口</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">ElectronShareOptions</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Custom name for BroadcastChannel.</span></span><br><span class="line"><span class="comment">   * Useful if you have multiple apps running on the same domain/protocol.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@default</span> &#x27;pinia-electron-share&#x27;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">channelName</span>?: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 消息载荷定义</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">SyncPayload</span> = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;UPDATE&#x27;</span> | <span class="string">&#x27;REQUEST_INIT&#x27;</span> | <span class="string">&#x27;RESPONSE_INIT&#x27;</span></span><br><span class="line">  <span class="attr">storeId</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">data</span>?: <span class="built_in">any</span></span><br><span class="line">  <span class="attr">timestamp</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 插件主函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createElectronSharePlugin</span>(<span class="params"><span class="attr">globalOptions</span>: <span class="title class_">ElectronShareOptions</span> = &#123;&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">CHANNEL_NAME</span> = globalOptions.<span class="property">channelName</span> || <span class="string">&#x27;pinia-electron-share&#x27;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建频道 (由于是广播，可以在插件层级复用一个实例，也可以在 Store 级创建，这里为了简单和性能复用一个)</span></span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(<span class="variable constant_">CHANNEL_NAME</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">&#123; store, options &#125;: <span class="title class_">PiniaPluginContext</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果 Store 没有开启 share，直接跳过</span></span><br><span class="line">    <span class="keyword">if</span> (!options.<span class="property">share</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> isExternalUpdate = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 消息接收逻辑 ---</span></span><br><span class="line">    channel.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params"><span class="attr">event</span>: <span class="title class_">MessageEvent</span>&lt;<span class="title class_">SyncPayload</span>&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; <span class="keyword">type</span>, storeId, data &#125; = event.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 忽略不属于当前 Store 的消息</span></span><br><span class="line">      <span class="keyword">if</span> (storeId !== store.<span class="property">$id</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;UPDATE&#x27;</span>:</span><br><span class="line">          <span class="keyword">if</span> (!isExternalUpdate) &#123;</span><br><span class="line">            isExternalUpdate = <span class="literal">true</span></span><br><span class="line">            store.$patch(data)</span><br><span class="line">            <span class="comment">// 宏任务延迟释放锁，确保 Vue 响应式队列清空</span></span><br><span class="line">            <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; isExternalUpdate = <span class="literal">false</span> &#125;, <span class="number">0</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;REQUEST_INIT&#x27;</span>:</span><br><span class="line">          <span class="comment">// 收到新窗口的请求，发送当前状态</span></span><br><span class="line">          channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;RESPONSE_INIT&#x27;</span>,</span><br><span class="line">            <span class="attr">storeId</span>: store.<span class="property">$id</span>,</span><br><span class="line">            <span class="attr">data</span>: <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(store.<span class="property">$state</span>)),</span><br><span class="line">            <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;RESPONSE_INIT&#x27;</span>:</span><br><span class="line">          <span class="comment">// 收到初始化数据，应用到当前 Store</span></span><br><span class="line">          isExternalUpdate = <span class="literal">true</span></span><br><span class="line">          store.$patch(data)</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; isExternalUpdate = <span class="literal">false</span> &#125;, <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 状态变更监听 ---</span></span><br><span class="line">    store.$subscribe(<span class="function">(<span class="params">mutation, state</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isExternalUpdate) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> rawState = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state))</span><br><span class="line">        </span><br><span class="line">        channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;UPDATE&#x27;</span>,</span><br><span class="line">          <span class="attr">storeId</span>: store.<span class="property">$id</span>,</span><br><span class="line">          <span class="attr">data</span>: rawState,</span><br><span class="line">          <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">`[pinia-plugin-electron-share] Failed to serialize state for store &quot;<span class="subst">$&#123;store.$id&#125;</span>&quot;. Ensure state is JSON-serializable.`</span>, e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --- 初始化握手 ---</span></span><br><span class="line">    <span class="comment">// 延迟极短时间发送请求，确保监听器已挂载</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;REQUEST_INIT&#x27;</span>,</span><br><span class="line">        <span class="attr">storeId</span>: store.<span class="property">$id</span>,</span><br><span class="line">        <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;, <span class="number">50</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="3-构建配置-vite-config-ts"><a href="#3-构建配置-vite-config-ts" class="headerlink" title="3. 构建配置 (vite.config.ts)"></a>3. 构建配置 (<code>vite.config.ts</code>)</h3><p>使用 Vite 的库模式（Library Mode）是目前打包现代前端库的最佳实践。我们需要同时输出 ESM (给 Vite&#x2F;Webpack 用) 和 CJS (给旧 Node 环境用，虽然后者在 Electron 前端不常用，但为了规范还是加上)。</p><p>你需要安装开发依赖：<br><code>npm install -D vite vite-plugin-dts typescript vue pinia</code></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vite.config.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> dts <span class="keyword">from</span> <span class="string">&#x27;vite-plugin-dts&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; resolve &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="comment">// 自动生成 .d.ts 类型文件</span></span><br><span class="line">    <span class="title function_">dts</span>(&#123; </span><br><span class="line">      <span class="attr">include</span>: [<span class="string">&#x27;src/**/*.ts&#x27;</span>],</span><br><span class="line">      <span class="attr">insertTypesEntry</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">lib</span>: &#123;</span><br><span class="line">      <span class="attr">entry</span>: <span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;src/index.ts&#x27;</span>),</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;PiniaPluginElectronShare&#x27;</span>,</span><br><span class="line">      <span class="attr">fileName</span>: <span class="function">(<span class="params">format</span>) =&gt;</span> <span class="string">`index.<span class="subst">$&#123;format&#125;</span>.js`</span> <span class="comment">// index.es.js, index.umd.js</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="comment">// 确保外部化处理那些你不想打包进库的依赖</span></span><br><span class="line">      <span class="attr">external</span>: [<span class="string">&#x27;pinia&#x27;</span>, <span class="string">&#x27;vue&#x27;</span>],</span><br><span class="line">      <span class="attr">output</span>: &#123;</span><br><span class="line">        <span class="comment">// 在 UMD 构建模式下为这些外部化的依赖提供一个全局变量</span></span><br><span class="line">        <span class="attr">globals</span>: &#123;</span><br><span class="line">          <span class="attr">vue</span>: <span class="string">&#x27;Vue&#x27;</span>,</span><br><span class="line">          <span class="attr">pinia</span>: <span class="string">&#x27;Pinia&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><hr><h3 id="4-package-json-配置"><a href="#4-package-json-配置" class="headerlink" title="4. package.json 配置"></a>4. <code>package.json</code> 配置</h3><p>这里有几个关键点：</p><ol><li><strong><code>peerDependencies</code></strong>：明确告诉使用者，你必须先安装 <code>pinia</code>。</li><li><strong><code>exports</code></strong>：现代 npm 包的导出规范。</li><li><strong><code>types</code></strong>：指向生成的类型文件。</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinia-plugin-electron-share&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Sync Pinia state across Electron windows (Renderer processes) using BroadcastChannel. Ideal for Dockview.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;main&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./dist/index.umd.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./dist/index.es.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./dist/index.d.ts&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;exports&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;.&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;import&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./dist/index.es.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;require&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./dist/index.umd.js&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;types&quot;</span><span class="punctuation">:</span> <span class="string">&quot;./dist/index.d.ts&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;dist&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite build --watch&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vite build&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;prepublishOnly&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npm run build&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;keywords&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;pinia&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;electron&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;vue&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;share&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;multi-window&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;dockview&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;author&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Your Name&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;license&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MIT&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;peerDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;pinia&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;devDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;pinia&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;typescript&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;vite&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;vite-plugin-dts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;vue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.0.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><hr><h3 id="5-tsconfig-json"><a href="#5-tsconfig-json" class="headerlink" title="5. tsconfig.json"></a>5. <code>tsconfig.json</code></h3><p>确保能正确编译。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;compilerOptions&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ESNext&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;useDefineForClassFields&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;module&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ESNext&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;moduleResolution&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Node&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;strict&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sourceMap&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;resolveJsonModule&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;isolatedModules&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;esModuleInterop&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lib&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;ESNext&quot;</span><span class="punctuation">,</span> <span class="string">&quot;DOM&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;skipLibCheck&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;declaration&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;include&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;src&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><hr><h3 id="6-使用说明-README-md-片段"><a href="#6-使用说明-README-md-片段" class="headerlink" title="6. 使用说明 (README.md 片段)"></a>6. 使用说明 (<code>README.md</code> 片段)</h3><p>你可以直接把这段贴到文档里：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># pinia-plugin-electron-share</span></span><br><span class="line"></span><br><span class="line">Sync Pinia state across multiple Electron windows (Renderer Processes).</span><br><span class="line"></span><br><span class="line"><span class="section">## Installation</span></span><br><span class="line"></span><br><span class="line"><span class="code">```bash</span></span><br><span class="line"><span class="code">npm install pinia-plugin-electron-share</span></span><br></pre></td></tr></table></figure><h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><h3 id="1-Register-the-Plugin"><a href="#1-Register-the-Plugin" class="headerlink" title="1. Register the Plugin"></a>1. Register the Plugin</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/index.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createElectronSharePlugin &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia-plugin-electron-share&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pinia = <span class="title function_">createPinia</span>()</span><br><span class="line"></span><br><span class="line">pinia.<span class="title function_">use</span>(<span class="title function_">createElectronSharePlugin</span>(&#123;</span><br><span class="line">  <span class="comment">// Optional: Custom channel name</span></span><br><span class="line">  <span class="attr">channelName</span>: <span class="string">&#x27;my-app-sync&#x27;</span> </span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> pinia</span><br></pre></td></tr></table></figure><h3 id="2-Enable-in-Store"><a href="#2-Enable-in-Store" class="headerlink" title="2. Enable in Store"></a>2. Enable in Store</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store/user.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123; <span class="attr">count</span>: <span class="number">0</span> &#125;),</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">increment</span>(<span class="params"></span>) &#123; <span class="variable language_">this</span>.<span class="property">count</span>++ &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// Enable sync for this store</span></span><br><span class="line">  <span class="attr">share</span>: <span class="literal">true</span> </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">### 7. 发布流程</span><br><span class="line"></span><br><span class="line">作为高级工程师，你应该知道发布流程，但为了完整性我还是列一下：</span><br><span class="line"></span><br><span class="line">这里提醒一下 npm 官网更新了验证机制，你需要去在你的账户下创建一个access token，然后在命令行中使用 `npm login --registry=https://registry.npmjs.org/` 登录。</span><br><span class="line"></span><br><span class="line">在项目下创建一个.npmrc 文件，内容如下：</span><br></pre></td></tr></table></figure><p>registry&#x3D;<a href="https://registry.npmjs.com/">https://registry.npmjs.com/</a><br>&#x2F;&#x2F;registry.npmjs.com&#x2F;:_authToken&#x3D;YOUR_ACCESS_TOKEN</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1.  **构建**：</span><br><span class="line">    ```bash</span><br><span class="line">    npm run build</span><br></pre></td></tr></table></figure><pre><code>*(确保 `dist` 目录下生成了 `index.es.js` 和 `index.d.ts`)*</code></pre><ol start="2"><li><p><strong>发布</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm login</span><br><span class="line">npm publish --access public</span><br></pre></td></tr></table></figure></li><li><p><strong>在你的项目中使用</strong>：<br>在你的 Electron 项目中 <code>npm install pinia-plugin-electron-share</code>，然后按照 README 配置即可。</p></li></ol><h3 id="为什么这样做更好？"><a href="#为什么这样做更好？" class="headerlink" title="为什么这样做更好？"></a>为什么这样做更好？</h3><ol><li><strong>解耦</strong>：你的业务代码库不会混入一堆复杂的 IPC 通信逻辑。</li><li><strong>复用</strong>：如果你有下一个 Electron 项目，直接 install 即可。</li><li><strong>类型安全</strong>：通过 <code>declare module</code>，你的同事在写 <code>defineStore</code> 时，输入 <code>share:</code> 会自动获得代码提示，这才是高级开发体验。</li></ol>]]></content>
      
      
      <categories>
          
          <category> electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>electron多窗口状态同步 插件开发pinia-plugin-electron-share</title>
      <link href="/2025/12/13/%E5%89%8D%E7%AB%AF/electron/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AApinia%E6%8F%92%E4%BB%B6/"/>
      <url>/2025/12/13/%E5%89%8D%E7%AB%AF/electron/%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AApinia%E6%8F%92%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="设计方案"><a href="#设计方案" class="headerlink" title="设计方案"></a>设计方案</h2><ol><li><strong>零主进程依赖</strong>：基于 <code>BroadcastChannel</code>，不需要修改 Electron 主进程代码，纯前端实现。</li><li><strong>自动水合（Hydration）</strong>：新窗口（Dockview 弹出窗）打开时，会自动向老窗口“要”数据，解决初始化空白问题。</li><li><strong>防死循环</strong>：内置互斥锁，防止 A -&gt; B -&gt; A 的无限更新。</li><li><strong>按需同步</strong>：不是所有 Store 都会同步，你可以在定义 Store 时通过 <code>share: true</code> 开启。</li></ol><span id="more"></span><hr><h3 id="1-核心插件代码"><a href="#1-核心插件代码" class="headerlink" title="1. 核心插件代码"></a>1. 核心插件代码</h3><p>请在项目中新建文件 <code>src/plugins/pinia-plugin-electron-share.ts</code>。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">PiniaPluginContext</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 扩展 Pinia 的定义，以便在使用 defineStore 时有代码提示</span></span><br><span class="line"><span class="keyword">declare</span> <span class="variable language_">module</span> <span class="string">&#x27;pinia&#x27;</span> &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">DefineStoreOptionsBase</span>&lt;S, <span class="title class_">Store</span>&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否在 Electron 多窗口之间同步该 Store 的状态</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@default</span> <span class="variable">false</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="attr">share</span>?: <span class="built_in">boolean</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息类型定义</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">SyncPayload</span> = &#123;</span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;UPDATE&#x27;</span> | <span class="string">&#x27;REQUEST_INIT&#x27;</span> | <span class="string">&#x27;RESPONSE_INIT&#x27;</span>;</span><br><span class="line">  <span class="attr">storeId</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">data</span>?: <span class="built_in">any</span>; <span class="comment">// State object</span></span><br><span class="line">  <span class="attr">timestamp</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 频道名称</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CHANNEL_NAME</span> = <span class="string">&#x27;electron-pinia-share-channel&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">piniaPluginElectronShare</span>(<span class="params">&#123; store, options &#125;: <span class="title class_">PiniaPluginContext</span></span>) &#123;</span><br><span class="line">  <span class="comment">// 1. 检查当前 Store 是否开启了共享</span></span><br><span class="line">  <span class="keyword">if</span> (!options.<span class="property">share</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. 创建广播频道 (所有窗口共用同一个频道名)</span></span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> <span class="title class_">BroadcastChannel</span>(<span class="variable constant_">CHANNEL_NAME</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 内部状态锁：防止死循环 (收到消息更新时，不再广播出去)</span></span><br><span class="line">  <span class="keyword">let</span> isExternalUpdate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 核心逻辑：处理接收到的消息</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  channel.<span class="property">onmessage</span> = <span class="function">(<span class="params"><span class="attr">event</span>: <span class="title class_">MessageEvent</span>&lt;<span class="title class_">SyncPayload</span>&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="keyword">type</span>, storeId, data, timestamp &#125; = event.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只处理当前 Store 的消息</span></span><br><span class="line">    <span class="keyword">if</span> (storeId !== store.<span class="property">$id</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">type</span>) &#123;</span><br><span class="line">      <span class="comment">// 场景 A: 收到其他窗口的状态更新</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;UPDATE&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> (!isExternalUpdate) &#123;</span><br><span class="line">          isExternalUpdate = <span class="literal">true</span>;</span><br><span class="line">          store.$patch(data);</span><br><span class="line">          <span class="comment">// 这里稍微延迟一点释放锁，确保 Vue 响应式系统处理完毕</span></span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; isExternalUpdate = <span class="literal">false</span>; &#125;, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 场景 B: 新窗口刚打开，请求初始化数据 (我是老窗口，我有数据)</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;REQUEST_INIT&#x27;</span>:</span><br><span class="line">        <span class="comment">// 为了避免多个老窗口同时回复，这里可以做一个简单的随机延迟，或者由于是替换操作，多次回复也无所谓</span></span><br><span class="line">        <span class="comment">// 直接发送当前状态给新窗口</span></span><br><span class="line">        channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="string">&#x27;RESPONSE_INIT&#x27;</span>,</span><br><span class="line">          <span class="attr">storeId</span>: store.<span class="property">$id</span>,</span><br><span class="line">          <span class="attr">data</span>: <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(store.<span class="property">$state</span>)),</span><br><span class="line">          <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 场景 C: 我是新窗口，收到了初始化数据</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;RESPONSE_INIT&#x27;</span>:</span><br><span class="line">        isExternalUpdate = <span class="literal">true</span>;</span><br><span class="line">        store.$patch(data);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; isExternalUpdate = <span class="literal">false</span>; &#125;, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 核心逻辑：监听当前 Store 变化并广播</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  store.$subscribe(<span class="function">(<span class="params">mutation, state</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果是由外部消息触发的更新，则不广播，断绝死循环</span></span><br><span class="line">    <span class="keyword">if</span> (isExternalUpdate) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 序列化 State (去除 Vue 的响应式代理，转为纯 JSON)</span></span><br><span class="line">    <span class="comment">// 注意：如果有 Date/Map/Set 需要特殊处理，这里假设是基础 JSON</span></span><br><span class="line">    <span class="keyword">const</span> rawState = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(state));</span><br><span class="line"></span><br><span class="line">    channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;UPDATE&#x27;</span>,</span><br><span class="line">      <span class="attr">storeId</span>: store.<span class="property">$id</span>,</span><br><span class="line">      <span class="attr">data</span>: rawState,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化逻辑：</span></span><br><span class="line"><span class="comment">   * 插件加载（Store 创建）时，如果是新窗口，可能数据是空的。</span></span><br><span class="line"><span class="comment">   * 发送一个 &quot;REQUEST_INIT&quot; 广播，问问有没有其他窗口存活着并有数据。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// 延时极短的时间，确保 BroadcastChannel 已经准备好，且不会阻塞主线程</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    channel.<span class="title function_">postMessage</span>(&#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="string">&#x27;REQUEST_INIT&#x27;</span>,</span><br><span class="line">      <span class="attr">storeId</span>: store.<span class="property">$id</span>,</span><br><span class="line">      <span class="attr">timestamp</span>: <span class="title class_">Date</span>.<span class="title function_">now</span>(),</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="number">50</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 组件销毁时关闭频道 (可选，Pinia Store 通常生命周期伴随整个应用，不关也没事)</span></span><br><span class="line">  <span class="comment">// return () =&gt; &#123; channel.close(); &#125; </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="2-在-Pinia-中注册插件"><a href="#2-在-Pinia-中注册插件" class="headerlink" title="2. 在 Pinia 中注册插件"></a>2. 在 Pinia 中注册插件</h3><p>修改你的 <code>src/store/index.ts</code> (或者你创建 pinia 的地方)。</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; piniaPluginElectronShare &#125; <span class="keyword">from</span> <span class="string">&#x27;../plugins/pinia-plugin-electron-share&#x27;</span>; <span class="comment">// 引入上面写的文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pinia = <span class="title function_">createPinia</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册插件</span></span><br><span class="line">pinia.<span class="title function_">use</span>(piniaPluginElectronShare);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> pinia;</span><br></pre></td></tr></table></figure><hr><h3 id="3-如何在-Store-中使用"><a href="#3-如何在-Store-中使用" class="headerlink" title="3. 如何在 Store 中使用"></a>3. 如何在 Store 中使用</h3><p>这步最关键。你需要在那些“需要在 Dockview 窗口间同步”的 Store 里，加上 <code>share: true</code>。</p><p>例如 <code>src/store/modules/user.ts</code>：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useUserStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;user&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">token</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">userInfo</span>: &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;Guest&#x27;</span>,</span><br><span class="line">      <span class="attr">age</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// 假设这是 Dockview 的布局配置，也需要同步</span></span><br><span class="line">    <span class="attr">layoutConfig</span>: &#123;&#125; </span><br><span class="line">  &#125;),</span><br><span class="line">  </span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">updateName</span>(<span class="params"><span class="attr">name</span>: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">userInfo</span>.<span class="property">name</span> = name;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开启多窗口同步</span></span><br><span class="line">  <span class="attr">share</span>: <span class="literal">true</span> </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>如果是 Setup Store 写法：</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;counter&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">increment</span>(<span class="params"></span>) &#123; count.<span class="property">value</span>++ &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; count, increment &#125;;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  <span class="comment">// Setup Store 的配置项在这里</span></span><br><span class="line">  <span class="attr">share</span>: <span class="literal">true</span> </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><hr><h3 id="4-验证与调试方法"><a href="#4-验证与调试方法" class="headerlink" title="4. 验证与调试方法"></a>4. 验证与调试方法</h3><p>我建议你按照以下步骤验证方案是否生效：</p><ol><li><strong>启动应用</strong>：打开主窗口。</li><li><strong>修改数据</strong>：在主窗口修改 <code>useUserStore</code> 中的数据（比如登录，或者改个名字）。</li><li><strong>弹出窗口 (Dockview)</strong>：拖拽 Tab 形成一个新的弹出窗口。<ul><li><strong>预期</strong>：弹出窗口应该立即显示刚才修改过的数据（这是 <code>REQUEST_INIT</code> 逻辑在起作用）。</li></ul></li><li><strong>双向同步测试</strong>：<ul><li>在<strong>弹出窗口</strong>里修改数据。</li><li>观察<strong>主窗口</strong>（以及其他弹出窗口）的数据是否跟着变了。</li><li><strong>预期</strong>：应该毫秒级同步。</li></ul></li></ol><h3 id="5-注意事项-Senior-Tips"><a href="#5-注意事项-Senior-Tips" class="headerlink" title="5. 注意事项 (Senior Tips)"></a>5. 注意事项 (Senior Tips)</h3><ol><li><strong>同源策略</strong>：<br><code>BroadcastChannel</code> 依赖浏览器的同源策略。确保你的 <code>electron-vite</code> 在开发模式下所有窗口都是 <code>http://localhost:xxxx</code>，或者在生产模式下加载的都是 <code>file://</code> 或者自定义协议 <code>app://</code>。只要它们属于同一个 Origin，这个方案就 100% 有效。</li><li><strong>性能</strong>：<br>虽然 <code>BroadcastChannel</code> 很快，但不要用它传输非常大的二进制数据（如图片 Base64、超长文本）。如果 State 特别大，建议将大数据放在 IndexedDB，Store 里只存 ID。</li><li><strong>非序列化数据</strong>：<br><code>JSON.stringify</code> 会丢失 <code>Function</code>、<code>Map</code>、<code>Set</code> 等类型。请确保你的 Pinia State 是纯数据对象（Plain Object）。这是 Vue 和 Pinia 的最佳实践，也是多进程通信的限制。</li></ol><p>这套代码虽然看起来简单，但处理了多进程架构中最棘手的“竞争”和“初始化”问题，完全可以直接合入项目。</p>]]></content>
      
      
      <categories>
          
          <category> electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>electron 开发者的自我介绍</title>
      <link href="/2025/12/13/%E5%89%8D%E7%AB%AF/%E5%85%B6%E4%BB%96/%E5%A6%82%E4%BD%95%E6%8F%8F%E8%BF%B0%E8%87%AA%E5%B7%B1%E5%81%9A%E7%9A%84%E4%BA%8B%E6%83%85/"/>
      <url>/2025/12/13/%E5%89%8D%E7%AB%AF/%E5%85%B6%E4%BB%96/%E5%A6%82%E4%BD%95%E6%8F%8F%E8%BF%B0%E8%87%AA%E5%B7%B1%E5%81%9A%E7%9A%84%E4%BA%8B%E6%83%85/</url>
      
        <content type="html"><![CDATA[<p>作为一名在前端和桌面端应用开发领域深耕 10 年的高级架构师，我不仅熟悉 Electron 的底层原理（Chromium + Node.js + Native APIs），也深谙现代前端框架（Vue3&#x2F;React）与后端服务（Nest.js&#x2F;Next.js）的结合之道。<br>&lt;–more–&gt;<br>在 Electron 开发中，我通常会从以下几个核心维度为您构建系统性的解决方案：<br>架构设计 (Architecture)：<br>进程模型：主进程 (Main)、渲染进程 (Renderer) 与 GPU 进程的职责划分。<br>通信机制：如何设计高效、类型安全（Type-safe）的 IPC（Inter-Process Communication）通信策略（例如使用 ipcRenderer.invoke + handle 模式）。<br>安全性 (Security)：上下文隔离 (Context Isolation)、沙箱模式 (Sandbox)、以及如何安全地暴露 Node.js 能力（Preload Scripts）。<br>技术栈整合 (Integration)：<br>Vue3&#x2F;React：如何处理路由（Hash vs History mode）、状态管理（Pinia&#x2F;Redux&#x2F;Zustand）在多窗口间的数据同步。<br>后端交互：如何与 Nest.js 等后端微服务进行鉴权、Socket 连接或本地 Node.js 服务的集成。<br>性能优化 (Performance)：<br>启动速度优化（Vite&#x2F;Webpack 构建调优）。<br>内存泄漏排查与长列表渲染。<br>安装包体积瘦身（Asar打包、依赖剔除）。<br>原生能力与工程化 (Native &amp; DevOps)：<br>文件系统操作、系统托盘、原生菜单、快捷键。<br>C++&#x2F;Rust Addons 调用（Node-API）。<br>自动更新 (Auto-updater) 策略。<br>CI&#x2F;CD 流程及多平台（Win&#x2F;Mac&#x2F;Linux）签名与构建。</p>]]></content>
      
      
      <categories>
          
          <category> cocos </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cocos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>electron-vite相关</title>
      <link href="/2025/12/07/%E5%89%8D%E7%AB%AF/electron/electron-vite%E7%9B%B8%E5%85%B3/"/>
      <url>/2025/12/07/%E5%89%8D%E7%AB%AF/electron/electron-vite%E7%9B%B8%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<h2 id="1-electron-vite相关的问题汇总"><a href="#1-electron-vite相关的问题汇总" class="headerlink" title="1. electron-vite相关的问题汇总"></a>1. electron-vite相关的问题汇总</h2><p><a href="https://github.com/alex8088/electron-vite">https://github.com/alex8088/electron-vite</a><br><a href="https://cn.electron-vite.org/">https://cn.electron-vite.org/</a></p><span id="more"></span><h2 id="2-electron-vite如何集成-Dockview"><a href="#2-electron-vite如何集成-Dockview" class="headerlink" title="2. electron-vite如何集成 Dockview"></a>2. electron-vite如何集成 Dockview</h2><p><a href="https://dockview.dev/templates/">https://dockview.dev/templates/</a><br>完整 Dockview 浮动窗口示例 (Electron-Vite)</p><ol><li>⚙️ 主进程 (Main Process) 设置<br>在你的 Electron 主进程文件（通常是 src&#x2F;main&#x2F;index.ts 或 src&#x2F;main&#x2F;main.ts）中，你需要添加代码来监听渲染进程发出的创建新窗口的请求。</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title class_">TypeScript</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/main/index.ts (或类似的主进程文件)</span></span><br><span class="line"><span class="keyword">import</span> &#123; app, <span class="title class_">BrowserWindow</span>, ipcMain &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; join &#125; <span class="keyword">from</span> <span class="string">&#x27;path&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... (省略了 createWindow 等初始化代码)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> externalWindows = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">BrowserWindow</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听渲染进程请求创建浮动面板窗口</span></span><br><span class="line">ipcMain.<span class="title function_">on</span>(<span class="string">&#x27;create-external-panel-window&#x27;</span>, <span class="function">(<span class="params">_, <span class="attr">data</span>: &#123; groupId: <span class="built_in">string</span>, initialBounds: <span class="built_in">any</span>, url: <span class="built_in">string</span> &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; groupId, initialBounds, url &#125; = data;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (externalWindows.<span class="title function_">has</span>(groupId)) &#123;</span><br><span class="line">    externalWindows.<span class="title function_">get</span>(groupId)?.<span class="title function_">focus</span>();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个新的 Electron 浏览器窗口</span></span><br><span class="line">  <span class="keyword">const</span> externalWindow = <span class="keyword">new</span> <span class="title class_">BrowserWindow</span>(&#123;</span><br><span class="line">    <span class="attr">x</span>: initialBounds.<span class="property">x</span>,</span><br><span class="line">    <span class="attr">y</span>: initialBounds.<span class="property">y</span>,</span><br><span class="line">    <span class="attr">width</span>: initialBounds.<span class="property">width</span>,</span><br><span class="line">    <span class="attr">height</span>: initialBounds.<span class="property">height</span>,</span><br><span class="line">    <span class="attr">show</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">webPreferences</span>: &#123;</span><br><span class="line">      <span class="attr">preload</span>: <span class="title function_">join</span>(__dirname, <span class="string">&#x27;../preload/index.js&#x27;</span>),</span><br><span class="line">      <span class="comment">// 注意：这里需要启用 sandbox，然后通过 preload 暴露安全 API</span></span><br><span class="line">      <span class="attr">sandbox</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">contextIsolation</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  externalWindow.<span class="title function_">on</span>(<span class="string">&#x27;closed&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    externalWindows.<span class="title function_">delete</span>(groupId);</span><br><span class="line">    <span class="comment">// 通知主窗口面板已关闭</span></span><br><span class="line">    <span class="title class_">BrowserWindow</span>.<span class="title function_">getAllWindows</span>().<span class="title function_">forEach</span>(<span class="function"><span class="params">win</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (win !== externalWindow) &#123;</span><br><span class="line">            win.<span class="property">webContents</span>.<span class="title function_">send</span>(<span class="string">&#x27;external-panel-closed&#x27;</span>, groupId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载 Dockview 外部窗口的特定 URL</span></span><br><span class="line">  <span class="comment">// 我们将使用主窗口的 URL，但带上查询参数来指示它是外部窗口</span></span><br><span class="line">  externalWindow.<span class="title function_">loadURL</span>(<span class="string">`<span class="subst">$&#123;url&#125;</span>?groupId=<span class="subst">$&#123;groupId&#125;</span>&amp;external=true`</span>);</span><br><span class="line">  </span><br><span class="line">  externalWindow.<span class="title function_">once</span>(<span class="string">&#x27;ready-to-show&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    externalWindow.<span class="title function_">show</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  externalWindows.<span class="title function_">set</span>(groupId, externalWindow);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听并转发来自主窗口的消息到特定的外部窗口</span></span><br><span class="line">ipcMain.<span class="title function_">on</span>(<span class="string">&#x27;external-panel-message&#x27;</span>, <span class="function">(<span class="params">_, <span class="attr">groupId</span>: <span class="built_in">string</span>, <span class="attr">message</span>: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> win = externalWindows.<span class="title function_">get</span>(groupId);</span><br><span class="line">    <span class="keyword">if</span> (win) &#123;</span><br><span class="line">        win.<span class="property">webContents</span>.<span class="title function_">send</span>(<span class="string">&#x27;dockview-message&#x27;</span>, message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="2"><li>Preload 脚本设置<br>为了在渲染进程中安全地使用 IPC，你需要通过 contextBridge 在 Preload 脚本中暴露必要的 IPC 功能。</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">TypeScript</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// src/preload/index.ts (或类似的 Preload 文件)</span></span><br><span class="line"><span class="keyword">import</span> &#123; contextBridge, ipcRenderer &#125; <span class="keyword">from</span> <span class="string">&#x27;electron&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... (省略了其他 IPC 暴露)</span></span><br><span class="line"></span><br><span class="line">contextBridge.<span class="title function_">exposeInMainWorld</span>(<span class="string">&#x27;electron&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">ipcRenderer</span>: &#123;</span><br><span class="line">    <span class="comment">// Dockview 外部化功能所需的 IPC</span></span><br><span class="line">    <span class="attr">send</span>: <span class="function">(<span class="params"><span class="attr">channel</span>: <span class="built_in">string</span>, ...<span class="attr">args</span>: <span class="built_in">any</span>[]</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> validChannels = [</span><br><span class="line">          <span class="string">&#x27;create-external-panel-window&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;external-panel-message&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;dispose-external-panel-window&#x27;</span></span><br><span class="line">      ];</span><br><span class="line">      <span class="keyword">if</span> (validChannels.<span class="title function_">includes</span>(channel)) &#123;</span><br><span class="line">        ipcRenderer.<span class="title function_">send</span>(channel, ...args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">on</span>: <span class="function">(<span class="params"><span class="attr">channel</span>: <span class="built_in">string</span>, <span class="attr">func</span>: (...args: <span class="built_in">any</span>[]) =&gt; <span class="built_in">void</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> validChannels = [</span><br><span class="line">          <span class="string">&#x27;dockview-message&#x27;</span>, <span class="comment">// 接收来自主进程的消息</span></span><br><span class="line">          <span class="string">&#x27;external-panel-closed&#x27;</span></span><br><span class="line">      ];</span><br><span class="line">      <span class="keyword">if</span> (validChannels.<span class="title function_">includes</span>(channel)) &#123;</span><br><span class="line">        <span class="comment">// ... (省略了类型检查和 IPC 监听的实现细节)</span></span><br><span class="line">        ipcRenderer.<span class="title function_">on</span>(channel, <span class="function">(<span class="params">_event, ...args</span>) =&gt;</span> <span class="title function_">func</span>(...args));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// ... 其他必要的 IPC 方法</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="3"><li>🖼️ 渲染进程 (Renderer Process) - Dockview 组件修改<br>你需要修改 DockviewContainer.vue，实现 createExternalWindow 钩子。</li></ol><p>代码段</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&quot;containerRef&quot;</span> <span class="attr">:class</span>=<span class="string">&quot;&#123; &#x27;dockview-external-host&#x27;: isExternal &#125;&quot;</span> <span class="attr">style</span>=<span class="string">&quot;height: 100vh; width: 100vw;&quot;</span>/&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span> <span class="attr">lang</span>=<span class="string">&quot;ts&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">import &#123; ref, onMounted, shallowRef &#125; from &#x27;vue&#x27;;</span></span><br><span class="line"><span class="language-xml">import &#123; createApp, type App &#125; from &#x27;vue&#x27;;</span></span><br><span class="line"><span class="language-xml">import &#123; DockviewComponent, IDockviewPanel, DockviewExternalWindow &#125; from &#x27;dockview&#x27;;</span></span><br><span class="line"><span class="language-xml">import PanelContent from &#x27;./PanelContent.vue&#x27;;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">// --- 检查是否为外部窗口 ---</span></span><br><span class="line"><span class="language-xml">// 简单方法：检查 URL 是否有 `?external=true` 查询参数</span></span><br><span class="line"><span class="language-xml">const isExternal = window.location.search.includes(&#x27;external=true&#x27;);</span></span><br><span class="line"><span class="language-xml">const urlParams = new URLSearchParams(window.location.search);</span></span><br><span class="line"><span class="language-xml">const groupId = urlParams.get(&#x27;groupId&#x27;) || &#x27;&#x27;;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">// ... (省略 PanelContent 挂载和 vueApps Map 的代码，见上一个回答)</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">// --- Dockview 外部化配置 ---</span></span><br><span class="line"><span class="language-xml">const createExternalWindow = (event: &#123;</span></span><br><span class="line"><span class="language-xml">    groupId: string;</span></span><br><span class="line"><span class="language-xml">    bounds: &#123; x: number; y: number; width: number; height: number &#125;;</span></span><br><span class="line"><span class="language-xml">&#125;): DockviewExternalWindow =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">    </span></span><br><span class="line"><span class="language-xml">    // 1. 通知主进程创建新窗口</span></span><br><span class="line"><span class="language-xml">    window.electron.ipcRenderer.send(&#x27;create-external-panel-window&#x27;, &#123;</span></span><br><span class="line"><span class="language-xml">        groupId: event.groupId,</span></span><br><span class="line"><span class="language-xml">        initialBounds: event.bounds,</span></span><br><span class="line"><span class="language-xml">        // 传递当前 URL，让新窗口知道加载什么</span></span><br><span class="line"><span class="language-xml">        url: window.location.href.split(&#x27;?&#x27;)[0] </span></span><br><span class="line"><span class="language-xml">    &#125;);</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    // 2. 返回 Dockview 需要的 PostMessage 接口</span></span><br><span class="line"><span class="language-xml">    return &#123;</span></span><br><span class="line"><span class="language-xml">        // 用于向新窗口发送数据 (由 Dockview 内部调用)</span></span><br><span class="line"><span class="language-xml">        postMessage: (message) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">            window.electron.ipcRenderer.send(&#x27;external-panel-message&#x27;, event.groupId, message);</span></span><br><span class="line"><span class="language-xml">        &#125;,</span></span><br><span class="line"><span class="language-xml">        // 当浮动面板关闭或被重新拖回主窗口时调用</span></span><br><span class="line"><span class="language-xml">        dispose: () =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">            window.electron.ipcRenderer.send(&#x27;dispose-external-panel-window&#x27;, event.groupId);</span></span><br><span class="line"><span class="language-xml">        &#125;</span></span><br><span class="line"><span class="language-xml">    &#125;;</span></span><br><span class="line"><span class="language-xml">&#125;;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">// --- Dockview 实例化 ---</span></span><br><span class="line"><span class="language-xml">onMounted(() =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">  if (!containerRef.value) return;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  const dockview = new DockviewComponent(&#123;</span></span><br><span class="line"><span class="language-xml">    parentElement: containerRef.value,</span></span><br><span class="line"><span class="language-xml">    createComponent: createVueComponent,</span></span><br><span class="line"><span class="language-xml">    </span></span><br><span class="line"><span class="language-xml">    // 启用外部拖拽</span></span><br><span class="line"><span class="language-xml">    allowExternalDrag: true, </span></span><br><span class="line"><span class="language-xml">    </span></span><br><span class="line"><span class="language-xml">    // 实现创建外部窗口的钩子</span></span><br><span class="line"><span class="language-xml">    createExternalWindow: createExternalWindow, </span></span><br><span class="line"><span class="language-xml">    </span></span><br><span class="line"><span class="language-xml">    // 如果是外部窗口，需要传入 groupdId 来恢复布局</span></span><br><span class="line"><span class="language-xml">    is\&#x27;external\&#x27; = isExternal,</span></span><br><span class="line"><span class="language-xml">    externalGroupId: groupId || undefined</span></span><br><span class="line"><span class="language-xml">  &#125;);</span></span><br><span class="line"><span class="language-xml">  dockviewRef.value = dockview;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  // --- 外部窗口的特殊处理 ---</span></span><br><span class="line"><span class="language-xml">  if (isExternal) &#123;</span></span><br><span class="line"><span class="language-xml">    // 1. 监听来自主窗口的消息，并转发给 Dockview 实例</span></span><br><span class="line"><span class="language-xml">    window.electron.ipcRenderer.on(&#x27;dockview-message&#x27;, (message) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">        dockview.processExternalWindowMessage(message);</span></span><br><span class="line"><span class="language-xml">    &#125;);</span></span><br><span class="line"><span class="language-xml">  &#125; else &#123;</span></span><br><span class="line"><span class="language-xml">    // 2. 主窗口初始化布局</span></span><br><span class="line"><span class="language-xml">    dockview.addPanel(&#123; id: &#x27;panel-1&#x27;, component: &#x27;vue-panel&#x27;, title: &#x27;主窗口面板 1&#x27; &#125;);</span></span><br><span class="line"><span class="language-xml">    dockview.addPanel(&#123; id: &#x27;panel-2&#x27;, component: &#x27;vue-panel&#x27;, title: &#x27;主窗口面板 2&#x27; &#125;);</span></span><br><span class="line"><span class="language-xml">    </span></span><br><span class="line"><span class="language-xml">    // 3. 监听外部窗口关闭事件</span></span><br><span class="line"><span class="language-xml">    window.electron.ipcRenderer.on(&#x27;external-panel-closed&#x27;, (closedGroupId) =&gt; &#123;</span></span><br><span class="line"><span class="language-xml">        // 通知 Dockview 外部组已关闭，以便它可以清理内部状态</span></span><br><span class="line"><span class="language-xml">        dockview.removeExternalComponent(closedGroupId);</span></span><br><span class="line"><span class="language-xml">    &#125;);</span></span><br><span class="line"><span class="language-xml">  &#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">  // ... (省略 resize 监听代码)</span></span><br><span class="line"><span class="language-xml">&#125;);</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="comment">/* 可选：为外部窗口提供一个不同的背景或边框 */</span></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="selector-class">.dockview-external-host</span> &#123;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">    <span class="comment">/* 外部窗口通常不需要边框 */</span></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>🔑 总结和操作步骤<br>设置 IPC (Preload &amp; Main): 在主进程中配置 ipcMain 来创建 BrowserWindow，并在 Preload 中通过 contextBridge 安全暴露 ipcRenderer 的 send 和 on 方法。</p><p>实现 createExternalWindow: 在 DockviewContainer.vue 中，实现 createExternalWindow 钩子，它向主进程发送创建新窗口的请求，并返回 Dockview 所需的 postMessage 接口。</p><p>处理外部窗口初始化:</p><p>检查 URL 中的查询参数 (?external&#x3D;true) 来判断当前窗口是主窗口还是浮动面板窗口。</p><p>如果是浮动面板窗口，在实例化 DockviewComponent 时传入 isExternal: true 和 externalGroupId，并监听主窗口发来的 dockview-message。</p><p>操作步骤：</p><p>运行你的 Electron-Vite 应用。</p><p>点击一个面板的标题栏。</p><p>将标题栏拖出主窗口的边界。</p><p>释放鼠标，一个新的、独立的 Electron 窗口就会弹出，其中包含你拖出的面板</p>]]></content>
      
      
      <categories>
          
          <category> electron </category>
          
      </categories>
      
      
        <tags>
            
            <tag> electron </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vite注意事项</title>
      <link href="/2025/12/07/tools/vite%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E6%A0%B7%E5%BC%8F%E5%86%B2%E7%AA%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
      <url>/2025/12/07/tools/vite%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BA%93%E6%A0%B7%E5%BC%8F%E5%86%B2%E7%AA%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</url>
      
        <content type="html"><![CDATA[<h1 id="vite本地开发第三方库样式冲突解决方案"><a href="#vite本地开发第三方库样式冲突解决方案" class="headerlink" title="vite本地开发第三方库样式冲突解决方案"></a>vite本地开发第三方库样式冲突解决方案</h1><h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>在使用vite开发vue项目时，<br>同时使用了 elementui-plus和 element-plus-x,<br>然后 在开发环境 里面有一些 element-plus-x 的特殊样式会污染elementui-plus的原有样式。</p><span id="more"></span><p>比如 ThoughtChain  这个思维链的组件 用了 el-collapse ，然后修改了他的样式的高度 height<br>elementui-plus的原样式</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.el-collapse-item__header</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">min-height</span>: <span class="built_in">var</span>(--el-collapse-header-height);</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="built_in">var</span>(--el-collapse-header-height);</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">var</span>(--el-collapse-header-bg-color);</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--el-collapse-header-text-color);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--el-collapse-border-color);</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="built_in">var</span>(--el-collapse-header-font-size);</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">    <span class="attribute">transition</span>: border-bottom-color <span class="built_in">var</span>(--el-transition-duration);</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改后 多了一个固定高度</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#elx_wrapper</span> <span class="selector-class">.el-collapse-item__header</span> &#123;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="built_in">var</span>(--el-collapse-header-bg-color);</span><br><span class="line">    <span class="attribute">border</span>: none;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--el-collapse-border-color);</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--el-collapse-header-text-color);</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="built_in">var</span>(--el-collapse-header-font-size);</span><br><span class="line">    <span class="attribute">font-weight</span>: <span class="number">500</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="built_in">var</span>(--el-collapse-header-height); //这一行 上面是没有的。</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="built_in">var</span>(--el-collapse-header-height);</span><br><span class="line">    <span class="attribute">outline</span>: none;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">transition</span>: border-bottom-color <span class="built_in">var</span>(--el-transition-duration);</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上面只是个比喻</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>也是考虑了好几种方案。但是都感觉对已有项目的改动太大。</p><ul><li>方案一：<br>用element-plus的 el-config-provider 包裹，然后修改namespace为ep。全局修改element-plus的样式浅醉</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;el-config-provider namespace=<span class="string">&quot;ep&quot;</span>&gt;</span><br><span class="line">    &lt;!-- ... --&gt;</span><br><span class="line">  &lt;/el-config-provider&gt;</span><br><span class="line"></span><br><span class="line">  写一个 css styles/element/index.<span class="property">scss</span>：</span><br><span class="line">  @forward <span class="string">&#x27;element-plus/theme-chalk/src/mixins/config.scss&#x27;</span> <span class="title function_">with</span> (</span><br><span class="line">  <span class="attr">$namespace</span>: <span class="string">&#x27;ep&#x27;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">在 vite.<span class="property">config</span>.<span class="property">ts</span> 中导入 styles/element/index.<span class="property">scss</span>：</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="comment">// https://vitejs.dev/config/</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">css</span>: &#123;</span><br><span class="line">    <span class="attr">preprocessorOptions</span>: &#123;</span><br><span class="line">      <span class="attr">scss</span>: &#123;</span><br><span class="line">        <span class="attr">additionalData</span>: <span class="string">`@use &quot;~/styles/element/index.scss&quot; as *;`</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ul><li>方案二： 使用posscss插件</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">在vite.<span class="property">config</span>.<span class="property">ts</span>中配置</span><br><span class="line"><span class="keyword">import</span> prefixSelector <span class="keyword">from</span> <span class="string">&#x27;postcss-prefix-selector&#x27;</span></span><br><span class="line"><span class="attr">css</span>: &#123;</span><br><span class="line">      <span class="attr">preprocessorOptions</span>: &#123;</span><br><span class="line">        <span class="comment">// 定义全局 SCSS 变量</span></span><br><span class="line">        <span class="attr">scss</span>: &#123;</span><br><span class="line">          <span class="attr">additionalData</span>: <span class="string">`@use &quot;@/styles/variables.scss&quot; as *;`</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">postcss</span>: &#123;</span><br><span class="line">      <span class="attr">plugins</span>: [</span><br><span class="line">        <span class="title function_">prefixSelector</span>(&#123;</span><br><span class="line">          <span class="comment">// 只有当处理 element-plus-x 的样式文件时才生效</span></span><br><span class="line">          <span class="comment">// 注意：你需要确认该库样式文件的具体路径特征</span></span><br><span class="line">          <span class="attr">includeFiles</span>: [<span class="regexp">/element-plus-x/</span>, <span class="regexp">/node_modules\/element-plus-x/</span>], </span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 忽略 html 和 body 标签，避免破坏全局基础样式</span></span><br><span class="line">          <span class="attr">exclude</span>: [<span class="string">&#x27;html&#x27;</span>, <span class="string">&#x27;body&#x27;</span>, <span class="string">&#x27;:root&#x27;</span>],</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 核心：将所有样式限制在这个 ID 下</span></span><br><span class="line">          <span class="attr">prefix</span>: <span class="string">&#x27;#elx_wrapper&#x27;</span>, </span><br><span class="line">          </span><br><span class="line">          <span class="title function_">transform</span>(<span class="params">prefix: string, selector: string, prefixedSelector: string, filePath: string</span>) &#123;</span><br><span class="line">            <span class="comment">// 对于 :root 下的变量定义，可能需要特殊处理以免丢失</span></span><br><span class="line">            <span class="keyword">if</span> (selector === <span class="string">&#x27;:root&#x27;</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="string">&#x27;:root #elx_wrapper&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> prefixedSelector</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vite </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nuxt相关问题</title>
      <link href="/2025/12/07/%E5%89%8D%E7%AB%AF/vue/nuxt%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/"/>
      <url>/2025/12/07/%E5%89%8D%E7%AB%AF/vue/nuxt%E7%9B%B8%E5%85%B3%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h2 id="1-nuxt项目能解决什么问题"><a href="#1-nuxt项目能解决什么问题" class="headerlink" title="1. nuxt项目能解决什么问题"></a>1. nuxt项目能解决什么问题</h2><p>assets&#x2F;: 用于存储未编译的资源，如图像、字体和样式表。</p><p>components&#x2F;: 用于存储 Vue 组件，Nuxt 会自动导入。</p><p>composables&#x2F;: 存放可复用的 Composition API 函数（组合式函数）。</p><p>layouts&#x2F;: 定义应用程序的布局结构（如页眉、页脚）。</p><p>pages&#x2F;: 最重要的目录，用于定义应用程序的路由和视图。</p><p>plugins&#x2F;: 用于在 Nuxt 应用程序启动前运行的 JavaScript 插件。</p><p>server&#x2F;: 存放 Nitro 引擎 的服务端路由和 API 接口。</p>]]></content>
      
      
      <categories>
          
          <category> vue3 </category>
          
          <category> nuxt </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue3 </tag>
            
            <tag> nuxt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vite注意事项</title>
      <link href="/2025/03/01/tools/vite/"/>
      <url>/2025/03/01/tools/vite/</url>
      
        <content type="html"><![CDATA[<h2 id="Vite-是如何实现快速开发的？它的原理是什么？"><a href="#Vite-是如何实现快速开发的？它的原理是什么？" class="headerlink" title="Vite 是如何实现快速开发的？它的原理是什么？"></a>Vite 是如何实现快速开发的？它的原理是什么？</h2><p>Vite的快速开发体验是通过以下原理实现的：</p><p>使用原生ES模块化，无需预打包。<br>利用服务端渲染（SSR）将源代码转换为浏览器可识别的模块。<br>在开发模式下，按需编译和提供模块，实现快速的冷启动和热模块替换（HMR）。</p><span id="more"></span>]]></content>
      
      
      <categories>
          
          <category> vite </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack打包工具注意事项</title>
      <link href="/2025/03/01/tools/webpack/"/>
      <url>/2025/03/01/tools/webpack/</url>
      
        <content type="html"><![CDATA[<h2 id="Webpack-的四个核心概念是什么？"><a href="#Webpack-的四个核心概念是什么？" class="headerlink" title="Webpack 的四个核心概念是什么？"></a>Webpack 的四个核心概念是什么？</h2><p>列举并简述 Webpack 的四大核心配置项。<br>概念描述<br>entry入口文件，指定 Webpack 开始构建的位置<br>output输出路径与文件名配置<br>loader处理非 JS 文件（如 CSS、图片、TypeScript）<br>plugin扩展 Webpack 功能（如压缩、优化、注入变量）</p><span id="more"></span><h2 id="如何配置多个入口（entry）？"><a href="#如何配置多个入口（entry）？" class="headerlink" title="如何配置多个入口（entry）？"></a>如何配置多个入口（entry）？</h2><p>配置 Webpack 同时打包两个独立页面（如 index 和 about 页面）。</p><h2 id="如何配置环境变量？"><a href="#如何配置环境变量？" class="headerlink" title="如何配置环境变量？"></a>如何配置环境变量？</h2><p> 在不同环境中注入不同的 API 地址。<br> 使用 DefinePlugin 定义全局变量。</p><h2 id="什么是-Tree-Shaking？如何启用？"><a href="#什么是-Tree-Shaking？如何启用？" class="headerlink" title="什么是 Tree Shaking？如何启用？"></a>什么是 Tree Shaking？如何启用？</h2><p> 只打包实际使用的代码，减少体积。<br> Tree Shaking 是通过 ES Module 静态分析删除未使用代码的技术。</p> <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">usedExports</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">minimize</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sideEffects&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="如何优化打包体积？"><a href="#如何优化打包体积？" class="headerlink" title="如何优化打包体积？"></a>如何优化打包体积？</h2><p>减少最终打包文件大小的方法有哪些？</p><p>使用 TerserPlugin 压缩 JS。<br>使用 MiniCssExtractPlugin 提取 CSS。<br>使用 SplitChunksPlugin 分包。<br>移除无用代码（Tree Shaking）。<br>使用 externals 排除第三方库（如 React）。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="attr">optimization</span>: &#123;</span><br><span class="line">  <span class="attr">minimize</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">minimizer</span>: [<span class="keyword">new</span> <span class="title class_">TerserPlugin</span>()],</span><br><span class="line">  <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">    <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="如何配置-Webpack-构建多页应用（MPA）？"><a href="#如何配置-Webpack-构建多页应用（MPA）？" class="headerlink" title="如何配置 Webpack 构建多页应用（MPA）？"></a>如何配置 Webpack 构建多页应用（MPA）？</h2><p>同时打包多个 HTML 页面，每个页面对应一个入口文件。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: &#123;</span><br><span class="line">    <span class="attr">home</span>: <span class="string">&#x27;./src/home.js&#x27;</span>,</span><br><span class="line">    <span class="attr">about</span>: <span class="string">&#x27;./src/about.js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;[name].bundle.js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123; <span class="attr">filename</span>: <span class="string">&#x27;home.html&#x27;</span>, <span class="attr">template</span>: <span class="string">&#x27;./src/home.html&#x27;</span>, <span class="attr">chunks</span>: [<span class="string">&#x27;home&#x27;</span>] &#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123; <span class="attr">filename</span>: <span class="string">&#x27;about.html&#x27;</span>, <span class="attr">template</span>: <span class="string">&#x27;./src/about.html&#x27;</span>, <span class="attr">chunks</span>: [<span class="string">&#x27;about&#x27;</span>] &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> webpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> webpack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cocos小游戏开发</title>
      <link href="/2025/01/01/%E5%89%8D%E7%AB%AF/%E5%85%B6%E4%BB%96/cocos%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/"/>
      <url>/2025/01/01/%E5%89%8D%E7%AB%AF/%E5%85%B6%E4%BB%96/cocos%E5%BC%80%E5%8F%91%E7%9B%B8%E5%85%B3/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> cocos </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cocos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue2组件库开发</title>
      <link href="/2024/06/01/%E5%89%8D%E7%AB%AF/vue/vue2%E7%BB%84%E4%BB%B6%E5%BA%93/"/>
      <url>/2024/06/01/%E5%89%8D%E7%AB%AF/vue/vue2%E7%BB%84%E4%BB%B6%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<p>Vue2组件库开发</p>]]></content>
      
      
      <categories>
          
          <category> vue2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue3重点</title>
      <link href="/2024/05/01/%E5%89%8D%E7%AB%AF/vue/vue3%E9%9D%A2%E8%AF%95/"/>
      <url>/2024/05/01/%E5%89%8D%E7%AB%AF/vue/vue3%E9%9D%A2%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h1 id="Vue-3-面试题集"><a href="#Vue-3-面试题集" class="headerlink" title="Vue 3 面试题集"></a>Vue 3 面试题集</h1><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><h3 id="1-Vue-3-相比-Vue-2-有哪些重大变化？"><a href="#1-Vue-3-相比-Vue-2-有哪些重大变化？" class="headerlink" title="1. Vue 3 相比 Vue 2 有哪些重大变化？"></a>1. Vue 3 相比 Vue 2 有哪些重大变化？</h3><p><strong>答案</strong>：</p><ul><li><strong>性能提升</strong>：Vue 3 重写了虚拟 DOM 实现，渲染性能提升约 1.3~2 倍，内存占用减少约 50%</li><li><strong>Composition API</strong>：新增组合式 API，提供更灵活的逻辑组织和复用方式</li><li><strong>TypeScript 支持</strong>：Vue 3 是用 TypeScript 重写的，提供了更好的类型推断</li><li><strong>Teleport 组件</strong>：允许将组件的内容传送到 DOM 的其他位置</li><li><strong>Fragments</strong>：组件可以有多个根节点</li><li><strong>Suspense</strong>：处理异步组件的新特性</li><li><strong>响应式系统升级</strong>：使用 ES6 的 Proxy 代替 Object.defineProperty，解决了 Vue 2 中的数组和对象响应式问题</li><li><strong>全局 API 改为应用实例调用</strong>：减少了全局污染</li><li><strong>更好的 Tree-shaking 支持</strong>：减小打包体积</li></ul><span id="more"></span><h3 id="2-什么是-Composition-API？它解决了什么问题？"><a href="#2-什么是-Composition-API？它解决了什么问题？" class="headerlink" title="2. 什么是 Composition API？它解决了什么问题？"></a>2. 什么是 Composition API？它解决了什么问题？</h3><p><strong>答案</strong>：<br>Composition API 是 Vue 3 引入的一种新的组件逻辑组织方式，它允许我们按照功能&#x2F;关注点组织代码，而不是按照选项（data、methods、computed 等）。</p><p><strong>解决的问题</strong>：</p><ul><li><strong>逻辑复用</strong>：相比于 Vue 2 的 mixins，Composition API 提供了更清晰、更灵活的逻辑复用方式</li><li><strong>更好的类型推断</strong>：对 TypeScript 的支持更好</li><li><strong>代码组织</strong>：相关功能的代码可以放在一起，而不是分散在不同的选项中</li><li><strong>避免命名冲突</strong>：不同功能模块可以在各自的作用域中定义变量，避免了 mixins 中的命名冲突问题</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vue 2 的 Options API</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">user</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">age</span>: <span class="number">0</span> &#125;,</span><br><span class="line">      <span class="attr">posts</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">fetchUserData</span>(<span class="params"></span>) &#123; <span class="comment">/* ... */</span> &#125;,</span><br><span class="line">    <span class="title function_">fetchUserPosts</span>(<span class="params"></span>) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">computed</span>: &#123;</span><br><span class="line">    <span class="title function_">userFullName</span>(<span class="params"></span>) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue 3 的 Composition API</span></span><br><span class="line"><span class="keyword">import</span> &#123; ref, computed, onMounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 用户相关逻辑</span></span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">ref</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>, <span class="attr">age</span>: <span class="number">0</span> &#125;)</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">fetchUserData</span> = (<span class="params"></span>) =&gt; &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">    <span class="keyword">const</span> userFullName = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123; <span class="comment">/* ... */</span> &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 文章相关逻辑</span></span><br><span class="line">    <span class="keyword">const</span> posts = <span class="title function_">ref</span>([])</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">fetchUserPosts</span> = (<span class="params"></span>) =&gt; &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">fetchUserData</span>()</span><br><span class="line">      <span class="title function_">fetchUserPosts</span>()</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      user,</span><br><span class="line">      posts,</span><br><span class="line">      userFullName,</span><br><span class="line">      fetchUserData,</span><br><span class="line">      fetchUserPosts</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-ref-和-reactive-有什么区别？什么情况下使用它们？"><a href="#3-ref-和-reactive-有什么区别？什么情况下使用它们？" class="headerlink" title="3. ref 和 reactive 有什么区别？什么情况下使用它们？"></a>3. ref 和 reactive 有什么区别？什么情况下使用它们？</h3><p><strong>答案</strong>：<br>ref 和 reactive 都是用于创建响应式数据的 API，但它们有以下区别：</p><p><strong>ref</strong>：</p><ul><li>可以包装任何类型的值（基本类型和对象类型）</li><li>创建一个包含 <code>.value</code> 属性的响应式对象</li><li>在模板中使用时会自动解包（不需要 <code>.value</code>）</li><li>适合处理基本类型值（如字符串、数字、布尔值）</li></ul><p><strong>reactive</strong>：</p><ul><li>只能用于对象类型（包括数组和普通对象）</li><li>直接返回原始对象的响应式代理</li><li>不能用于基本类型值</li><li>不能被重新赋值（会破坏响应性）</li></ul><p><strong>使用场景</strong>：</p><ul><li>对于基本类型值（如 string、number、boolean），必须使用 ref</li><li>对于复杂对象，可以使用 reactive 或 ref</li><li>如果需要整体替换一个响应式对象，应该使用 ref</li><li>如果只需要修改对象的属性，可以使用 reactive</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 ref</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(count.<span class="property">value</span>) <span class="comment">// 0</span></span><br><span class="line">count.<span class="property">value</span>++</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(count.<span class="property">value</span>) <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 reactive</span></span><br><span class="line"><span class="keyword">const</span> state = <span class="title function_">reactive</span>(&#123; <span class="attr">count</span>: <span class="number">0</span> &#125;)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(state.<span class="property">count</span>) <span class="comment">// 0</span></span><br><span class="line">state.<span class="property">count</span>++</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(state.<span class="property">count</span>) <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ref 可以包装对象</span></span><br><span class="line"><span class="keyword">const</span> user = <span class="title function_">ref</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;)</span><br><span class="line">user.<span class="property">value</span>.<span class="property">age</span>++</span><br><span class="line"><span class="comment">// 或者整体替换</span></span><br><span class="line">user.<span class="property">value</span> = &#123; <span class="attr">name</span>: <span class="string">&#x27;Jane&#x27;</span>, <span class="attr">age</span>: <span class="number">25</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reactive 不能重新赋值</span></span><br><span class="line"><span class="keyword">const</span> user2 = <span class="title function_">reactive</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;)</span><br><span class="line">user2.<span class="property">age</span>++</span><br><span class="line"><span class="comment">// 下面这样会破坏响应性</span></span><br><span class="line"><span class="comment">// user2 = &#123; name: &#x27;Jane&#x27;, age: 25 &#125; // 错误用法</span></span><br></pre></td></tr></table></figure><h3 id="4-Vue-3-中的生命周期钩子有哪些变化？"><a href="#4-Vue-3-中的生命周期钩子有哪些变化？" class="headerlink" title="4. Vue 3 中的生命周期钩子有哪些变化？"></a>4. Vue 3 中的生命周期钩子有哪些变化？</h3><p><strong>答案</strong>：<br>Vue 3 中的生命周期钩子与 Vue 2 相比有以下变化：</p><ol><li><p><strong>命名变化</strong>：</p><ul><li><code>beforeCreate</code> 和 <code>created</code> 被 <code>setup()</code> 函数本身替代</li><li>其他钩子前缀改为 <code>on</code>，如 <code>mounted</code> 变为 <code>onMounted</code></li></ul></li><li><p><strong>使用方式</strong>：在 Composition API 中，生命周期钩子作为函数导入并在 <code>setup()</code> 中调用</p></li><li><p><strong>新增钩子</strong>：</p><ul><li><code>onRenderTracked</code>：当组件渲染过程中追踪到响应式依赖时调用</li><li><code>onRenderTriggered</code>：当响应式依赖触发组件重新渲染时调用</li></ul></li><li><p><strong>移除钩子</strong>：</p><ul><li><code>beforeDestroy</code> 改名为 <code>beforeUnmount</code></li><li><code>destroyed</code> 改名为 <code>unmounted</code></li></ul></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; </span><br><span class="line">  onBeforeMount, </span><br><span class="line">  onMounted, </span><br><span class="line">  onBeforeUpdate, </span><br><span class="line">  onUpdated, </span><br><span class="line">  onBeforeUnmount, </span><br><span class="line">  onUnmounted,</span><br><span class="line">  onActivated,</span><br><span class="line">  onDeactivated,</span><br><span class="line">  onErrorCaptured</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title function_">onBeforeMount</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;组件挂载前&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;组件挂载完成&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 其他生命周期钩子...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-什么是-Teleport？它解决了什么问题？"><a href="#5-什么是-Teleport？它解决了什么问题？" class="headerlink" title="5. 什么是 Teleport？它解决了什么问题？"></a>5. 什么是 Teleport？它解决了什么问题？</h3><p><strong>答案</strong>：<br>Teleport 是 Vue 3 新增的一个内置组件，它可以将组件的一部分 DOM 传送到组件 DOM 树之外的位置。</p><p><strong>解决的问题</strong>：</p><ul><li>解决了模态框、弹出菜单、通知等需要打破组件层次结构的 UI 元素的定位问题</li><li>避免了 CSS 样式（如 z-index、overflow、position）带来的限制</li><li>保持了组件的逻辑封装，同时允许 DOM 结构的灵活布局</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showModal = true&quot;</span>&gt;</span>打开模态框<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 使用 Teleport 将模态框传送到 body 下 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">teleport</span> <span class="attr">to</span>=<span class="string">&quot;body&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">&quot;showModal&quot;</span> <span class="attr">class</span>=<span class="string">&quot;modal&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>模态框标题<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>模态框内容...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;showModal = false&quot;</span>&gt;</span>关闭<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">teleport</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> showModal = <span class="title function_">ref</span>(<span class="literal">false</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> &#123; showModal &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="响应式系统"><a href="#响应式系统" class="headerlink" title="响应式系统"></a>响应式系统</h2><h3 id="6-Vue-3-的响应式系统是如何工作的？"><a href="#6-Vue-3-的响应式系统是如何工作的？" class="headerlink" title="6. Vue 3 的响应式系统是如何工作的？"></a>6. Vue 3 的响应式系统是如何工作的？</h3><p><strong>答案</strong>：<br>Vue 3 的响应式系统基于 ES6 的 Proxy 实现，主要工作流程如下：</p><ol><li><strong>创建响应式对象</strong>：通过 <code>reactive()</code> 或 <code>ref()</code> 创建响应式对象</li><li><strong>代理拦截</strong>：使用 Proxy 拦截对象的属性访问、修改等操作</li><li><strong>依赖追踪</strong>：当组件渲染或计算属性计算时，会访问响应式对象的属性，此时系统会记录这些依赖关系</li><li><strong>变更通知</strong>：当响应式对象的属性被修改时，Proxy 的 set 处理器会被触发，然后通知所有依赖于该属性的副作用（如组件重新渲染）</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简化版的响应式系统实现原理</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">      <span class="comment">// 追踪依赖</span></span><br><span class="line">      <span class="title function_">track</span>(target, key)</span><br><span class="line">      <span class="keyword">const</span> value = <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver)</span><br><span class="line">      <span class="comment">// 如果值是对象，则递归使其响应式</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">&#x27;object&#x27;</span> ? <span class="title function_">reactive</span>(value) : value</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> oldValue = target[key]</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver)</span><br><span class="line">      <span class="keyword">if</span> (oldValue !== value) &#123;</span><br><span class="line">        <span class="comment">// 触发更新</span></span><br><span class="line">        <span class="title function_">trigger</span>(target, key)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-Vue-3-中如何实现计算属性？"><a href="#7-Vue-3-中如何实现计算属性？" class="headerlink" title="7. Vue 3 中如何实现计算属性？"></a>7. Vue 3 中如何实现计算属性？</h3><p><strong>答案</strong>：<br>Vue 3 中使用 <code>computed()</code> 函数来创建计算属性：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, computed &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstName = <span class="title function_">ref</span>(<span class="string">&#x27;John&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> lastName = <span class="title function_">ref</span>(<span class="string">&#x27;Doe&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建只读计算属性</span></span><br><span class="line">    <span class="keyword">const</span> fullName = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;firstName.value&#125;</span> <span class="subst">$&#123;lastName.value&#125;</span>`</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建可写计算属性</span></span><br><span class="line">    <span class="keyword">const</span> fullName2 = <span class="title function_">computed</span>(&#123;</span><br><span class="line">      <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;firstName.value&#125;</span> <span class="subst">$&#123;lastName.value&#125;</span>`</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">set</span>(<span class="params">newValue</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> names = newValue.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        firstName.<span class="property">value</span> = names[<span class="number">0</span>]</span><br><span class="line">        lastName.<span class="property">value</span> = names[<span class="number">1</span>] || <span class="string">&#x27;&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      firstName,</span><br><span class="line">      lastName,</span><br><span class="line">      fullName,</span><br><span class="line">      fullName2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>计算属性具有以下特点：</p><ul><li>基于其响应式依赖进行缓存</li><li>只有当依赖项变化时才会重新计算</li><li>返回一个只读的响应式引用</li><li>可以通过提供 get 和 set 函数创建可写的计算属性</li></ul><h3 id="8-watchEffect-和-watch-有什么区别？"><a href="#8-watchEffect-和-watch-有什么区别？" class="headerlink" title="8. watchEffect 和 watch 有什么区别？"></a>8. watchEffect 和 watch 有什么区别？</h3><p><strong>答案</strong>：<br><code>watchEffect</code> 和 <code>watch</code> 都用于侦听响应式数据的变化并执行副作用，但它们有以下区别：</p><p><strong>watchEffect</strong>：</p><ul><li>立即执行一次回调函数，并自动追踪其中的响应式依赖</li><li>当任何依赖项变化时重新执行回调</li><li>不需要明确指定要侦听的数据源</li><li>无法获取被侦听状态的前一个值</li></ul><p><strong>watch</strong>：</p><ul><li>默认情况下，只有在侦听的源数据变化时才执行回调</li><li>需要明确指定要侦听的数据源</li><li>可以访问被侦听状态的当前值和前一个值</li><li>支持侦听多个数据源</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, watch, watchEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> name = <span class="title function_">ref</span>(<span class="string">&#x27;Vue&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// watchEffect 示例</span></span><br><span class="line">    <span class="title function_">watchEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Count is: <span class="subst">$&#123;count.value&#125;</span>, Name is: <span class="subst">$&#123;name.value&#125;</span>`</span>)</span><br><span class="line">      <span class="comment">// 自动追踪 count 和 name 的变化</span></span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// watch 示例 - 侦听单个数据源</span></span><br><span class="line">    <span class="title function_">watch</span>(count, <span class="function">(<span class="params">newValue, oldValue</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Count changed from <span class="subst">$&#123;oldValue&#125;</span> to <span class="subst">$&#123;newValue&#125;</span>`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// watch 示例 - 侦听多个数据源</span></span><br><span class="line">    <span class="title function_">watch</span>([count, name], <span class="function">(<span class="params">[newCount, newName], [oldCount, oldName]</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Count: <span class="subst">$&#123;oldCount&#125;</span> -&gt; <span class="subst">$&#123;newCount&#125;</span>, Name: <span class="subst">$&#123;oldName&#125;</span> -&gt; <span class="subst">$&#123;newName&#125;</span>`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// watch 示例 - 深度侦听</span></span><br><span class="line">    <span class="keyword">const</span> user = <span class="title function_">ref</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;)</span><br><span class="line">    <span class="title function_">watch</span>(user, <span class="function">(<span class="params">newUser, oldUser</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;User changed:&#x27;</span>, newUser, oldUser)</span><br><span class="line">    &#125;, &#123; <span class="attr">deep</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      count,</span><br><span class="line">      name,</span><br><span class="line">      user</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="组件通信"><a href="#组件通信" class="headerlink" title="组件通信"></a>组件通信</h2><h3 id="9-Vue-3-中组件之间有哪些通信方式？"><a href="#9-Vue-3-中组件之间有哪些通信方式？" class="headerlink" title="9. Vue 3 中组件之间有哪些通信方式？"></a>9. Vue 3 中组件之间有哪些通信方式？</h3><p><strong>答案</strong>：<br>Vue 3 中组件通信的主要方式包括：</p><ol><li><p><strong>Props 和 Events</strong>：</p><ul><li>父组件通过 props 向子组件传递数据</li><li>子组件通过 emits 向父组件发送事件</li></ul></li><li><p><strong>v-model</strong>：</p><ul><li>Vue 3 中的 v-model 可以使用自定义的 prop 和事件</li><li>可以在同一组件上使用多个 v-model</li></ul></li><li><p><strong>provide&#x2F;inject</strong>：</p><ul><li>适用于深层组件嵌套的场景</li><li>祖先组件通过 provide 提供数据，后代组件通过 inject 注入数据</li></ul></li><li><p><strong>Vuex&#x2F;Pinia</strong>：</p><ul><li>集中式状态管理</li><li>适用于复杂应用的全局状态管理</li></ul></li><li><p><strong>mitt&#x2F;tiny-emitter</strong>：</p><ul><li>事件总线，用于任意组件间通信</li><li>Vue 3 移除了 $on, $off 等事件 API，可以使用第三方库实现</li></ul></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Props 和 Events</span></span><br><span class="line"><span class="comment">// 子组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">message</span>: <span class="title class_">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">emits</span>: [<span class="string">&#x27;update&#x27;</span>],</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params">props, &#123; emit &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleClick</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;New message&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123; handleClick &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父组件</span></span><br><span class="line">&lt;child-component </span><br><span class="line">  :message=<span class="string">&quot;parentMessage&quot;</span> </span><br><span class="line">  @update=<span class="string">&quot;parentMessage = $event&quot;</span> </span><br><span class="line">/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// provide/inject</span></span><br><span class="line"><span class="comment">// 父组件</span></span><br><span class="line"><span class="keyword">import</span> &#123; provide, ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> theme = <span class="title function_">ref</span>(<span class="string">&#x27;light&#x27;</span>)</span><br><span class="line">    <span class="title function_">provide</span>(<span class="string">&#x27;theme&#x27;</span>, theme) <span class="comment">// 提供响应式数据</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123; theme &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 子组件或后代组件</span></span><br><span class="line"><span class="keyword">import</span> &#123; inject &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> theme = <span class="title function_">inject</span>(<span class="string">&#x27;theme&#x27;</span>) <span class="comment">// 注入数据</span></span><br><span class="line">    <span class="keyword">return</span> &#123; theme &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="10-Vue-3-中的-v-model-有什么变化？"><a href="#10-Vue-3-中的-v-model-有什么变化？" class="headerlink" title="10. Vue 3 中的 v-model 有什么变化？"></a>10. Vue 3 中的 v-model 有什么变化？</h3><p><strong>答案</strong>：<br>Vue 3 中的 v-model 相比 Vue 2 有以下变化：</p><ol><li><p><strong>默认 prop 和事件名称变化</strong>：</p><ul><li>Vue 2：prop 为 <code>value</code>，事件为 <code>input</code></li><li>Vue 3：prop 为 <code>modelValue</code>，事件为 <code>update:modelValue</code></li></ul></li><li><p><strong>支持多个 v-model</strong>：</p><ul><li>Vue 3 允许在同一组件上使用多个 v-model，每个绑定可以有不同的名称</li></ul></li><li><p><strong>移除 .sync 修饰符</strong>：</p><ul><li>Vue 3 中 v-model 可以替代 Vue 2 中的 .sync 修饰符</li></ul></li><li><p><strong>自定义 v-model 修饰符</strong>：</p><ul><li>Vue 3 支持自定义 v-model 修饰符</li></ul></li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 基本用法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">custom-input</span> <span class="attr">v-model</span>=<span class="string">&quot;searchText&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 等价于 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">custom-input</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:modelValue</span>=<span class="string">&quot;searchText&quot;</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">update:modelValue</span>=<span class="string">&quot;searchText = $event&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 多个 v-model --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user-form</span></span></span><br><span class="line"><span class="tag">  <span class="attr">v-model:name</span>=<span class="string">&quot;userName&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">v-model:age</span>=<span class="string">&quot;userAge&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 等价于 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user-form</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:name</span>=<span class="string">&quot;userName&quot;</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">update:name</span>=<span class="string">&quot;userName = $event&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:age</span>=<span class="string">&quot;userAge&quot;</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">update:age</span>=<span class="string">&quot;userAge = $event&quot;</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 带修饰符的 v-model --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">custom-input</span> <span class="attr">v-model.capitalize</span>=<span class="string">&quot;searchText&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>组件实现：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单个 v-model</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">modelValue</span>: <span class="title class_">String</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">emits</span>: [<span class="string">&#x27;update:modelValue&#x27;</span>],</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params">props, &#123; emit &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleInput</span> = (<span class="params">e</span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&#x27;update:modelValue&#x27;</span>, e.<span class="property">target</span>.<span class="property">value</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123; handleInput &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个 v-model</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="title class_">Number</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">emits</span>: [<span class="string">&#x27;update:name&#x27;</span>, <span class="string">&#x27;update:age&#x27;</span>],</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params">props, &#123; emit &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">updateName</span> = (<span class="params">name</span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&#x27;update:name&#x27;</span>, name)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">updateAge</span> = (<span class="params">age</span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&#x27;update:age&#x27;</span>, age)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123; updateName, updateAge &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义修饰符</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">modelValue</span>: <span class="title class_">String</span>,</span><br><span class="line">    <span class="attr">modelModifiers</span>: &#123;</span><br><span class="line">      <span class="attr">default</span>: <span class="function">() =&gt;</span> (&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">emits</span>: [<span class="string">&#x27;update:modelValue&#x27;</span>],</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params">props, &#123; emit &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleInput</span> = (<span class="params">e</span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">let</span> value = e.<span class="property">target</span>.<span class="property">value</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 应用修饰符</span></span><br><span class="line">      <span class="keyword">if</span> (props.<span class="property">modelModifiers</span>.<span class="property">capitalize</span>) &#123;</span><br><span class="line">        value = value.<span class="title function_">charAt</span>(<span class="number">0</span>).<span class="title function_">toUpperCase</span>() + value.<span class="title function_">slice</span>(<span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="title function_">emit</span>(<span class="string">&#x27;update:modelValue&#x27;</span>, value)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123; handleInput &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><h3 id="11-Vue-3-中如何优化性能？"><a href="#11-Vue-3-中如何优化性能？" class="headerlink" title="11. Vue 3 中如何优化性能？"></a>11. Vue 3 中如何优化性能？</h3><p><strong>答案</strong>：<br>Vue 3 中的性能优化方法包括：</p><ol><li><p><strong>使用 v-memo 减少不必要的重新渲染</strong>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-memo</span>=<span class="string">&quot;[item.id === selected]&quot;</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 只有当 item.id === selected 变化时才会重新渲染 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>使用 v-once 渲染静态内容</strong>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-once</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 只渲染一次，之后不再更新 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>使用 computed 缓存计算结果</strong>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> filteredItems = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> items.<span class="property">value</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">price</span> &gt; <span class="number">100</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 shallowRef 和 shallowReactive 减少深层响应</strong>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只有 state 的顶层属性是响应式的</span></span><br><span class="line"><span class="keyword">const</span> state = <span class="title function_">shallowReactive</span>(&#123;</span><br><span class="line">  <span class="attr">user</span>: &#123; <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>, <span class="attr">address</span>: &#123; <span class="attr">city</span>: <span class="string">&#x27;New York&#x27;</span> &#125; &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 defineAsyncComponent 异步加载组件</strong>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">AsyncComponent</span> = <span class="title function_">defineAsyncComponent</span>(<span class="function">() =&gt;</span> </span><br><span class="line">  <span class="keyword">import</span>(<span class="string">&#x27;./components/AsyncComponent.vue&#x27;</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 KeepAlive 缓存组件实例</strong>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;currentComponent&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>使用 Suspense 处理异步依赖</strong>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">suspense</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> #<span class="attr">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">async-component</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> #<span class="attr">fallback</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">loading-spinner</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">suspense</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>使用虚拟列表渲染大量数据</strong>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">virtual-list</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:items</span>=<span class="string">&quot;items&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">:item-height</span>=<span class="string">&quot;50&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">v-slot</span>=<span class="string">&quot;&#123; item &#125;&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123; item.name &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">virtual-list</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="12-Vue-3-中如何实现自定义指令？"><a href="#12-Vue-3-中如何实现自定义指令？" class="headerlink" title="12. Vue 3 中如何实现自定义指令？"></a>12. Vue 3 中如何实现自定义指令？</h3><p><strong>答案</strong>：<br>Vue 3 中自定义指令的实现方式与 Vue 2 有所不同，主要变化在于钩子函数的名称与组件生命周期保持一致：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局注册</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">directive</span>(<span class="string">&#x27;focus&#x27;</span>, &#123;</span><br><span class="line">  <span class="title function_">mounted</span>(<span class="params">el</span>) &#123;</span><br><span class="line">    el.<span class="title function_">focus</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 局部注册</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">directives</span>: &#123;</span><br><span class="line">    <span class="attr">focus</span>: &#123;</span><br><span class="line">      <span class="title function_">mounted</span>(<span class="params">el</span>) &#123;</span><br><span class="line">        el.<span class="title function_">focus</span>()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Vue 3 中自定义指令的钩子函数包括：</p><ul><li><code>created</code>：在绑定元素的 attribute 或事件监听器被应用之前调用</li><li><code>beforeMount</code>：在元素被插入到 DOM 之前调用</li><li><code>mounted</code>：在绑定元素的父组件被挂载后调用</li><li><code>beforeUpdate</code>：在包含组件的 VNode 更新之前调用</li><li><code>updated</code>：在包含组件的 VNode 及其子组件的 VNode 更新之后调用</li><li><code>beforeUnmount</code>：在绑定元素的父组件卸载之前调用</li><li><code>unmounted</code>：当指令与元素解除绑定且父组件已卸载时调用</li></ul><p>自定义指令的参数：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">directive</span>(<span class="string">&#x27;my-directive&#x27;</span>, <span class="function">(<span class="params">el, binding, vnode, prevVnode</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// binding 包含以下属性：</span></span><br><span class="line">  <span class="comment">// value：传递给指令的值</span></span><br><span class="line">  <span class="comment">// oldValue：之前的值，仅在 beforeUpdate 和 updated 中可用</span></span><br><span class="line">  <span class="comment">// arg：传递给指令的参数，如 v-my-directive:arg</span></span><br><span class="line">  <span class="comment">// modifiers：包含修饰符的对象，如 v-my-directive.foo.bar 中，modifiers 为 &#123; foo: true, bar: true &#125;</span></span><br><span class="line">  <span class="comment">// instance：使用该指令的组件实例</span></span><br><span class="line">  <span class="comment">// dir：指令定义对象</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="工程化与生态"><a href="#工程化与生态" class="headerlink" title="工程化与生态"></a>工程化与生态</h2><h3 id="13-Vue-3-中如何使用-TypeScript？"><a href="#13-Vue-3-中如何使用-TypeScript？" class="headerlink" title="13. Vue 3 中如何使用 TypeScript？"></a>13. Vue 3 中如何使用 TypeScript？</h3><p><strong>答案</strong>：<br>Vue 3 对 TypeScript 有很好的支持，主要使用方式包括：</p><ol><li><p><strong>使用 defineComponent 包装组件选项</strong>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">message</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">String</span>,</span><br><span class="line">      <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="title function_">data</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>在 setup 函数中使用类型注解</strong>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineComponent, ref, <span class="title class_">Ref</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">count</span>: <span class="title class_">Ref</span>&lt;<span class="built_in">number</span>&gt; = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">user</span>: <span class="title class_">Ref</span>&lt;<span class="title class_">User</span>&gt; = <span class="title function_">ref</span>(&#123; <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123; count, user &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 defineProps 和 defineEmits</strong>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=<span class="string">&quot;ts&quot;</span>&gt;</span><br><span class="line"><span class="comment">// 使用运行时声明</span></span><br><span class="line"><span class="keyword">const</span> props = defineProps&lt;&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">age</span>?: <span class="built_in">number</span>;</span><br><span class="line">&#125;&gt;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> emit = defineEmits&lt;&#123;</span><br><span class="line">  (<span class="attr">e</span>: <span class="string">&#x27;update&#x27;</span>, <span class="attr">id</span>: <span class="built_in">number</span>): <span class="built_in">void</span>;</span><br><span class="line">  (<span class="attr">e</span>: <span class="string">&#x27;delete&#x27;</span>): <span class="built_in">void</span>;</span><br><span class="line">&#125;&gt;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用默认值</span></span><br><span class="line"><span class="title function_">withDefaults</span>(defineProps&lt;&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">age</span>?: <span class="built_in">number</span>;</span><br><span class="line">&#125;&gt;(), &#123;</span><br><span class="line">  <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li><li><p><strong>为 ref 和 reactive 提供类型</strong>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; ref, reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 ref 提供类型</span></span><br><span class="line"><span class="keyword">const</span> user = ref&lt;<span class="title class_">User</span>&gt;(&#123; <span class="attr">name</span>: <span class="string">&#x27;John&#x27;</span>, <span class="attr">age</span>: <span class="number">30</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 reactive 提供类型</span></span><br><span class="line"><span class="keyword">const</span> state = reactive&lt;&#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="built_in">number</span>;</span><br><span class="line">  <span class="attr">users</span>: <span class="title class_">User</span>[];</span><br><span class="line">&#125;&gt;(&#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">users</span>: []</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 PropType 定义复杂 prop 类型</strong>：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineComponent, <span class="title class_">PropType</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">age</span>: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">user</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">Object</span> <span class="keyword">as</span> <span class="title class_">PropType</span>&lt;<span class="title class_">User</span>&gt;,</span><br><span class="line">      <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">callback</span>: &#123;</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">Function</span> <span class="keyword">as</span> <span class="title class_">PropType</span>&lt;<span class="function">(<span class="params"><span class="attr">id</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="built_in">void</span>&gt;,</span><br><span class="line">      <span class="attr">required</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li></ol><h3 id="14-Vue-3-中如何使用-Pinia-进行状态管理？"><a href="#14-Vue-3-中如何使用-Pinia-进行状态管理？" class="headerlink" title="14. Vue 3 中如何使用 Pinia 进行状态管理？"></a>14. Vue 3 中如何使用 Pinia 进行状态管理？</h3><p><strong>答案</strong>：<br>Pinia 是 Vue 官方推荐的状态管理库，用于替代 Vuex。使用方法如下：</p><ol><li><p><strong>安装 Pinia</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install pinia</span><br></pre></td></tr></table></figure></li><li><p><strong>创建 Pinia 实例并挂载到应用</strong>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createPinia &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App.vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">createApp</span>(<span class="title class_">App</span>)</span><br><span class="line"><span class="keyword">const</span> pinia = <span class="title function_">createPinia</span>()</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(pinia)</span><br><span class="line">app.<span class="title function_">mount</span>(<span class="string">&#x27;#app&#x27;</span>)</span><br></pre></td></tr></table></figure></li><li><p><strong>定义 Store</strong>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stores/counter.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一个参数是应用中 store 的唯一 ID</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;counter&#x27;</span>, &#123;</span><br><span class="line">  <span class="comment">// state</span></span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Eduardo&#x27;</span></span><br><span class="line">  &#125;),</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// getters</span></span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="attr">doubleCount</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">count</span> * <span class="number">2</span>,</span><br><span class="line">    <span class="comment">// 使用 this 访问其他 getter</span></span><br><span class="line">    <span class="title function_">doubleCountPlusOne</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">doubleCount</span> + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// actions</span></span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">count</span>++</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> data = <span class="keyword">await</span> api.<span class="title function_">get</span>(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">count</span> = data.<span class="property">count</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>使用 Setup Stores</strong>（更简洁的语法）：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; ref, computed &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;counter&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// state</span></span><br><span class="line">  <span class="keyword">const</span> count = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> name = <span class="title function_">ref</span>(<span class="string">&#x27;Eduardo&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// getters</span></span><br><span class="line">  <span class="keyword">const</span> doubleCount = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> count.<span class="property">value</span> * <span class="number">2</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// actions</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span><br><span class="line">    count.<span class="property">value</span>++</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123; count, name, doubleCount, increment &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li><li><p><strong>在组件中使用 Store</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;Count: &#123;&#123; counter.count &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;Double count: &#123;&#123; counter.doubleCount &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;button @click=&quot;counter.increment()&quot;&gt;Increment&lt;/button&gt;</span><br><span class="line">    &lt;button @click=&quot;increment&quot;&gt;Increment (extracted)&lt;/button&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; useCounterStore &#125; from &#x27;@/stores/counter&#x27;</span><br><span class="line">import &#123; storeToRefs &#125; from &#x27;pinia&#x27;</span><br><span class="line"></span><br><span class="line">const counter = useCounterStore()</span><br><span class="line"></span><br><span class="line">// 解构 store 时保持响应性</span><br><span class="line">const &#123; count, doubleCount &#125; = storeToRefs(counter)</span><br><span class="line">// 直接解构 actions</span><br><span class="line">const &#123; increment &#125; = counter</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li><li><p><strong>修改 State</strong>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1：直接修改</span></span><br><span class="line">counter.<span class="property">count</span>++</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2：使用 $patch 方法</span></span><br><span class="line">counter.$patch(&#123;</span><br><span class="line">  <span class="attr">count</span>: counter.<span class="property">count</span> + <span class="number">1</span>,</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;Alex&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 3：使用 $patch 函数</span></span><br><span class="line">counter.$patch(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">  state.<span class="property">count</span>++</span><br><span class="line">  state.<span class="property">name</span> = <span class="string">&#x27;Alex&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 4：使用 actions</span></span><br><span class="line">counter.<span class="title function_">increment</span>()</span><br></pre></td></tr></table></figure></li><li><p><strong>重置 State</strong>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">counter.$reset()</span><br></pre></td></tr></table></figure></li></ol><h3 id="15-Vue-3-中的-script-setup-语法有什么优势？"><a href="#15-Vue-3-中的-script-setup-语法有什么优势？" class="headerlink" title="15. Vue 3 中的 script setup 语法有什么优势？"></a>15. Vue 3 中的 script setup 语法有什么优势？</h3><p><strong>答案</strong>：<br><code>&lt;script setup&gt;</code> 是 Vue 3.2 引入的编译时语法糖，它有以下优势：</p><ol><li><p><strong>更少的样板代码</strong>：</p><ul><li>不需要返回要暴露给模板的变量</li><li>导入的组件自动注册，无需在 components 选项中声明</li></ul></li><li><p><strong>更好的性能</strong>：</p><ul><li>编译时优化，减少运行时开销</li><li>模板中的变量访问不需要通过代理</li></ul></li><li><p><strong>更好的 TypeScript 支持</strong>：</p><ul><li>直接在 <code>&lt;script setup&gt;</code> 中使用 TypeScript</li><li>使用 defineProps 和 defineEmits 获得完整的类型推断</li></ul></li><li><p><strong>更好的 IDE 支持</strong>：</p><ul><li>更好的自动补全</li><li>更准确的类型检查</li></ul></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">import &#123; ref, computed &#125; from &#x27;vue&#x27;</span><br><span class="line">import MyComponent from &#x27;./MyComponent.vue&#x27; // 自动注册</span><br><span class="line"></span><br><span class="line">// 声明响应式状态</span><br><span class="line">const count = ref(0)</span><br><span class="line"></span><br><span class="line">// 计算属性</span><br><span class="line">const doubleCount = computed(() =&gt; count.value * 2)</span><br><span class="line"></span><br><span class="line">// 方法</span><br><span class="line">function increment() &#123;</span><br><span class="line">  count.value++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 生命周期钩子</span><br><span class="line">onMounted(() =&gt; &#123;</span><br><span class="line">  console.log(&#x27;Component mounted&#x27;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 直接导入并使用组件，无需注册</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;p&gt;Count: &#123;&#123; count &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;p&gt;Double count: &#123;&#123; doubleCount &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &lt;button @click=&quot;increment&quot;&gt;Increment&lt;/button&gt;</span><br><span class="line">    &lt;MyComponent /&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure><p>使用 defineProps 和 defineEmits：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup&gt;</span><br><span class="line">// 声明 props</span><br><span class="line">const props = defineProps(&#123;</span><br><span class="line">  title: String,</span><br><span class="line">  likes: &#123;</span><br><span class="line">    type: Number,</span><br><span class="line">    default: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">// 声明 emits</span><br><span class="line">const emit = defineEmits([&#x27;update&#x27;, &#x27;delete&#x27;])</span><br><span class="line"></span><br><span class="line">// 使用 emit</span><br><span class="line">function handleClick() &#123;</span><br><span class="line">  emit(&#x27;update&#x27;, 123)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>使用 TypeScript：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">// 使用类型声明 props</span><br><span class="line">const props = defineProps&lt;&#123;</span><br><span class="line">  title: string;</span><br><span class="line">  likes?: number;</span><br><span class="line">&#125;&gt;()</span><br><span class="line"></span><br><span class="line">// 使用类型声明 emits</span><br><span class="line">const emit = defineEmits&lt;&#123;</span><br><span class="line">  (e: &#x27;update&#x27;, id: number): void;</span><br><span class="line">  (e: &#x27;delete&#x27;): void;</span><br><span class="line">&#125;&gt;()</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h2 id="适合快速熟悉-Vue-3-的-GitHub-项目"><a href="#适合快速熟悉-Vue-3-的-GitHub-项目" class="headerlink" title="适合快速熟悉 Vue 3 的 GitHub 项目"></a>适合快速熟悉 Vue 3 的 GitHub 项目</h2><p>以下是一些优质的 Vue 3 项目，可以帮助你快速熟悉 Vue 3 的各种特性和最佳实践：</p><ol><li><p><strong>Vue 3 官方示例</strong>：</p><ul><li>链接：<a href="https://github.com/vuejs/vue-next-examples">https://github.com/vuejs/vue-next-examples</a></li><li>描述：Vue 团队提供的 Vue 3 示例集合，涵盖了各种 API 的使用方法</li></ul></li><li><p><strong>Hoppscotch</strong>：</p><ul><li>链接：<a href="https://github.com/hoppscotch/hoppscotch">https://github.com/hoppscotch/hoppscotch</a></li><li>描述：开源的 API 开发生态系统，使用 Vue 3 + TypeScript 构建，拥有 55K+ stars</li></ul></li><li><p><strong>VueUse</strong>：</p><ul><li>链接：<a href="https://github.com/vueuse/vueuse">https://github.com/vueuse/vueuse</a></li><li>描述：Vue Composition API 的实用工具集合，包含大量可复用的组合式函数</li></ul></li><li><p><strong>Element Plus</strong>：</p><ul><li>链接：<a href="https://github.com/element-plus/element-plus">https://github.com/element-plus/element-plus</a></li><li>描述：基于 Vue 3 的桌面端组件库</li></ul></li><li><p><strong>Vite</strong>：</p><ul><li>链接：<a href="https://github.com/vitejs/vite">https://github.com/vitejs/vite</a></li><li>描述：下一代前端构建工具，由 Vue 作者尤雨溪创建，与 Vue 3 配合使用效果最佳</li></ul></li><li><p><strong>Vue 3 Instagram Clone</strong>：</p><ul><li>链接：<a href="https://github.com/selemondev/8-Awesome-Vue-Projects">https://github.com/selemondev/8-Awesome-Vue-Projects</a></li><li>描述：使用 Vue 3、Pinia、TailwindCSS 和 Firebase 构建的 Instagram 克隆项目</li></ul></li><li><p><strong>Vue 3 Whatsapp Clone</strong>：</p><ul><li>链接：<a href="https://github.com/selemondev/8-Awesome-Vue-Projects">https://github.com/selemondev/8-Awesome-Vue-Projects</a></li><li>描述：使用 Vue 3、Pinia、TailwindCSS 和 Firebase 构建的 Whatsapp 克隆项目</li></ul></li><li><p><strong>Vue 3 Netflix Clone</strong>：</p><ul><li>链接：<a href="https://github.com/selemondev/8-Awesome-Vue-Projects">https://github.com/selemondev/8-Awesome-Vue-Projects</a></li><li>描述：使用 Vue 3、Supabase、Pinia 和 TailwindCSS 构建的 Netflix 克隆项目</li></ul></li><li><p><strong>Elk</strong>：</p><ul><li>链接：<a href="https://github.com/elk-zone/elk">https://github.com/elk-zone/elk</a></li><li>描述：一个 Mastodon 网页客户端，使用 Vue 3 和 Nuxt 3 构建</li></ul></li><li><p><strong>Pinia</strong>：</p><ul><li>链接：<a href="https://github.com/vuejs/pinia">https://github.com/vuejs/pinia</a></li><li>描述：Vue 官方推荐的状态管理库，了解其源码有助于深入理解 Vue 3 的响应式系统</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> vue3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webpack 插件如何编写</title>
      <link href="/2024/04/01/tools/webpack%20%E6%8F%92%E4%BB%B6%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99/"/>
      <url>/2024/04/01/tools/webpack%20%E6%8F%92%E4%BB%B6%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99/</url>
      
        <content type="html"><![CDATA[<p>编写 Webpack 插件可以帮助你在 Webpack 构建过程中添加自定义行为。Webpack 插件是一个具有 apply 方法的 JavaScript 对象。这个 apply 方法会在 Webpack 编译器实例上被调用，并且你可以通过这个方法来访问 Webpack 的编译器对象，从而在特定的编译阶段插入自定义逻辑。   下面是一个简单的步骤指南和示例代码，帮助你编写一个基本的 Webpack 插件。<br>步骤指南<br>创建插件对象：创建一个 JavaScript 对象，并定义一个 apply 方法。<br>访问编译器对象：在 apply 方法中，通过参数访问 Webpack 编译器对象。<br>绑定钩子：使用编译器对象提供的钩子来绑定你的插件逻辑。<br>导出插件：将你的插件对象导出，以便在 Webpack 配置中使用。<br>示例代码<br>假设我们要编写一个简单的插件，在 Webpack 构建完成后输出一条消息到控制台。<br>创建插件文件   首先，创建一个文件 MyWebpackPlugin.js，内容如下：</p><span id="more"></span><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MyWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;./MyWebpackPlugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;bundle.js&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MyWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;自定义构建消息：构建成功！&#x27;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>详细说明<br>插件对象</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyWebpackPlugin</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span> = options;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">apply</span>(<span class="params">compiler</span>) &#123;</span><br><span class="line">    compiler.<span class="property">hooks</span>.<span class="property">done</span>.<span class="title function_">tap</span>(<span class="string">&#x27;MyWebpackPlugin&#x27;</span>, <span class="function">(<span class="params">stats</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Webpack 构建完成！&#x27;</span>);</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`构建时间: <span class="subst">$&#123;stats.endTime - stats.startTime&#125;</span> ms`</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">message</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">message</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>构造函数：用于接收配置选项。<br>apply 方法：这是插件的核心方法。它会在 Webpack 编译器实例上被调用，并且你可以通过参数访问编译器对象。<br>绑定钩子：在这个例子中，我们使用了 compiler.hooks.done.tap 来绑定到 Webpack 的 done 钩子。done 钩子在构建完成时触发。tap 方法的第一个参数是插件的名称，第二个参数是一个回调函数，这个回调函数会在钩子触发时执行</p><p>使用插件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MyWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;./MyWebpackPlugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;bundle.js&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">MyWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;自定义构建消息：构建成功！&#x27;</span>,</span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>引入插件：使用 require 引入你编写的插件。<br>配置插件：在 plugins 数组中实例化你的插件，并传入配置选项。<br>更多钩子<br>Webpack 提供了许多不同的钩子，可以在不同的编译阶段插入自定义逻辑。以下是一些常用的钩子：<br>compiler.hooks.compile：在编译开始时触发。<br>compiler.hooks.emit：在生成文件之前触发，可以用来修改生成的文件内容。<br>compiler.hooks.done：在编译完成时触发。<br>compilation.hooks.moduleIds：在模块 ID 分配时触发。<br>compilation.hooks.chunkIds：在 chunk ID 分配时触发。<br>compilation.hooks.optimizeDependencies：在优化依赖时触发。<br>你可以根据需要选择合适的钩子来实现你的插件功能。<br>总结<br>编写 Webpack 插件的基本步骤包括创建插件对象、定义 apply 方法、访问编译器对象、绑定钩子以及导出插件。通过这些步骤，你可以为 Webpack 构建过程添加各种自定义行为，从而更好地满足项目的特定需求</p>]]></content>
      
      
      <categories>
          
          <category> webpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> webpack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue 3 源码解读</title>
      <link href="/2024/04/01/%E5%89%8D%E7%AB%AF/vue/vue3%E6%BA%90%E7%A0%81/"/>
      <url>/2024/04/01/%E5%89%8D%E7%AB%AF/vue/vue3%E6%BA%90%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>Vue 3的源码采用monorepo的方式组织，使用pnpm进行包管理，主要包含以下核心模块：</p><ul><li><strong>reactivity</strong>: 响应式系统</li><li><strong>runtime-core</strong>: 与平台无关的运行时核心</li><li><strong>runtime-dom</strong>: 浏览器平台特定的运行时</li><li><strong>compiler-core</strong>: 与平台无关的编译器核心</li><li><strong>compiler-dom</strong>: 浏览器平台特定的编译器实现</li><li><strong>compiler-sfc</strong>: 单文件组件(.vue文件)编译器</li><li><strong>shared</strong>: 共享工具函数</li><li><strong>vue</strong>: 完整版本，包含运行时和编译器</li></ul><span id="more"></span><h2 id="一、响应式系统-reactivity"><a href="#一、响应式系统-reactivity" class="headerlink" title="一、响应式系统 (reactivity)"></a>一、响应式系统 (reactivity)</h2><p>Vue 3的响应式系统是整个框架的核心，它基于ES6的Proxy实现，相比Vue 2使用的Object.defineProperty有了质的飞跃。</p><h3 id="1-1-核心API实现原理"><a href="#1-1-核心API实现原理" class="headerlink" title="1.1 核心API实现原理"></a>1.1 核心API实现原理</h3><h4 id="reactive"><a href="#reactive" class="headerlink" title="reactive"></a>reactive</h4><p><code>reactive</code>函数是创建响应式对象的主要入口：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/reactivity/src/reactive.ts (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">target: object</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果是只读对象，直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isReadonly</span>(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 创建响应式代理</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createReactiveObject</span>(</span><br><span class="line">    target,</span><br><span class="line">    <span class="literal">false</span>,</span><br><span class="line">    mutableHandlers,</span><br><span class="line">    mutableCollectionHandlers,</span><br><span class="line">    reactiveMap</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createReactiveObject</span>(<span class="params"></span></span><br><span class="line"><span class="params">  target: Target,</span></span><br><span class="line"><span class="params">  isReadonly: boolean,</span></span><br><span class="line"><span class="params">  baseHandlers: ProxyHandler&lt;any&gt;,</span></span><br><span class="line"><span class="params">  collectionHandlers: ProxyHandler&lt;any&gt;,</span></span><br><span class="line"><span class="params">  proxyMap: <span class="built_in">WeakMap</span>&lt;Target, any&gt;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 如果目标不是对象，直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(target)) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果已经是响应式对象，直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    target[<span class="title class_">ReactiveFlags</span>.<span class="property">RAW</span>] &amp;&amp;</span><br><span class="line">    !(isReadonly &amp;&amp; target[<span class="title class_">ReactiveFlags</span>.<span class="property">IS_REACTIVE</span>])</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 检查缓存中是否已存在对应的代理</span></span><br><span class="line">  <span class="keyword">const</span> existingProxy = proxyMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="keyword">if</span> (existingProxy) &#123;</span><br><span class="line">    <span class="keyword">return</span> existingProxy</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 获取目标的类型</span></span><br><span class="line">  <span class="keyword">const</span> targetType = <span class="title function_">getTargetType</span>(target)</span><br><span class="line">  <span class="comment">// 如果目标类型无效，直接返回原对象</span></span><br><span class="line">  <span class="keyword">if</span> (targetType === <span class="title class_">TargetType</span>.<span class="property">INVALID</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 根据目标类型选择不同的handlers</span></span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(</span><br><span class="line">    target,</span><br><span class="line">    targetType === <span class="title class_">TargetType</span>.<span class="property">COLLECTION</span> ? collectionHandlers : baseHandlers</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 缓存代理对象</span></span><br><span class="line">  proxyMap.<span class="title function_">set</span>(target, proxy)</span><br><span class="line">  <span class="keyword">return</span> proxy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="effect"><a href="#effect" class="headerlink" title="effect"></a>effect</h4><p><code>effect</code>函数用于注册副作用函数，当响应式数据变化时会自动执行：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/reactivity/src/effect.ts (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> effect&lt;T = any&gt;(</span><br><span class="line">  <span class="attr">fn</span>: <span class="function">() =&gt;</span> T,</span><br><span class="line">  options?: <span class="title class_">ReactiveEffectOptions</span></span><br><span class="line">): <span class="title class_">ReactiveEffectRunner</span> &#123;</span><br><span class="line">  <span class="comment">// 如果fn已经是一个effect函数，获取原始函数</span></span><br><span class="line">  <span class="keyword">if</span> ((fn <span class="keyword">as</span> <span class="title class_">ReactiveEffectRunner</span>).<span class="property">effect</span>) &#123;</span><br><span class="line">    fn = (fn <span class="keyword">as</span> <span class="title class_">ReactiveEffectRunner</span>).<span class="property">effect</span>.<span class="property">fn</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建响应式effect</span></span><br><span class="line">  <span class="keyword">const</span> _effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(fn)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 合并选项</span></span><br><span class="line">  <span class="keyword">if</span> (options) &#123;</span><br><span class="line">    <span class="title function_">extend</span>(_effect, options)</span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">scope</span>) <span class="title function_">recordEffectScope</span>(_effect, options.<span class="property">scope</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果不是懒执行，立即运行</span></span><br><span class="line">  <span class="keyword">if</span> (!options || !options.<span class="property">lazy</span>) &#123;</span><br><span class="line">    _effect.<span class="title function_">run</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 返回绑定了this的run函数</span></span><br><span class="line">  <span class="keyword">const</span> runner = _effect.<span class="property">run</span>.<span class="title function_">bind</span>(_effect) <span class="keyword">as</span> <span class="title class_">ReactiveEffectRunner</span></span><br><span class="line">  runner.<span class="property">effect</span> = _effect</span><br><span class="line">  <span class="keyword">return</span> runner</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">ReactiveEffect</span>&lt;T = any&gt; &#123;</span><br><span class="line">  active = <span class="literal">true</span></span><br><span class="line">  <span class="attr">deps</span>: <span class="title class_">Dep</span>[] = []</span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">ReactiveEffect</span> | <span class="literal">undefined</span> = <span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    public fn: () =&gt; T,</span></span><br><span class="line"><span class="params">    public scheduler: EffectScheduler | <span class="literal">null</span> = <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">    scope?: EffectScope</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="title function_">recordEffectScope</span>(<span class="variable language_">this</span>, scope)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">run</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">fn</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 设置当前活动的effect</span></span><br><span class="line">      activeEffect = <span class="variable language_">this</span></span><br><span class="line">      <span class="comment">// 执行函数前，将其标记为允许追踪</span></span><br><span class="line">      trackOpBit = <span class="number">1</span> &lt;&lt; ++effectTrackDepth</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 如果嵌套深度小于最大值，使用位操作追踪</span></span><br><span class="line">      <span class="keyword">if</span> (effectTrackDepth &lt;= maxMarkerBits) &#123;</span><br><span class="line">        <span class="title function_">initDepMarkers</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 否则清除所有依赖</span></span><br><span class="line">        <span class="title function_">cleanupEffect</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 执行函数，此时会触发代理的getter，从而收集依赖</span></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">fn</span>()</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// 恢复状态</span></span><br><span class="line">      <span class="keyword">if</span> (effectTrackDepth &lt;= maxMarkerBits) &#123;</span><br><span class="line">        <span class="title function_">finalizeDepMarkers</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      trackOpBit = <span class="number">1</span> &lt;&lt; --effectTrackDepth</span><br><span class="line">      activeEffect = <span class="variable language_">this</span>.<span class="property">parent</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">stop</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="title function_">cleanupEffect</span>(<span class="variable language_">this</span>)</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">onStop</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onStop</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h4><p><code>ref</code>函数用于创建基本类型的响应式引用：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/reactivity/src/ref.ts (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ref</span>(<span class="params">value?: unknown</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createRef</span>(value, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createRef</span>(<span class="params">rawValue: unknown, shallow: boolean</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果已经是ref，直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isRef</span>(rawValue)) &#123;</span><br><span class="line">    <span class="keyword">return</span> rawValue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RefImpl</span>(rawValue, shallow)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RefImpl</span>&lt;T&gt; &#123;</span><br><span class="line">  private <span class="attr">_value</span>: T</span><br><span class="line">  private <span class="attr">_rawValue</span>: T</span><br><span class="line">  </span><br><span class="line">  public dep?: <span class="title class_">Dep</span> = <span class="literal">undefined</span></span><br><span class="line">  public readonly __v_isRef = <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">value: T, public readonly __v_isShallow: boolean</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_rawValue</span> = __v_isShallow ? value : <span class="title function_">toRaw</span>(value)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_value</span> = __v_isShallow ? value : <span class="title function_">toReactive</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="comment">// 追踪依赖</span></span><br><span class="line">    <span class="title function_">trackRefValue</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_value</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">    <span class="comment">// 获取原始值进行比较</span></span><br><span class="line">    newVal = <span class="variable language_">this</span>.<span class="property">__v_isShallow</span> ? newVal : <span class="title function_">toRaw</span>(newVal)</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">hasChanged</span>(newVal, <span class="variable language_">this</span>.<span class="property">_rawValue</span>)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_rawValue</span> = newVal</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_value</span> = <span class="variable language_">this</span>.<span class="property">__v_isShallow</span> ? newVal : <span class="title function_">toReactive</span>(newVal)</span><br><span class="line">      <span class="comment">// 触发更新</span></span><br><span class="line">      <span class="title function_">triggerRefValue</span>(<span class="variable language_">this</span>, newVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-依赖收集与触发更新"><a href="#1-2-依赖收集与触发更新" class="headerlink" title="1.2 依赖收集与触发更新"></a>1.2 依赖收集与触发更新</h3><p>Vue 3的响应式系统核心在于依赖收集(track)和触发更新(trigger)：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/reactivity/src/effect.ts (简化版)</span></span><br><span class="line"><span class="comment">// 依赖收集</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">track</span>(<span class="params">target: object, type: TrackOpTypes, key: unknown</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (shouldTrack &amp;&amp; activeEffect) &#123;</span><br><span class="line">    <span class="comment">// 获取target对应的依赖Map</span></span><br><span class="line">    <span class="keyword">let</span> depsMap = targetMap.<span class="title function_">get</span>(target)</span><br><span class="line">    <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">      targetMap.<span class="title function_">set</span>(target, (depsMap = <span class="keyword">new</span> <span class="title class_">Map</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取key对应的依赖集合</span></span><br><span class="line">    <span class="keyword">let</span> dep = depsMap.<span class="title function_">get</span>(key)</span><br><span class="line">    <span class="keyword">if</span> (!dep) &#123;</span><br><span class="line">      depsMap.<span class="title function_">set</span>(key, (dep = <span class="title function_">createDep</span>()))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 收集依赖</span></span><br><span class="line">    <span class="title function_">trackEffects</span>(dep)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 触发更新</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">trigger</span>(<span class="params"></span></span><br><span class="line"><span class="params">  target: object,</span></span><br><span class="line"><span class="params">  type: TriggerOpTypes,</span></span><br><span class="line"><span class="params">  key?: unknown,</span></span><br><span class="line"><span class="params">  newValue?: unknown,</span></span><br><span class="line"><span class="params">  oldValue?: unknown,</span></span><br><span class="line"><span class="params">  oldTarget?: <span class="built_in">Map</span>&lt;unknown, unknown&gt; | <span class="built_in">Set</span>&lt;unknown&gt;</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 获取target对应的依赖Map</span></span><br><span class="line">  <span class="keyword">const</span> depsMap = targetMap.<span class="title function_">get</span>(target)</span><br><span class="line">  <span class="keyword">if</span> (!depsMap) &#123;</span><br><span class="line">    <span class="comment">// 没有依赖，直接返回</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 收集需要触发的effects</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">deps</span>: (<span class="title class_">Dep</span> | <span class="literal">undefined</span>)[] = []</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 根据操作类型收集相关依赖</span></span><br><span class="line">  <span class="keyword">if</span> (type === <span class="title class_">TriggerOpTypes</span>.<span class="property">CLEAR</span>) &#123;</span><br><span class="line">    <span class="comment">// 清除操作，触发所有依赖</span></span><br><span class="line">    deps = [...depsMap.<span class="title function_">values</span>()]</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">&#x27;length&#x27;</span> &amp;&amp; <span class="title function_">isArray</span>(target)) &#123;</span><br><span class="line">    <span class="comment">// 数组length变化</span></span><br><span class="line">    depsMap.<span class="title function_">forEach</span>(<span class="function">(<span class="params">dep, key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (key === <span class="string">&#x27;length&#x27;</span> || key &gt;= (newValue <span class="keyword">as</span> number)) &#123;</span><br><span class="line">        deps.<span class="title function_">push</span>(dep)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 普通属性变化</span></span><br><span class="line">    <span class="keyword">if</span> (key !== <span class="keyword">void</span> <span class="number">0</span>) &#123;</span><br><span class="line">      deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(key))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据操作类型添加额外依赖</span></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">TriggerOpTypes</span>.<span class="property">ADD</span>:</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isArray</span>(target)) &#123;</span><br><span class="line">          deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">ITERATE_KEY</span>))</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isMap</span>(target)) &#123;</span><br><span class="line">            deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">MAP_KEY_ITERATE_KEY</span>))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isIntegerKey</span>(key)) &#123;</span><br><span class="line">          <span class="comment">// 数组索引添加，触发length相关依赖</span></span><br><span class="line">          deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="string">&#x27;length&#x27;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">TriggerOpTypes</span>.<span class="property">DELETE</span>:</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isArray</span>(target)) &#123;</span><br><span class="line">          deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">ITERATE_KEY</span>))</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isMap</span>(target)) &#123;</span><br><span class="line">            deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">MAP_KEY_ITERATE_KEY</span>))</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">TriggerOpTypes</span>.<span class="property">SET</span>:</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isMap</span>(target)) &#123;</span><br><span class="line">          deps.<span class="title function_">push</span>(depsMap.<span class="title function_">get</span>(<span class="variable constant_">ITERATE_KEY</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 触发收集的effects</span></span><br><span class="line">  <span class="keyword">if</span> (deps.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (deps[<span class="number">0</span>]) &#123;</span><br><span class="line">      <span class="title function_">triggerEffects</span>(deps[<span class="number">0</span>])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">effects</span>: <span class="title class_">ReactiveEffect</span>[] = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> dep <span class="keyword">of</span> deps) &#123;</span><br><span class="line">      <span class="keyword">if</span> (dep) &#123;</span><br><span class="line">        effects.<span class="title function_">push</span>(...dep)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">triggerEffects</span>(<span class="title function_">createDep</span>(effects))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="二、组件系统与渲染机制"><a href="#二、组件系统与渲染机制" class="headerlink" title="二、组件系统与渲染机制"></a>二、组件系统与渲染机制</h2><p>Vue 3的组件系统是构建用户界面的核心，它基于虚拟DOM实现高效的渲染。</p><h3 id="2-1-虚拟DOM-VNode"><a href="#2-1-虚拟DOM-VNode" class="headerlink" title="2.1 虚拟DOM (VNode)"></a>2.1 虚拟DOM (VNode)</h3><p>VNode是Vue中虚拟DOM节点的表示：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/vnode.ts (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createVNode = (</span><br><span class="line">  <span class="attr">type</span>: <span class="title class_">VNodeTypes</span>,</span><br><span class="line">  <span class="attr">props</span>: <span class="title class_">VNodeProps</span> | <span class="literal">null</span> = <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">children</span>: unknown = <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">patchFlag</span>: number = <span class="number">0</span>,</span><br><span class="line">  <span class="attr">dynamicProps</span>: string[] | <span class="literal">null</span> = <span class="literal">null</span>,</span><br><span class="line">  isBlockNode = <span class="literal">false</span></span><br><span class="line">): <span class="function"><span class="params">VNode</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 处理class和style规范化</span></span><br><span class="line">  <span class="keyword">if</span> (props) &#123;</span><br><span class="line">    <span class="comment">// 规范化class</span></span><br><span class="line">    <span class="keyword">if</span> (props.<span class="property">class</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">      props.<span class="property">class</span> = <span class="title function_">normalizeClass</span>(props.<span class="property">class</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 规范化style</span></span><br><span class="line">    <span class="keyword">if</span> (props.<span class="property">style</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">      props.<span class="property">style</span> = <span class="title function_">normalizeStyle</span>(props.<span class="property">style</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 根据type类型确定shapeFlag</span></span><br><span class="line">  <span class="keyword">const</span> shapeFlag = <span class="title function_">isString</span>(type)</span><br><span class="line">    ? <span class="title class_">ShapeFlags</span>.<span class="property">ELEMENT</span></span><br><span class="line">    : <span class="title function_">isObject</span>(type)</span><br><span class="line">    ? <span class="title class_">ShapeFlags</span>.<span class="property">STATEFUL_COMPONENT</span></span><br><span class="line">    : <span class="title function_">isFunction</span>(type)</span><br><span class="line">    ? <span class="title class_">ShapeFlags</span>.<span class="property">FUNCTIONAL_COMPONENT</span></span><br><span class="line">    : <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建VNode对象</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createBaseVNode</span>(</span><br><span class="line">    type,</span><br><span class="line">    props,</span><br><span class="line">    children,</span><br><span class="line">    patchFlag,</span><br><span class="line">    dynamicProps,</span><br><span class="line">    shapeFlag,</span><br><span class="line">    isBlockNode,</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-组件实例创建与生命周期"><a href="#2-2-组件实例创建与生命周期" class="headerlink" title="2.2 组件实例创建与生命周期"></a>2.2 组件实例创建与生命周期</h3><p>组件实例的创建过程：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/component.ts (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">createComponentInstance</span>(<span class="params"></span></span><br><span class="line"><span class="params">  vnode: VNode,</span></span><br><span class="line"><span class="params">  parent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  suspense: SuspenseBoundary | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 获取组件类型和上下文</span></span><br><span class="line">  <span class="keyword">const</span> type = vnode.<span class="property">type</span> <span class="keyword">as</span> <span class="title class_">ConcreteComponent</span></span><br><span class="line">  <span class="keyword">const</span> appContext = (parent ? parent.<span class="property">appContext</span> : vnode.<span class="property">appContext</span>) || emptyAppContext</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建组件实例对象</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">instance</span>: <span class="title class_">ComponentInternalInstance</span> = &#123;</span><br><span class="line">    <span class="attr">uid</span>: uid++,</span><br><span class="line">    vnode,</span><br><span class="line">    type,</span><br><span class="line">    parent,</span><br><span class="line">    appContext,</span><br><span class="line">    <span class="attr">root</span>: <span class="literal">null</span>!, <span class="comment">// 稍后设置</span></span><br><span class="line">    <span class="attr">next</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">subTree</span>: <span class="literal">null</span>!, <span class="comment">// 稍后设置</span></span><br><span class="line">    <span class="attr">effect</span>: <span class="literal">null</span>!,</span><br><span class="line">    <span class="attr">update</span>: <span class="literal">null</span>!, <span class="comment">// 稍后设置</span></span><br><span class="line">    <span class="attr">scope</span>: <span class="keyword">new</span> <span class="title class_">EffectScope</span>(<span class="literal">true</span> <span class="comment">/* detached */</span>),</span><br><span class="line">    <span class="attr">render</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">proxy</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">exposed</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">exposeProxy</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">withProxy</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">provides</span>: parent ? parent.<span class="property">provides</span> : <span class="title class_">Object</span>.<span class="title function_">create</span>(appContext.<span class="property">provides</span>),</span><br><span class="line">    <span class="attr">accessCache</span>: <span class="literal">null</span>!,</span><br><span class="line">    <span class="attr">renderCache</span>: [],</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 组件状态</span></span><br><span class="line">    <span class="attr">components</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">directives</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">propsOptions</span>: <span class="title function_">normalizePropsOptions</span>(type, appContext),</span><br><span class="line">    <span class="attr">emitsOptions</span>: <span class="title function_">normalizeEmitsOptions</span>(type, appContext),</span><br><span class="line">    <span class="attr">emit</span>: <span class="literal">null</span>!, <span class="comment">// 稍后设置</span></span><br><span class="line">    <span class="attr">emitted</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">propsDefaults</span>: <span class="variable constant_">EMPTY_OBJ</span>,</span><br><span class="line">    <span class="attr">inheritAttrs</span>: type.<span class="property">inheritAttrs</span>,</span><br><span class="line">    <span class="attr">ctx</span>: <span class="variable constant_">EMPTY_OBJ</span>,</span><br><span class="line">    <span class="attr">data</span>: <span class="variable constant_">EMPTY_OBJ</span>,</span><br><span class="line">    <span class="attr">props</span>: <span class="variable constant_">EMPTY_OBJ</span>,</span><br><span class="line">    <span class="attr">attrs</span>: <span class="variable constant_">EMPTY_OBJ</span>,</span><br><span class="line">    <span class="attr">slots</span>: <span class="variable constant_">EMPTY_OBJ</span>,</span><br><span class="line">    <span class="attr">refs</span>: <span class="variable constant_">EMPTY_OBJ</span>,</span><br><span class="line">    <span class="attr">setupState</span>: <span class="variable constant_">EMPTY_OBJ</span>,</span><br><span class="line">    <span class="attr">setupContext</span>: <span class="literal">null</span>,</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 生命周期钩子</span></span><br><span class="line">    suspense,</span><br><span class="line">    <span class="attr">suspenseId</span>: suspense ? suspense.<span class="property">pendingId</span> : <span class="number">0</span>,</span><br><span class="line">    <span class="attr">asyncDep</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">asyncResolved</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">isMounted</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">isUnmounted</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">isDeactivated</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">bc</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">c</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">bm</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">m</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">bu</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">u</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">um</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">bum</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">da</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">a</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">rtg</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">rtc</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">ec</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">sp</span>: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 开发环境下使用代理对象作为上下文</span></span><br><span class="line">  instance.<span class="property">ctx</span> = &#123; <span class="attr">_</span>: instance &#125;</span><br><span class="line">  instance.<span class="property">root</span> = parent ? parent.<span class="property">root</span> : instance</span><br><span class="line">  instance.<span class="property">emit</span> = emit.<span class="title function_">bind</span>(<span class="literal">null</span>, instance)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-组件挂载与更新"><a href="#2-3-组件挂载与更新" class="headerlink" title="2.3 组件挂载与更新"></a>2.3 组件挂载与更新</h3><p>组件的挂载和更新过程：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/renderer.ts (简化版)</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">mountComponent</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  initialVNode: VNode,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentComponent: ComponentInternalInstance | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: boolean,</span></span><br><span class="line"><span class="params">  optimized: boolean</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 创建组件实例</span></span><br><span class="line">  <span class="keyword">const</span> instance = (initialVNode.<span class="property">component</span> = <span class="title function_">createComponentInstance</span>(</span><br><span class="line">    initialVNode,</span><br><span class="line">    parentComponent,</span><br><span class="line">    parentSuspense</span><br><span class="line">  ))</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 设置组件实例</span></span><br><span class="line">  <span class="title function_">setupComponent</span>(instance)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 设置并运行带有副作用的渲染函数</span></span><br><span class="line">  <span class="title function_">setupRenderEffect</span>(</span><br><span class="line">    instance,</span><br><span class="line">    initialVNode,</span><br><span class="line">    container,</span><br><span class="line">    anchor,</span><br><span class="line">    parentSuspense,</span><br><span class="line">    isSVG,</span><br><span class="line">    optimized</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">setupRenderEffect</span> = (<span class="params"></span></span><br><span class="line"><span class="params">  instance: ComponentInternalInstance,</span></span><br><span class="line"><span class="params">  initialVNode: VNode,</span></span><br><span class="line"><span class="params">  container: RendererElement,</span></span><br><span class="line"><span class="params">  anchor: RendererNode | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  parentSuspense: SuspenseBoundary | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  isSVG: boolean,</span></span><br><span class="line"><span class="params">  optimized: boolean</span></span><br><span class="line"><span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">componentUpdateFn</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!instance.<span class="property">isMounted</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载组件</span></span><br><span class="line">      <span class="keyword">const</span> &#123; bm, m, parent &#125; = instance</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// beforeMount 钩子</span></span><br><span class="line">      <span class="keyword">if</span> (bm) &#123;</span><br><span class="line">        <span class="title function_">invokeArrayFns</span>(bm)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 渲染组件子树</span></span><br><span class="line">      <span class="keyword">const</span> subTree = (instance.<span class="property">subTree</span> = <span class="title function_">renderComponentRoot</span>(instance))</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 挂载子树</span></span><br><span class="line">      <span class="title function_">patch</span>(</span><br><span class="line">        <span class="literal">null</span>,</span><br><span class="line">        subTree,</span><br><span class="line">        container,</span><br><span class="line">        anchor,</span><br><span class="line">        instance,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG</span><br><span class="line">      )</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 设置元素引用</span></span><br><span class="line">      initialVNode.<span class="property">el</span> = subTree.<span class="property">el</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// mounted 钩子</span></span><br><span class="line">      <span class="keyword">if</span> (m) &#123;</span><br><span class="line">        <span class="title function_">queuePostRenderEffect</span>(m, parentSuspense)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 标记为已挂载</span></span><br><span class="line">      instance.<span class="property">isMounted</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 更新组件</span></span><br><span class="line">      <span class="keyword">let</span> &#123; next, bu, u, parent, vnode &#125; = instance</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 如果有待更新的VNode</span></span><br><span class="line">      <span class="keyword">if</span> (next) &#123;</span><br><span class="line">        next.<span class="property">el</span> = vnode.<span class="property">el</span></span><br><span class="line">        <span class="title function_">updateComponentPreRender</span>(instance, next, optimized)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next = vnode</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// beforeUpdate 钩子</span></span><br><span class="line">      <span class="keyword">if</span> (bu) &#123;</span><br><span class="line">        <span class="title function_">invokeArrayFns</span>(bu)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 渲染新的子树</span></span><br><span class="line">      <span class="keyword">const</span> nextTree = <span class="title function_">renderComponentRoot</span>(instance)</span><br><span class="line">      <span class="keyword">const</span> prevTree = instance.<span class="property">subTree</span></span><br><span class="line">      instance.<span class="property">subTree</span> = nextTree</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 更新子树</span></span><br><span class="line">      <span class="title function_">patch</span>(</span><br><span class="line">        prevTree,</span><br><span class="line">        nextTree,</span><br><span class="line">        <span class="title function_">hostParentNode</span>(prevTree.<span class="property">el</span>!)!,</span><br><span class="line">        <span class="title function_">getNextHostNode</span>(prevTree),</span><br><span class="line">        instance,</span><br><span class="line">        parentSuspense,</span><br><span class="line">        isSVG</span><br><span class="line">      )</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 更新引用</span></span><br><span class="line">      next.<span class="property">el</span> = nextTree.<span class="property">el</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// updated 钩子</span></span><br><span class="line">      <span class="keyword">if</span> (u) &#123;</span><br><span class="line">        <span class="title function_">queuePostRenderEffect</span>(u, parentSuspense)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建响应式effect</span></span><br><span class="line">  <span class="keyword">const</span> effect = (instance.<span class="property">effect</span> = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(</span><br><span class="line">    componentUpdateFn,</span><br><span class="line">    <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(update),</span><br><span class="line">    instance.<span class="property">scope</span></span><br><span class="line">  ))</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 组件更新函数</span></span><br><span class="line">  <span class="keyword">const</span> update = (instance.<span class="property">update</span> = <span class="function">() =&gt;</span> effect.<span class="title function_">run</span>())</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行更新</span></span><br><span class="line">  <span class="title function_">update</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="三、Composition-API-实现"><a href="#三、Composition-API-实现" class="headerlink" title="三、Composition API 实现"></a>三、Composition API 实现</h2><p>Composition API是Vue 3的一大特色，它提供了一种更灵活的组织组件逻辑的方式。</p><h3 id="3-1-setup函数"><a href="#3-1-setup函数" class="headerlink" title="3.1 setup函数"></a>3.1 setup函数</h3><p><code>setup</code>函数是Composition API的入口：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/component.ts (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">setupComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  instance: ComponentInternalInstance,</span></span><br><span class="line"><span class="params">  isSSR = <span class="literal">false</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; props, children &#125; = instance.<span class="property">vnode</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 处理props</span></span><br><span class="line">  <span class="title function_">initProps</span>(instance, props, isSSR)</span><br><span class="line">  <span class="comment">// 处理slots</span></span><br><span class="line">  <span class="title function_">initSlots</span>(instance, children)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 设置有状态的组件</span></span><br><span class="line">  <span class="keyword">const</span> setupResult = <span class="title function_">setupStatefulComponent</span>(instance, isSSR)</span><br><span class="line">  <span class="keyword">return</span> setupResult</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setupStatefulComponent</span>(<span class="params"></span></span><br><span class="line"><span class="params">  instance: ComponentInternalInstance,</span></span><br><span class="line"><span class="params">  isSSR: boolean</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">Component</span> = instance.<span class="property">type</span> <span class="keyword">as</span> <span class="title class_">ComponentOptions</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建渲染上下文代理</span></span><br><span class="line">  instance.<span class="property">proxy</span> = <span class="title function_">markRaw</span>(<span class="keyword">new</span> <span class="title class_">Proxy</span>(instance.<span class="property">ctx</span>, <span class="title class_">PublicInstanceProxyHandlers</span>))</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 获取setup函数</span></span><br><span class="line">  <span class="keyword">const</span> &#123; setup &#125; = <span class="title class_">Component</span></span><br><span class="line">  <span class="keyword">if</span> (setup) &#123;</span><br><span class="line">    <span class="comment">// 创建setup上下文</span></span><br><span class="line">    <span class="keyword">const</span> setupContext = (instance.<span class="property">setupContext</span> =</span><br><span class="line">      setup.<span class="property">length</span> &gt; <span class="number">1</span> ? <span class="title function_">createSetupContext</span>(instance) : <span class="literal">null</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置当前实例</span></span><br><span class="line">    <span class="title function_">setCurrentInstance</span>(instance)</span><br><span class="line">    <span class="comment">// 暂停依赖收集</span></span><br><span class="line">    <span class="title function_">pauseTracking</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用setup函数</span></span><br><span class="line">    <span class="keyword">const</span> setupResult = <span class="title function_">callWithErrorHandling</span>(</span><br><span class="line">      setup,</span><br><span class="line">      instance,</span><br><span class="line">      <span class="title class_">ErrorCodes</span>.<span class="property">SETUP_FUNCTION</span>,</span><br><span class="line">      [instance.<span class="property">props</span>, setupContext]</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 恢复依赖收集</span></span><br><span class="line">    <span class="title function_">resetTracking</span>()</span><br><span class="line">    <span class="comment">// 清除当前实例</span></span><br><span class="line">    <span class="title function_">unsetCurrentInstance</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理setup返回值</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isPromise</span>(setupResult)) &#123;</span><br><span class="line">      <span class="comment">// 异步setup</span></span><br><span class="line">      setupResult.<span class="title function_">then</span>(unsetCurrentInstance, unsetCurrentInstance)</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (isSSR) &#123;</span><br><span class="line">        <span class="comment">// 服务端渲染处理</span></span><br><span class="line">        <span class="keyword">return</span> setupResult</span><br><span class="line">          .<span class="title function_">then</span>(<span class="function">(<span class="params">resolvedResult</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">handleSetupResult</span>(instance, resolvedResult, isSSR)</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">handleError</span>(e, instance, <span class="title class_">ErrorCodes</span>.<span class="property">SETUP_FUNCTION</span>)</span><br><span class="line">          &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 客户端异步组件处理</span></span><br><span class="line">        instance.<span class="property">asyncDep</span> = setupResult</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 同步setup</span></span><br><span class="line">      <span class="title function_">handleSetupResult</span>(instance, setupResult, isSSR)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 无setup函数，完成组件设置</span></span><br><span class="line">    <span class="title function_">finishComponentSetup</span>(instance, isSSR)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-核心Composition-API实现"><a href="#3-2-核心Composition-API实现" class="headerlink" title="3.2 核心Composition API实现"></a>3.2 核心Composition API实现</h3><h4 id="ref和reactive"><a href="#ref和reactive" class="headerlink" title="ref和reactive"></a>ref和reactive</h4><p>前面已经介绍过，这里不再重复。</p><h4 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h4><p><code>computed</code>函数用于创建计算属性：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/reactivity/src/computed.ts (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> computed&lt;T&gt;(</span><br><span class="line">  <span class="attr">getterOrOptions</span>: <span class="title class_">ComputedGetter</span>&lt;T&gt; | <span class="title class_">WritableComputedOptions</span>&lt;T&gt;,</span><br><span class="line">  debugOptions?: <span class="title class_">DebuggerOptions</span>,</span><br><span class="line">  isSSR = <span class="literal">false</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">getter</span>: <span class="title class_">ComputedGetter</span>&lt;T&gt;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">setter</span>: <span class="title class_">ComputedSetter</span>&lt;T&gt;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 规范化参数</span></span><br><span class="line">  <span class="keyword">const</span> onlyGetter = <span class="title function_">isFunction</span>(getterOrOptions)</span><br><span class="line">  <span class="keyword">if</span> (onlyGetter) &#123;</span><br><span class="line">    getter = getterOrOptions</span><br><span class="line">    setter = <span class="variable constant_">NOOP</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    getter = getterOrOptions.<span class="property">get</span></span><br><span class="line">    setter = getterOrOptions.<span class="property">set</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建计算属性实例</span></span><br><span class="line">  <span class="keyword">const</span> cRef = <span class="keyword">new</span> <span class="title class_">ComputedRefImpl</span>(getter, setter, onlyGetter || !setter, isSSR)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> cRef <span class="keyword">as</span> any</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ComputedRefImpl</span>&lt;T&gt; &#123;</span><br><span class="line">  public dep?: <span class="title class_">Dep</span> = <span class="literal">undefined</span></span><br><span class="line">  </span><br><span class="line">  private _value!: T</span><br><span class="line">  public readonly <span class="attr">effect</span>: <span class="title class_">ReactiveEffect</span>&lt;T&gt;</span><br><span class="line">  </span><br><span class="line">  public readonly __v_isRef = <span class="literal">true</span></span><br><span class="line">  public readonly [<span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>]: boolean = <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  public _dirty = <span class="literal">true</span></span><br><span class="line">  public <span class="attr">_cacheable</span>: boolean</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    getter: ComputedGetter&lt;T&gt;,</span></span><br><span class="line"><span class="params">    private readonly _setter: ComputedSetter&lt;T&gt;,</span></span><br><span class="line"><span class="params">    isReadonly: boolean,</span></span><br><span class="line"><span class="params">    isSSR: boolean</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="comment">// 创建effect</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">effect</span> = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(getter, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 当依赖变化时，标记为脏</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_dirty</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">_dirty</span> = <span class="literal">true</span></span><br><span class="line">        <span class="comment">// 触发更新</span></span><br><span class="line">        <span class="title function_">triggerRefValue</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">effect</span>.<span class="property">computed</span> = <span class="variable language_">this</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">effect</span>.<span class="property">active</span> = <span class="variable language_">this</span>.<span class="property">_cacheable</span> = !isSSR</span><br><span class="line">    <span class="variable language_">this</span>[<span class="title class_">ReactiveFlags</span>.<span class="property">IS_READONLY</span>] = isReadonly</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">get</span> <span class="title function_">value</span>() &#123;</span><br><span class="line">    <span class="comment">// 如果是可缓存的，且有依赖追踪</span></span><br><span class="line">    <span class="keyword">const</span> self = <span class="title function_">toRaw</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="comment">// 追踪依赖</span></span><br><span class="line">    <span class="title function_">trackRefValue</span>(self)</span><br><span class="line">    <span class="comment">// 如果脏或者不可缓存，重新计算</span></span><br><span class="line">    <span class="keyword">if</span> (self.<span class="property">_dirty</span> || !self.<span class="property">_cacheable</span>) &#123;</span><br><span class="line">      self.<span class="property">_dirty</span> = <span class="literal">false</span></span><br><span class="line">      self.<span class="property">_value</span> = self.<span class="property">effect</span>.<span class="title function_">run</span>()!</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> self.<span class="property">_value</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">set</span> <span class="title function_">value</span>(<span class="params">newValue: T</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_setter</span>(newValue)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="watch和watchEffect"><a href="#watch和watchEffect" class="headerlink" title="watch和watchEffect"></a>watch和watchEffect</h4><p><code>watch</code>和<code>watchEffect</code>用于监听响应式数据变化：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/runtime-core/src/apiWatch.ts (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> watch&lt;T = any, <span class="title class_">Immediate</span> <span class="keyword">extends</span> <span class="title class_">Readonly</span>&lt;boolean&gt; = <span class="literal">false</span>&gt;(</span><br><span class="line">  <span class="attr">source</span>: T | <span class="title class_">WatchSource</span>&lt;T&gt;,</span><br><span class="line">  <span class="attr">cb</span>: any,</span><br><span class="line">  options?: <span class="title class_">WatchOptions</span>&lt;<span class="title class_">Immediate</span>&gt;</span><br><span class="line">): <span class="title class_">WatchStopHandle</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">doWatch</span>(source <span class="keyword">as</span> any, cb, options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">watchEffect</span>(<span class="params"></span></span><br><span class="line"><span class="params">  effect: WatchEffect,</span></span><br><span class="line"><span class="params">  options?: WatchOptionsBase</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">WatchStopHandle</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">doWatch</span>(effect, <span class="literal">null</span>, options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doWatch</span>(<span class="params"></span></span><br><span class="line"><span class="params">  source: WatchSource | WatchSource[] | WatchEffect | object,</span></span><br><span class="line"><span class="params">  cb: WatchCallback | <span class="literal">null</span>,</span></span><br><span class="line"><span class="params">  &#123; immediate, deep, flush, onTrack, onTrigger &#125;: WatchOptions = EMPTY_OBJ</span></span><br><span class="line"><span class="params"></span>): <span class="title class_">WatchStopHandle</span> &#123;</span><br><span class="line">  <span class="comment">// 处理source</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">getter</span>: <span class="function">() =&gt;</span> any</span><br><span class="line">  <span class="keyword">let</span> forceTrigger = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> isMultiSource = <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isRef</span>(source)) &#123;</span><br><span class="line">    <span class="comment">// ref类型</span></span><br><span class="line">    getter = <span class="function">() =&gt;</span> source.<span class="property">value</span></span><br><span class="line">    forceTrigger = <span class="title function_">isShallow</span>(source)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isReactive</span>(source)) &#123;</span><br><span class="line">    <span class="comment">// reactive类型</span></span><br><span class="line">    getter = <span class="function">() =&gt;</span> source</span><br><span class="line">    deep = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isArray</span>(source)) &#123;</span><br><span class="line">    <span class="comment">// 数组类型</span></span><br><span class="line">    isMultiSource = <span class="literal">true</span></span><br><span class="line">    forceTrigger = source.<span class="title function_">some</span>(<span class="function"><span class="params">s</span> =&gt;</span> <span class="title function_">isReactive</span>(s) || <span class="title function_">isShallow</span>(s))</span><br><span class="line">    getter = <span class="function">() =&gt;</span></span><br><span class="line">      source.<span class="title function_">map</span>(<span class="function"><span class="params">s</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isRef</span>(s)) &#123;</span><br><span class="line">          <span class="keyword">return</span> s.<span class="property">value</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isReactive</span>(s)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">traverse</span>(s)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isFunction</span>(s)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">callWithErrorHandling</span>(s, instance, <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_GETTER</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> s</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isFunction</span>(source)) &#123;</span><br><span class="line">    <span class="comment">// 函数类型</span></span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="comment">// watch(getter, cb)</span></span><br><span class="line">      getter = <span class="function">() =&gt;</span></span><br><span class="line">        <span class="title function_">callWithErrorHandling</span>(source, instance, <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_GETTER</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// watchEffect</span></span><br><span class="line">      getter = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance &amp;&amp; instance.<span class="property">isUnmounted</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (cleanup) &#123;</span><br><span class="line">          <span class="title function_">cleanup</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">callWithAsyncErrorHandling</span>(</span><br><span class="line">          source,</span><br><span class="line">          instance,</span><br><span class="line">          <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_CALLBACK</span>,</span><br><span class="line">          [onCleanup]</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 无效source</span></span><br><span class="line">    getter = <span class="variable constant_">NOOP</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 处理deep选项</span></span><br><span class="line">  <span class="keyword">if</span> (cb &amp;&amp; deep) &#123;</span><br><span class="line">    <span class="keyword">const</span> baseGetter = getter</span><br><span class="line">    getter = <span class="function">() =&gt;</span> <span class="title function_">traverse</span>(<span class="title function_">baseGetter</span>())</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 清理函数</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">cleanup</span>: <span class="function">() =&gt;</span> <span class="keyword">void</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">onCleanup</span>: <span class="title class_">OnCleanup</span> = <span class="function">(<span class="params">fn: () =&gt; <span class="keyword">void</span></span>) =&gt;</span> &#123;</span><br><span class="line">    cleanup = effect.<span class="property">onStop</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">callWithErrorHandling</span>(fn, instance, <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_CLEANUP</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 旧值</span></span><br><span class="line">  <span class="keyword">let</span> oldValue = isMultiSource</span><br><span class="line">    ? <span class="keyword">new</span> <span class="title class_">Array</span>((source <span class="keyword">as</span> []).<span class="property">length</span>).<span class="title function_">fill</span>(<span class="variable constant_">INITIAL_WATCHER_VALUE</span>)</span><br><span class="line">    : <span class="variable constant_">INITIAL_WATCHER_VALUE</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 调度器函数</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">job</span>: <span class="title class_">SchedulerJob</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!effect.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="comment">// watch(source, cb)</span></span><br><span class="line">      <span class="keyword">const</span> newValue = effect.<span class="title function_">run</span>()</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        deep ||</span><br><span class="line">        forceTrigger ||</span><br><span class="line">        (isMultiSource</span><br><span class="line">          ? (newValue <span class="keyword">as</span> any[]).<span class="title function_">some</span>(<span class="function">(<span class="params">v, i</span>) =&gt;</span></span><br><span class="line">              <span class="title function_">hasChanged</span>(v, (oldValue <span class="keyword">as</span> any[])[i])</span><br><span class="line">            )</span><br><span class="line">          : <span class="title function_">hasChanged</span>(newValue, oldValue))</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// 清理旧的副作用</span></span><br><span class="line">        <span class="keyword">if</span> (cleanup) &#123;</span><br><span class="line">          <span class="title function_">cleanup</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调用回调</span></span><br><span class="line">        <span class="title function_">callWithAsyncErrorHandling</span>(cb, instance, <span class="title class_">ErrorCodes</span>.<span class="property">WATCH_CALLBACK</span>, [</span><br><span class="line">          newValue,</span><br><span class="line">          oldValue === <span class="variable constant_">INITIAL_WATCHER_VALUE</span></span><br><span class="line">            ? <span class="literal">undefined</span></span><br><span class="line">            : isMultiSource &amp;&amp; oldValue[<span class="number">0</span>] === <span class="variable constant_">INITIAL_WATCHER_VALUE</span></span><br><span class="line">            ? []</span><br><span class="line">            : oldValue,</span><br><span class="line">          onCleanup</span><br><span class="line">        ])</span><br><span class="line">        <span class="comment">// 更新旧值</span></span><br><span class="line">        oldValue = newValue</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// watchEffect</span></span><br><span class="line">      effect.<span class="title function_">run</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 设置调度器优先级</span></span><br><span class="line">  job.<span class="property">allowRecurse</span> = !!cb</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 根据flush选项设置调度器</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">scheduler</span>: <span class="title class_">EffectScheduler</span></span><br><span class="line">  <span class="keyword">if</span> (flush === <span class="string">&#x27;sync&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 同步调度</span></span><br><span class="line">    scheduler = job <span class="keyword">as</span> any</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flush === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 后置调度（组件更新后）</span></span><br><span class="line">    scheduler = <span class="function">() =&gt;</span> <span class="title function_">queuePostRenderEffect</span>(job, instance &amp;&amp; instance.<span class="property">suspense</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 默认：&#x27;pre&#x27;，前置调度（组件更新前）</span></span><br><span class="line">    job.<span class="property">pre</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (instance) job.<span class="property">id</span> = instance.<span class="property">uid</span></span><br><span class="line">    scheduler = <span class="function">() =&gt;</span> <span class="title function_">queueJob</span>(job)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 创建effect</span></span><br><span class="line">  <span class="keyword">const</span> effect = <span class="keyword">new</span> <span class="title class_">ReactiveEffect</span>(getter, scheduler)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 初始运行</span></span><br><span class="line">  <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">    <span class="keyword">if</span> (immediate) &#123;</span><br><span class="line">      <span class="title function_">job</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      oldValue = effect.<span class="title function_">run</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (flush === <span class="string">&#x27;post&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">queuePostRenderEffect</span>(</span><br><span class="line">      effect.<span class="property">run</span>.<span class="title function_">bind</span>(effect),</span><br><span class="line">      instance &amp;&amp; instance.<span class="property">suspense</span></span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    effect.<span class="title function_">run</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 返回停止函数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    effect.<span class="title function_">stop</span>()</span><br><span class="line">    <span class="keyword">if</span> (instance &amp;&amp; instance.<span class="property">scope</span>) &#123;</span><br><span class="line">      <span class="title function_">remove</span>(instance.<span class="property">scope</span>.<span class="property">effects</span>!, effect)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四、编译优化"><a href="#四、编译优化" class="headerlink" title="四、编译优化"></a>四、编译优化</h2><p>Vue 3在编译阶段引入了许多优化，提高了渲染性能。</p><h3 id="4-1-静态提升"><a href="#4-1-静态提升" class="headerlink" title="4.1 静态提升"></a>4.1 静态提升</h3><p>静态提升是指将静态节点提升到渲染函数之外，避免重复创建：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译前的模板</span></span><br><span class="line">&lt;div&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;static&quot;</span>&gt;</span>Static<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;&#123; dynamic &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue 2编译后的渲染函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, [</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;static&#x27;</span> &#125;, <span class="string">&#x27;Static&#x27;</span>),</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, <span class="variable language_">this</span>.<span class="property">dynamic</span>)</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue 3编译后的渲染函数（带静态提升）</span></span><br><span class="line"><span class="keyword">const</span> hoisted = <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123; <span class="attr">class</span>: <span class="string">&#x27;static&#x27;</span> &#125;, <span class="string">&#x27;Static&#x27;</span>)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, [</span><br><span class="line">    hoisted,</span><br><span class="line">    <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, ctx.<span class="property">dynamic</span>)</span><br><span class="line">  ])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-补丁标记-PatchFlags"><a href="#4-2-补丁标记-PatchFlags" class="headerlink" title="4.2 补丁标记 (PatchFlags)"></a>4.2 补丁标记 (PatchFlags)</h3><p>补丁标记用于标识动态内容的类型，优化更新性能：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译前的模板</span></span><br><span class="line">&lt;div id=<span class="string">&quot;foo&quot;</span> :<span class="keyword">class</span>=<span class="string">&quot;cls&quot;</span>&gt;&#123;&#123; text &#125;&#125;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue 3编译后的渲染函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, </span><br><span class="line">    &#123; </span><br><span class="line">      <span class="attr">id</span>: <span class="string">&#x27;foo&#x27;</span>, </span><br><span class="line">      <span class="attr">class</span>: ctx.<span class="property">cls</span> <span class="comment">// 动态class</span></span><br><span class="line">    &#125;, </span><br><span class="line">    ctx.<span class="property">text</span>,       <span class="comment">// 动态文本</span></span><br><span class="line">    <span class="title class_">PatchFlags</span>.<span class="property">CLASS</span> | <span class="title class_">PatchFlags</span>.<span class="property">TEXT</span> <span class="comment">// 补丁标记</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-块树-Block-Tree"><a href="#4-3-块树-Block-Tree" class="headerlink" title="4.3 块树 (Block Tree)"></a>4.3 块树 (Block Tree)</h3><p>块树是Vue 3引入的新概念，用于跟踪动态子节点：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译前的模板</span></span><br><span class="line">&lt;div&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>Static<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-if</span>=<span class="string">&quot;show&quot;</span>&gt;</span>Conditional<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">v-for</span>=<span class="string">&quot;item in list&quot;</span>&gt;</span>&#123;&#123; item &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue 3编译后的渲染函数（简化）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">createBlock</span>(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, [</span><br><span class="line">    <span class="title function_">createVNode</span>(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;Static&#x27;</span>),</span><br><span class="line">    (ctx.<span class="property">show</span>)</span><br><span class="line">      ? <span class="title function_">createVNode</span>(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, <span class="string">&#x27;Conditional&#x27;</span>, <span class="title class_">PatchFlags</span>.<span class="property">DYNAMIC</span>)</span><br><span class="line">      : <span class="title function_">createCommentVNode</span>(<span class="string">&#x27;v-if&#x27;</span>),</span><br><span class="line">    <span class="title function_">renderList</span>(ctx.<span class="property">list</span>, <span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">createVNode</span>(<span class="string">&#x27;div&#x27;</span>, <span class="literal">null</span>, item, <span class="title class_">PatchFlags</span>.<span class="property">TEXT</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  ], <span class="title class_">PatchFlags</span>.<span class="property">STABLE_FRAGMENT</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Vue 3源码的核心亮点：</p><ol><li><strong>响应式系统</strong>：基于Proxy的全新响应式系统，提供了更好的性能和更完整的响应式覆盖</li><li><strong>组合式API</strong>：提供了更灵活的逻辑组织方式，解决了选项式API的限制</li><li><strong>编译优化</strong>：静态提升、补丁标记、块树等优化大幅提升了渲染性能</li><li><strong>TypeScript支持</strong>：源码完全用TypeScript重写，提供了更好的类型推导</li><li><strong>模块化设计</strong>：采用monorepo管理，各个模块可以独立使用</li></ol><p>Vue 3的源码设计体现了现代前端框架的最佳实践，通过深入理解其实现原理，可以更好地使用Vue 3进行开发。</p>]]></content>
      
      
      <categories>
          
          <category> vue3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端面试题集</title>
      <link href="/2023/03/02/%E5%89%8D%E7%AB%AF/%E5%85%B6%E4%BB%96/%E9%9D%A2%E8%AF%95/"/>
      <url>/2023/03/02/%E5%89%8D%E7%AB%AF/%E5%85%B6%E4%BB%96/%E9%9D%A2%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h2 id="适配问题"><a href="#适配问题" class="headerlink" title="适配问题"></a>适配问题</h2><h2 id="react相关问题"><a href="#react相关问题" class="headerlink" title="react相关问题"></a>react相关问题</h2><h2 id="网络问题"><a href="#网络问题" class="headerlink" title="网络问题"></a>网络问题</h2><h2 id="性能问题"><a href="#性能问题" class="headerlink" title="性能问题"></a>性能问题</h2><h2 id="兼容性问题"><a href="#兼容性问题" class="headerlink" title="兼容性问题"></a>兼容性问题</h2><h2 id="工程化问题"><a href="#工程化问题" class="headerlink" title="工程化问题"></a>工程化问题</h2><h2 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h2><h3 id="移动端适配问题。"><a href="#移动端适配问题。" class="headerlink" title="移动端适配问题。"></a>移动端适配问题。</h3><h2 id="createElement-和-cloneElement-有什么区别？"><a href="#createElement-和-cloneElement-有什么区别？" class="headerlink" title="createElement 和 cloneElement 有什么区别？"></a>createElement 和 cloneElement 有什么区别？</h2><p>传入的第一个参数不同</p><p>React.createElement():JSX 语法就是用 React.createElement()来构建 React 元素的。</p><p>它接受三个参数，第一个参数可以是一个标签名。如 div、span，或者 React 组件。第二个参数为传入的属性。第三个以及之后的参数，皆作为组件的子组件。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">createElement</span>(type, [props], [...children]);</span><br></pre></td></tr></table></figure><p>React.cloneElement()与 React.createElement()相似，不同的是它传入的第一个参数是一个 React 元素，而不是标签名或组件。新添加的属性会并入原有的属性，传入到返回的新元素中，而旧的子元素将被替换。将保留原始元素的键和引用。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">React</span>.<span class="title function_">cloneElement</span>(element, [props], [...children]);</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="1、react-父组件怎么调用子组件的方法"><a href="#1、react-父组件怎么调用子组件的方法" class="headerlink" title="1、react 父组件怎么调用子组件的方法"></a>1、react 父组件怎么调用子组件的方法</h2><p>‌函数组件使用 forwardRef+useImperativeHandle‌：子组件通过useImperativeHandle暴露方法，父组件通过ref调用</p><h2 id="2、react-useEffect-依赖项数组为空-或者不写数组有啥区别"><a href="#2、react-useEffect-依赖项数组为空-或者不写数组有啥区别" class="headerlink" title="2、react useEffect 依赖项数组为空 或者不写数组有啥区别"></a>2、react useEffect 依赖项数组为空 或者不写数组有啥区别</h2><p>空数组[]‌：仅在挂载时执行一次，卸载时清理<br>‌不传数组‌：每次渲染后都会执行<br>‌含依赖项‌：依赖变化时执行MCP_3]^</p><p>1、react性能优化<br>1.1、useMemo<br>1.2、useCallback</p><ol start="2"><li>useLayoutEffect () 与 useEffect () 的区别<br>useLayoutEffect会阻塞浏览器渲染，useEffect不会<br>useEffect()：异步执行，DOM 更新后触发（适合大多数副作用）。<br>useLayoutEffect()：同步执行，DOM 更新前触发（适合需要测量 DOM 的场景）。</li></ol><p>React.memo缓存组件，避免无意义重新渲染<br>useMemo&#x2F;useCallback缓存函数或计算结果</p><h2 id="3、usecontext-有什么作用和缺点"><a href="#3、usecontext-有什么作用和缺点" class="headerlink" title="3、usecontext,有什么作用和缺点"></a>3、usecontext,有什么作用和缺点</h2><p>优点‌：<br>跨组件层级共享状态<br>避免prop drilling<br>‌缺点‌：<br>状态更新会导致所有消费者重新渲染<br>不适合高频更新的场景MCP_3]^</p><h2 id="4、react组件逻辑服用怎么弄。"><a href="#4、react组件逻辑服用怎么弄。" class="headerlink" title="4、react组件逻辑服用怎么弄。"></a>4、react组件逻辑服用怎么弄。</h2><p>React组件逻辑复用<br>‌自定义Hooks‌：提取通用逻辑为可复用函数<br>‌HOC高阶组件‌：通过组件包装增强功能<br>‌Render Props‌：通过函数prop共享代码<br>‌Context API‌：跨层级状态共享MCP_3]^</p><h3 id="5、React-Hooks-的作用和常用-Hook-有哪些？"><a href="#5、React-Hooks-的作用和常用-Hook-有哪些？" class="headerlink" title="5、React Hooks 的作用和常用 Hook 有哪些？"></a>5、React Hooks 的作用和常用 Hook 有哪些？</h3><p><strong>答案</strong>：<br>React Hooks 是 React 16.8 引入的特性，允许在函数组件中使用状态和其他 React 特性，而不需要编写类组件。</p><p><strong>作用</strong>：</p><ul><li>在函数组件中使用状态和生命周期特性</li><li>复用状态逻辑，而不需要改变组件层次结构</li><li>将相关逻辑组合在一起，而不是按生命周期方法分散</li></ul><p><strong>常用的 Hook</strong>：</p><ul><li><strong>useState</strong>：管理组件状态</li><li><strong>useEffect</strong>：处理副作用（类似 componentDidMount、componentDidUpdate、componentWillUnmount）</li><li><strong>useContext</strong>：访问 React Context</li><li><strong>useReducer</strong>：使用 reducer 管理复杂状态逻辑</li><li><strong>useCallback</strong>：记忆函数，避免不必要的重新渲染</li><li><strong>useMemo</strong>：记忆计算结果，避免重复计算</li><li><strong>useRef</strong>：保存可变值，不触发重新渲染</li></ul><h3 id="状态管理工具（Redux-Vuex-Pinia）的核心概念和工作原理"><a href="#状态管理工具（Redux-Vuex-Pinia）的核心概念和工作原理" class="headerlink" title="状态管理工具（Redux&#x2F;Vuex&#x2F;Pinia）的核心概念和工作原理"></a>状态管理工具（Redux&#x2F;Vuex&#x2F;Pinia）的核心概念和工作原理</h3><p><strong>答案</strong>：<br>状态管理工具用于集中管理应用的状态，使状态变化可预测和可追踪。</p><p><strong>Redux（React）核心概念</strong>：</p><ul><li><strong>Store</strong>：存储应用的状态</li><li><strong>Action</strong>：描述状态变化的普通对象</li><li><strong>Reducer</strong>：纯函数，根据当前状态和 action 计算新状态</li><li><strong>Dispatch</strong>：发送 action 的方法</li><li><strong>Middleware</strong>：扩展 Redux 功能的中间件（如处理异步操作）</li></ul><h3 id="6、闭包是什么？有什么用途和潜在问题？"><a href="#6、闭包是什么？有什么用途和潜在问题？" class="headerlink" title="6、闭包是什么？有什么用途和潜在问题？"></a>6、闭包是什么？有什么用途和潜在问题？</h3><p><strong>答案</strong>：<br>闭包是指一个函数可以记住并访问其词法作用域，即使该函数在其词法作用域之外执行。</p><p><strong>用途</strong>：</p><ul><li>数据私有化&#x2F;封装</li><li>创建函数工厂</li><li>实现模块模式</li><li>维持状态</li></ul><p><strong>潜在问题</strong>：</p><ul><li>内存泄漏：闭包会保持对外部变量的引用，可能导致这些变量无法被垃圾回收</li><li>性能问题：过度使用闭包可能影响性能</li></ul><p> 解释 JavaScript 中的原型和原型链<br><strong>答案</strong>：<br>JavaScript 中的每个对象都有一个原型（prototype），原型也是一个对象，对象可以从原型继承属性和方法。</p><ul><li><strong>原型</strong>：每个函数都有一个 <code>prototype</code> 属性，指向一个对象，这个对象就是该函数的实例的原型</li><li><strong>原型链</strong>：当访问一个对象的属性时，如果对象本身没有这个属性，JavaScript 会沿着原型链向上查找，直到找到该属性或到达原型链的末端（<code>null</code>）</li></ul><h3 id="解释事件循环（Event-Loop）机制"><a href="#解释事件循环（Event-Loop）机制" class="headerlink" title="解释事件循环（Event Loop）机制"></a>解释事件循环（Event Loop）机制</h3><p><strong>答案</strong>：<br>JavaScript 是单线程的，事件循环是 JavaScript 实现异步的核心机制，它由以下部分组成：</p><ul><li><strong>调用栈（Call Stack）</strong>：执行同步代码</li><li><strong>任务队列（Task Queue）</strong>：<ul><li><strong>宏任务（Macrotask）</strong>：setTimeout、setInterval、I&#x2F;O、UI 渲染等</li><li><strong>微任务（Microtask）</strong>：Promise 回调、MutationObserver、queueMicrotask() 等</li></ul></li></ul><p>事件循环的执行顺序：</p><ol><li>执行同步代码（调用栈中的任务）</li><li>执行所有微任务</li><li>执行一个宏任务</li><li>重复步骤 2-3</li></ol><pre><code class="language-javascript"></code></pre>]]></content>
      
      
      <categories>
          
          <category> 前端面试题集 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端面试题集 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>前端面试题集</title>
      <link href="/2022/03/02/%E5%89%8D%E7%AB%AF/%E5%85%B6%E4%BB%96/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
      <url>/2022/03/02/%E5%89%8D%E7%AB%AF/%E5%85%B6%E4%BB%96/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h2 id="JavaScript-基础"><a href="#JavaScript-基础" class="headerlink" title="JavaScript 基础"></a>JavaScript 基础</h2><h3 id="Javascript中apply和call的区别"><a href="#Javascript中apply和call的区别" class="headerlink" title="Javascript中apply和call的区别"></a>Javascript中apply和call的区别</h3><p>参数传递方式不同：call 方法接受的是一个参数列表，而 apply 方法接受的是一个参数数组。<br>适用场景不同：当参数数量固定时，通常使用 call；当参数数量不固定时，使用 apply 更为方便。</p><p>call 和 apply 都用于改变函数执行时的 this 指向。</p><p>call 接受参数列表，apply 接受参数数组。</p><p>根据参数的数量和形式选择合适的调用方式。</p><p>掌握 call 和 apply 的使用，能够让你在 JavaScript 中更加灵活地控制函数的执行上下文，提升代码的复用性和可维护性。</p><h3 id="1-解释-JavaScript-中的原型和原型链"><a href="#1-解释-JavaScript-中的原型和原型链" class="headerlink" title="1. 解释 JavaScript 中的原型和原型链"></a>1. 解释 JavaScript 中的原型和原型链</h3><p><strong>答案</strong>：<br>JavaScript 中的每个对象都有一个原型（prototype），原型也是一个对象，对象可以从原型继承属性和方法。</p><ul><li><strong>原型</strong>：每个函数都有一个 <code>prototype</code> 属性，指向一个对象，这个对象就是该函数的实例的原型</li><li><strong>原型链</strong>：当访问一个对象的属性时，如果对象本身没有这个属性，JavaScript 会沿着原型链向上查找，直到找到该属性或到达原型链的末端（<code>null</code>）</li></ul><span id="more"></span><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params">name</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">sayHello</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hello, my name is <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> alice = <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&#x27;Alice&#x27;</span>);</span><br><span class="line">alice.<span class="title function_">sayHello</span>(); <span class="comment">// &quot;Hello, my name is Alice&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 原型链示例</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(alice.<span class="property">__proto__</span> === <span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> === <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>); <span class="comment">// true</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> === <span class="literal">null</span>); <span class="comment">// true</span></span><br></pre></td></tr></table></figure><h3 id="2-var、let-和-const-的区别是什么？"><a href="#2-var、let-和-const-的区别是什么？" class="headerlink" title="2. var、let 和 const 的区别是什么？"></a>2. var、let 和 const 的区别是什么？</h3><p><strong>答案</strong>：</p><ul><li><p><strong>var</strong>：</p><ul><li>函数作用域或全局作用域</li><li>存在变量提升（可以在声明前使用，值为 undefined）</li><li>可以重复声明同名变量</li><li>可以重新赋值</li></ul></li><li><p><strong>let</strong>：</p><ul><li>块级作用域</li><li>存在暂时性死区（不能在声明前使用）</li><li>不可以重复声明同名变量</li><li>可以重新赋值</li></ul></li><li><p><strong>const</strong>：</p><ul><li>块级作用域</li><li>存在暂时性死区（不能在声明前使用）</li><li>不可以重复声明同名变量</li><li>不可以重新赋值（但对于引用类型，可以修改其属性）</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var 示例</span></span><br><span class="line"><span class="keyword">var</span> x = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> x = <span class="number">2</span>; <span class="comment">// 同一个变量</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(x); <span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// let 示例</span></span><br><span class="line"><span class="keyword">let</span> y = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> y = <span class="number">2</span>; <span class="comment">// 不同的变量</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(y); <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const 示例</span></span><br><span class="line"><span class="keyword">const</span> z = &#123; <span class="attr">value</span>: <span class="number">1</span> &#125;;</span><br><span class="line">z.<span class="property">value</span> = <span class="number">2</span>; <span class="comment">// 可以修改属性</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(z.<span class="property">value</span>); <span class="comment">// 2</span></span><br><span class="line"><span class="comment">// z = &#123; value: 3 &#125;; // 错误：不能重新赋值</span></span><br></pre></td></tr></table></figure><h3 id="3-解释事件循环（Event-Loop）机制"><a href="#3-解释事件循环（Event-Loop）机制" class="headerlink" title="3. 解释事件循环（Event Loop）机制"></a>3. 解释事件循环（Event Loop）机制</h3><p><strong>答案</strong>：<br>JavaScript 是单线程的，事件循环是 JavaScript 实现异步的核心机制，它由以下部分组成：</p><ul><li><strong>调用栈（Call Stack）</strong>：执行同步代码</li><li><strong>任务队列（Task Queue）</strong>：<ul><li><strong>宏任务（Macrotask）</strong>：setTimeout、setInterval、I&#x2F;O、UI 渲染等</li><li><strong>微任务（Microtask）</strong>：Promise 回调、MutationObserver、queueMicrotask() 等</li></ul></li></ul><p>事件循环的执行顺序：</p><ol><li>执行同步代码（调用栈中的任务）</li><li>执行所有微任务</li><li>执行一个宏任务</li><li>重复步骤 2-3</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;1&#x27;</span>); <span class="comment">// 同步代码</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;2&#x27;</span>); <span class="comment">// 宏任务</span></span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;3&#x27;</span>); <span class="comment">// 微任务</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;4&#x27;</span>); <span class="comment">// 同步代码</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：1, 4, 3, 2</span></span><br></pre></td></tr></table></figure><h3 id="4-闭包是什么？有什么用途和潜在问题？"><a href="#4-闭包是什么？有什么用途和潜在问题？" class="headerlink" title="4. 闭包是什么？有什么用途和潜在问题？"></a>4. 闭包是什么？有什么用途和潜在问题？</h3><p><strong>答案</strong>：<br>闭包是指一个函数可以记住并访问其词法作用域，即使该函数在其词法作用域之外执行。</p><p><strong>用途</strong>：</p><ul><li>数据私有化&#x2F;封装</li><li>创建函数工厂</li><li>实现模块模式</li><li>维持状态</li></ul><p><strong>潜在问题</strong>：</p><ul><li>内存泄漏：闭包会保持对外部变量的引用，可能导致这些变量无法被垃圾回收</li><li>性能问题：过度使用闭包可能影响性能</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 闭包示例 - 计数器</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createCounter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">0</span>; <span class="comment">// 私有变量</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">increment</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      count++;</span><br><span class="line">      <span class="keyword">return</span> count;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">decrement</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      count--;</span><br><span class="line">      <span class="keyword">return</span> count;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">getCount</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> counter = <span class="title function_">createCounter</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">increment</span>()); <span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">increment</span>()); <span class="comment">// 2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(counter.<span class="title function_">decrement</span>()); <span class="comment">// 1</span></span><br></pre></td></tr></table></figure><h3 id="5-Promise、async-await-的作用和区别"><a href="#5-Promise、async-await-的作用和区别" class="headerlink" title="5. Promise、async&#x2F;await 的作用和区别"></a>5. Promise、async&#x2F;await 的作用和区别</h3><p><strong>答案</strong>：<br>Promise 和 async&#x2F;await 都是用于处理 JavaScript 中的异步操作。</p><p><strong>Promise</strong>：</p><ul><li>表示一个异步操作的最终完成（或失败）及其结果值</li><li>有三种状态：pending（进行中）、fulfilled（已成功）、rejected（已失败）</li><li>使用 <code>.then()</code> 和 <code>.catch()</code> 方法处理结果和错误</li></ul><p><strong>async&#x2F;await</strong>：</p><ul><li>是基于 Promise 的语法糖</li><li><code>async</code> 函数返回一个 Promise</li><li><code>await</code> 关键字只能在 <code>async</code> 函数内使用，用于等待 Promise 解决</li><li>使代码看起来更像同步代码，更易读</li></ul><p><strong>区别</strong>：</p><ul><li>语法：async&#x2F;await 语法更简洁，更接近同步代码</li><li>错误处理：Promise 使用 <code>.catch()</code>，async&#x2F;await 使用 try&#x2F;catch</li><li>调试：async&#x2F;await 更容易调试</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise 示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fetchDataPromise</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.example.com/data&#x27;</span>)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">      <span class="keyword">return</span> data;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// async/await 示例</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchDataAsync</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.example.com/data&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error:&#x27;</span>, error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HTML-CSS"><a href="#HTML-CSS" class="headerlink" title="HTML &amp; CSS"></a>HTML &amp; CSS</h2><h3 id="6-语义化-HTML-的意义是什么？"><a href="#6-语义化-HTML-的意义是什么？" class="headerlink" title="6. 语义化 HTML 的意义是什么？"></a>6. 语义化 HTML 的意义是什么？</h3><p><strong>答案</strong>：<br>语义化 HTML 是指使用恰当的 HTML 标签来表示内容的结构和含义，而不仅仅是为了展示效果。</p><p><strong>意义</strong>：</p><ul><li><strong>可访问性</strong>：屏幕阅读器等辅助技术可以更好地解释页面内容</li><li><strong>SEO 优化</strong>：搜索引擎更容易理解页面内容和结构</li><li><strong>可维护性</strong>：代码更清晰，易于理解和维护</li><li><strong>设备兼容性</strong>：在不同设备上有更好的展示效果</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 非语义化的写法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;logo&quot;</span>&gt;</span>网站名称<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;nav&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>关于<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 语义化的写法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>网站名称<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">nav</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/about&quot;</span>&gt;</span>关于<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="7-解释-CSS-盒模型及其不同类型"><a href="#7-解释-CSS-盒模型及其不同类型" class="headerlink" title="7. 解释 CSS 盒模型及其不同类型"></a>7. 解释 CSS 盒模型及其不同类型</h3><p><strong>答案</strong>：<br>CSS 盒模型描述了元素内容（content）、内边距（padding）、边框（border）和外边距（margin）如何一起决定元素的总尺寸。</p><p><strong>两种盒模型</strong>：</p><ul><li><p><strong>标准盒模型（content-box）</strong>：</p><ul><li><code>width</code> 和 <code>height</code> 只包括内容区域</li><li>总宽度 &#x3D; width + padding + border + margin</li></ul></li><li><p><strong>替代盒模型（border-box）</strong>：</p><ul><li><code>width</code> 和 <code>height</code> 包括内容区域、内边距和边框</li><li>总宽度 &#x3D; width + margin（width 已经包含了 padding 和 border）</li></ul></li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 标准盒模型（默认） */</span></span><br><span class="line"><span class="selector-class">.box-content</span> &#123;</span><br><span class="line">  <span class="attribute">box-sizing</span>: content-box;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">10px</span> solid black;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">15px</span>;</span><br><span class="line">  <span class="comment">/* 总宽度 = 300px + 40px(padding) + 20px(border) + 30px(margin) = 390px */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 替代盒模型 */</span></span><br><span class="line"><span class="selector-class">.box-border</span> &#123;</span><br><span class="line">  <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">300px</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">10px</span> solid black;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">15px</span>;</span><br><span class="line">  <span class="comment">/* 总宽度 = 300px + 30px(margin) = 330px */</span></span><br><span class="line">  <span class="comment">/* 内容区实际宽度 = 300px - 40px(padding) - 20px(border) = 240px */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-CSS-选择器的优先级是如何计算的？"><a href="#8-CSS-选择器的优先级是如何计算的？" class="headerlink" title="8. CSS 选择器的优先级是如何计算的？"></a>8. CSS 选择器的优先级是如何计算的？</h3><p><strong>答案</strong>：<br>CSS 选择器的优先级按照以下规则计算：</p><ol><li><strong>内联样式</strong>：1000 分</li><li><strong>ID 选择器</strong>：100 分</li><li><strong>类选择器、属性选择器、伪类</strong>：10 分</li><li><strong>元素选择器、伪元素</strong>：1 分</li><li><strong>通配符（*）</strong>：0 分</li><li><strong>继承的样式</strong>：无优先级</li></ol><p>当优先级相同时，后声明的样式会覆盖先声明的样式。<br>使用 <code>!important</code> 可以覆盖所有其他样式（除非对方也使用了 <code>!important</code>，此时仍按优先级计算）。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 优先级: 1 (元素选择器) */</span></span><br><span class="line"><span class="selector-tag">p</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: black;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 优先级: 10 (类选择器) */</span></span><br><span class="line"><span class="selector-class">.text</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: blue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 优先级: 11 (类选择器 + 元素选择器) */</span></span><br><span class="line"><span class="selector-tag">p</span><span class="selector-class">.text</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: green;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 优先级: 110 (ID选择器 + 元素选择器) */</span></span><br><span class="line"><span class="selector-id">#content</span> <span class="selector-tag">p</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: red;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 优先级: 10 (类选择器)，但使用 !important */</span></span><br><span class="line"><span class="selector-class">.highlight</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: yellow <span class="meta">!important</span>; <span class="comment">/* 会覆盖上面所有规则 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-响应式设计的核心原则和实现方法有哪些？"><a href="#9-响应式设计的核心原则和实现方法有哪些？" class="headerlink" title="9. 响应式设计的核心原则和实现方法有哪些？"></a>9. 响应式设计的核心原则和实现方法有哪些？</h3><p><strong>答案</strong>：<br>响应式设计是一种让网站能够适应不同设备和屏幕尺寸的设计方法。</p><p><strong>核心原则</strong>：</p><ul><li><strong>流式布局</strong>：使用相对单位（%、em、rem）而非固定单位（px）</li><li><strong>媒体查询</strong>：根据设备特性应用不同的样式</li><li><strong>灵活的图片</strong>：确保图片能够缩放而不溢出容器</li><li><strong>移动优先</strong>：先设计移动端界面，再逐步增强到大屏幕</li></ul><p><strong>实现方法</strong>：</p><ul><li>使用媒体查询（@media）</li><li>使用 viewport 元标签</li><li>使用 CSS Grid 和 Flexbox 布局</li><li>使用相对单位（%、em、rem、vw、vh）</li><li>使用响应式图片技术（srcset、sizes 属性）</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- viewport 设置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 流式布局 */</span></span><br><span class="line"><span class="selector-class">.container</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">90%</span>;</span><br><span class="line">  <span class="attribute">max-width</span>: <span class="number">1200px</span>;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 响应式图片 */</span></span><br><span class="line"><span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">max-width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: auto;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 媒体查询 */</span></span><br><span class="line"><span class="comment">/* 移动设备 */</span></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">767px</span>) &#123;</span><br><span class="line">  <span class="selector-class">.sidebar</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.main-content</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 平板设备 */</span></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="number">768px</span>) <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">1023px</span>) &#123;</span><br><span class="line">  <span class="selector-class">.sidebar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">30%</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.main-content</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">70%</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 桌面设备 */</span></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="number">1024px</span>) &#123;</span><br><span class="line">  <span class="selector-class">.sidebar</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">25%</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.main-content</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">75%</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="10-解释-CSS-Grid-和-Flexbox-的区别及适用场景"><a href="#10-解释-CSS-Grid-和-Flexbox-的区别及适用场景" class="headerlink" title="10. 解释 CSS Grid 和 Flexbox 的区别及适用场景"></a>10. 解释 CSS Grid 和 Flexbox 的区别及适用场景</h3><p><strong>答案</strong>：<br>CSS Grid 和 Flexbox 都是现代 CSS 布局技术，但它们有不同的设计目标和适用场景。</p><p><strong>Flexbox（弹性盒子）</strong>：</p><ul><li><strong>一维布局系统</strong>：主要沿一个轴（主轴或交叉轴）进行布局</li><li><strong>内容驱动</strong>：元素大小由其内容决定</li><li><strong>适用场景</strong>：导航菜单、卡片布局、居中元素、简单的一维布局</li></ul><p><strong>CSS Grid（网格布局）</strong>：</p><ul><li><strong>二维布局系统</strong>：同时控制行和列</li><li><strong>布局驱动</strong>：先定义布局结构，再放入元素</li><li><strong>适用场景</strong>：整体页面布局、复杂的二维布局、不规则布局</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Flexbox 示例 - 导航菜单 */</span></span><br><span class="line"><span class="selector-class">.nav</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">  <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.nav-item</span> &#123;</span><br><span class="line">  <span class="attribute">flex</span>: <span class="number">0</span> <span class="number">1</span> auto;</span><br><span class="line">  <span class="attribute">margin</span>: <span class="number">0</span> <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* CSS Grid 示例 - 页面布局 */</span></span><br><span class="line"><span class="selector-class">.page</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: grid;</span><br><span class="line">  <span class="attribute">grid-template-columns</span>: <span class="number">1</span>fr <span class="number">3</span>fr <span class="number">1</span>fr;</span><br><span class="line">  <span class="attribute">grid-template-rows</span>: auto <span class="number">1</span>fr auto;</span><br><span class="line">  <span class="attribute">grid-template-areas</span>:</span><br><span class="line">    <span class="string">&quot;header header header&quot;</span></span><br><span class="line">    <span class="string">&quot;sidebar main aside&quot;</span></span><br><span class="line">    <span class="string">&quot;footer footer footer&quot;</span>;</span><br><span class="line">  <span class="attribute">min-height</span>: <span class="number">100vh</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.header</span> &#123; <span class="attribute">grid-area</span>: header; &#125;</span><br><span class="line"><span class="selector-class">.sidebar</span> &#123; <span class="attribute">grid-area</span>: sidebar; &#125;</span><br><span class="line"><span class="selector-class">.main</span> &#123; <span class="attribute">grid-area</span>: main; &#125;</span><br><span class="line"><span class="selector-class">.aside</span> &#123; <span class="attribute">grid-area</span>: aside; &#125;</span><br><span class="line"><span class="selector-class">.footer</span> &#123; <span class="attribute">grid-area</span>: footer; &#125;</span><br></pre></td></tr></table></figure><h2 id="前端框架"><a href="#前端框架" class="headerlink" title="前端框架"></a>前端框架</h2><h3 id="11-React-中的虚拟-DOM-是什么？它有什么优势？"><a href="#11-React-中的虚拟-DOM-是什么？它有什么优势？" class="headerlink" title="11. React 中的虚拟 DOM 是什么？它有什么优势？"></a>11. React 中的虚拟 DOM 是什么？它有什么优势？</h3><p><strong>答案</strong>：<br>虚拟 DOM (Virtual DOM) 是 React 中的一个概念，它是真实 DOM 的一种轻量级的 JavaScript 对象表示。</p><p><strong>工作原理</strong>：</p><ol><li>当组件状态改变时，React 创建一个新的虚拟 DOM 树</li><li>将新的虚拟 DOM 树与之前的虚拟 DOM 树进行比较（Diffing 算法）</li><li>计算出需要更新的部分</li><li>只更新真实 DOM 中需要变化的部分</li></ol><p><strong>优势</strong>：</p><ul><li><strong>性能优化</strong>：减少直接操作 DOM 的次数，批量处理 DOM 更新</li><li><strong>跨平台</strong>：虚拟 DOM 是平台无关的，可以渲染到不同环境（Web、Native、服务器等）</li><li><strong>声明式编程</strong>：开发者只需关注状态和 UI 的映射关系，不需要手动操作 DOM</li><li><strong>调试方便</strong>：可以追踪 DOM 变化的历史记录</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// React 组件示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Count: &#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;Increment<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当点击按钮时，React 会：</span></span><br><span class="line"><span class="comment">// 1. 创建新的虚拟 DOM 树（count 值更新）</span></span><br><span class="line"><span class="comment">// 2. 与旧的虚拟 DOM 树比较</span></span><br><span class="line"><span class="comment">// 3. 发现只有 &lt;p&gt; 中的文本内容需要更新</span></span><br><span class="line"><span class="comment">// 4. 只更新真实 DOM 中的那部分内容</span></span><br></pre></td></tr></table></figure><h3 id="12-Vue-的响应式原理是什么？"><a href="#12-Vue-的响应式原理是什么？" class="headerlink" title="12. Vue 的响应式原理是什么？"></a>12. Vue 的响应式原理是什么？</h3><p><strong>答案</strong>：<br>Vue 的响应式系统是其核心特性之一，它能够自动追踪依赖关系并在数据变化时更新视图。</p><p><strong>Vue 2 响应式原理</strong>：</p><ul><li>使用 <code>Object.defineProperty()</code> 劫持对象的属性</li><li>在 getter 中收集依赖（Watcher）</li><li>在 setter 中通知依赖更新</li><li>对于数组，通过重写数组方法（push、pop 等）实现响应式</li></ul><p><strong>Vue 3 响应式原理</strong>：</p><ul><li>使用 ES6 的 Proxy 代替 Object.defineProperty</li><li>可以监听整个对象，包括属性的添加和删除</li><li>可以监听数组的索引和长度变化</li><li>性能更好，没有 Vue 2 中的一些限制</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Vue 2 响应式系统简化示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">defineReactive</span>(<span class="params">obj, key, val</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>(); <span class="comment">// 依赖收集器</span></span><br><span class="line">  </span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        dep.<span class="title function_">depend</span>(); <span class="comment">// 收集依赖</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> val;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (newVal === val) <span class="keyword">return</span>;</span><br><span class="line">      val = newVal;</span><br><span class="line">      dep.<span class="title function_">notify</span>(); <span class="comment">// 通知依赖更新</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Vue 3 响应式系统简化示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reactive</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(obj, &#123;</span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key, receiver</span>) &#123;</span><br><span class="line">      <span class="title function_">track</span>(target, key); <span class="comment">// 收集依赖</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">get</span>(target, key, receiver);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value, receiver</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> result = <span class="title class_">Reflect</span>.<span class="title function_">set</span>(target, key, value, receiver);</span><br><span class="line">      <span class="title function_">trigger</span>(target, key); <span class="comment">// 触发更新</span></span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="13-React-Hooks-的作用和常用-Hook-有哪些？"><a href="#13-React-Hooks-的作用和常用-Hook-有哪些？" class="headerlink" title="13. React Hooks 的作用和常用 Hook 有哪些？"></a>13. React Hooks 的作用和常用 Hook 有哪些？</h3><p><strong>答案</strong>：<br>React Hooks 是 React 16.8 引入的特性，允许在函数组件中使用状态和其他 React 特性，而不需要编写类组件。</p><p><strong>作用</strong>：</p><ul><li>在函数组件中使用状态和生命周期特性</li><li>复用状态逻辑，而不需要改变组件层次结构</li><li>将相关逻辑组合在一起，而不是按生命周期方法分散</li></ul><p><strong>常用的 Hook</strong>：</p><ul><li><strong>useState</strong>：管理组件状态</li><li><strong>useEffect</strong>：处理副作用（类似 componentDidMount、componentDidUpdate、componentWillUnmount）</li><li><strong>useContext</strong>：访问 React Context</li><li><strong>useReducer</strong>：使用 reducer 管理复杂状态逻辑</li><li><strong>useCallback</strong>：记忆函数，避免不必要的重新渲染</li><li><strong>useMemo</strong>：记忆计算结果，避免重复计算</li><li><strong>useRef</strong>：保存可变值，不触发重新渲染</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// useState 示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Count: &#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;Increment<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// useEffect 示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">DataFetcher</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [data, setData] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://api.example.com/data&#x27;</span>);</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        <span class="title function_">setData</span>(result);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Error fetching data:&#x27;</span>, error);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">fetchData</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理函数（类似 componentWillUnmount）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 取消请求或清理资源</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, []); <span class="comment">// 空依赖数组表示只在组件挂载时执行</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (loading) <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;/* 渲染数据 */&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="14-前端路由的实现原理是什么？"><a href="#14-前端路由的实现原理是什么？" class="headerlink" title="14. 前端路由的实现原理是什么？"></a>14. 前端路由的实现原理是什么？</h3><p><strong>答案</strong>：<br>前端路由是指在单页应用（SPA）中，通过 JavaScript 控制页面内容的切换，而不刷新整个页面。主要有两种实现方式：</p><p><strong>Hash 模式</strong>：</p><ul><li>基于 URL 的哈希部分（<code>#</code> 后面的部分）</li><li>通过监听 <code>hashchange</code> 事件检测路由变化</li><li>兼容性好，但 URL 不够美观</li></ul><p><strong>History 模式</strong>：</p><ul><li>基于 HTML5 History API（<code>pushState</code>、<code>replaceState</code>）</li><li>通过监听 <code>popstate</code> 事件检测路由变化</li><li>URL 更美观，但需要服务器配置支持</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hash 模式路由简单实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HashRouter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">routes</span> = &#123;&#125;;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;hashchange&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handleHashChange</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">handleHashChange</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">route</span>(<span class="params">path, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">routes</span>[path] = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">handleHashChange</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> hash = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hash</span>.<span class="title function_">slice</span>(<span class="number">1</span>) || <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="keyword">const</span> handler = <span class="variable language_">this</span>.<span class="property">routes</span>[hash];</span><br><span class="line">    <span class="keyword">if</span> (handler) &#123;</span><br><span class="line">      <span class="title function_">handler</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// History 模式路由简单实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HistoryRouter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">routes</span> = &#123;&#125;;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;popstate&#x27;</span>, <span class="variable language_">this</span>.<span class="property">handlePopState</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>));</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">handlePopState</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">route</span>(<span class="params">path, callback</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">routes</span>[path] = callback;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">navigate</span>(<span class="params">path</span>) &#123;</span><br><span class="line">    history.<span class="title function_">pushState</span>(<span class="literal">null</span>, <span class="literal">null</span>, path);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">handlePopState</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">handlePopState</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> path = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span>;</span><br><span class="line">    <span class="keyword">const</span> handler = <span class="variable language_">this</span>.<span class="property">routes</span>[path];</span><br><span class="line">    <span class="keyword">if</span> (handler) &#123;</span><br><span class="line">      <span class="title function_">handler</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="15-状态管理工具（Redux-Vuex-Pinia）的核心概念和工作原理"><a href="#15-状态管理工具（Redux-Vuex-Pinia）的核心概念和工作原理" class="headerlink" title="15. 状态管理工具（Redux&#x2F;Vuex&#x2F;Pinia）的核心概念和工作原理"></a>15. 状态管理工具（Redux&#x2F;Vuex&#x2F;Pinia）的核心概念和工作原理</h3><p><strong>答案</strong>：<br>状态管理工具用于集中管理应用的状态，使状态变化可预测和可追踪。</p><p><strong>Redux（React）核心概念</strong>：</p><ul><li><strong>Store</strong>：存储应用的状态</li><li><strong>Action</strong>：描述状态变化的普通对象</li><li><strong>Reducer</strong>：纯函数，根据当前状态和 action 计算新状态</li><li><strong>Dispatch</strong>：发送 action 的方法</li><li><strong>Middleware</strong>：扩展 Redux 功能的中间件（如处理异步操作）</li></ul><p><strong>Vuex（Vue 2）核心概念</strong>：</p><ul><li><strong>State</strong>：应用的状态</li><li><strong>Getters</strong>：从 state 派生的状态</li><li><strong>Mutations</strong>：同步修改状态的方法</li><li><strong>Actions</strong>：可包含异步操作，提交 mutation</li><li><strong>Modules</strong>：将 store 分割成模块</li></ul><p><strong>Pinia（Vue 3）核心概念</strong>：</p><ul><li><strong>Store</strong>：定义状态和操作的容器</li><li><strong>State</strong>：存储的响应式状态</li><li><strong>Getters</strong>：类似计算属性，从 state 派生状态</li><li><strong>Actions</strong>：修改状态的方法，可以是异步的</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Redux 示例</span></span><br><span class="line"><span class="comment">// 创建 reducer</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">counterReducer</span>(<span class="params">state = &#123; count: <span class="number">0</span> &#125;, action</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;INCREMENT&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">count</span>: state.<span class="property">count</span> + <span class="number">1</span> &#125;;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;DECREMENT&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">count</span>: state.<span class="property">count</span> - <span class="number">1</span> &#125;;</span><br><span class="line">    <span class="attr">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 store</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="title class_">Redux</span>.<span class="title function_">createStore</span>(counterReducer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅变化</span></span><br><span class="line">store.<span class="title function_">subscribe</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(store.<span class="title function_">getState</span>());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送 action</span></span><br><span class="line">store.<span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span> &#125;); <span class="comment">// &#123; count: 1 &#125;</span></span><br><span class="line">store.<span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;INCREMENT&#x27;</span> &#125;); <span class="comment">// &#123; count: 2 &#125;</span></span><br><span class="line">store.<span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;DECREMENT&#x27;</span> &#125;); <span class="comment">// &#123; count: 1 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Vuex 示例</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> <span class="title class_">Vuex</span>.<span class="title class_">Store</span>(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">    <span class="title function_">increment</span>(<span class="params">state</span>) &#123;</span><br><span class="line">      state.<span class="property">count</span>++;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">decrement</span>(<span class="params">state</span>) &#123;</span><br><span class="line">      state.<span class="property">count</span>--;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">incrementAsync</span>(<span class="params">&#123; commit &#125;</span>) &#123;</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">commit</span>(<span class="string">&#x27;increment&#x27;</span>);</span><br><span class="line">      &#125;, <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="attr">doubleCount</span>: <span class="function"><span class="params">state</span> =&gt;</span> state.<span class="property">count</span> * <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pinia 示例 (Vue 3)</span></span><br><span class="line"><span class="keyword">import</span> &#123; defineStore &#125; <span class="keyword">from</span> <span class="string">&#x27;pinia&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> useCounterStore = <span class="title function_">defineStore</span>(<span class="string">&#x27;counter&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">state</span>: <span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">    <span class="attr">doubleCount</span>: <span class="function">(<span class="params">state</span>) =&gt;</span> state.<span class="property">count</span> * <span class="number">2</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">actions</span>: &#123;</span><br><span class="line">    <span class="title function_">increment</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">count</span>++;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">incrementAsync</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">1000</span>));</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">increment</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="前端工程化与性能优化"><a href="#前端工程化与性能优化" class="headerlink" title="前端工程化与性能优化"></a>前端工程化与性能优化</h2><h3 id="16-前端模块化的发展历程和主要规范"><a href="#16-前端模块化的发展历程和主要规范" class="headerlink" title="16. 前端模块化的发展历程和主要规范"></a>16. 前端模块化的发展历程和主要规范</h3><p><strong>答案</strong>：<br>前端模块化是为了解决全局变量污染、代码复用、依赖管理等问题而发展起来的。</p><p><strong>发展历程</strong>：</p><ol><li><strong>全局函数</strong>：最初的代码组织方式，容易造成命名冲突</li><li><strong>命名空间</strong>：将相关功能封装在对象中，减少全局变量</li><li><strong>IIFE（立即执行函数表达式）</strong>：创建私有作用域，避免变量泄露</li><li><strong>CommonJS</strong>：Node.js 采用的模块规范，同步加载</li><li><strong>AMD（Asynchronous Module Definition）</strong>：异步加载模块，适用于浏览器</li><li><strong>UMD（Universal Module Definition）</strong>：兼容 CommonJS 和 AMD</li><li><strong>ES Modules</strong>：ECMAScript 官方模块系统，现代浏览器原生支持</li></ol><p><strong>主要规范</strong>：</p><p><strong>CommonJS</strong>：</p><ul><li>使用 <code>require()</code> 导入，<code>module.exports</code> 或 <code>exports</code> 导出</li><li>同步加载，适合服务器环境</li><li>Node.js 默认使用</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出 (math.js)</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">add</span>: <span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b,</span><br><span class="line">  <span class="attr">subtract</span>: <span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入</span></span><br><span class="line"><span class="keyword">const</span> math = <span class="built_in">require</span>(<span class="string">&#x27;./math&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(math.<span class="title function_">add</span>(<span class="number">2</span>, <span class="number">3</span>)); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure><p><strong>AMD</strong>：</p><ul><li>使用 <code>define()</code> 定义模块，<code>require()</code> 加载模块</li><li>异步加载，适合浏览器环境</li><li>RequireJS 是其实现</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义模块</span></span><br><span class="line"><span class="title function_">define</span>(<span class="string">&#x27;math&#x27;</span>, [], <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">add</span>: <span class="keyword">function</span>(<span class="params">a, b</span>) &#123; <span class="keyword">return</span> a + b; &#125;,</span><br><span class="line">    <span class="attr">subtract</span>: <span class="keyword">function</span>(<span class="params">a, b</span>) &#123; <span class="keyword">return</span> a - b; &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用模块</span></span><br><span class="line"><span class="built_in">require</span>([<span class="string">&#x27;math&#x27;</span>], <span class="keyword">function</span>(<span class="params">math</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(math.<span class="title function_">add</span>(<span class="number">2</span>, <span class="number">3</span>)); <span class="comment">// 5</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>ES Modules</strong>：</p><ul><li>使用 <code>import</code> 导入，<code>export</code> 导出</li><li>静态分析，支持 tree-shaking</li><li>现代浏览器原生支持</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导出 (math.js)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">subtract</span>(<span class="params">a, b</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入</span></span><br><span class="line"><span class="keyword">import</span> &#123; add, subtract &#125; <span class="keyword">from</span> <span class="string">&#x27;./math.js&#x27;</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">add</span>(<span class="number">2</span>, <span class="number">3</span>)); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure><h3 id="17-Webpack-的核心概念和工作原理"><a href="#17-Webpack-的核心概念和工作原理" class="headerlink" title="17. Webpack 的核心概念和工作原理"></a>17. Webpack 的核心概念和工作原理</h3><p><strong>答案</strong>：<br>Webpack 是一个现代 JavaScript 应用程序的静态模块打包工具，它将项目中的各种资源（JS、CSS、图片等）视为模块，根据模块的依赖关系进行打包。</p><p><strong>核心概念</strong>：</p><ul><li><strong>Entry</strong>：入口，指定 webpack 开始构建的起点</li><li><strong>Output</strong>：输出，指定打包后的资源输出到哪里</li><li><strong>Loaders</strong>：加载器，处理非 JavaScript 文件（如 CSS、图片）</li><li><strong>Plugins</strong>：插件，执行范围更广的任务（如打包优化、资源管理）</li><li><strong>Mode</strong>：模式，指定开发环境或生产环境</li><li><strong>Chunks</strong>：代码块，打包过程中的代码单元</li></ul><p><strong>工作原理</strong>：</p><ol><li><strong>初始化参数</strong>：从配置文件和命令行参数中读取配置</li><li><strong>开始编译</strong>：初始化 Compiler 对象，加载所有配置的插件</li><li><strong>确定入口</strong>：根据配置中的 entry 找出所有入口文件</li><li><strong>编译模块</strong>：从入口文件出发，调用所有配置的 Loader 对模块进行转换，再递归处理依赖的模块</li><li><strong>完成模块编译</strong>：得到每个模块被转换后的最终内容和它们之间的依赖关系</li><li><strong>输出资源</strong>：根据依赖关系，组装成一个个包含多个模块的 Chunk</li><li><strong>输出完成</strong>：根据配置确定输出路径和文件名，将文件内容写入文件系统</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js 示例</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HtmlWebpackPlugin</span> = <span class="built_in">require</span>(<span class="string">&#x27;html-webpack-plugin&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="comment">// 入口</span></span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&#x27;./src/index.js&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 输出</span></span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: path.<span class="title function_">resolve</span>(__dirname, <span class="string">&#x27;dist&#x27;</span>),</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&#x27;bundle.[contenthash].js&#x27;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 模式</span></span><br><span class="line">  <span class="attr">mode</span>: <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 模块处理</span></span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">rules</span>: [</span><br><span class="line">      <span class="comment">// 处理 JavaScript</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>,</span><br><span class="line">        <span class="attr">use</span>: &#123;</span><br><span class="line">          <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">          <span class="attr">options</span>: &#123;</span><br><span class="line">            <span class="attr">presets</span>: [<span class="string">&#x27;@babel/preset-env&#x27;</span>]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 处理 CSS</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        <span class="attr">use</span>: [<span class="string">&#x27;style-loader&#x27;</span>, <span class="string">&#x27;css-loader&#x27;</span>]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 处理图片</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.(png|svg|jpg|jpeg|gif)$/i</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&#x27;asset/resource&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 插件</span></span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HtmlWebpackPlugin</span>(&#123;</span><br><span class="line">      <span class="attr">template</span>: <span class="string">&#x27;./src/index.html&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ],</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 优化</span></span><br><span class="line">  <span class="attr">optimization</span>: &#123;</span><br><span class="line">    <span class="attr">splitChunks</span>: &#123;</span><br><span class="line">      <span class="attr">chunks</span>: <span class="string">&#x27;all&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="18-前端性能优化的主要方法和指标"><a href="#18-前端性能优化的主要方法和指标" class="headerlink" title="18. 前端性能优化的主要方法和指标"></a>18. 前端性能优化的主要方法和指标</h3><p><strong>答案</strong>：<br>前端性能优化是提升用户体验的关键，包括多个方面的优化策略。</p><p><strong>主要优化方法</strong>：</p><p><strong>网络优化</strong>：</p><ul><li>减少 HTTP 请求数（合并文件、CSS Sprites、Base64 编码）</li><li>使用 HTTP&#x2F;2</li><li>使用 CDN 加速</li><li>启用 Gzip 压缩</li><li>使用浏览器缓存（Cache-Control、ETag）</li><li>懒加载和预加载资源</li></ul><p><strong>资源优化</strong>：</p><ul><li>压缩代码（JS、CSS、HTML）</li><li>压缩和优化图片（WebP、SVG、响应式图片）</li><li>Tree-shaking 移除未使用的代码</li><li>代码分割（Code Splitting）</li><li>使用现代格式的图片</li></ul><p><strong>渲染优化</strong>：</p><ul><li>避免重排（reflow）和重绘（repaint）</li><li>使用 CSS 动画代替 JavaScript 动画</li><li>使用 <code>requestAnimationFrame</code> 处理动画</li><li>使用 Web Workers 处理复杂计算</li><li>虚拟滚动处理长列表</li></ul><p><strong>应用优化</strong>：</p><ul><li>服务端渲染（SSR）或静态站点生成（SSG）</li><li>应用 PWA 技术</li><li>使用 Web 缓存 API</li><li>实现骨架屏（Skeleton Screen）</li><li>优化首次内容绘制（FCP）</li></ul><p><strong>主要性能指标</strong>：</p><ul><li><strong>FCP (First Contentful Paint)</strong>：首次内容绘制，页面上首次绘制任何文本、图像、非空白 canvas 或 SVG 的时间</li><li><strong>LCP (Largest Contentful Paint)</strong>：最大内容绘制，视口中最大的内容元素绘制完成的时间</li><li><strong>FID (First Input Delay)</strong>：首次输入延迟，用户首次与页面交互到浏览器响应的时间</li><li><strong>CLS (Cumulative Layout Shift)</strong>：累积布局偏移，页面加载过程中元素意外移动的程度</li><li><strong>TTI (Time to Interactive)</strong>：可交互时间，页面完全可交互所需的时间</li><li><strong>TBT (Total Blocking Time)</strong>：总阻塞时间，FCP 和 TTI 之间主线程被阻塞的总时间</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能监测示例</span></span><br><span class="line"><span class="comment">// 使用 Performance API 测量关键指标</span></span><br><span class="line"><span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">PerformanceObserver</span>(<span class="function">(<span class="params">list</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> entry <span class="keyword">of</span> list.<span class="title function_">getEntries</span>()) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;entry.name&#125;</span>: <span class="subst">$&#123;entry.startTime&#125;</span>ms`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听各种性能指标</span></span><br><span class="line">observer.<span class="title function_">observe</span>(&#123; <span class="attr">entryTypes</span>: [<span class="string">&#x27;paint&#x27;</span>, <span class="string">&#x27;largest-contentful-paint&#x27;</span>, <span class="string">&#x27;layout-shift&#x27;</span>] &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义性能标记</span></span><br><span class="line">performance.<span class="title function_">mark</span>(<span class="string">&#x27;app-init-start&#x27;</span>);</span><br><span class="line"><span class="comment">// ... 初始化应用 ...</span></span><br><span class="line">performance.<span class="title function_">mark</span>(<span class="string">&#x27;app-init-end&#x27;</span>);</span><br><span class="line">performance.<span class="title function_">measure</span>(<span class="string">&#x27;app-initialization&#x27;</span>, <span class="string">&#x27;app-init-start&#x27;</span>, <span class="string">&#x27;app-init-end&#x27;</span>);</span><br></pre></td></tr></table></figure><h3 id="19-前端安全问题及防范措施"><a href="#19-前端安全问题及防范措施" class="headerlink" title="19. 前端安全问题及防范措施"></a>19. 前端安全问题及防范措施</h3><p><strong>答案</strong>：<br>前端安全是 Web 应用安全的重要组成部分，主要包括以下安全问题和防范措施：</p><p><strong>XSS（跨站脚本攻击）</strong>：</p><ul><li><strong>问题</strong>：攻击者将恶意脚本注入到网页中，当用户浏览页面时执行</li><li><strong>防范措施</strong>：<ul><li>对输入输出进行转义和验证</li><li>使用 Content-Security-Policy (CSP) 头</li><li>使用 HttpOnly 和 Secure 标记保护 Cookie</li><li>使用现代框架的内置 XSS 保护</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 输入转义示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">escapeHTML</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> str</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&amp;/g</span>, <span class="string">&#x27;&amp;amp;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&lt;/g</span>, <span class="string">&#x27;&amp;lt;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&gt;/g</span>, <span class="string">&#x27;&amp;gt;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&quot;/g</span>, <span class="string">&#x27;&amp;quot;&#x27;</span>)</span><br><span class="line">    .<span class="title function_">replace</span>(<span class="regexp">/&#x27;/g</span>, <span class="string">&#x27;&amp;#039;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CSP 示例</span></span><br><span class="line"><span class="comment">// 在 HTTP 头中设置</span></span><br><span class="line"><span class="comment">// Content-Security-Policy: default-src &#x27;self&#x27;; script-src &#x27;self&#x27; https://trusted-cdn.com;</span></span><br></pre></td></tr></table></figure><p><strong>CSRF（跨站请求伪造）</strong>：</p><ul><li><strong>问题</strong>：攻击者诱导用户在已认证的网站上执行非预期操作</li><li><strong>防范措施</strong>：<ul><li>使用 CSRF Token</li><li>验证 Origin 和 Referer 头</li><li>使用 SameSite Cookie 属性</li><li>对敏感操作要求重新认证</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CSRF Token 示例</span></span><br><span class="line"><span class="comment">// 服务端生成 token 并在表单中包含</span></span><br><span class="line"><span class="keyword">const</span> csrfToken = <span class="title function_">generateRandomToken</span>();</span><br><span class="line">session.<span class="property">csrfToken</span> = csrfToken;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTML 表单</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;/api/update&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;csrf_token&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123;csrfToken&#125;&#125;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="comment">&lt;!-- 其他表单字段 --&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">// 服务端验证</span></span><br><span class="line"><span class="language-xml">if (request.body.csrf_token !== session.csrfToken) &#123;</span></span><br><span class="line"><span class="language-xml">  return response.status(403).send(&#x27;CSRF token 验证失败&#x27;);</span></span><br><span class="line"><span class="language-xml">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>点击劫持</strong>：</p><ul><li><strong>问题</strong>：攻击者将透明的目标网站覆盖在另一个网站上，诱导用户点击</li><li><strong>防范措施</strong>：<ul><li>使用 X-Frame-Options 头</li><li>使用 CSP 的 frame-ancestors 指令</li><li>JavaScript 框架防御</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// X-Frame-Options 示例</span></span><br><span class="line"><span class="comment">// 在 HTTP 头中设置</span></span><br><span class="line"><span class="comment">// X-Frame-Options: DENY</span></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="comment">// X-Frame-Options: SAMEORIGIN</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// CSP frame-ancestors 示例</span></span><br><span class="line"><span class="comment">// Content-Security-Policy: frame-ancestors &#x27;none&#x27;;</span></span><br></pre></td></tr></table></figure><p><strong>其他安全问题</strong>：</p><ul><li><strong>中间人攻击</strong>：使用 HTTPS 防范</li><li><strong>不安全的依赖</strong>：定期更新依赖，使用安全扫描工具</li><li><strong>敏感信息泄露</strong>：避免在前端存储敏感信息，使用环境变量</li><li><strong>服务器端请求伪造 (SSRF)</strong>：验证和限制 URL，使用白名单</li><li><strong>本地存储安全</strong>：不在 localStorage&#x2F;sessionStorage 中存储敏感数据</li></ul><h3 id="20-微前端架构的原理和实现方式"><a href="#20-微前端架构的原理和实现方式" class="headerlink" title="20. 微前端架构的原理和实现方式"></a>20. 微前端架构的原理和实现方式</h3><p><strong>答案</strong>：<br>微前端是一种将前端应用分解为更小、更易于管理的部分的架构风格，每个部分可以独立开发、测试和部署。</p><p><strong>核心原则</strong>：</p><ul><li><strong>技术栈无关</strong>：每个微前端可以使用不同的技术栈</li><li><strong>独立开发部署</strong>：团队可以独立工作，不影响其他团队</li><li><strong>运行时集成</strong>：微前端在浏览器中组合，而不是构建时</li><li><strong>隔离</strong>：微前端之间不应相互影响</li></ul><p><strong>实现方式</strong>：</p><p><strong>1. 基于路由的分发</strong>：</p><ul><li>不同路由对应不同的微应用</li><li>简单易实现，但页面间集成度低</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简单的路由分发示例</span></span><br><span class="line"><span class="keyword">const</span> routes = &#123;</span><br><span class="line">  <span class="string">&#x27;/app1&#x27;</span>: loadApp1,</span><br><span class="line">  <span class="string">&#x27;/app2&#x27;</span>: loadApp2,</span><br><span class="line">  <span class="string">&#x27;/app3&#x27;</span>: loadApp3</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">router</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> path = <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span>;</span><br><span class="line">  <span class="keyword">const</span> route = <span class="title class_">Object</span>.<span class="title function_">keys</span>(routes).<span class="title function_">find</span>(<span class="function"><span class="params">route</span> =&gt;</span> path.<span class="title function_">startsWith</span>(route));</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (route) &#123;</span><br><span class="line">    routes[route]();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">loadDefaultApp</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;popstate&#x27;</span>, router);</span><br><span class="line"><span class="title function_">router</span>();</span><br></pre></td></tr></table></figure><p><strong>2. 使用 iframe</strong>：</p><ul><li>完全隔离各个应用</li><li>但存在通信困难、样式不一致等问题</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- iframe 集成示例 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">&quot;micro-frontend&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://app1.example.com&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 根据某些条件切换 iframe 的 src</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">loadApp</span>(<span class="params">appUrl</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;micro-frontend&#x27;</span>).<span class="property">src</span> = appUrl;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 应用间通信</span></span></span><br><span class="line"><span class="language-javascript">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (event.<span class="property">origin</span> === <span class="string">&#x27;https://app1.example.com&#x27;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Received message:&#x27;</span>, event.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>3. Web Components</strong>：</p><ul><li>使用自定义元素封装微前端</li><li>提供良好的封装性和互操作性</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Web Components 示例</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MicroApp</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HTMLElement</span> &#123;</span><br><span class="line">  <span class="title function_">connectedCallback</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> appName = <span class="variable language_">this</span>.<span class="title function_">getAttribute</span>(<span class="string">&#x27;name&#x27;</span>);</span><br><span class="line">    <span class="keyword">const</span> appUrl = <span class="variable language_">this</span>.<span class="title function_">getAttribute</span>(<span class="string">&#x27;url&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载微应用</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;appUrl&#125;</span>/asset-manifest.json`</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">res</span> =&gt;</span> res.<span class="title function_">json</span>())</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function"><span class="params">manifest</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 加载 JS 和 CSS</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">loadResources</span>(manifest, appUrl);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">loadResources</span>(<span class="params">manifest, baseUrl</span>) &#123;</span><br><span class="line">    <span class="comment">// 加载 CSS</span></span><br><span class="line">    <span class="keyword">if</span> (manifest.<span class="property">css</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> link = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;link&#x27;</span>);</span><br><span class="line">      link.<span class="property">rel</span> = <span class="string">&#x27;stylesheet&#x27;</span>;</span><br><span class="line">      link.<span class="property">href</span> = <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/<span class="subst">$&#123;manifest.css&#125;</span>`</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">appendChild</span>(link);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加载 JS</span></span><br><span class="line">    <span class="keyword">if</span> (manifest.<span class="property">js</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">      script.<span class="property">src</span> = <span class="string">`<span class="subst">$&#123;baseUrl&#125;</span>/<span class="subst">$&#123;manifest.js&#125;</span>`</span>;</span><br><span class="line">      script.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 调用微应用的挂载函数</span></span><br><span class="line">        <span class="variable language_">window</span>[<span class="string">`mount<span class="subst">$&#123;<span class="variable language_">this</span>.getAttribute(<span class="string">&#x27;name&#x27;</span>)&#125;</span>`</span>](<span class="variable language_">this</span>);</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">appendChild</span>(script);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">disconnectedCallback</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 调用微应用的卸载函数</span></span><br><span class="line">    <span class="keyword">const</span> appName = <span class="variable language_">this</span>.<span class="title function_">getAttribute</span>(<span class="string">&#x27;name&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>[<span class="string">`unmount<span class="subst">$&#123;appName&#125;</span>`</span>]) &#123;</span><br><span class="line">      <span class="variable language_">window</span>[<span class="string">`unmount<span class="subst">$&#123;appName&#125;</span>`</span>]();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">customElements.<span class="title function_">define</span>(<span class="string">&#x27;micro-app&#x27;</span>, <span class="title class_">MicroApp</span>);</span><br></pre></td></tr></table></figure><p><strong>4. JavaScript 模块加载</strong>：</p><ul><li>动态加载 JavaScript 模块</li><li>灵活性高，但需要处理好依赖和冲突</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态加载模块示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">loadApp</span>(<span class="params">name, url</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>);</span><br><span class="line">    script.<span class="property">src</span> = url;</span><br><span class="line">    script.<span class="property">onload</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">resolve</span>(<span class="variable language_">window</span>[name]);</span><br><span class="line">    &#125;;</span><br><span class="line">    script.<span class="property">onerror</span> = reject;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(script);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="title function_">loadApp</span>(<span class="string">&#x27;app1&#x27;</span>, <span class="string">&#x27;https://app1.example.com/bundle.js&#x27;</span>)</span><br><span class="line">  .<span class="title function_">then</span>(<span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    app.<span class="title function_">mount</span>(<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;app1-container&#x27;</span>));</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p><strong>5. 使用微前端框架</strong>：</p><ul><li><strong>single-spa</strong>：JavaScript 微前端框架</li><li><strong>qiankun</strong>：基于 single-spa 的增强框架</li><li><strong>Module Federation</strong>：Webpack 5 提供的模块联邦功能</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// single-spa 示例</span></span><br><span class="line"><span class="keyword">import</span> &#123; registerApplication, start &#125; <span class="keyword">from</span> <span class="string">&#x27;single-spa&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册应用</span></span><br><span class="line"><span class="title function_">registerApplication</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;app1&#x27;</span>,</span><br><span class="line">  <span class="attr">app</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;app1&#x27;</span>),</span><br><span class="line">  <span class="attr">activeWhen</span>: <span class="string">&#x27;/app1&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title function_">registerApplication</span>(&#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;app2&#x27;</span>,</span><br><span class="line">  <span class="attr">app</span>: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;app2&#x27;</span>),</span><br><span class="line">  <span class="attr">activeWhen</span>: <span class="string">&#x27;/app2&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动</span></span><br><span class="line"><span class="title function_">start</span>();</span><br></pre></td></tr></table></figure><p><strong>挑战与解决方案</strong>：</p><ul><li><strong>样式隔离</strong>：使用 CSS Modules、CSS-in-JS 或 Shadow DOM</li><li><strong>共享依赖</strong>：使用 Webpack 的 Module Federation 或 import maps</li><li><strong>通信机制</strong>：使用自定义事件、发布订阅模式或全局状态管理</li><li><strong>认证授权</strong>：使用 SSO 或 token 共享</li></ul>]]></content>
      
      
      <categories>
          
          <category> 前端面试题集 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端面试题集 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>react重点</title>
      <link href="/2021/06/07/%E5%89%8D%E7%AB%AF/react/react%E9%9D%A2%E8%AF%95/"/>
      <url>/2021/06/07/%E5%89%8D%E7%AB%AF/react/react%E9%9D%A2%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h2 id="1、react-父组件怎么调用子组件的方法"><a href="#1、react-父组件怎么调用子组件的方法" class="headerlink" title="1、react 父组件怎么调用子组件的方法"></a>1、react 父组件怎么调用子组件的方法</h2><p>‌函数组件使用 forwardRef+useImperativeHandle‌：子组件通过useImperativeHandle暴露方法，父组件通过ref调用</p><span id="more"></span><h2 id="2、有用过worker吗"><a href="#2、有用过worker吗" class="headerlink" title="2、有用过worker吗"></a>2、有用过worker吗</h2><p>Web Worker用于在后台线程执行耗时操作，避免阻塞UI渲染。典型应用场景包括：<br>复杂计算（如图像处理）<br>大数据量排序&#x2F;过滤<br>保持页面响应性MCP_3</p><h2 id="3、有用过那些打包工具"><a href="#3、有用过那些打包工具" class="headerlink" title="3、有用过那些打包工具"></a>3、有用过那些打包工具</h2><p>webpack roolup vite </p><h2 id="4、有写过webpack插件么"><a href="#4、有写过webpack插件么" class="headerlink" title="4、有写过webpack插件么"></a>4、有写过webpack插件么</h2><p>编写插件需要理解Webpack的compiler和compilation钩子。典型结构：</p><h2 id="6、原型和原型链"><a href="#6、原型和原型链" class="headerlink" title="6、原型和原型链"></a>6、原型和原型链</h2><p>‌原型‌：每个函数创建的prototype对象<br>‌原型链‌：对象通过__proto__链接形成的继承链条<br>访问属性时沿原型链向上查找MCP_3]^</p><h2 id="7、类的静态方法和原型方法有啥区别，访问方式有什么不同"><a href="#7、类的静态方法和原型方法有啥区别，访问方式有什么不同" class="headerlink" title="7、类的静态方法和原型方法有啥区别，访问方式有什么不同"></a>7、类的静态方法和原型方法有啥区别，访问方式有什么不同</h2><p>通过类名访问Class.method() ，，<br>通过实例访问instance.method()</p><h2 id="8、有用过canvas么，那些2d的动画库。"><a href="#8、有用过canvas么，那些2d的动画库。" class="headerlink" title="8、有用过canvas么，那些2d的动画库。"></a>8、有用过canvas么，那些2d的动画库。</h2><h2 id="9、移动端适配，em-rem-vw和vh的区别"><a href="#9、移动端适配，em-rem-vw和vh的区别" class="headerlink" title="9、移动端适配，em rem vw和vh的区别"></a>9、移动端适配，em rem vw和vh的区别</h2><h2 id="10、移动端安卓和ios-兼容上有哪些不一样"><a href="#10、移动端安卓和ios-兼容上有哪些不一样" class="headerlink" title="10、移动端安卓和ios 兼容上有哪些不一样"></a>10、移动端安卓和ios 兼容上有哪些不一样</h2><p>‌点击延迟‌：iOS需要touch-action优化<br>‌滚动回弹‌：iOS特有的弹性滚动效果<br>‌输入框聚焦‌：iOS键盘弹出行为不同<br>‌日期选择器‌：各系统原生控件样式差异大<br>‌安全区域‌：iOS刘海屏需要viewport-fit适配MCP_3]^</p><h2 id="11、react-useEffect-依赖项数组为空-或者不写数组有啥区别"><a href="#11、react-useEffect-依赖项数组为空-或者不写数组有啥区别" class="headerlink" title="11、react useEffect 依赖项数组为空 或者不写数组有啥区别"></a>11、react useEffect 依赖项数组为空 或者不写数组有啥区别</h2><p>空数组[]‌：仅在挂载时执行一次，卸载时清理<br>‌不传数组‌：每次渲染后都会执行<br>‌含依赖项‌：依赖变化时执行MCP_3]^</p><h2 id="12、react合成事件原理。"><a href="#12、react合成事件原理。" class="headerlink" title="12、react合成事件原理。"></a>12、react合成事件原理。</h2><p>‌事件委托‌：所有事件委托到document处理<br>‌统一封装‌：对原生事件进行跨浏览器包装<br>‌性能优化‌：使用事件池复用事件对象<br>‌异步处理‌：批量更新事件处理MCP_3]^</p><p>什么是React事件，什么是原生事件？两者的区别在哪儿？<br>React 事件: React 事件是经过封装和合成的，以保证在不同浏览器上的一致性。在使用 React 中的事件处理时，你会给 JSX 元素添加事件处理函数，比如 onClick、onChange 等，然后在事件处理函数中处理相应的逻辑。React 事件的处理方式提供了一定程度的抽象，使得开发者可以更加方便地处理事件和跨浏览器的兼容性。<br>原生事件是指由浏览器原生提供的事件，如 click、change、mouseover 等。在传统的 Web 开发中，我们通过 JavaScript 直接操作 DOM 元素并为其绑定原生事件处理程序来实现交互行为。</p><p>合成事件系统：React 事件是经过合成的，React 通过事件委派（event delegation）的方式来管理事件，而不是直接将事件绑定到每个 DOM 元素上。这种方式可以提高性能，同时减少内存占用。<br>跨浏览器兼容性：React 事件处理封装了底层的浏览器差异，使得开发者无需关心不同浏览器的事件兼容性问题。<br>事件命名：React 使用驼峰式命名来定义事件名，如 onClick、onChange，而原生事件则使用全小写的方式，如 click、change。</p><p>React 中的事件委派是指 React 将事件处理逻辑委托给组件的共同祖先（根组件），而不是直接在每个组件上添加事件监听器。这意味着 React 在整个组件树中只添加了一个事件监听器，而不是每个组件都有自己的事件监听器。<br>当用户触发事件时，React 会在 DOM 树中找到最近的共同祖先，并在该节点上触发事件处理函数。然后，React 会使用事件冒泡（event bubbling）的机制将事件传播到组件树中的每个组件，并调用相应的事件处理函数。<br>React 事件委派的优点包括：<br>性能优化：减少了事件监听器的数量，提高了性能。相比每个组件都添加事件监听器，只有一个共同祖先添加事件监听器的方式更加高效。<br>简化事件管理：不需要为每个组件都添加事件监听器，减少了事件管理的复杂性。当组件被添加、移除或更新时，不需要手动管理事件监听器。<br>更少的内存占用：只有一个事件监听器，减少了内存占用。</p><h2 id="15、webpack-公布变量-html访问"><a href="#15、webpack-公布变量-html访问" class="headerlink" title="15、webpack 公布变量 html访问"></a>15、webpack 公布变量 html访问</h2><p>1、使用 htmlwebpackPlugin<br>2、环境变量注入<br>3、DefinePlugin全局变量</p><h2 id="13、usecontext-有什么作用和缺点"><a href="#13、usecontext-有什么作用和缺点" class="headerlink" title="13、usecontext,有什么作用和缺点"></a>13、usecontext,有什么作用和缺点</h2><p>优点‌：<br>跨组件层级共享状态<br>避免prop drilling<br>‌缺点‌：<br>状态更新会导致所有消费者重新渲染<br>不适合高频更新的场景MCP_3]^</p><h2 id="14、webpack-怎么配置多入口。"><a href="#14、webpack-怎么配置多入口。" class="headerlink" title="14、webpack 怎么配置多入口。"></a>14、webpack 怎么配置多入口。</h2><p>pages属性</p><h2 id="5、react组件逻辑复用有哪些方式。"><a href="#5、react组件逻辑复用有哪些方式。" class="headerlink" title="5、react组件逻辑复用有哪些方式。"></a>5、react组件逻辑复用有哪些方式。</h2><p>React组件逻辑复用<br>‌自定义Hooks‌：提取通用逻辑为可复用函数<br>‌HOC高阶组件‌：通过组件包装增强功能<br>‌Render Props‌：通过函数prop共享代码<br>‌Context API‌：跨层级状态共享MCP_3]^</p><p>1、react性能优化<br>1.1、useMemo<br>1.2、useCallback</p><p>useLayoutEffect会阻塞浏览器渲染，useEffect不会</p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Vue 2 源码解读</title>
      <link href="/2021/06/01/%E5%89%8D%E7%AB%AF/vue/vue2%E6%BA%90%E7%A0%81/"/>
      <url>/2021/06/01/%E5%89%8D%E7%AB%AF/vue/vue2%E6%BA%90%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p>Vue 2的源码采用典型的模块化结构，主要包含以下核心模块：</p><ul><li><strong>core</strong>: 核心代码，包含响应式系统、虚拟DOM、组件系统等</li><li><strong>platforms</strong>: 平台特定代码，包括Web和Weex</li><li><strong>compiler</strong>: 模板编译器，将模板转换为渲染函数</li><li><strong>server</strong>: 服务端渲染相关代码</li><li><strong>sfc</strong>: 单文件组件(.vue文件)解析器</li><li><strong>shared</strong>: 共享工具函数</li></ul><h2 id="一、响应式系统"><a href="#一、响应式系统" class="headerlink" title="一、响应式系统"></a>一、响应式系统</h2><p>Vue 2的响应式系统是整个框架的核心，它基于Object.defineProperty实现数据劫持和发布订阅模式。</p><h3 id="1-1-数据响应式原理"><a href="#1-1-数据响应式原理" class="headerlink" title="1.1 数据响应式原理"></a>1.1 数据响应式原理</h3><span id="more"></span><h4 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h4><p>Observer类负责将普通JavaScript对象转换为响应式对象：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/index.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Observer</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vmCount</span> = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 在对象上添加__ob__属性，指向Observer实例</span></span><br><span class="line">    <span class="title function_">def</span>(value, <span class="string">&#x27;__ob__&#x27;</span>, <span class="variable language_">this</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">      <span class="comment">// 数组响应式处理</span></span><br><span class="line">      <span class="keyword">const</span> augment = hasProto</span><br><span class="line">        ? protoAugment</span><br><span class="line">        : copyAugment</span><br><span class="line">      <span class="title function_">augment</span>(value, arrayMethods, arrayKeys)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">observeArray</span>(value)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 对象响应式处理</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">walk</span>(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历对象的所有属性并将它们转换为getter/setter</span></span><br><span class="line">  <span class="title function_">walk</span> (obj) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="title function_">defineReactive</span>(obj, keys[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历数组的每一项并将它们转换为响应式</span></span><br><span class="line">  <span class="title function_">observeArray</span> (items) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="title function_">observe</span>(items[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将对象转换为响应式</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">observe</span> (<span class="params">value, asRootData</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(value) || value <span class="keyword">instanceof</span> <span class="title class_">VNode</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> ob</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">hasOwn</span>(value, <span class="string">&#x27;__ob__&#x27;</span>) &amp;&amp; value.<span class="property">__ob__</span> <span class="keyword">instanceof</span> <span class="title class_">Observer</span>) &#123;</span><br><span class="line">    ob = value.<span class="property">__ob__</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    shouldObserve &amp;&amp;</span><br><span class="line">    !<span class="title function_">isServerRendering</span>() &amp;&amp;</span><br><span class="line">    (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value) || <span class="title function_">isPlainObject</span>(value)) &amp;&amp;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">isExtensible</span>(value) &amp;&amp;</span><br><span class="line">    !value.<span class="property">_isVue</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    ob = <span class="keyword">new</span> <span class="title class_">Observer</span>(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">    ob.<span class="property">vmCount</span>++</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="defineReactive"><a href="#defineReactive" class="headerlink" title="defineReactive"></a>defineReactive</h4><p><code>defineReactive</code>函数使用Object.defineProperty将对象属性转换为getter&#x2F;setter：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/index.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">defineReactive</span> (<span class="params"></span></span><br><span class="line"><span class="params">  obj,</span></span><br><span class="line"><span class="params">  key,</span></span><br><span class="line"><span class="params">  val,</span></span><br><span class="line"><span class="params">  customSetter,</span></span><br><span class="line"><span class="params">  shallow</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 为每个属性创建一个依赖收集器</span></span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> property = <span class="title class_">Object</span>.<span class="title function_">getOwnPropertyDescriptor</span>(obj, key)</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.<span class="property">configurable</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存原来的getter和setter</span></span><br><span class="line">  <span class="keyword">const</span> getter = property &amp;&amp; property.<span class="property">get</span></span><br><span class="line">  <span class="keyword">const</span> setter = property &amp;&amp; property.<span class="property">set</span></span><br><span class="line">  <span class="keyword">if</span> ((!getter || setter) &amp;&amp; <span class="variable language_">arguments</span>.<span class="property">length</span> === <span class="number">2</span>) &#123;</span><br><span class="line">    val = obj[key]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归观察子属性</span></span><br><span class="line">  <span class="keyword">let</span> childOb = !shallow &amp;&amp; <span class="title function_">observe</span>(val)</span><br><span class="line">  </span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">    <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">reactiveGetter</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val</span><br><span class="line">      <span class="comment">// 依赖收集</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        dep.<span class="title function_">depend</span>()</span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.<span class="property">dep</span>.<span class="title function_">depend</span>()</span><br><span class="line">          <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">            <span class="title function_">dependArray</span>(value)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">reactiveSetter</span> (<span class="params">newVal</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val</span><br><span class="line">      <span class="comment">// 值没有变化则不触发更新</span></span><br><span class="line">      <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">        <span class="title function_">customSetter</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span></span><br><span class="line">      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        setter.<span class="title function_">call</span>(obj, newVal)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 新值需要重新观察</span></span><br><span class="line">      childOb = !shallow &amp;&amp; <span class="title function_">observe</span>(newVal)</span><br><span class="line">      <span class="comment">// 通知依赖更新</span></span><br><span class="line">      dep.<span class="title function_">notify</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-2-依赖收集与更新"><a href="#1-2-依赖收集与更新" class="headerlink" title="1.2 依赖收集与更新"></a>1.2 依赖收集与更新</h3><h4 id="Dep"><a href="#Dep" class="headerlink" title="Dep"></a>Dep</h4><p>Dep类是一个发布订阅中心，负责收集依赖和通知更新：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/dep.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> target</span><br><span class="line">  id</span><br><span class="line">  subs</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = uid++</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span> = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加订阅者</span></span><br><span class="line">  <span class="title function_">addSub</span> (sub) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(sub)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除订阅者</span></span><br><span class="line">  <span class="title function_">removeSub</span> (sub) &#123;</span><br><span class="line">    <span class="title function_">remove</span>(<span class="variable language_">this</span>.<span class="property">subs</span>, sub)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 收集依赖</span></span><br><span class="line">  <span class="title function_">depend</span> () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">      <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="title function_">addDep</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通知所有订阅者更新</span></span><br><span class="line">  <span class="title function_">notify</span> () &#123;</span><br><span class="line">    <span class="comment">// 稳定订阅者列表</span></span><br><span class="line">    <span class="keyword">const</span> subs = <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">slice</span>()</span><br><span class="line">    <span class="comment">// 通知所有订阅者</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">      subs[i].<span class="title function_">update</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前正在评估的Watcher</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> targetStack = []</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置当前Watcher</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">pushTarget</span> (<span class="params">target</span>) &#123;</span><br><span class="line">  targetStack.<span class="title function_">push</span>(target)</span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = target</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恢复之前的Watcher</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">popTarget</span> (<span class="params"></span>) &#123;</span><br><span class="line">  targetStack.<span class="title function_">pop</span>()</span><br><span class="line">  <span class="title class_">Dep</span>.<span class="property">target</span> = targetStack[targetStack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h4><p>Watcher类是依赖的具体实现，负责执行更新操作：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/watcher.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (<span class="params"></span></span><br><span class="line"><span class="params">    vm,</span></span><br><span class="line"><span class="params">    expOrFn,</span></span><br><span class="line"><span class="params">    cb,</span></span><br><span class="line"><span class="params">    options,</span></span><br><span class="line"><span class="params">    isRenderWatcher</span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vm</span> = vm</span><br><span class="line">    <span class="keyword">if</span> (isRenderWatcher) &#123;</span><br><span class="line">      vm.<span class="property">_watcher</span> = <span class="variable language_">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    vm.<span class="property">_watchers</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 选项</span></span><br><span class="line">    <span class="keyword">if</span> (options) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deep</span> = !!options.<span class="property">deep</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">user</span> = !!options.<span class="property">user</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">lazy</span> = !!options.<span class="property">lazy</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">sync</span> = !!options.<span class="property">sync</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">before</span> = options.<span class="property">before</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deep</span> = <span class="variable language_">this</span>.<span class="property">user</span> = <span class="variable language_">this</span>.<span class="property">lazy</span> = <span class="variable language_">this</span>.<span class="property">sync</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cb</span> = cb</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">id</span> = ++uid <span class="comment">// uid for batching</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="variable language_">this</span>.<span class="property">lazy</span> <span class="comment">// for lazy watchers</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deps</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDeps</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">depIds</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDepIds</span> = <span class="keyword">new</span> <span class="title class_">Set</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">expression</span> = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span></span><br><span class="line">      ? expOrFn.<span class="title function_">toString</span>()</span><br><span class="line">      : <span class="string">&#x27;&#x27;</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">// 解析表达式</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = expOrFn</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">getter</span> = <span class="title function_">parsePath</span>(expOrFn)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">getter</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">getter</span> = noop</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="property">lazy</span></span><br><span class="line">      ? <span class="literal">undefined</span></span><br><span class="line">      : <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取值并收集依赖</span></span><br><span class="line">  <span class="title function_">get</span> () &#123;</span><br><span class="line">    <span class="title function_">pushTarget</span>(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="keyword">let</span> value</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="variable language_">this</span>.<span class="property">vm</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 执行getter，触发依赖收集</span></span><br><span class="line">      value = <span class="variable language_">this</span>.<span class="property">getter</span>.<span class="title function_">call</span>(vm, vm)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">user</span>) &#123;</span><br><span class="line">        <span class="title function_">handleError</span>(e, vm, <span class="string">`getter for watcher &quot;<span class="subst">$&#123;<span class="variable language_">this</span>.expression&#125;</span>&quot;`</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> e</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// 处理深度监听</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">deep</span>) &#123;</span><br><span class="line">        <span class="title function_">traverse</span>(value)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">popTarget</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">cleanupDeps</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加依赖</span></span><br><span class="line">  <span class="title function_">addDep</span> (dep) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = dep.<span class="property">id</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">add</span>(id)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">newDeps</span>.<span class="title function_">push</span>(dep)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">depIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">        dep.<span class="title function_">addSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清理依赖</span></span><br><span class="line">  <span class="title function_">cleanupDeps</span> () &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="property">length</span></span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> dep = <span class="variable language_">this</span>.<span class="property">deps</span>[i]</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">has</span>(dep.<span class="property">id</span>)) &#123;</span><br><span class="line">        dep.<span class="title function_">removeSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> tmp = <span class="variable language_">this</span>.<span class="property">depIds</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">depIds</span> = <span class="variable language_">this</span>.<span class="property">newDepIds</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDepIds</span> = tmp</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">clear</span>()</span><br><span class="line">    tmp = <span class="variable language_">this</span>.<span class="property">deps</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">deps</span> = <span class="variable language_">this</span>.<span class="property">newDeps</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDeps</span> = tmp</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">newDeps</span>.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新</span></span><br><span class="line">  <span class="title function_">update</span> () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">lazy</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">sync</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">run</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">queueWatcher</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行更新</span></span><br><span class="line">  <span class="title function_">run</span> () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        value !== <span class="variable language_">this</span>.<span class="property">value</span> ||</span><br><span class="line">        <span class="title function_">isObject</span>(value) ||</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deep</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// 设置新值</span></span><br><span class="line">        <span class="keyword">const</span> oldValue = <span class="variable language_">this</span>.<span class="property">value</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">user</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">cb</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">vm</span>, value, oldValue)</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="title function_">handleError</span>(e, <span class="variable language_">this</span>.<span class="property">vm</span>, <span class="string">`callback for watcher &quot;<span class="subst">$&#123;<span class="variable language_">this</span>.expression&#125;</span>&quot;`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">cb</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">vm</span>, value, oldValue)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算属性的求值</span></span><br><span class="line">  <span class="title function_">evaluate</span> () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 收集所有依赖</span></span><br><span class="line">  <span class="title function_">depend</span> () &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="property">length</span></span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">deps</span>[i].<span class="title function_">depend</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 销毁</span></span><br><span class="line">  <span class="title function_">teardown</span> () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">vm</span>.<span class="property">_isBeingDestroyed</span>) &#123;</span><br><span class="line">        <span class="title function_">remove</span>(<span class="variable language_">this</span>.<span class="property">vm</span>.<span class="property">_watchers</span>, <span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">deps</span>.<span class="property">length</span></span><br><span class="line">      <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deps</span>[i].<span class="title function_">removeSub</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">active</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1-3-数组响应式处理"><a href="#1-3-数组响应式处理" class="headerlink" title="1.3 数组响应式处理"></a>1.3 数组响应式处理</h3><p>Vue 2对数组的变异方法进行了特殊处理，以实现数组的响应式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/observer/array.js (简化版)</span></span><br><span class="line"><span class="keyword">import</span> &#123; def &#125; <span class="keyword">from</span> <span class="string">&#x27;../util/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arrayProto = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line"><span class="comment">// 创建一个对象，该对象的原型指向Array.prototype</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> arrayMethods = <span class="title class_">Object</span>.<span class="title function_">create</span>(arrayProto)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要拦截的数组方法</span></span><br><span class="line"><span class="keyword">const</span> methodsToPatch = [</span><br><span class="line">  <span class="string">&#x27;push&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;pop&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;shift&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;unshift&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;splice&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;sort&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;reverse&#x27;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拦截数组方法</span></span><br><span class="line">methodsToPatch.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">method</span>) &#123;</span><br><span class="line">  <span class="comment">// 缓存原始方法</span></span><br><span class="line">  <span class="keyword">const</span> original = arrayProto[method]</span><br><span class="line">  <span class="title function_">def</span>(arrayMethods, method, <span class="keyword">function</span> <span class="title function_">mutator</span> (<span class="params">...args</span>) &#123;</span><br><span class="line">    <span class="comment">// 调用原始方法</span></span><br><span class="line">    <span class="keyword">const</span> result = original.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">    <span class="comment">// 获取Observer实例</span></span><br><span class="line">    <span class="keyword">const</span> ob = <span class="variable language_">this</span>.<span class="property">__ob__</span></span><br><span class="line">    <span class="keyword">let</span> inserted</span><br><span class="line">    <span class="comment">// 对新增的元素进行观察</span></span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;push&#x27;</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;unshift&#x27;</span>:</span><br><span class="line">        inserted = args</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;splice&#x27;</span>:</span><br><span class="line">        inserted = args.<span class="title function_">slice</span>(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inserted) ob.<span class="title function_">observeArray</span>(inserted)</span><br><span class="line">    <span class="comment">// 通知更新</span></span><br><span class="line">    ob.<span class="property">dep</span>.<span class="title function_">notify</span>()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="二、组件系统与渲染机制"><a href="#二、组件系统与渲染机制" class="headerlink" title="二、组件系统与渲染机制"></a>二、组件系统与渲染机制</h2><p>Vue 2的组件系统是构建用户界面的核心，它基于虚拟DOM实现高效的渲染。</p><h3 id="2-1-Vue实例创建"><a href="#2-1-Vue实例创建" class="headerlink" title="2.1 Vue实例创建"></a>2.1 Vue实例创建</h3><p>Vue实例的创建过程：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/index.js (简化版)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Vue</span> (<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    !(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Vue</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">&#x27;Vue is a constructor and should be called with the `new` keyword&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 混入核心方法</span></span><br><span class="line"><span class="title function_">initMixin</span>(<span class="title class_">Vue</span>)       <span class="comment">// 实现 _init 方法</span></span><br><span class="line"><span class="title function_">stateMixin</span>(<span class="title class_">Vue</span>)      <span class="comment">// 实现 $data, $props, $set, $delete, $watch 等</span></span><br><span class="line"><span class="title function_">eventsMixin</span>(<span class="title class_">Vue</span>)     <span class="comment">// 实现 $on, $once, $off, $emit 等</span></span><br><span class="line"><span class="title function_">lifecycleMixin</span>(<span class="title class_">Vue</span>)  <span class="comment">// 实现 _update, $forceUpdate, $destroy 等</span></span><br><span class="line"><span class="title function_">renderMixin</span>(<span class="title class_">Vue</span>)     <span class="comment">// 实现 $nextTick, _render 等</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure><h4 id="init方法"><a href="#init方法" class="headerlink" title="_init方法"></a>_init方法</h4><p><code>_init</code>方法是Vue实例初始化的入口：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/init.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">initMixin</span> (<span class="params">Vue</span>) &#123;</span><br><span class="line">  <span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="variable language_">this</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 合并选项</span></span><br><span class="line">    <span class="keyword">if</span> (options &amp;&amp; options.<span class="property">_isComponent</span>) &#123;</span><br><span class="line">      <span class="comment">// 优化内部组件实例化</span></span><br><span class="line">      <span class="title function_">initInternalComponent</span>(vm, options)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vm.<span class="property">$options</span> = <span class="title function_">mergeOptions</span>(</span><br><span class="line">        <span class="title function_">resolveConstructorOptions</span>(vm.<span class="property">constructor</span>),</span><br><span class="line">        options || &#123;&#125;,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化生命周期</span></span><br><span class="line">    <span class="title function_">initLifecycle</span>(vm)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化事件</span></span><br><span class="line">    <span class="title function_">initEvents</span>(vm)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化渲染</span></span><br><span class="line">    <span class="title function_">initRender</span>(vm)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用beforeCreate钩子</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeCreate&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化注入内容</span></span><br><span class="line">    <span class="title function_">initInjections</span>(vm)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化状态</span></span><br><span class="line">    <span class="title function_">initState</span>(vm)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化提供内容</span></span><br><span class="line">    <span class="title function_">initProvide</span>(vm)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用created钩子</span></span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;created&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有el选项，自动挂载</span></span><br><span class="line">    <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">el</span>) &#123;</span><br><span class="line">      vm.$mount(vm.<span class="property">$options</span>.<span class="property">el</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-虚拟DOM-VNode"><a href="#2-2-虚拟DOM-VNode" class="headerlink" title="2.2 虚拟DOM (VNode)"></a>2.2 虚拟DOM (VNode)</h3><p>VNode是Vue中虚拟DOM节点的表示：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/vdom/vnode.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="attr">tag</span>: string | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;</span><br><span class="line">  <span class="attr">text</span>: string | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">elm</span>: <span class="title class_">Node</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">ns</span>: string | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">context</span>: <span class="title class_">Component</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">key</span>: string | number | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">componentOptions</span>: <span class="title class_">VNodeComponentOptions</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">componentInstance</span>: <span class="title class_">Component</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">parent</span>: <span class="title class_">VNode</span> | <span class="keyword">void</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 以下是一些标志位</span></span><br><span class="line">  <span class="attr">raw</span>: boolean</span><br><span class="line">  <span class="attr">isStatic</span>: boolean</span><br><span class="line">  <span class="attr">isRootInsert</span>: boolean</span><br><span class="line">  <span class="attr">isComment</span>: boolean</span><br><span class="line">  <span class="attr">isCloned</span>: boolean</span><br><span class="line">  <span class="attr">isOnce</span>: boolean</span><br><span class="line">  <span class="attr">asyncFactory</span>: <span class="title class_">Function</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">asyncMeta</span>: <span class="title class_">Object</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">isAsyncPlaceholder</span>: boolean</span><br><span class="line">  <span class="attr">ssrContext</span>: <span class="title class_">Object</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">fnContext</span>: <span class="title class_">Component</span> | <span class="keyword">void</span></span><br><span class="line">  <span class="attr">fnOptions</span>: ?<span class="title class_">ComponentOptions</span></span><br><span class="line">  <span class="attr">fnScopeId</span>: ?string</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span> (<span class="params"></span></span><br><span class="line"><span class="params">    tag?: string,</span></span><br><span class="line"><span class="params">    data?: VNodeData,</span></span><br><span class="line"><span class="params">    children?: ?<span class="built_in">Array</span>&lt;VNode&gt;,</span></span><br><span class="line"><span class="params">    text?: string,</span></span><br><span class="line"><span class="params">    elm?: Node,</span></span><br><span class="line"><span class="params">    context?: Component,</span></span><br><span class="line"><span class="params">    componentOptions?: VNodeComponentOptions,</span></span><br><span class="line"><span class="params">    asyncFactory?: <span class="built_in">Function</span></span></span><br><span class="line"><span class="params">  </span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tag</span> = tag</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = data</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">children</span> = children</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">text</span> = text</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">elm</span> = elm</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">ns</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">context</span> = context</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnContext</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnOptions</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">fnScopeId</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">key</span> = data &amp;&amp; data.<span class="property">key</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentOptions</span> = componentOptions</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">componentInstance</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">parent</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">raw</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isStatic</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isRootInsert</span> = <span class="literal">true</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isComment</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isCloned</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isOnce</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncFactory</span> = asyncFactory</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">asyncMeta</span> = <span class="literal">undefined</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isAsyncPlaceholder</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于调试</span></span><br><span class="line">  get <span class="title function_">child</span> (): <span class="title class_">Component</span> | <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">componentInstance</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-3-渲染与更新"><a href="#2-3-渲染与更新" class="headerlink" title="2.3 渲染与更新"></a>2.3 渲染与更新</h3><p>Vue 2的渲染和更新过程主要涉及<code>_render</code>和<code>_update</code>方法：</p><h4 id="render方法"><a href="#render方法" class="headerlink" title="_render方法"></a>_render方法</h4><p><code>_render</code>方法用于生成虚拟DOM：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/render.js (简化版)</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_render</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> vm = <span class="variable language_">this</span></span><br><span class="line">  <span class="keyword">const</span> &#123; render, _parentVnode &#125; = vm.<span class="property">$options</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置父VNode</span></span><br><span class="line">  <span class="keyword">if</span> (_parentVnode) &#123;</span><br><span class="line">    vm.<span class="property">$scopedSlots</span> = <span class="title function_">normalizeScopedSlots</span>(</span><br><span class="line">      _parentVnode.<span class="property">data</span>.<span class="property">scopedSlots</span>,</span><br><span class="line">      vm.<span class="property">$slots</span>,</span><br><span class="line">      vm.<span class="property">$scopedSlots</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置父节点</span></span><br><span class="line">  vm.<span class="property">$vnode</span> = _parentVnode</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 渲染VNode</span></span><br><span class="line">  <span class="keyword">let</span> vnode</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 调用render函数生成VNode</span></span><br><span class="line">    currentRenderingInstance = vm</span><br><span class="line">    vnode = render.<span class="title function_">call</span>(vm.<span class="property">_renderProxy</span>, vm.<span class="property">$createElement</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="title function_">handleError</span>(e, vm, <span class="string">`render`</span>)</span><br><span class="line">    <span class="comment">// 渲染错误时的处理</span></span><br><span class="line">    vnode = vm.<span class="property">_vnode</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    currentRenderingInstance = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果返回数组，则创建一个Fragment节点</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(vnode) &amp;&amp; vnode.<span class="property">length</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    vnode = vnode[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果render函数出错，创建空VNode</span></span><br><span class="line">  <span class="keyword">if</span> (!(vnode <span class="keyword">instanceof</span> <span class="title class_">VNode</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(vnode)) &#123;</span><br><span class="line">      <span class="title function_">warn</span>(</span><br><span class="line">        <span class="string">&#x27;Multiple root nodes returned from render function. Render function &#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;should return a single root node.&#x27;</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    vnode = <span class="title function_">createEmptyVNode</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 设置父节点</span></span><br><span class="line">  vnode.<span class="property">parent</span> = _parentVnode</span><br><span class="line">  <span class="keyword">return</span> vnode</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="update方法"><a href="#update方法" class="headerlink" title="_update方法"></a>_update方法</h4><p><code>_update</code>方法用于将虚拟DOM渲染为真实DOM：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/lifecycle.js (简化版)</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span> (<span class="params">vnode, hydrating</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> vm = <span class="variable language_">this</span></span><br><span class="line">  <span class="keyword">const</span> prevEl = vm.<span class="property">$el</span></span><br><span class="line">  <span class="keyword">const</span> prevVnode = vm.<span class="property">_vnode</span></span><br><span class="line">  <span class="keyword">const</span> restoreActiveInstance = <span class="title function_">setActiveInstance</span>(vm)</span><br><span class="line">  </span><br><span class="line">  vm.<span class="property">_vnode</span> = vnode</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 首次渲染</span></span><br><span class="line">  <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">    <span class="comment">// 初始渲染</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(vm.<span class="property">$el</span>, vnode, hydrating, <span class="literal">false</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(prevVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="title function_">restoreActiveInstance</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 更新__vue__引用</span></span><br><span class="line">  <span class="keyword">if</span> (prevEl) &#123;</span><br><span class="line">    prevEl.<span class="property">__vue__</span> = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$el</span>) &#123;</span><br><span class="line">    vm.<span class="property">$el</span>.<span class="property">__vue__</span> = vm</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果父节点是HOC，也更新其$el</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$vnode</span> &amp;&amp; vm.<span class="property">$parent</span> &amp;&amp; vm.<span class="property">$vnode</span> === vm.<span class="property">$parent</span>.<span class="property">_vnode</span>) &#123;</span><br><span class="line">    vm.<span class="property">$parent</span>.<span class="property">$el</span> = vm.<span class="property">$el</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-Patch算法"><a href="#2-4-Patch算法" class="headerlink" title="2.4 Patch算法"></a>2.4 Patch算法</h3><p>Patch算法是Vue 2中的核心Diff算法，用于高效更新DOM：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/vdom/patch.js (简化版)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">patch</span> (<span class="params">oldVnode, vnode, hydrating, removeOnly</span>) &#123;</span><br><span class="line">  <span class="comment">// 如果新VNode不存在但旧VNode存在，则销毁旧VNode</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode)) <span class="title function_">invokeDestroyHook</span>(oldVnode)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> isInitialPatch = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> insertedVnodeQueue = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果旧VNode不存在，则创建新元素</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldVnode)) &#123;</span><br><span class="line">    isInitialPatch = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">createElm</span>(vnode, insertedVnodeQueue)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 判断是否为真实DOM</span></span><br><span class="line">    <span class="keyword">const</span> isRealElement = <span class="title function_">isDef</span>(oldVnode.<span class="property">nodeType</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 不是真实DOM且是相同类型的VNode</span></span><br><span class="line">    <span class="keyword">if</span> (!isRealElement &amp;&amp; <span class="title function_">sameVnode</span>(oldVnode, vnode)) &#123;</span><br><span class="line">      <span class="comment">// 更新已存在的节点</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, <span class="literal">null</span>, <span class="literal">null</span>, removeOnly)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 是真实DOM，创建空的VNode</span></span><br><span class="line">      <span class="keyword">if</span> (isRealElement) &#123;</span><br><span class="line">        <span class="comment">// 挂载到真实元素上</span></span><br><span class="line">        <span class="keyword">if</span> (oldVnode.<span class="property">nodeType</span> === <span class="number">1</span> &amp;&amp; oldVnode.<span class="title function_">hasAttribute</span>(<span class="variable constant_">SSR_ATTR</span>)) &#123;</span><br><span class="line">          oldVnode.<span class="title function_">removeAttribute</span>(<span class="variable constant_">SSR_ATTR</span>)</span><br><span class="line">          hydrating = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isTrue</span>(hydrating)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">hydrate</span>(oldVnode, vnode, insertedVnodeQueue)) &#123;</span><br><span class="line">            <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, <span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">return</span> oldVnode</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 不是服务端渲染或混合失败，创建空VNode</span></span><br><span class="line">        oldVnode = <span class="title function_">emptyNodeAt</span>(oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 替换已存在的元素</span></span><br><span class="line">      <span class="keyword">const</span> oldElm = oldVnode.<span class="property">elm</span></span><br><span class="line">      <span class="keyword">const</span> parentElm = nodeOps.<span class="title function_">parentNode</span>(oldElm)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建新节点</span></span><br><span class="line">      <span class="title function_">createElm</span>(</span><br><span class="line">        vnode,</span><br><span class="line">        insertedVnodeQueue,</span><br><span class="line">        parentElm,</span><br><span class="line">        nodeOps.<span class="title function_">nextSibling</span>(oldElm)</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 销毁旧节点</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(parentElm)) &#123;</span><br><span class="line">        <span class="title function_">removeVnodes</span>([oldVnode], <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">tag</span>)) &#123;</span><br><span class="line">        <span class="title function_">invokeDestroyHook</span>(oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch)</span><br><span class="line">  <span class="keyword">return</span> vnode.<span class="property">elm</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="patchVnode"><a href="#patchVnode" class="headerlink" title="patchVnode"></a>patchVnode</h4><p><code>patchVnode</code>函数用于更新已存在的节点：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/vdom/patch.js (简化版)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">patchVnode</span> (<span class="params"></span></span><br><span class="line"><span class="params">  oldVnode,</span></span><br><span class="line"><span class="params">  vnode,</span></span><br><span class="line"><span class="params">  insertedVnodeQueue,</span></span><br><span class="line"><span class="params">  ownerArray,</span></span><br><span class="line"><span class="params">  index,</span></span><br><span class="line"><span class="params">  removeOnly</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 如果新旧VNode相同，直接返回</span></span><br><span class="line">  <span class="keyword">if</span> (oldVnode === vnode) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 复用DOM元素</span></span><br><span class="line">  <span class="keyword">const</span> elm = vnode.<span class="property">elm</span> = oldVnode.<span class="property">elm</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 异步占位符</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTrue</span>(oldVnode.<span class="property">isAsyncPlaceholder</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(vnode.<span class="property">asyncFactory</span>.<span class="property">resolved</span>)) &#123;</span><br><span class="line">      <span class="title function_">hydrate</span>(oldVnode.<span class="property">elm</span>, vnode, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vnode.<span class="property">isAsyncPlaceholder</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 静态节点优化</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isTrue</span>(vnode.<span class="property">isStatic</span>) &amp;&amp;</span><br><span class="line">    <span class="title function_">isTrue</span>(oldVnode.<span class="property">isStatic</span>) &amp;&amp;</span><br><span class="line">    vnode.<span class="property">key</span> === oldVnode.<span class="property">key</span> &amp;&amp;</span><br><span class="line">    (<span class="title function_">isTrue</span>(vnode.<span class="property">isCloned</span>) || <span class="title function_">isTrue</span>(vnode.<span class="property">isOnce</span>))</span><br><span class="line">  ) &#123;</span><br><span class="line">    vnode.<span class="property">componentInstance</span> = oldVnode.<span class="property">componentInstance</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行组件prepatch钩子</span></span><br><span class="line">  <span class="keyword">let</span> i</span><br><span class="line">  <span class="keyword">const</span> data = vnode.<span class="property">data</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isDef</span>(i = data.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">prepatch</span>)) &#123;</span><br><span class="line">    <span class="title function_">i</span>(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取子节点</span></span><br><span class="line">  <span class="keyword">const</span> oldCh = oldVnode.<span class="property">children</span></span><br><span class="line">  <span class="keyword">const</span> ch = vnode.<span class="property">children</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行更新钩子</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isPatchable</span>(vnode)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.<span class="property">update</span>.<span class="property">length</span>; ++i) cbs.<span class="property">update</span>[i](oldVnode, vnode)</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(i = data.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">update</span>)) <span class="title function_">i</span>(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果新VNode没有文本</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode.<span class="property">text</span>)) &#123;</span><br><span class="line">    <span class="comment">// 如果新旧VNode都有子节点</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh) &amp;&amp; <span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">      <span class="comment">// 更新子节点</span></span><br><span class="line">      <span class="keyword">if</span> (oldCh !== ch) <span class="title function_">updateChildren</span>(elm, oldCh, ch, insertedVnodeQueue, removeOnly)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">      <span class="comment">// 如果只有新VNode有子节点</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">      <span class="title function_">addVnodes</span>(elm, <span class="literal">null</span>, ch, <span class="number">0</span>, ch.<span class="property">length</span> - <span class="number">1</span>, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh)) &#123;</span><br><span class="line">      <span class="comment">// 如果只有旧VNode有子节点</span></span><br><span class="line">      <span class="title function_">removeVnodes</span>(oldCh, <span class="number">0</span>, oldCh.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) &#123;</span><br><span class="line">      <span class="comment">// 如果旧VNode有文本，清空</span></span><br><span class="line">      nodeOps.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVnode.<span class="property">text</span> !== vnode.<span class="property">text</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果文本不同，更新文本</span></span><br><span class="line">    nodeOps.<span class="title function_">setTextContent</span>(elm, vnode.<span class="property">text</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 执行postpatch钩子</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">isDef</span>(data)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(i = data.<span class="property">hook</span>) &amp;&amp; <span class="title function_">isDef</span>(i = i.<span class="property">postpatch</span>)) <span class="title function_">i</span>(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="updateChildren"><a href="#updateChildren" class="headerlink" title="updateChildren"></a>updateChildren</h4><p><code>updateChildren</code>函数是Vue 2中的核心Diff算法，用于高效更新子节点：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/vdom/patch.js (简化版)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateChildren</span> (<span class="params"></span></span><br><span class="line"><span class="params">  parentElm,</span></span><br><span class="line"><span class="params">  oldCh,</span></span><br><span class="line"><span class="params">  newCh,</span></span><br><span class="line"><span class="params">  insertedVnodeQueue,</span></span><br><span class="line"><span class="params">  removeOnly</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> oldStartIdx = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> newStartIdx = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> oldEndIdx = oldCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> oldStartVnode = oldCh[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">let</span> oldEndVnode = oldCh[oldEndIdx]</span><br><span class="line">  <span class="keyword">let</span> newEndIdx = newCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> newStartVnode = newCh[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">let</span> newEndVnode = newCh[newEndIdx]</span><br><span class="line">  <span class="keyword">let</span> oldKeyToIdx, idxInOld, vnodeToMove, refElm</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否是简单移动</span></span><br><span class="line">  <span class="keyword">const</span> canMove = !removeOnly</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 双端比较算法</span></span><br><span class="line">  <span class="keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldStartVnode)) &#123;</span><br><span class="line">      <span class="comment">// 旧起始节点为空，移动指针</span></span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldEndVnode)) &#123;</span><br><span class="line">      <span class="comment">// 旧结束节点为空，移动指针</span></span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="comment">// 旧起始和新起始节点相同</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="comment">// 旧结束和新结束节点相同</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">      newEndVnode = newCh[--newEndIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newEndVnode)) &#123;</span><br><span class="line">      <span class="comment">// 旧起始和新结束节点相同</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx)</span><br><span class="line">      <span class="comment">// 将旧起始节点移动到最后</span></span><br><span class="line">      canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, oldStartVnode.<span class="property">elm</span>, nodeOps.<span class="title function_">nextSibling</span>(oldEndVnode.<span class="property">elm</span>))</span><br><span class="line">      oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">      newEndVnode = newCh[--newEndIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newStartVnode)) &#123;</span><br><span class="line">      <span class="comment">// 旧结束和新起始节点相同</span></span><br><span class="line">      <span class="title function_">patchVnode</span>(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">      <span class="comment">// 将旧结束节点移动到最前</span></span><br><span class="line">      canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, oldEndVnode.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>)</span><br><span class="line">      oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 以上四种情况都不满足</span></span><br><span class="line">      <span class="comment">// 创建key到索引的映射</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldKeyToIdx)) oldKeyToIdx = <span class="title function_">createKeyToOldIdx</span>(oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">      <span class="comment">// 在旧子节点中查找新起始节点的位置</span></span><br><span class="line">      idxInOld = <span class="title function_">isDef</span>(newStartVnode.<span class="property">key</span>)</span><br><span class="line">        ? oldKeyToIdx[newStartVnode.<span class="property">key</span>]</span><br><span class="line">        : <span class="title function_">findIdxInOld</span>(newStartVnode, oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 如果没找到，创建新元素</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isUndef</span>(idxInOld)) &#123;</span><br><span class="line">        <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 找到了，获取要移动的节点</span></span><br><span class="line">        vnodeToMove = oldCh[idxInOld]</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(vnodeToMove, newStartVnode)) &#123;</span><br><span class="line">          <span class="comment">// 节点相同，进行patch</span></span><br><span class="line">          <span class="title function_">patchVnode</span>(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx)</span><br><span class="line">          oldCh[idxInOld] = <span class="literal">undefined</span></span><br><span class="line">          <span class="comment">// 移动节点</span></span><br><span class="line">          canMove &amp;&amp; nodeOps.<span class="title function_">insertBefore</span>(parentElm, vnodeToMove.<span class="property">elm</span>, oldStartVnode.<span class="property">elm</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 相同key但不是相同节点，创建新元素</span></span><br><span class="line">          <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.<span class="property">elm</span>, <span class="literal">false</span>, newCh, newStartIdx)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      newStartVnode = newCh[++newStartIdx]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 处理剩余节点</span></span><br><span class="line">  <span class="keyword">if</span> (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">    <span class="comment">// 旧子节点处理完，添加剩余的新子节点</span></span><br><span class="line">    refElm = <span class="title function_">isUndef</span>(newCh[newEndIdx + <span class="number">1</span>]) ? <span class="literal">null</span> : newCh[newEndIdx + <span class="number">1</span>].<span class="property">elm</span></span><br><span class="line">    <span class="title function_">addVnodes</span>(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStartIdx &gt; newEndIdx) &#123;</span><br><span class="line">    <span class="comment">// 新子节点处理完，移除剩余的旧子节点</span></span><br><span class="line">    <span class="title function_">removeVnodes</span>(oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="三、生命周期与指令系统"><a href="#三、生命周期与指令系统" class="headerlink" title="三、生命周期与指令系统"></a>三、生命周期与指令系统</h2><h3 id="3-1-生命周期钩子"><a href="#3-1-生命周期钩子" class="headerlink" title="3.1 生命周期钩子"></a>3.1 生命周期钩子</h3><p>Vue 2的生命周期钩子是在特定阶段调用的函数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/instance/lifecycle.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">callHook</span> (<span class="params">vm, hook</span>) &#123;</span><br><span class="line">  <span class="comment">// 禁用依赖收集</span></span><br><span class="line">  <span class="title function_">pushTarget</span>()</span><br><span class="line">  <span class="keyword">const</span> handlers = vm.<span class="property">$options</span>[hook]</span><br><span class="line">  <span class="keyword">const</span> info = <span class="string">`<span class="subst">$&#123;hook&#125;</span> hook`</span></span><br><span class="line">  <span class="keyword">if</span> (handlers) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, j = handlers.<span class="property">length</span>; i &lt; j; i++) &#123;</span><br><span class="line">      <span class="title function_">invokeWithErrorHandling</span>(handlers[i], vm, <span class="literal">null</span>, vm, info)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">_hasHookEvent</span>) &#123;</span><br><span class="line">    vm.$emit(<span class="string">&#x27;hook:&#x27;</span> + hook)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">popTarget</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生命周期钩子的调用时机：</p><ol><li><strong>beforeCreate</strong>: 在实例初始化之后，数据观测和事件配置之前</li><li><strong>created</strong>: 在实例创建完成后，数据观测、属性和方法的运算，watch&#x2F;event事件回调已完成</li><li><strong>beforeMount</strong>: 在挂载开始之前被调用</li><li><strong>mounted</strong>: 在挂载完成后调用</li><li><strong>beforeUpdate</strong>: 数据更新时调用，发生在虚拟DOM重新渲染和打补丁之前</li><li><strong>updated</strong>: 数据更改导致的虚拟DOM重新渲染和打补丁之后调用</li><li><strong>beforeDestroy</strong>: 实例销毁之前调用</li><li><strong>destroyed</strong>: 实例销毁后调用</li></ol><h3 id="3-2-指令系统"><a href="#3-2-指令系统" class="headerlink" title="3.2 指令系统"></a>3.2 指令系统</h3><p>Vue 2的指令系统允许开发者扩展HTML的功能：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/core/vdom/modules/directives.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">create</span>: updateDirectives,</span><br><span class="line">  <span class="attr">update</span>: updateDirectives,</span><br><span class="line">  <span class="attr">destroy</span>: <span class="keyword">function</span> <span class="title function_">unbindDirectives</span> (<span class="params">vnode</span>) &#123;</span><br><span class="line">    <span class="title function_">updateDirectives</span>(vnode, emptyNode)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateDirectives</span> (<span class="params">oldVnode, vnode</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (oldVnode.<span class="property">data</span>.<span class="property">directives</span> || vnode.<span class="property">data</span>.<span class="property">directives</span>) &#123;</span><br><span class="line">    <span class="title function_">_update</span>(oldVnode, vnode)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_update</span> (<span class="params">oldVnode, vnode</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> isCreate = oldVnode === emptyNode</span><br><span class="line">  <span class="keyword">const</span> isDestroy = vnode === emptyNode</span><br><span class="line">  <span class="keyword">const</span> oldDirs = <span class="title function_">normalizeDirectives</span>(oldVnode.<span class="property">data</span>.<span class="property">directives</span>, oldVnode.<span class="property">context</span>)</span><br><span class="line">  <span class="keyword">const</span> newDirs = <span class="title function_">normalizeDirectives</span>(vnode.<span class="property">data</span>.<span class="property">directives</span>, vnode.<span class="property">context</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> dirsWithInsert = []</span><br><span class="line">  <span class="keyword">const</span> dirsWithPostpatch = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> key, oldDir, dir</span><br><span class="line">  <span class="keyword">for</span> (key <span class="keyword">in</span> newDirs) &#123;</span><br><span class="line">    oldDir = oldDirs[key]</span><br><span class="line">    dir = newDirs[key]</span><br><span class="line">    <span class="keyword">if</span> (!oldDir) &#123;</span><br><span class="line">      <span class="comment">// 新指令，调用bind</span></span><br><span class="line">      <span class="title function_">callHook</span>(dir, <span class="string">&#x27;bind&#x27;</span>, vnode, oldVnode)</span><br><span class="line">      <span class="keyword">if</span> (dir.<span class="property">def</span> &amp;&amp; dir.<span class="property">def</span>.<span class="property">inserted</span>) &#123;</span><br><span class="line">        dirsWithInsert.<span class="title function_">push</span>(dir)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 已存在的指令，调用update</span></span><br><span class="line">      dir.<span class="property">oldValue</span> = oldDir.<span class="property">value</span></span><br><span class="line">      dir.<span class="property">oldArg</span> = oldDir.<span class="property">arg</span></span><br><span class="line">      <span class="title function_">callHook</span>(dir, <span class="string">&#x27;update&#x27;</span>, vnode, oldVnode)</span><br><span class="line">      <span class="keyword">if</span> (dir.<span class="property">def</span> &amp;&amp; dir.<span class="property">def</span>.<span class="property">componentUpdated</span>) &#123;</span><br><span class="line">        dirsWithPostpatch.<span class="title function_">push</span>(dir)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理需要inserted钩子的指令</span></span><br><span class="line">  <span class="keyword">if</span> (dirsWithInsert.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">callInsert</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dirsWithInsert.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">callHook</span>(dirsWithInsert[i], <span class="string">&#x27;inserted&#x27;</span>, vnode, oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isCreate) &#123;</span><br><span class="line">      <span class="title function_">mergeVNodeHook</span>(vnode, <span class="string">&#x27;insert&#x27;</span>, callInsert)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="title function_">callInsert</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理需要componentUpdated钩子的指令</span></span><br><span class="line">  <span class="keyword">if</span> (dirsWithPostpatch.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="title function_">mergeVNodeHook</span>(vnode, <span class="string">&#x27;postpatch&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; dirsWithPostpatch.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="title function_">callHook</span>(dirsWithPostpatch[i], <span class="string">&#x27;componentUpdated&#x27;</span>, vnode, oldVnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理需要解绑的指令</span></span><br><span class="line">  <span class="keyword">if</span> (!isCreate) &#123;</span><br><span class="line">    <span class="keyword">for</span> (key <span class="keyword">in</span> oldDirs) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!newDirs[key]) &#123;</span><br><span class="line">        <span class="comment">// 不再存在的指令，调用unbind</span></span><br><span class="line">        <span class="title function_">callHook</span>(oldDirs[key], <span class="string">&#x27;unbind&#x27;</span>, oldVnode, oldVnode, isDestroy)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="四、编译器与模板解析"><a href="#四、编译器与模板解析" class="headerlink" title="四、编译器与模板解析"></a>四、编译器与模板解析</h2><p>Vue 2的编译器负责将模板转换为渲染函数。</p><h3 id="4-1-编译过程"><a href="#4-1-编译过程" class="headerlink" title="4.1 编译过程"></a>4.1 编译过程</h3><p>编译过程主要包括解析(parse)、优化(optimize)和生成(generate)三个阶段：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/compiler/index.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">compile</span> (<span class="params"></span></span><br><span class="line"><span class="params">  template,</span></span><br><span class="line"><span class="params">  options</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> finalOptions = <span class="title class_">Object</span>.<span class="title function_">create</span>(baseOptions)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 合并选项</span></span><br><span class="line">  <span class="keyword">if</span> (options) &#123;</span><br><span class="line">    <span class="comment">// 合并自定义模块</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">modules</span>) &#123;</span><br><span class="line">      finalOptions.<span class="property">modules</span> =</span><br><span class="line">        (baseOptions.<span class="property">modules</span> || []).<span class="title function_">concat</span>(options.<span class="property">modules</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 合并指令</span></span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">directives</span>) &#123;</span><br><span class="line">      finalOptions.<span class="property">directives</span> = <span class="title function_">extend</span>(</span><br><span class="line">        <span class="title class_">Object</span>.<span class="title function_">create</span>(baseOptions.<span class="property">directives</span> || <span class="literal">null</span>),</span><br><span class="line">        options.<span class="property">directives</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 复制其他选项</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> options) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key !== <span class="string">&#x27;modules&#x27;</span> &amp;&amp; key !== <span class="string">&#x27;directives&#x27;</span>) &#123;</span><br><span class="line">        finalOptions[key] = options[key]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编译模板</span></span><br><span class="line">  <span class="keyword">const</span> compiled = <span class="title function_">baseCompile</span>(template.<span class="title function_">trim</span>(), finalOptions)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 检查错误</span></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&#x27;production&#x27;</span>) &#123;</span><br><span class="line">    <span class="title function_">detectErrors</span>(compiled.<span class="property">ast</span>, warn)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  compiled.<span class="property">errors</span> = errors</span><br><span class="line">  compiled.<span class="property">tips</span> = tips</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> compiled</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 基础编译函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">baseCompile</span> (<span class="params"></span></span><br><span class="line"><span class="params">  template,</span></span><br><span class="line"><span class="params">  options</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 解析模板为AST</span></span><br><span class="line">  <span class="keyword">const</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 优化AST</span></span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">optimize</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_">optimize</span>(ast, options)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 生成代码</span></span><br><span class="line">  <span class="keyword">const</span> code = <span class="title function_">generate</span>(ast, options)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-解析-Parse"><a href="#4-2-解析-Parse" class="headerlink" title="4.2 解析(Parse)"></a>4.2 解析(Parse)</h3><p>解析阶段将模板字符串转换为抽象语法树(AST)：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/compiler/parser/index.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">parse</span> (<span class="params"></span></span><br><span class="line"><span class="params">  template,</span></span><br><span class="line"><span class="params">  options</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 解析选项</span></span><br><span class="line">  <span class="keyword">const</span> stack = []</span><br><span class="line">  <span class="keyword">let</span> root</span><br><span class="line">  <span class="keyword">let</span> currentParent</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// HTML解析器</span></span><br><span class="line">  <span class="title function_">parseHTML</span>(template, &#123;</span><br><span class="line">    <span class="title function_">start</span> (tag, attrs, unary, start, end) &#123;</span><br><span class="line">      <span class="comment">// 处理开始标签</span></span><br><span class="line">      <span class="keyword">const</span> element = <span class="title function_">createASTElement</span>(tag, attrs, currentParent)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 处理指令</span></span><br><span class="line">      <span class="title function_">processFor</span>(element)</span><br><span class="line">      <span class="title function_">processIf</span>(element)</span><br><span class="line">      <span class="title function_">processOnce</span>(element)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 树管理</span></span><br><span class="line">      <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">        root = element</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (currentParent &amp;&amp; !element.<span class="property">forbidden</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (element.<span class="property">elseif</span> || element.<span class="property">else</span>) &#123;</span><br><span class="line">          <span class="title function_">processIfConditions</span>(element, currentParent)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (element.<span class="property">slotScope</span>) &#123;</span><br><span class="line">            <span class="comment">// 作用域插槽</span></span><br><span class="line">            <span class="keyword">const</span> name = element.<span class="property">slotTarget</span> || <span class="string">&#x27;&quot;default&quot;&#x27;</span></span><br><span class="line">            ;(currentParent.<span class="property">scopedSlots</span> || (currentParent.<span class="property">scopedSlots</span> = &#123;&#125;))[name] = element</span><br><span class="line">          &#125;</span><br><span class="line">          currentParent.<span class="property">children</span>.<span class="title function_">push</span>(element)</span><br><span class="line">          element.<span class="property">parent</span> = currentParent</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 非自闭合标签入栈</span></span><br><span class="line">      <span class="keyword">if</span> (!unary) &#123;</span><br><span class="line">        currentParent = element</span><br><span class="line">        stack.<span class="title function_">push</span>(element)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">closeElement</span>(element)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">end</span> (tag, start, end) &#123;</span><br><span class="line">      <span class="comment">// 处理结束标签</span></span><br><span class="line">      <span class="keyword">const</span> element = stack[stack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">      <span class="comment">// 弹出栈</span></span><br><span class="line">      stack.<span class="property">length</span> -= <span class="number">1</span></span><br><span class="line">      currentParent = stack[stack.<span class="property">length</span> - <span class="number">1</span>]</span><br><span class="line">      <span class="title function_">closeElement</span>(element)</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">chars</span> (text, start, end) &#123;</span><br><span class="line">      <span class="comment">// 处理文本内容</span></span><br><span class="line">      <span class="keyword">if</span> (!currentParent) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">const</span> children = currentParent.<span class="property">children</span></span><br><span class="line">      <span class="keyword">if</span> (text) &#123;</span><br><span class="line">        <span class="keyword">let</span> res</span><br><span class="line">        <span class="keyword">let</span> child</span><br><span class="line">        <span class="keyword">if</span> (text !== <span class="string">&#x27; &#x27;</span> &amp;&amp; (res = <span class="title function_">parseText</span>(text, delimiters))) &#123;</span><br><span class="line">          <span class="comment">// 带表达式的文本</span></span><br><span class="line">          child = &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">expression</span>: res.<span class="property">expression</span>,</span><br><span class="line">            <span class="attr">tokens</span>: res.<span class="property">tokens</span>,</span><br><span class="line">            text</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (text !== <span class="string">&#x27; &#x27;</span> || !children.<span class="property">length</span> || children[children.<span class="property">length</span> - <span class="number">1</span>].<span class="property">text</span> !== <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">          <span class="comment">// 纯文本</span></span><br><span class="line">          child = &#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="number">3</span>,</span><br><span class="line">            text</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (child) &#123;</span><br><span class="line">          children.<span class="title function_">push</span>(child)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">comment</span> (text, start, end) &#123;</span><br><span class="line">      <span class="comment">// 处理注释</span></span><br><span class="line">      <span class="keyword">if</span> (currentParent) &#123;</span><br><span class="line">        <span class="keyword">const</span> child = &#123;</span><br><span class="line">          <span class="attr">type</span>: <span class="number">3</span>,</span><br><span class="line">          text,</span><br><span class="line">          <span class="attr">isComment</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        currentParent.<span class="property">children</span>.<span class="title function_">push</span>(child)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3-优化-Optimize"><a href="#4-3-优化-Optimize" class="headerlink" title="4.3 优化(Optimize)"></a>4.3 优化(Optimize)</h3><p>优化阶段标记静态节点，提高渲染性能：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/compiler/optimizer.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">optimize</span> (<span class="params">root, options</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!root) <span class="keyword">return</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 标记静态节点</span></span><br><span class="line">  <span class="title function_">markStatic</span>(root)</span><br><span class="line">  <span class="comment">// 标记静态根节点</span></span><br><span class="line">  <span class="title function_">markStaticRoots</span>(root, <span class="literal">false</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">markStatic</span> (<span class="params">node</span>) &#123;</span><br><span class="line">  <span class="comment">// 判断节点是否静态</span></span><br><span class="line">  node.<span class="property">static</span> = <span class="title function_">isStatic</span>(node)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 不要将组件插槽内容标记为静态</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !<span class="title function_">isPlatformReservedTag</span>(node.<span class="property">tag</span>) &amp;&amp;</span><br><span class="line">      node.<span class="property">tag</span> !== <span class="string">&#x27;slot&#x27;</span> &amp;&amp;</span><br><span class="line">      node.<span class="property">attrsMap</span>[<span class="string">&#x27;inline-template&#x27;</span>] == <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 递归处理子节点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = node.<span class="property">children</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> child = node.<span class="property">children</span>[i]</span><br><span class="line">      <span class="title function_">markStatic</span>(child)</span><br><span class="line">      <span class="comment">// 如果子节点不是静态的，父节点也不是</span></span><br><span class="line">      <span class="keyword">if</span> (!child.<span class="property">static</span>) &#123;</span><br><span class="line">        node.<span class="property">static</span> = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理条件节点</span></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">ifConditions</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>, l = node.<span class="property">ifConditions</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> block = node.<span class="property">ifConditions</span>[i].<span class="property">block</span></span><br><span class="line">        <span class="title function_">markStatic</span>(block)</span><br><span class="line">        <span class="keyword">if</span> (!block.<span class="property">static</span>) &#123;</span><br><span class="line">          node.<span class="property">static</span> = <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">markStaticRoots</span> (<span class="params">node, isInFor</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 静态节点或有v-once指令</span></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">static</span> || node.<span class="property">once</span>) &#123;</span><br><span class="line">      node.<span class="property">staticInFor</span> = isInFor</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对于有子节点且子节点不只是文本的静态节点，标记为静态根</span></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">static</span> &amp;&amp; node.<span class="property">children</span>.<span class="property">length</span> &amp;&amp; !(</span><br><span class="line">      node.<span class="property">children</span>.<span class="property">length</span> === <span class="number">1</span> &amp;&amp;</span><br><span class="line">      node.<span class="property">children</span>[<span class="number">0</span>].<span class="property">type</span> === <span class="number">3</span></span><br><span class="line">    )) &#123;</span><br><span class="line">      node.<span class="property">staticRoot</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      node.<span class="property">staticRoot</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 递归处理子节点</span></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">children</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = node.<span class="property">children</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="title function_">markStaticRoots</span>(node.<span class="property">children</span>[i], isInFor || !!node.<span class="property">for</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理条件节点</span></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">ifConditions</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>, l = node.<span class="property">ifConditions</span>.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="title function_">markStaticRoots</span>(node.<span class="property">ifConditions</span>[i].<span class="property">block</span>, isInFor)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-生成-Generate"><a href="#4-4-生成-Generate" class="headerlink" title="4.4 生成(Generate)"></a>4.4 生成(Generate)</h3><p>生成阶段将AST转换为渲染函数代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/compiler/codegen/index.js (简化版)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">generate</span> (<span class="params"></span></span><br><span class="line"><span class="params">  ast,</span></span><br><span class="line"><span class="params">  options</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> state = <span class="keyword">new</span> <span class="title class_">CodegenState</span>(options)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 根据AST生成代码</span></span><br><span class="line">  <span class="keyword">const</span> code = ast ? <span class="title function_">genElement</span>(ast, state) : <span class="string">&#x27;_c(&quot;div&quot;)&#x27;</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">render</span>: <span class="string">`with(this)&#123;return <span class="subst">$&#123;code&#125;</span>&#125;`</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: state.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">genElement</span> (<span class="params">el, state</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">parent</span>) &#123;</span><br><span class="line">    el.<span class="property">pre</span> = el.<span class="property">pre</span> || el.<span class="property">parent</span>.<span class="property">pre</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理静态根节点</span></span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">staticRoot</span> &amp;&amp; !el.<span class="property">staticProcessed</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genStatic</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">once</span> &amp;&amp; !el.<span class="property">onceProcessed</span>) &#123;</span><br><span class="line">    <span class="comment">// v-once</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genOnce</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">for</span> &amp;&amp; !el.<span class="property">forProcessed</span>) &#123;</span><br><span class="line">    <span class="comment">// v-for</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genFor</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">if</span> &amp;&amp; !el.<span class="property">ifProcessed</span>) &#123;</span><br><span class="line">    <span class="comment">// v-if</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genIf</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">tag</span> === <span class="string">&#x27;template&#x27;</span> &amp;&amp; !el.<span class="property">slotTarget</span> &amp;&amp; !state.<span class="property">pre</span>) &#123;</span><br><span class="line">    <span class="comment">// 模板</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genChildren</span>(el, state) || <span class="string">&#x27;void 0&#x27;</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el.<span class="property">tag</span> === <span class="string">&#x27;slot&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 插槽</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genSlot</span>(el, state)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 组件或元素</span></span><br><span class="line">    <span class="keyword">let</span> code</span><br><span class="line">    <span class="keyword">if</span> (el.<span class="property">component</span>) &#123;</span><br><span class="line">      <span class="comment">// 组件</span></span><br><span class="line">      code = <span class="title function_">genComponent</span>(el.<span class="property">component</span>, el, state)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> data</span><br><span class="line">      <span class="keyword">if</span> (!el.<span class="property">plain</span> || (el.<span class="property">pre</span> &amp;&amp; state.<span class="title function_">maybeComponent</span>(el))) &#123;</span><br><span class="line">        <span class="comment">// 生成元素数据</span></span><br><span class="line">        data = <span class="title function_">genData</span>(el, state)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> children = el.<span class="property">inlineTemplate</span> ? <span class="literal">null</span> : <span class="title function_">genChildren</span>(el, state, <span class="literal">true</span>)</span><br><span class="line">      code = <span class="string">`_c(&#x27;<span class="subst">$&#123;el.tag&#125;</span>&#x27;<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        data ? <span class="string">`,<span class="subst">$&#123;data&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span> // 数据</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span><span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">        children ? <span class="string">`,<span class="subst">$&#123;children&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span> // 子节点</span></span></span><br><span class="line"><span class="subst"><span class="string">      &#125;</span>)`</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 模块转换</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; state.<span class="property">transforms</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      code = state.<span class="property">transforms</span>[i](el, code)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Vue 2源码的核心亮点：</p><ol><li><strong>响应式系统</strong>：基于Object.defineProperty的数据劫持和发布订阅模式，实现数据与视图的自动同步</li><li><strong>虚拟DOM</strong>：通过JavaScript对象表示DOM结构，配合高效的Diff算法实现最小化DOM操作</li><li><strong>组件系统</strong>：组件是Vue的核心抽象，提供了组合、复用和封装的能力</li><li><strong>编译系统</strong>：将模板编译为渲染函数，支持指令、插值等特性</li><li><strong>生命周期</strong>：提供完整的组件生命周期钩子，方便开发者在不同阶段执行逻辑</li></ol><p>Vue 2的源码设计体现了优秀的前端框架架构思想，通过深入理解其实现原理，可以更好地使用Vue进行开发，也能学习到很多前端工程化的最佳实践。</p>]]></content>
      
      
      <categories>
          
          <category> vue2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React自定义Hook让逻辑复用</title>
      <link href="/2021/01/01/%E5%89%8D%E7%AB%AF/react/React%E8%87%AA%E5%AE%9A%E4%B9%89Hook%E8%AE%A9%E9%80%BB%E8%BE%91%E5%A4%8D%E7%94%A8/"/>
      <url>/2021/01/01/%E5%89%8D%E7%AB%AF/react/React%E8%87%AA%E5%AE%9A%E4%B9%89Hook%E8%AE%A9%E9%80%BB%E8%BE%91%E5%A4%8D%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>你是不是经常在多个组件里写同样的逻辑？比如监听窗口大小变化，或者跟踪鼠标位置？每次都要写一遍useEffect添加监听，还要在卸载时清理事件… 这样的重复代码不仅浪费时间，还容易出错。今天我要分享的React自定义Hook，就是解决这个痛点的神器！它能让你像搭积木一样封装和复用组件逻辑，代码整洁度直接提升一个level！</p><span id="more"></span><h2 id="什么是React自定义Hook？"><a href="#什么是React自定义Hook？" class="headerlink" title="什么是React自定义Hook？"></a>什么是React自定义Hook？</h2><p>先看一个实际例子：<br>让我直接用一个获取窗口大小的例子来展示自定义Hook的魅力。没有自定义Hook之前，你可能这样写：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useEffect &#125; <span class="keyword">from</span><span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [windowSize, setWindowSize] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="variable language_">window</span>.<span class="property">innerWidth</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="variable language_">window</span>.<span class="property">innerHeight</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleResize</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">setWindowSize</span>(&#123;</span><br><span class="line">        <span class="attr">width</span>: <span class="variable language_">window</span>.<span class="property">innerWidth</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="variable language_">window</span>.<span class="property">innerHeight</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, handleResize);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 清理函数：组件卸载时移除监听</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, handleResize);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, []); <span class="comment">// 空依赖数组表示只在组件挂载时执行一次</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      当前窗口大小：&#123;windowSize.width&#125; x &#123;windowSize.height&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样写没问题，但如果另一个组件也需要窗口大小呢？难道要复制粘贴一遍？使用自定义Hook后，代码变得超简洁：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span><span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义Hook：useWindowSize</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useWindowSize</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [windowSize, setWindowSize] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">    <span class="attr">width</span>: <span class="variable language_">window</span>.<span class="property">innerWidth</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="variable language_">window</span>.<span class="property">innerHeight</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleResize</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">setWindowSize</span>(&#123;</span><br><span class="line">        <span class="attr">width</span>: <span class="variable language_">window</span>.<span class="property">innerWidth</span>,</span><br><span class="line">        <span class="attr">height</span>: <span class="variable language_">window</span>.<span class="property">innerHeight</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, handleResize);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;resize&#x27;</span>, handleResize);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> windowSize; <span class="comment">// 返回窗口大小状态</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在组件中使用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> windowSize = <span class="title function_">useWindowSize</span>(); <span class="comment">// 一行代码搞定！</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      当前窗口大小：&#123;windowSize.width&#125; x &#123;windowSize.height&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看到差别了吗？自定义Hook把复杂的逻辑封装起来，使用时只需要一行代码！这才是真正的”写一次，到处用”。</p><h2 id="再来看一个跟踪鼠标位置的自定义Hook"><a href="#再来看一个跟踪鼠标位置的自定义Hook" class="headerlink" title="再来看一个跟踪鼠标位置的自定义Hook"></a>再来看一个跟踪鼠标位置的自定义Hook</h2><p>鼠标位置跟踪是另一个常见需求，比如实现拖拽效果、鼠标悬停提示等。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState, useEffect &#125; <span class="keyword">from</span><span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义Hook：useMousePosition</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useMousePosition</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [position, setPosition] = <span class="title function_">useState</span>(&#123; <span class="attr">x</span>: <span class="number">0</span>, <span class="attr">y</span>: <span class="number">0</span> &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleMouseMove</span> = (<span class="params">event</span>) =&gt; &#123;</span><br><span class="line">      <span class="title function_">setPosition</span>(&#123;</span><br><span class="line">        <span class="attr">x</span>: event.<span class="property">clientX</span>,</span><br><span class="line">        <span class="attr">y</span>: event.<span class="property">clientY</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听鼠标移动事件</span></span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mousemove&#x27;</span>, handleMouseMove);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;mousemove&#x27;</span>, handleMouseMove);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, []); <span class="comment">// 空依赖数组确保effect只运行一次</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> position; <span class="comment">// 返回鼠标位置</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">CursorTracker</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> mousePos = <span class="title function_">useMousePosition</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      鼠标当前位置：(&#123;mousePos.x&#125;, &#123;mousePos.y&#125;)</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 另一个组件也可以复用同样的逻辑</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Tooltip</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; x, y &#125; = <span class="title function_">useMousePosition</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">position:</span> &#x27;<span class="attr">absolute</span>&#x27;, <span class="attr">left:</span> <span class="attr">x</span> + <span class="attr">10</span>, <span class="attr">top:</span> <span class="attr">y</span> + <span class="attr">10</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      我是跟随鼠标的提示框！</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这两个例子展示了自定义Hook的核心价值：把状态逻辑从组件中提取出来，实现真正的逻辑复用。</p><h2 id="自定义Hook的命名约定：为什么一定要用use开头？"><a href="#自定义Hook的命名约定：为什么一定要用use开头？" class="headerlink" title="自定义Hook的命名约定：为什么一定要用use开头？"></a>自定义Hook的命名约定：为什么一定要用use开头？</h2><p>你可能注意到了，所有自定义Hook都以use开头，比如useWindowSize、useMousePosition。这可不是随便起的名字，而是React官方强制要求的约定！原因有三：让React工具能识别HookReact DevTools等调试工具依赖use前缀来识别哪些函数是Hook，这样在调试时能正确显示Hook的状态和调用顺序。避免违反Hook规则ESLint的React Hook插件会检查以use开头的函数，确保它们遵守Hook的规则。如果你不用use开头，这些重要的静态检查就失效了。提高代码可读性看到use开头，其他开发者（包括未来的你）立即知道这是一个自定义Hook，而不是普通函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 正确：use开头，明确这是自定义Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useLocalStorage</span>(<span class="params">key, initialValue</span>) &#123;</span><br><span class="line">  <span class="comment">// ... Hook逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ❌ 错误：没有use前缀，React工具无法识别</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getLocalStorage</span>(<span class="params">key, initialValue</span>) &#123;</span><br><span class="line">  <span class="comment">// 这里如果用了useState等Hook，ESLint会报错</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>记住这个简单的规则：自定义Hook的名字必须以use开头，后面跟描述性的名称，使用驼峰命名法。</p><h2 id="实战：组合多个自定义Hook实现复杂功能"><a href="#实战：组合多个自定义Hook实现复杂功能" class="headerlink" title="实战：组合多个自定义Hook实现复杂功能"></a>实战：组合多个自定义Hook实现复杂功能</h2><p>真正的威力在于，你可以像搭积木一样组合多个自定义Hook！比如，我们要实现一个响应式的组件，在桌面端显示详细内容，在移动端显示简化版，并且根据鼠标位置改变样式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 组合使用之前定义的两个Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ResponsiveComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> windowSize = <span class="title function_">useWindowSize</span>();</span><br><span class="line">  <span class="keyword">const</span> mousePosition = <span class="title function_">useMousePosition</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> isMobile = windowSize.<span class="property">width</span> &lt; <span class="number">768</span>;</span><br><span class="line">  <span class="keyword">const</span> isNearTop = mousePosition.<span class="property">y</span> &lt; <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">background:</span> <span class="attr">isNearTop</span> ? &#x27;#<span class="attr">f0f0f0</span>&#x27; <span class="attr">:</span> &#x27;#<span class="attr">ffffff</span>&#x27;,</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">padding:</span> <span class="attr">isMobile</span> ? &#x27;<span class="attr">10px</span>&#x27; <span class="attr">:</span> &#x27;<span class="attr">20px</span>&#x27;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isMobile ? (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span>移动端简化版<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      ) : (</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">h1</span>&gt;</span>桌面端详细内容<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">p</span>&gt;</span>鼠标位置：(&#123;mousePosition.x&#125;, &#123;mousePosition.y&#125;)<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          <span class="tag">&lt;<span class="name">p</span>&gt;</span>窗口大小：&#123;windowSize.width&#125; x &#123;windowSize.height&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      )&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种组合能力让代码既简洁又强大，每个Hook专注做好一件事，组件只关心如何组合这些功能。</p><h2 id="必须避开的坑：Hook的三大规则"><a href="#必须避开的坑：Hook的三大规则" class="headerlink" title="必须避开的坑：Hook的三大规则"></a>必须避开的坑：Hook的三大规则</h2><p>自定义Hook虽然强大，但必须遵守React Hook的基本规则，否则会掉进各种坑里。</p><h3 id="规则1：只在最顶层调用Hook不要在循环、条件或嵌套函数中调用Hook"><a href="#规则1：只在最顶层调用Hook不要在循环、条件或嵌套函数中调用Hook" class="headerlink" title="规则1：只在最顶层调用Hook不要在循环、条件或嵌套函数中调用Hook"></a>规则1：只在最顶层调用Hook不要在循环、条件或嵌套函数中调用Hook</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误示例：在条件语句中调用Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">BadComponent</span>(<span class="params">&#123; shouldTrack &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (shouldTrack) &#123;</span><br><span class="line">    <span class="keyword">const</span> position = <span class="title function_">useMousePosition</span>(); <span class="comment">// 这样写会出错！</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>错误示例<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确写法：无条件调用，在effect中控制逻辑</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">GoodComponent</span>(<span class="params">&#123; shouldTrack &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> position = <span class="title function_">useMousePosition</span>(); <span class="comment">// 始终调用</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldTrack) &#123;</span><br><span class="line">      <span class="comment">// 在这里使用position做某些事情</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;跟踪位置:&#x27;</span>, position);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [shouldTrack, position]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>正确示例<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为什么有这个规则？React依赖Hook的调用顺序来正确管理状态。如果条件不同导致Hook调用顺序变化，状态就会乱套。</p><h3 id="规则2：只在React函数中调用Hook"><a href="#规则2：只在React函数中调用Hook" class="headerlink" title="规则2：只在React函数中调用Hook"></a>规则2：只在React函数中调用Hook</h3><p>在React函数组件或自定义Hook中调用，不要在普通JavaScript函数中调用</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：在普通函数中调用Hook</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">regularFunction</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>); <span class="comment">// 报错！</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：在组件或自定义Hook中调用</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>); <span class="comment">// 正确</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useCustomHook</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>); <span class="comment">// 正确（自定义Hook也是Hook）</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="规则3：自定义Hook必须返回需要的内容"><a href="#规则3：自定义Hook必须返回需要的内容" class="headerlink" title="规则3：自定义Hook必须返回需要的内容"></a>规则3：自定义Hook必须返回需要的内容</h3><p>根据需要返回状态、函数或其他值，保持接口清晰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ✅ 好的设计：返回需要的状态和操作方法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useToggle</span>(<span class="params">initialValue = <span class="literal">false</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = <span class="title function_">useState</span>(initialValue);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">toggle</span> = (<span class="params"></span>) =&gt; <span class="title function_">setValue</span>(!value);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setTrue</span> = (<span class="params"></span>) =&gt; <span class="title function_">setValue</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setFalse</span> = (<span class="params"></span>) =&gt; <span class="title function_">setValue</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [value, toggle, setTrue, setFalse]; <span class="comment">// 返回数组方便重命名</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用时的灵活性</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [isOpen, toggleOpen, open, close] = <span class="title function_">useToggle</span>(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;toggleOpen&#125;</span>&gt;</span>切换<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;open&#125;</span>&gt;</span>打开<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;close&#125;</span>&gt;</span>关闭<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;isOpen &amp;&amp; <span class="tag">&lt;<span class="name">div</span>&gt;</span>内容<span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="进阶技巧：带参数的自定义Hook"><a href="#进阶技巧：带参数的自定义Hook" class="headerlink" title="进阶技巧：带参数的自定义Hook"></a>进阶技巧：带参数的自定义Hook</h2><p>自定义Hook可以接受参数，根据参数不同返回不同的逻辑。比如，一个增强版的localStorage Hook：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useLocalStorage</span>(<span class="params">key, initialValue</span>) &#123;</span><br><span class="line">  <span class="comment">// 从localStorage读取初始值</span></span><br><span class="line">  <span class="keyword">const</span> [storedValue, setStoredValue] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> item = <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">getItem</span>(key);</span><br><span class="line">      <span class="keyword">return</span> item ? <span class="title class_">JSON</span>.<span class="title function_">parse</span>(item) : initialValue;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">      <span class="keyword">return</span> initialValue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回的setter函数会同时更新状态和localStorage</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">setValue</span> = (<span class="params">value</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 允许value是函数，就像useState一样</span></span><br><span class="line">      <span class="keyword">const</span> valueToStore = value instanceofFunction ? <span class="title function_">value</span>(storedValue) : value;</span><br><span class="line">      <span class="title function_">setStoredValue</span>(valueToStore);</span><br><span class="line">      <span class="variable language_">window</span>.<span class="property">localStorage</span>.<span class="title function_">setItem</span>(key, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(valueToStore));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [storedValue, setValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserSettings</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 不同的key创建不同的存储空间</span></span><br><span class="line">  <span class="keyword">const</span> [username, setUsername] = <span class="title function_">useLocalStorage</span>(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">  <span class="keyword">const</span> [theme, setTheme] = <span class="title function_">useLocalStorage</span>(<span class="string">&#x27;theme&#x27;</span>, <span class="string">&#x27;light&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">&#123;username&#125;</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> setUsername(e.target.value)&#125; </span></span><br><span class="line"><span class="language-xml">        placeholder=&quot;输入用户名&quot;</span></span><br><span class="line"><span class="language-xml">      /&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">select</span> <span class="attr">value</span>=<span class="string">&#123;theme&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> setTheme(e.target.value)&#125;&gt;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;light&quot;</span>&gt;</span>浅色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;dark&quot;</span>&gt;</span>深色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="真实场景：封装数据获取逻辑"><a href="#真实场景：封装数据获取逻辑" class="headerlink" title="真实场景：封装数据获取逻辑"></a>真实场景：封装数据获取逻辑</h2><p>数据获取是自定义Hook的经典应用场景。看看如何封装一个通用的数据获取Hook：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">useApi</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [data, setData] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">fetchData</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">setLoading</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="title function_">setError</span>(<span class="literal">null</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        <span class="keyword">if</span> (!response.<span class="property">ok</span>) &#123;</span><br><span class="line">          <span class="title function_">thrownewError</span>(<span class="string">`HTTP错误: <span class="subst">$&#123;response.status&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        <span class="title function_">setData</span>(result);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="title function_">setError</span>(err.<span class="property">message</span>);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">fetchData</span>();</span><br><span class="line">  &#125;, [url]); <span class="comment">// url变化时重新获取</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; data, loading, error &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">UserProfile</span>(<span class="params">&#123; userId &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; <span class="attr">data</span>: user, loading, error &#125; = <span class="title function_">useApi</span>(<span class="string">`/api/users/<span class="subst">$&#123;userId&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (loading) <span class="keyword">return</span><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>加载中...<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>错误: &#123;error&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (!user) <span class="keyword">return</span><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>用户不存在<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;user.name&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;user.email&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个useApi Hook处理了加载状态、错误处理、数据缓存等繁琐细节，让组件代码变得异常简洁。</p><h2 id="性能优化：避免不必要的重新渲染"><a href="#性能优化：避免不必要的重新渲染" class="headerlink" title="性能优化：避免不必要的重新渲染"></a>性能优化：避免不必要的重新渲染</h2><p>自定义Hook也可能引入性能问题，特别是当返回对象或数组时：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 可能引起性能问题：每次渲染都返回新对象</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useUserInfo</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 每次渲染都返回新对象，即使user没变</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    user,</span><br><span class="line">    <span class="attr">isAdmin</span>: user?.<span class="property">role</span> === <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    <span class="attr">canEdit</span>: user?.<span class="property">permissions</span>?.<span class="title function_">includes</span>(<span class="string">&#x27;edit&#x27;</span>)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 优化版本：使用useMemo缓存计算结果</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useUserInfoOptimized</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [user, setUser] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> userInfo = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> (&#123;</span><br><span class="line">    user,</span><br><span class="line">    <span class="attr">isAdmin</span>: user?.<span class="property">role</span> === <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    <span class="attr">canEdit</span>: user?.<span class="property">permissions</span>?.<span class="title function_">includes</span>(<span class="string">&#x27;edit&#x27;</span>)</span><br><span class="line">  &#125;), [user]); <span class="comment">// 只有user变化时才重新计算</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> userInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="测试自定义Hook：确保可靠性"><a href="#测试自定义Hook：确保可靠性" class="headerlink" title="测试自定义Hook：确保可靠性"></a>测试自定义Hook：确保可靠性</h2><p>自定义Hook也需要测试！推荐使用@testing-library&#x2F;react-hooks：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; renderHook, act &#125; <span class="keyword">from</span><span class="string">&#x27;@testing-library/react-hooks&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; useCounter &#125; <span class="keyword">from</span><span class="string">&#x27;./useCounter&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">test</span>(<span class="string">&#x27;useCounter应该正确增加计数&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; result &#125; = <span class="title function_">renderHook</span>(<span class="function">() =&gt;</span> <span class="title function_">useCounter</span>(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始值应该是0</span></span><br><span class="line">  <span class="title function_">expect</span>(result.<span class="property">current</span>.<span class="property">count</span>).<span class="title function_">toBe</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 测试increment</span></span><br><span class="line">  <span class="title function_">act</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    result.<span class="property">current</span>.<span class="title function_">increment</span>();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">expect</span>(result.<span class="property">current</span>.<span class="property">count</span>).<span class="title function_">toBe</span>(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="总结：什么时候该用自定义Hook？"><a href="#总结：什么时候该用自定义Hook？" class="headerlink" title="总结：什么时候该用自定义Hook？"></a>总结：什么时候该用自定义Hook？</h2><p>经过这么多例子，你可能想问：到底什么时候应该创建自定义Hook？<br>适合使用自定义Hook的场景：<br>多个组件共享相同的状态逻辑<br>复杂的useEffect逻辑需要封装<br>想要分离关注点，让组件更专注于UI<br>需要复用数据获取、事件监听等副作用逻辑</p><p>不适合的情况：<br>逻辑只在一个组件中使用，且不太可能复用<br>逻辑非常简单，封装反而增加复杂度<br>只是简单的工具函数，不涉及React状态或生命周期</p><p>自定义Hook是React函数组件的终极武器，它让逻辑复用变得前所未有的简单。从今天开始，试着把你项目中的重复逻辑提取成自定义Hook吧！</p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>useState函数怎么实现的</title>
      <link href="/2021/01/01/%E5%89%8D%E7%AB%AF/react/useState%E5%87%BD%E6%95%B0%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84/"/>
      <url>/2021/01/01/%E5%89%8D%E7%AB%AF/react/useState%E5%87%BD%E6%95%B0%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84/</url>
      
        <content type="html"><![CDATA[<p>useState 是 React 提供的一个 Hook，用于在函数组件中添加状态。它的实现涉及 React 的内部机制，特别是状态管理和渲染流程。下面是一个简化的概念性解释，帮助你理解 useState 的大概实现原理。 </p><ol><li>状态存储</li></ol><p>React 内部维护了一个状态队列，用于存储所有 Hook 的状态。当你在组件中调用 useState 时，React 会根据当前渲染的 Hook 序列找到对应的状态值。<br>2. Hook 调用<br>每次调用 useState 时，React 会执行以下步骤：<br>检查状态队列：根据当前渲染的 Hook 序列，检查状态队列中是否有对应的状态值。<br>初始化状态：如果没有找到状态值（即第一次渲染），则使用传入的初始值进行初始化。<br>返回状态和更新函数：返回当前的状态值和一个用于更新该状态的函数。<br>3. 更新函数<br>useState 返回的更新函数（例如 setStoredValue）用于更新状态。当你调用这个函数时，React 会：<br>更新状态：将新的状态值放入状态队列中。<br>触发重渲染：将组件标记为需要重新渲染，并安排一次更新。<br>4. 解构赋值<br>useState 返回一个数组，你可以使用解构赋值来获取状态值和更新函数。解构赋值的语法使得你可以为数组中的元素指定任意的变量名。<br>5. 状态更新的批处理<br>React 会对状态更新进行批处理，以提高性能。这意味着在同一个事件处理程序中多次调用 setStoredValue，React 可能会将这些更新合并为一个更新。<br>6. 闭包陷阱<br>需要注意的是，由于函数组件的特性，每次渲染都会创建一个新的函数和新的状态变量。这可能会导致闭包陷阱，即在事件处理程序中获取到的是旧的状态值。为了避免这种情况，React 提供了一些机制，比如 useCallback 和 useRef，来帮助开发者更好地管理状态和回调函数。<br>示例代码<br>以下是一个简化的示例代码，展示了 useState 的基本用法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ExampleComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>当前计数: &#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这个示例中，useState(0) 返回一个数组，数组的第一个元素是当前的 count 值，第二个元素是用于更新 count 的 setCount 函数。<br>总结<br>useState 的实现依赖于 React 的内部状态队列和渲染机制。通过解构赋值，你可以方便地获取和更新状态，同时 React 会对状态更新进行优化，以提高应用的性能。</p><h2 id="useState能传函数吗"><a href="#useState能传函数吗" class="headerlink" title="useState能传函数吗"></a>useState能传函数吗</h2><p>是的，useState 可以传入函数作为初始状态的设置值。这种用法在某些情况下非常有用，特别是在初始状态的计算比较复杂或者依赖于其他值时。具体来说，useState 可以接受两种类型的初始状态：<br>直接值：你可以直接传入一个初始值，例如一个数字、字符串、对象等。<br>函数：你可以传入一个函数，这个函数会在组件的初始渲染时被调用，其返回值将作为初始状态。<br>使用函数作为初始状态<br>使用函数作为初始状态可以避免在每次渲染时都进行复杂的计算。这在初始状态计算成本较高时尤其有用。<br>示例代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ExampleComponent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 直接传入初始值</span></span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用函数作为初始值</span></span><br><span class="line">  <span class="keyword">const</span> [complexState, setComplexState] = <span class="title function_">useState</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 复杂的初始状态计算</span></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">key</span>: <span class="string">&#x27;value&#x27;</span>, <span class="attr">computed</span>: <span class="title function_">expensiveComputation</span>() &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">expensiveComputation</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 假设这是一个耗时的操作</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;计算初始状态&#x27;</span>);</span><br><span class="line">    <span class="comment">// 返回计算结果</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>简单计数: &#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>复杂状态: &#123;JSON.stringify(complexState)&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setComplexState(&#123; ...complexState, key: &#x27;new value&#x27; &#125;)&#125;&gt;更新复杂状态<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">ExampleComponent</span>;</span><br></pre></td></tr></table></figure><p>在这个示例中：<br>useState(0) 直接传入了一个初始值 0。<br>useState(() &#x3D;&gt; { … }) 传入了一个函数，这个函数会在组件初始渲染时被调用一次，用于计算初始状态。<br>为什么使用函数作为初始状态<br>性能优化：如果初始状态的计算比较复杂，使用函数可以避免在每次渲染时都进行这个计算，从而提高性能。<br>依赖初始化：如果初始状态的计算依赖于某些外部值或函数，使用函数可以确保这些值在组件初始渲染时被正确计算。<br>总结<br>useState 可以传入函数作为初始状态，这种方式有助于优化性能和处理依赖复杂的初始化逻辑</p>]]></content>
      
      
      <categories>
          
          <category> react </category>
          
      </categories>
      
      
        <tags>
            
            <tag> react </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>render方法的具体含义</title>
      <link href="/2021/01/01/%E5%89%8D%E7%AB%AF/vue/render%E6%96%B9%E6%B3%95%E7%9A%84%E5%85%B7%E4%BD%93%E5%90%AB%E4%B9%89/"/>
      <url>/2021/01/01/%E5%89%8D%E7%AB%AF/vue/render%E6%96%B9%E6%B3%95%E7%9A%84%E5%85%B7%E4%BD%93%E5%90%AB%E4%B9%89/</url>
      
        <content type="html"><![CDATA[<h1 id="Vue-项目的main-js-中-render-h-h-App-具体含义解释"><a href="#Vue-项目的main-js-中-render-h-h-App-具体含义解释" class="headerlink" title="Vue 项目的main.js 中: render: h &#x3D;&gt; h(App) 具体含义解释"></a>Vue 项目的main.js 中: render: h &#x3D;&gt; h(App) 具体含义解释</h1><h2 id="请解释：render-h-h-App-这段话的意思？"><a href="#请解释：render-h-h-App-这段话的意思？" class="headerlink" title="请解释：render: h &#x3D;&gt; h(App) 这段话的意思？"></a>请解释：render: h &#x3D;&gt; h(App) 这段话的意思？</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># main.<span class="property">js</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">    <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">    <span class="attr">router</span>: router,</span><br><span class="line">    <span class="attr">store</span>: store,</span><br><span class="line">    <span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><span id="more"></span><p>render: h &#x3D;&gt; h(App) 是下面内容的缩写：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">render: function (createElement) &#123;</span><br><span class="line">    return createElement(App);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进一步缩写为(ES6 语法)：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_">render</span> (createElement) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">createElement</span>(<span class="title class_">App</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再进一步缩写为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_">render</span> (h)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="title class_">App</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>按照 ES6 箭头函数的写法，就得到了：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">render</span>: <span class="function"><span class="params">h</span> =&gt;</span> <span class="title function_">h</span>(<span class="title class_">App</span>);</span><br></pre></td></tr></table></figure><p>其中 根据 Vue.js 作者 Even You 的解释，h 的含义如下：<br>它来自单词 hyperscript，这个单词通常用在 virtual-dom 的实现中。Hyperscript 本身是指生成HTML 结构的 script 脚本，因为 HTML 是 hyper-text markup language 的缩写（超文本标记语言）</p>]]></content>
      
      
      <categories>
          
          <category> vue2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue3组件库</title>
      <link href="/2021/01/01/%E5%89%8D%E7%AB%AF/vue/vue3%E5%86%99%E7%BB%84%E4%BB%B6%E5%BA%93/"/>
      <url>/2021/01/01/%E5%89%8D%E7%AB%AF/vue/vue3%E5%86%99%E7%BB%84%E4%BB%B6%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>目前流行的组件库搭建方式都是使用monorepo的方式，好处很多，可以在一个代码仓库中管理多个项目，可以达到项目之间的资源共享。这里也是使用这种方式。</p><h2 id="以-pnpm-构建-monorepo"><a href="#以-pnpm-构建-monorepo" class="headerlink" title="以 pnpm 构建 monorepo"></a>以 pnpm 构建 monorepo</h2><p>首先全局安装pnpm</p><span id="more"></span><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">npm install pnpm -g</span><br></pre></td></tr></table></figure><p>pnpm初始化</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pnpm init</span><br><span class="line"><span class="string">``</span><span class="string">`     </span></span><br><span class="line"><span class="string">得到 package.json 的初始内容后删除 package.json 中的 name ，添加 &quot;private&quot;: true 属性，因为这个作为一个整体是不需要发布的。组件都是写在packages中。</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;private&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;main&quot;</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;test&quot;</span>: <span class="string">&quot;echo &quot;</span><span class="title class_">Error</span>: no test specified<span class="string">&quot; &amp;&amp; exit 1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;keywords&quot;</span>: [],</span><br><span class="line">  <span class="string">&quot;author&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;license&quot;</span>: <span class="string">&quot;ISC&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="配置-pnpm-的-monorepo-工作区"><a href="#配置-pnpm-的-monorepo-工作区" class="headerlink" title="配置 pnpm 的 monorepo 工作区"></a>配置 pnpm 的 monorepo 工作区</h2><p>这是我目前的结构目录，docs用来存放组件库文档，examples用于调试编写好的组件，packages里的compnents用于存放自己的组件。<br><img src="/img/1.jpg"><br>比如我使用到packages和examples这两个，那么就将这两个都配置进去,在pnpm-workspace.yaml中配置</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">packages</span>:</span><br><span class="line">  - <span class="string">&#x27;packages/*&#x27;</span></span><br><span class="line">  - <span class="string">&#x27;examples/*&#x27;</span></span><br></pre></td></tr></table></figure><p>每个子模块都有属于自己的package.json文件</p><p><img src="/img/2.jpg"></p><p>以components包的package.json举例，其中”@uv-ui&#x2F;hooks”: “workspace:^1.0.0”和 “@uv-ui&#x2F;utils”: “workspace:^1.0.0”是依赖于其他目录的包，如果这个components包需要用到这两个包，需要在这个目录下也安装上，之后发布npm包的时候将workspace:^去掉即可，这两个依赖的包也需要独立发布npm包，这些在发布组件中有详细描述。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;uv-ui&quot;</span>,</span><br><span class="line">  <span class="string">&quot;private&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0.11&quot;</span>,</span><br><span class="line">  <span class="string">&quot;main&quot;</span>: <span class="string">&quot;dist/es/index.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;module&quot;</span>: <span class="string">&quot;dist/es/index.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;style&quot;</span>: <span class="string">&quot;dist/es/style.css&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;基于vue3的移动端组件库&quot;</span>,</span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;build&quot;</span>: <span class="string">&quot;vite build&quot;</span>,</span><br><span class="line">    <span class="string">&quot;lint&quot;</span>: <span class="string">&quot;eslint ./src/**/*.&#123;js,jsx,vue,ts,tsx&#125; --fix&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;repository&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;git&quot;</span>,</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/monsterxwx/uv-ui&quot;</span>,</span><br><span class="line">    <span class="string">&quot;directory&quot;</span>: <span class="string">&quot;packages/uv-ui&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;keywords&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;uv-ui&quot;</span>,</span><br><span class="line">    <span class="string">&quot;vue3组件库&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mobile&quot;</span>,</span><br><span class="line">    <span class="string">&quot;frontend&quot;</span>,</span><br><span class="line">    <span class="string">&quot;components&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;files&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;dist&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;author&quot;</span>: <span class="string">&quot;coderxwx&quot;</span>,</span><br><span class="line">  <span class="string">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;@uv-ui/hooks&quot;</span>: <span class="string">&quot;workspace:^1.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@uv-ui/utils&quot;</span>: <span class="string">&quot;workspace:^1.0.0&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其他两个的包名则分别为：@uv-ui&#x2F;hooks 和 @uv-ui&#x2F;utils，创建过程同上。</p><h2 id="仓库项目内的包相互调用"><a href="#仓库项目内的包相互调用" class="headerlink" title="仓库项目内的包相互调用"></a>仓库项目内的包相互调用</h2><p>如何对hooks、utils和components这三个包进行互相调用呢？我们只需要把这三个包都安装到仓库根目录下的 node_modules 目录中即可。所有的依赖都在根目录下安装，安装到根目录需要加上-w ，表示安装到公共模块的 packages.json 中。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pnpm install uv-ui -w</span><br><span class="line">pnpm install @uv-ui/hooks -w</span><br><span class="line">pnpm install @uv-ui/utils -w</span><br></pre></td></tr></table></figure><p>根目录的package.json将会出现如下依赖，这三个就是我们刚刚安装的包<br><img src="/img/3.jpg"></p><h2 id="组件编写"><a href="#组件编写" class="headerlink" title="组件编写"></a>组件编写</h2><p>如果我们的组件库包需要支持按需引入，那么每个组件都需要进行vue的注册app.component(comp.name,comp)。每个都写一遍会比较麻烦，可以封装成一个函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="title function_">withInstall</span> = (<span class="params">comp</span>) =&gt; &#123;</span><br><span class="line">  comp.<span class="property">install</span> = <span class="function">(<span class="params">app</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 注册组件</span></span><br><span class="line">    app.<span class="title function_">component</span>(comp.<span class="property">name</span>, comp)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> comp</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以button组件为例，首先目录结构如下，在src目录下编写各个组件，在components目录下有一个index用于将所有的组件导出<br><img src="/img/4.jpg"><br>button的index.js代码如下：将编写的button组件导进来，然后导出去即可实现组件每个都是按需加载</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">Button</span> <span class="keyword">from</span> <span class="string">&#x27;./button.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;withInstall&#125; <span class="keyword">from</span> <span class="string">&#x27;@uv-ui/utils&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">UvButton</span> = <span class="title function_">withInstall</span>(<span class="title class_">Button</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">UvButton</span></span><br></pre></td></tr></table></figure><p>再来看看components目录下的index.js文件，写多少个组件就引入多少个，然后全部导出去，这么做的目的是在全量导入的时候，可以直接引入组件，然后vue.use(uv-ui)即可将全部的组件注册</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uvButton <span class="keyword">from</span> <span class="string">&#x27;./button&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> components = [</span><br><span class="line">  uvButton</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">install</span> = (<span class="params">Vue</span>) =&gt; &#123;</span><br><span class="line">  components.<span class="title function_">forEach</span>(<span class="function"><span class="params">component</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">Vue</span>.<span class="title function_">component</span>(component.<span class="property">name</span>, component)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">  uvButton</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> install</span><br></pre></td></tr></table></figure><p>再来看看button.vue文件,由于写的比较多，这里直接省略部分代码，只保留关键代码。</p><p>可以看到每个组件都需要给他一个名字方便在vue中注册，export default { name: ‘UvButton’ }， 其次样式通过css变量抽离出来，方便样式的更改，样式不用加scoped作用域，只要命名好样式名称即可。其他组件同理。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;uv-button&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="comment">// 代码</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">  <span class="attr">name</span>: <span class="string">&#x27;UvButton&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">&quot;scss&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">:root &#123;</span></span><br><span class="line"><span class="language-xml">  --uv-button-primary: #409eff;</span></span><br><span class="line"><span class="language-xml">  --uv-button-success: #67c23a;</span></span><br><span class="line"><span class="language-xml">  --uv-button-warning: #e6a23c;</span></span><br><span class="line"><span class="language-xml">  --uv-button-error: #f56c6c;</span></span><br><span class="line"><span class="language-xml">  --uv-button-info: #909399;</span></span><br><span class="line"><span class="language-xml">  --uv-button-text: #303133;</span></span><br><span class="line"><span class="language-xml">&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">$primary: var(--uv-button-primary);</span></span><br><span class="line"><span class="language-xml">$success: var(--uv-button-success);</span></span><br><span class="line"><span class="language-xml">$warning: var(--uv-button-warning) ;</span></span><br><span class="line"><span class="language-xml">$error: var(--uv-button-error) ;</span></span><br><span class="line"><span class="language-xml">$info: var(--uv-button-info) ;</span></span><br><span class="line"><span class="language-xml">$text: var(--uv-button-text) ;</span></span><br><span class="line"><span class="language-xml">.uv-button &#123;</span></span><br><span class="line"><span class="language-xml">  font-size: var(--uv-button-font-size);</span></span><br><span class="line"><span class="language-xml">  border: 0;</span></span><br><span class="line"><span class="language-xml">  border-radius: var(--uv-button-border-radius);</span></span><br><span class="line"><span class="language-xml">  white-space: nowrap;</span></span><br><span class="line"><span class="language-xml">  color: #ffffff;</span></span><br><span class="line"><span class="language-xml">  background: none;</span></span><br><span class="line"><span class="language-xml">  outline: none;</span></span><br><span class="line"><span class="language-xml">  cursor: pointer;</span></span><br><span class="line"><span class="language-xml">&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="组件打包"><a href="#组件打包" class="headerlink" title="组件打包"></a>组件打包</h2><p>组件打包采用的是vite的库模式打包，没有使用gulp这些工具，是比较简单的打包方式，只需要简单配置即可实现每个组件都单独打包，目前打包后所有组件样式会合成一个style.css文件，样式需要全部引入，组件是按需引入的方式，如果样式也想做分离就需要使用到gulp等这些工具，将样式全部拆分出来作为一个包theme-chalk,然后引入就类似element-ui那种方式，比较麻烦这里就不详细描述了，可以找找相关的文章了解。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; defineConfig &#125; <span class="keyword">from</span> <span class="string">&#x27;vite&#x27;</span></span><br><span class="line"><span class="keyword">import</span> vue <span class="keyword">from</span> <span class="string">&#x27;@vitejs/plugin-vue&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title function_">defineConfig</span>(&#123;</span><br><span class="line">  <span class="attr">build</span>: &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;modules&#x27;</span>,</span><br><span class="line">    <span class="comment">// 压缩</span></span><br><span class="line">    <span class="attr">minify</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">rollupOptions</span>: &#123;</span><br><span class="line">      <span class="comment">// 忽略打包vue文件</span></span><br><span class="line">      <span class="attr">external</span>: [<span class="string">&#x27;vue&#x27;</span>],</span><br><span class="line">      <span class="attr">input</span>: [<span class="string">&#x27;src/index.js&#x27;</span>],</span><br><span class="line">      <span class="attr">output</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">format</span>: <span class="string">&#x27;es&#x27;</span>,</span><br><span class="line">          <span class="attr">entryFileNames</span>: <span class="string">&#x27;[name].js&#x27;</span>,</span><br><span class="line">          <span class="attr">preserveModules</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="comment">// 配置打包根目录</span></span><br><span class="line">          <span class="attr">dir</span>: <span class="string">&#x27;dist/es&#x27;</span>,</span><br><span class="line">          <span class="attr">preserveModulesRoot</span>: <span class="string">&#x27;src&#x27;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">format</span>: <span class="string">&#x27;cjs&#x27;</span>,</span><br><span class="line">          <span class="attr">entryFileNames</span>: <span class="string">&#x27;[name].js&#x27;</span>,</span><br><span class="line">          <span class="attr">preserveModules</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">dir</span>: <span class="string">&#x27;dist/lib&#x27;</span>,</span><br><span class="line">          <span class="attr">preserveModulesRoot</span>: <span class="string">&#x27;src&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">lib</span>: &#123;</span><br><span class="line">      <span class="attr">entry</span>: <span class="string">&#x27;./index.js&#x27;</span>,</span><br><span class="line">      <span class="attr">formats</span>: [<span class="string">&#x27;es&#x27;</span>, <span class="string">&#x27;cjs&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: [</span><br><span class="line">    <span class="title function_">vue</span>()</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>下面是打包后的结构，分别拆成es和lib，样式在es目录下的style.css</p><p><img src="/img/5.jpg"></p><p>使用方式就比较简单了</p><h3 id="第一种：全量使用-main-js中导入"><a href="#第一种：全量使用-main-js中导入" class="headerlink" title="第一种：全量使用 main.js中导入"></a>第一种：全量使用 main.js中导入</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uvUI <span class="keyword">from</span> <span class="string">&#x27;uv-ui&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;uv-ui/dist/es/style.css&#x27;</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(uvUI)</span><br></pre></td></tr></table></figure><h3 id="第二种：按需导入-在main-js中引入样式文件"><a href="#第二种：按需导入-在main-js中引入样式文件" class="headerlink" title="第二种：按需导入 在main.js中引入样式文件"></a>第二种：按需导入 在main.js中引入样式文件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;uv-ui/dist/es/style.css&#x27;</span></span><br></pre></td></tr></table></figure><p>其他用到的地方引入相关组件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">uvButton</span> <span class="attr">type</span>=<span class="string">&quot;primary&quot;</span>&gt;</span>切换<span class="tag">&lt;/<span class="name">uvButton</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span> <span class="attr">setup</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">import</span> &#123; uvButton &#125; <span class="keyword">from</span> <span class="string">&#x27;uv-ui&#x27;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>组件发布<br>编写package.json<br>package.json重要字段说明：</p><p>name 即npm项目包名，发布到npm时就是取的这个name名，你自己取个语义化的名字，和已有的npm库不能重复；<br>private 是否私有包，要发布到npm需要关闭<br>version 版本号，更新npm包时必须修改一个更高的版本号后才能成功发布到npm，版本号最好遵循npm版本管理规范；<br>description 包的描述，发布到npm后你搜索该npm包时，在搜索联想列表里会显示在包名的下方，作为描述说明；<br>main 入口文件路径，在你通过import或require引用该npm包时就是引入的该路径的文件<br>keywords 该包的关键词<br>files 白名单目录，配置哪些文件会上传到npm包中。有些文件是必定会上传的，无法控制，例如package.json、LICENSE、README.md等等<br>repository 关联github地址</p><p>package.json完整代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;uv-ui&quot;</span>,</span><br><span class="line">  <span class="string">&quot;private&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0.11&quot;</span>,</span><br><span class="line">  <span class="string">&quot;main&quot;</span>: <span class="string">&quot;dist/es/index.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;module&quot;</span>: <span class="string">&quot;dist/es/index.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;style&quot;</span>: <span class="string">&quot;dist/es/style.css&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;基于vue3的移动端组件库&quot;</span>,</span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;build&quot;</span>: <span class="string">&quot;vite build&quot;</span>,</span><br><span class="line">    <span class="string">&quot;lint&quot;</span>: <span class="string">&quot;eslint ./src/**/*.&#123;js,jsx,vue,ts,tsx&#125; --fix&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;repository&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;git&quot;</span>,</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/monsterxwx/uv-ui&quot;</span>,</span><br><span class="line">    <span class="string">&quot;directory&quot;</span>: <span class="string">&quot;packages/uv-ui&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;keywords&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;uv-ui&quot;</span>,</span><br><span class="line">    <span class="string">&quot;vue3组件库&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mobile&quot;</span>,</span><br><span class="line">    <span class="string">&quot;frontend&quot;</span>,</span><br><span class="line">    <span class="string">&quot;components&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;files&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;dist&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;author&quot;</span>: <span class="string">&quot;coderxwx&quot;</span>,</span><br><span class="line">  <span class="string">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span>,</span><br><span class="line">  <span class="string">&quot;dependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;@coderxwx/uv-ui-hooks&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;@coderxwx/uv-ui-utils&quot;</span>: <span class="string">&quot;1.0.0&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="添加LICENSE"><a href="#添加LICENSE" class="headerlink" title="添加LICENSE"></a>添加LICENSE</h3><p>Copyright (c) 2023代表年份，coderxwx替换成自己的名字</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">MIT</span> <span class="title class_">License</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Copyright</span> (c) <span class="number">2023</span> coderxwx</span><br><span class="line"></span><br><span class="line"><span class="title class_">Permission</span> is hereby granted, free <span class="keyword">of</span> charge, to any person obtaining a copy</span><br><span class="line"><span class="keyword">of</span> <span class="variable language_">this</span> software and associated documentation <span class="title function_">files</span> (the <span class="string">&quot;Software&quot;</span>), to deal</span><br><span class="line"><span class="keyword">in</span> the <span class="title class_">Software</span> without restriction, including without limitation the rights</span><br><span class="line">to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span><br><span class="line">copies <span class="keyword">of</span> the <span class="title class_">Software</span>, and to permit persons to whom the <span class="title class_">Software</span> is</span><br><span class="line">furnished to <span class="keyword">do</span> so, subject to the following <span class="attr">conditions</span>:</span><br><span class="line"></span><br><span class="line"><span class="title class_">The</span> above copyright notice and <span class="variable language_">this</span> permission notice shall be included <span class="keyword">in</span> all</span><br><span class="line">copies or substantial portions <span class="keyword">of</span> the <span class="title class_">Software</span>.</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">THE</span> <span class="variable constant_">SOFTWARE</span> <span class="variable constant_">IS</span> <span class="variable constant_">PROVIDED</span> <span class="string">&quot;AS IS&quot;</span>, <span class="variable constant_">WITHOUT</span> <span class="variable constant_">WARRANTY</span> <span class="variable constant_">OF</span> <span class="variable constant_">ANY</span> <span class="variable constant_">KIND</span>, <span class="variable constant_">EXPRESS</span> <span class="variable constant_">OR</span></span><br><span class="line"><span class="variable constant_">IMPLIED</span>, <span class="variable constant_">INCLUDING</span> <span class="variable constant_">BUT</span> <span class="variable constant_">NOT</span> <span class="variable constant_">LIMITED</span> <span class="variable constant_">TO</span> <span class="variable constant_">THE</span> <span class="variable constant_">WARRANTIES</span> <span class="variable constant_">OF</span> <span class="variable constant_">MERCHANTABILITY</span>,</span><br><span class="line"><span class="variable constant_">FITNESS</span> <span class="variable constant_">FOR</span> A <span class="variable constant_">PARTICULAR</span> <span class="variable constant_">PURPOSE</span> <span class="variable constant_">AND</span> <span class="variable constant_">NONINFRINGEMENT</span>. <span class="variable constant_">IN</span> <span class="variable constant_">NO</span> <span class="variable constant_">EVENT</span> <span class="variable constant_">SHALL</span> <span class="variable constant_">THE</span></span><br><span class="line"><span class="variable constant_">AUTHORS</span> <span class="variable constant_">OR</span> <span class="variable constant_">COPYRIGHT</span> <span class="variable constant_">HOLDERS</span> <span class="variable constant_">BE</span> <span class="variable constant_">LIABLE</span> <span class="variable constant_">FOR</span> <span class="variable constant_">ANY</span> <span class="variable constant_">CLAIM</span>, <span class="variable constant_">DAMAGES</span> <span class="variable constant_">OR</span> <span class="variable constant_">OTHER</span></span><br><span class="line"><span class="variable constant_">LIABILITY</span>, <span class="variable constant_">WHETHER</span> <span class="variable constant_">IN</span> <span class="variable constant_">AN</span> <span class="variable constant_">ACTION</span> <span class="variable constant_">OF</span> <span class="variable constant_">CONTRACT</span>, <span class="variable constant_">TORT</span> <span class="variable constant_">OR</span> <span class="variable constant_">OTHERWISE</span>, <span class="variable constant_">ARISING</span> <span class="variable constant_">FROM</span>,</span><br><span class="line"><span class="variable constant_">OUT</span> <span class="variable constant_">OF</span> <span class="variable constant_">OR</span> <span class="variable constant_">IN</span> <span class="variable constant_">CONNECTION</span> <span class="variable constant_">WITH</span> <span class="variable constant_">THE</span> <span class="variable constant_">SOFTWARE</span> <span class="variable constant_">OR</span> <span class="variable constant_">THE</span> <span class="variable constant_">USE</span> <span class="variable constant_">OR</span> <span class="variable constant_">OTHER</span> <span class="variable constant_">DEALINGS</span> <span class="variable constant_">IN</span> <span class="variable constant_">THE</span></span><br><span class="line"><span class="variable constant_">SOFTWARE</span>.</span><br></pre></td></tr></table></figure><h3 id="npm账号注册登录"><a href="#npm账号注册登录" class="headerlink" title="npm账号注册登录"></a>npm账号注册登录</h3><p>要发布到npm上首先就要注册npm账号，通过官网进行账号注册：<a href="http://www.npmjs.com/[1]">www.npmjs.com/[1]</a> </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm login</span><br></pre></td></tr></table></figure><p>登录npm,输入账号和密码，密码输入不会有显示，正常输入即可，然后输入自己的邮箱，邮箱验证码验证通过后即成功登录，后续不需要重复登录。</p><h3 id="调试npm"><a href="#调试npm" class="headerlink" title="调试npm"></a>调试npm</h3><p>如果不需要调试，可以跳过调试步骤，直接发布。</p><p>npm项目根目录运行终端命令：运行后该npm包会放进本地npm缓存</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm link</span><br></pre></td></tr></table></figure><p>如果要在其他项目（例如项目名叫aaa）里引用调试，只需要在aaa里运行命令：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm link 包名</span><br></pre></td></tr></table></figure><p>为了防止本地调试npm与发布后的npm混淆冲突，在调试完成后一定记得手动取消项目关联。</p><h3 id="发布组件"><a href="#发布组件" class="headerlink" title="发布组件"></a>发布组件</h3><p>在npm包项目根目录运行命令：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm publish</span><br></pre></td></tr></table></figure><p>运行完稍等一段时间即可在npm官网搜索到发布的npm包。</p><h3 id="关于发布的一些错误汇总"><a href="#关于发布的一些错误汇总" class="headerlink" title="关于发布的一些错误汇总"></a>关于发布的一些错误汇总</h3><p>403错误</p><p>检查npm源是否是官方源registry.npmjs.org&#x2F;[2]，比如之前是淘宝的源则需要切换回官方源，否则发布失败；<br>是否登录成功（npm login 或者npm adduser 登录）；<br>是否已有重复的包名（修改package.json里的name或者使用scope）。<br>402错误</p><p>当使用npm publish发布带有scope作用域的包时，会出现402错误；<br>需使用npm publish –access&#x3D;public；<br>详细发布请看下面的发布私有包。<br>404错误</p><p>没有找到对应的路径，其实跟402错误差不多，基本都是作用域的问题</p><h3 id="发布私有包"><a href="#发布私有包" class="headerlink" title="发布私有包"></a>发布私有包</h3><p>我们在写组件库的时候会用到一些函数，这些都可以作为一个包进行发布，但是这些不需要发布为正式的包，只需要给组件库的主包使用，比如：</p><p><img src="/img/6.jpg"></p><p>package.json中如果name 是使用@xx来表示的则代表私有包，如果发布npm为私有包则需要收费，我们可以通过配置publishConfig字段将其表示为共有包，然后进行npm publish进行发布，如果不想写这个可以直接输入npm publish –access&#x3D;public 比如我的私有包的前缀是这个@coderxwx，@后面跟的是你npm的账号名</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;@coderxwx/uv-ui-hooks&quot;</span>,</span><br><span class="line">  <span class="string">&quot;private&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">  <span class="string">&quot;main&quot;</span>: <span class="string">&quot;index.js&quot;</span>,</span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;test&quot;</span>: <span class="string">&quot;echo &quot;</span><span class="title class_">Error</span>: no test specified<span class="string">&quot; &amp;&amp; exit 1&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;publishConfig&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;access&quot;</span>: <span class="string">&quot;public&quot;</span>,</span><br><span class="line">    <span class="string">&quot;registry&quot;</span>: <span class="string">&quot;https://registry.npmjs.org/&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;keywords&quot;</span>: [],</span><br><span class="line">  <span class="string">&quot;author&quot;</span>: <span class="string">&quot;coderxwx&quot;</span>,</span><br><span class="line">  <span class="string">&quot;license&quot;</span>: <span class="string">&quot;MIT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果不想使用自己的账号名作为私有包的前缀，可以创建一个组织<br><img src="/img/7.jpg"><br>创建完成后就可以使用这个名字来当前缀了，比如我创建的是uv-ui,之后就可以使用@uv-ui进行发布了。</p><h3 id="更新组件"><a href="#更新组件" class="headerlink" title="更新组件"></a>更新组件</h3><p>当完成组件的修改后需要重新发布更新组件，这里有两种方式，一种是直接修改package.json中的version信息，然后进行npm publish</p><p>还有一种更规范的方式是使用npm的指令。</p><p>其中type有这些：</p><p>patch：小变动，比如修复bug等 版本号变动 v1.0.0-&gt;v1.0.1</p><p>minor：增加新功能，不影响现有功能 版本号变动 v1.0.0-&gt;v1.1.0</p><p>major：破坏模块对向后的兼容性，大版本更新 版本号变动 v1.0.0-&gt;v2.0.0</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm version [type]</span><br><span class="line"></span><br><span class="line">npm publish</span><br></pre></td></tr></table></figure><h3 id="文档编写"><a href="#文档编写" class="headerlink" title="文档编写"></a>文档编写</h3><p>我用的是vitepress来构建文档，基本没啥难度</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vitepress -D</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> vue3 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue2重点</title>
      <link href="/2021/01/01/%E5%89%8D%E7%AB%AF/vue/vue2%E9%9D%A2%E8%AF%95/"/>
      <url>/2021/01/01/%E5%89%8D%E7%AB%AF/vue/vue2%E9%9D%A2%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h2 id="Vue2响应式系统的工作原理"><a href="#Vue2响应式系统的工作原理" class="headerlink" title="Vue2响应式系统的工作原理"></a>Vue2响应式系统的工作原理</h2><p>Vue2响应式系统的核心实现机制<br>Vue2的响应式系统基于数据劫持与发布-订阅模式，通过<code>Object.defineProperty()</code> API拦截数据访问与修改，并结合依赖收集机制实现视图自动更新。其核心目标是建立数据与视图之间的联动关系，当数据变化时触发依赖组件的重新渲染。 </p><span id="more"></span><p>数据劫持：对象与数组的响应式处理 </p><h5 id="对象响应式实现"><a href="#对象响应式实现" class="headerlink" title="对象响应式实现"></a>对象响应式实现</h5><ol><li><p>初始化监听<br>Vue在初始化阶段通过<code>observer</code>方法遍历<code>data</code>对象，对每个属性调用<code>defineReactive</code>函数，该函数内部使用<code>Object.defineProperty()</code>定义属性的<code>getter</code>和<code>setter</code>。  </p><ul><li>getter：当属性被访问时触发，用于依赖收集（将当前Watcher添加到Dep中）。  </li><li>setter：当属性被修改时触发，用于派发更新（通知Dep中的所有Watcher执行更新）。</li></ul></li><li><p>深度监听<br>若属性值为对象，<code>defineReactive</code>会递归执行深度监听，直至属性为基本类型，确保嵌套对象的变化也能被捕获。</p></li></ol><h5 id="数组响应式实现"><a href="#数组响应式实现" class="headerlink" title="数组响应式实现"></a>数组响应式实现</h5><p>由于<code>Object.defineProperty()</code>无法原生监听数组元素变化，Vue2通过重写数组原型方法解决：  </p><ul><li>拦截<code>push</code>、<code>pop</code>、<code>shift</code>、<code>unshift</code>、<code>splice</code>、<code>sort</code>、<code>reverse</code>共7个修改原数组的方法。  </li><li>重写后的方法在执行时会触发依赖更新，并通过<code>dep.notify()</code>通知视图刷新。</li></ul><p>依赖收集与派发更新流程<br>核心角色 </p><ul><li>Observer：遍历数据对象，将所有属性转换为响应式。  </li><li>Dep（依赖收集器）：每个响应式属性对应一个Dep实例，维护依赖该属性的Watcher列表。  </li><li>Watcher：观察者对象（如组件渲染Watcher、计算属性Watcher），负责接收数据变化通知并执行更新逻辑。</li></ul><h5 id="流程详解"><a href="#流程详解" class="headerlink" title="流程详解"></a>流程详解</h5><ol><li><p>依赖收集<br>组件初次渲染时，模板解析过程中访问数据属性会触发<code>getter</code>，此时<code>Dep.target</code>指向当前渲染Watcher，该Watcher被添加到属性对应的Dep中。 </p></li><li><p>派发更新<br>当数据通过<code>setter</code>修改时，Dep会调用<code>notify()</code>方法，遍历所有关联的Watcher并执行其<code>update()</code>方法，最终触发组件重新渲染。</p></li></ol><h5 id="Vue2响应式系统的局限性与解决方案"><a href="#Vue2响应式系统的局限性与解决方案" class="headerlink" title="Vue2响应式系统的局限性与解决方案"></a>Vue2响应式系统的局限性与解决方案</h5><p>局限性 </p><table><thead><tr><th>问题场景</th><th>原因分析</th></tr></thead><tbody><tr><td>动态新增&#x2F;删除对象属性</td><td><code>Object.defineProperty()</code>仅初始化时劫持已有属性，新增&#x2F;删除属性无法触发<code>setter</code>[[4]]</td></tr><tr><td>直接修改数组索引或长度</td><td>重写的数组方法仅覆盖7个操作，直接修改索引（如<code>this.arr[0] = 1</code>）无法被监听[[4]]</td></tr><tr><td>深度监听性能开销</td><td>初始化时递归遍历所有嵌套对象，层级过深可能导致首屏渲染卡顿</td></tr></tbody></table><p>解决方案 </p><ul><li>新增&#x2F;删除属性：使用<code>Vue.set(obj, key, value)</code>或<code>this.$set</code>添加属性，<code>Vue.delete(obj, key)</code>删除属性[[4]]。  </li><li>数组操作：优先使用重写后的数组方法（如<code>splice</code>），或直接替换数组（如<code>this.arr = [...this.arr, newItem]</code>）。  </li><li>性能优化：避免数据层级过深，或通过<code>Object.freeze()</code>冻结无需响应式的对象。</li></ul><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Vue2通过<code>Object.defineProperty()</code>结合发布-订阅模式实现响应式，核心在于数据劫持、依赖收集与派发更新的联动。尽管存在对新增属性、数组索引修改等场景的支持限制，但可通过<code>Vue.set</code>等API规避。这一机制为Vue2的数据驱动视图提供了基础，而Vue3则通过Proxy API进一步优化了这些局限性。</p>]]></content>
      
      
      <categories>
          
          <category> vue2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>拖拽的形式生成页面的工具</title>
      <link href="/2021/01/01/%E5%89%8D%E7%AB%AF/vue/%E6%8B%96%E6%8B%BD%E5%81%9A%E6%B4%BB%E5%8A%A8/"/>
      <url>/2021/01/01/%E5%89%8D%E7%AB%AF/vue/%E6%8B%96%E6%8B%BD%E5%81%9A%E6%B4%BB%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="要解决的问题"><a href="#要解决的问题" class="headerlink" title="要解决的问题"></a>要解决的问题</h2><p>从实现原理来说，其实需要解决的就是以下几个问题：</p><span id="more"></span><h2 id="需要有哪些可以编辑的元素？"><a href="#需要有哪些可以编辑的元素？" class="headerlink" title="需要有哪些可以编辑的元素？"></a>需要有哪些可以编辑的元素？</h2><p>文本、图片、形状、音频、链接等，二期以后会逐步增加更多的可编辑元素。</p><h2 id="如何编辑元素？"><a href="#如何编辑元素？" class="headerlink" title="如何编辑元素？"></a>如何编辑元素？</h2><p>通过点击或者上传的形式新增，通过拖拽来调整大小尺寸及位置，通过编辑面板来修改样式。同时，不同的元素将拥有不同的编辑面板，如文字类型，可以修改字体、颜色、大小、对齐方式等，而图片类型，则可以进行缩放、裁剪、圆角、阴影等调整。</p><h2 id="如何编辑和预览动画效果？"><a href="#如何编辑和预览动画效果？" class="headerlink" title="如何编辑和预览动画效果？"></a>如何编辑和预览动画效果？</h2><p>动画效果将模仿其他产品，合并至编辑面板，并通过点击图标的形式，更换不同的入场动画，更换的同时，触发本动画的实际效果预览。另外也可以点击独立的预览按钮，可以对已经编辑完毕的页面进行预览。</p><h2 id="如何实现与后台的数据交互？"><a href="#如何实现与后台的数据交互？" class="headerlink" title="如何实现与后台的数据交互？"></a>如何实现与后台的数据交互？</h2><p>按页和页内元素组合成一个json对象，附带音频信息传递至后台数据接口，读取时同样处理。</p><h2 id="如何将数据转换成手机端网页-所谓H5页面-？"><a href="#如何将数据转换成手机端网页-所谓H5页面-？" class="headerlink" title="如何将数据转换成手机端网页(所谓H5页面)？"></a>如何将数据转换成手机端网页(所谓H5页面)？</h2><p>借助vue的createElement方法，将json 逐一解析成对应的组件，渲染即可。<br>使用slider插件实现上下或者左右翻页。</p><h2 id="如何实现兼容手机端网页？"><a href="#如何实现兼容手机端网页？" class="headerlink" title="如何实现兼容手机端网页？"></a>如何实现兼容手机端网页？</h2><p>目前市面上，手动开发这类型网页，一般有两种兼容方式，即固定尺寸兼容及百分比兼容，我称之为主动兼容和被动兼容，区别主要是在与元素css的尺寸计算方式以及viewport的写法，这类型文章网上已经有不少，这里就不再敷述。而在本项目当中，最终选择的是两者相结合的方式来实现，原因在之后的文章中会提及。</p><h2 id="核心原理解析"><a href="#核心原理解析" class="headerlink" title="核心原理解析"></a>核心原理解析</h2><h3 id="将-JSON-转换成-H5"><a href="#将-JSON-转换成-H5" class="headerlink" title="将 JSON 转换成 H5"></a>将 JSON 转换成 H5</h3><p>相信阅读过 Vue JSX 文档 的同学对下面的代码应该不会陌生</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 以下代码来自：https://cn.vuejs.org/v2/guide/render-function.html#createElement-参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @returns &#123;VNode&#125;</span></span><br><span class="line"><span class="title function_">createElement</span>(</span><br><span class="line">  <span class="comment">// &#123;String | Object | Function&#125;</span></span><br><span class="line">  <span class="comment">// An HTML tag name, component options, or async</span></span><br><span class="line">  <span class="comment">// function resolving to one of these. Required.</span></span><br><span class="line">  <span class="string">&#x27;div&#x27;</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// &#123;Object&#125;</span></span><br><span class="line">  <span class="comment">// A data object corresponding to the attributes</span></span><br><span class="line">  <span class="comment">// you would use in a template. Optional.</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// (see details in the next section below)</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// &#123;String | Array&#125;</span></span><br><span class="line">  <span class="comment">// Children VNodes, built using `createElement()`,</span></span><br><span class="line">  <span class="comment">// or using strings to get &#x27;text VNodes&#x27;. Optional.</span></span><br><span class="line">  [</span><br><span class="line">    <span class="string">&#x27;Some text comes first.&#x27;</span>,</span><br><span class="line">    <span class="title function_">createElement</span>(<span class="string">&#x27;h1&#x27;</span>, <span class="string">&#x27;A headline&#x27;</span>),</span><br><span class="line">    <span class="title function_">createElement</span>(<span class="title class_">MyComponent</span>, &#123;</span><br><span class="line">      <span class="attr">props</span>: &#123;</span><br><span class="line">        <span class="attr">someProp</span>: <span class="string">&#x27;foobar&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h3 id="抽象抽象再抽象"><a href="#抽象抽象再抽象" class="headerlink" title="抽象抽象再抽象"></a>抽象抽象再抽象</h3><p>我们对上面的 demo 进行进一步的抽象：</p><p>1、移除注释<br>2、把 createElement(tagName || componentOptions, {data}, children) 对应到上面的代码中，把 children 部分单独抽象成一个数组<br>3、整理之后的代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// a component options demo:</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">MyComponent</span> = &#123;</span><br><span class="line">  <span class="attr">props</span>:[<span class="string">&#x27;someProp&#x27;</span>],</span><br><span class="line">  <span class="title function_">render</span>(<span class="params">h</span>) &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;span&#x27;</span>, <span class="variable language_">this</span>.<span class="property">someProp</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="comment">// 这里的 render(createElement) 我们更常见的写法是：render(h) </span></span><br><span class="line">  <span class="comment">// 关于这部分的解释，可以参见: https://segmentfault.com/q/1010000007130348?_ea=17466196</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="params">createElement</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> pageJSON = [</span><br><span class="line">      <span class="string">&#x27;Some text comes first.&#x27;</span>,</span><br><span class="line">      <span class="title function_">createElement</span>(<span class="string">&#x27;h1&#x27;</span>, <span class="string">&#x27;A headline&#x27;</span>),</span><br><span class="line">      <span class="title function_">createElement</span>(<span class="title class_">MyComponent</span> <span class="comment">/** component options */</span>, &#123;</span><br><span class="line">        <span class="attr">props</span>: &#123;</span><br><span class="line">          <span class="attr">someProp</span>: <span class="string">&#x27;foobar&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, pageJSON)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 再抽象一步</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params">h</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> pageJSON = [</span><br><span class="line">      &#123;<span class="attr">component</span>: <span class="string">&#x27;span&#x27;</span>, <span class="attr">text</span>: <span class="string">&#x27;Some text comes first.&#x27;</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">component</span>: <span class="string">&#x27;h1&#x27;</span>, <span class="attr">text</span>: <span class="string">&#x27;A headline&#x27;</span>&#125;,</span><br><span class="line">      &#123;<span class="attr">component</span>: <span class="string">&#x27;MyComponent&#x27;</span>, <span class="attr">data</span>: &#123;<span class="attr">props</span>: &#123;<span class="attr">someProp</span>: <span class="string">&#x27;foobar&#x27;</span>&#125;&#125; &#125;</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, pageJSON.<span class="title function_">map</span>(<span class="function"><span class="params">ele</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">h</span>(ele.<span class="property">component</span>, ele.<span class="property">text</span> ? ele.<span class="property">text</span> : ele.<span class="property">data</span>)</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 再抽象一步(哎，不对啊，作者，我咋感觉你这一步啥都没做啊😂，你说对了）</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">PageJSON</span> = [</span><br><span class="line">  &#123;<span class="attr">component</span>: <span class="string">&#x27;span&#x27;</span>, <span class="attr">text</span>: <span class="string">&#x27;Some text comes first.&#x27;</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">component</span>: <span class="string">&#x27;h1&#x27;</span>, <span class="attr">text</span>: <span class="string">&#x27;A headline&#x27;</span>&#125;,</span><br><span class="line">  &#123;<span class="attr">component</span>: <span class="string">&#x27;MyComponent&#x27;</span>, <span class="attr">data</span>: &#123;<span class="attr">props</span>: &#123;<span class="attr">someProp</span>: <span class="string">&#x27;foobar&#x27;</span>&#125;&#125; &#125;</span><br><span class="line">]</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params">h</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, pageJSON.<span class="title function_">map</span>(<span class="function"><span class="params">ele</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">h</span>(ele.<span class="property">component</span>, ele.<span class="property">text</span> ? ele.<span class="property">text</span> : ele.<span class="property">data</span>)</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 再抽象一步</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">WorkJSON</span> = &#123;</span><br><span class="line"><span class="attr">title</span>: <span class="string">&#x27;我是作品标题&#x27;</span>,</span><br><span class="line">    <span class="attr">description</span>: <span class="string">&#x27;我是作品描述&#x27;</span>,</span><br><span class="line">    <span class="attr">created_time</span>: <span class="string">&#x27;2019-09-01&#x27;</span>,</span><br><span class="line">    <span class="attr">updated_time</span>: <span class="string">&#x27;2019-09-01&#x27;</span>,</span><br><span class="line">    <span class="attr">pages</span>: [</span><br><span class="line">      <span class="attr">elements</span>: [</span><br><span class="line">          &#123;<span class="attr">component</span>: <span class="string">&#x27;span&#x27;</span>, <span class="attr">text</span>: <span class="string">&#x27;Some text comes first.&#x27;</span>&#125;,</span><br><span class="line">          &#123;<span class="attr">component</span>: <span class="string">&#x27;h1&#x27;</span>, <span class="attr">text</span>: <span class="string">&#x27;A headline&#x27;</span>&#125;,</span><br><span class="line">          &#123;<span class="attr">component</span>: <span class="string">&#x27;MyComponent&#x27;</span>, <span class="attr">data</span>: &#123;<span class="attr">props</span>: &#123;<span class="attr">someProp</span>: <span class="string">&#x27;foobar&#x27;</span>&#125;&#125; &#125;</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">el</span>: <span class="string">&#x27;#app&#x27;</span>,</span><br><span class="line">  <span class="title function_">render</span>(<span class="params">h</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">h</span>(<span class="string">&#x27;div&#x27;</span>, &#123;&#125;, <span class="title class_">WorkJSON</span>.<span class="property">pages</span>[<span class="number">0</span>].<span class="property">elements</span>.<span class="title function_">map</span>(<span class="function"><span class="params">ele</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title function_">h</span>(ele.<span class="property">component</span>, ele.<span class="property">text</span> ? ele.<span class="property">text</span> : ele.<span class="property">data</span>)</span><br><span class="line">    &#125;))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>相信到最后以这一步大家应该有些头绪了吧（要没有的话 😂😂😂，接着往下看吧）<br>其实鲁班H5的一个作品其实是一个就是一个大JSON(结构和上面的 WorkJSON 几乎一致)</p><p>这个大JSON 里面包含了很多页面,每个页面里面包含了很多元素<br>最终这个JSON 会传给 render(h) 进行解析渲染<br>到这里，也就能解答这一小节的问题了：</p>]]></content>
      
      
      <categories>
          
          <category> vue2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx Location 与前端路由优先级，以及刷新404 原由</title>
      <link href="/2021/01/01/%E5%89%8D%E7%AB%AF/vue/%E8%B7%AF%E7%94%B1history%E6%A8%A1%E5%BC%8F%E4%BC%98%E5%85%88%E7%BA%A7/"/>
      <url>/2021/01/01/%E5%89%8D%E7%AB%AF/vue/%E8%B7%AF%E7%94%B1history%E6%A8%A1%E5%BC%8F%E4%BC%98%E5%85%88%E7%BA%A7/</url>
      
        <content type="html"><![CDATA[<p>问：前端路由和 nginx location 哪个优先级更高？<br>答：当然是 nginx location 优先级更高因为 nginx location 优先级更高，所以会导致 history 模式的SPA（单页应用）在刷新的时候，会有 404 的问题</p><span id="more"></span><p>访问<a href="http://www.abc.com/dashboard%EF%BC%8C%E7%82%B9%E5%87%BBlogout%E9%80%80%E5%87%BA%E7%B3%BB%E7%BB%9F%EF%BC%8C%E5%89%8D%E7%AB%AF%E8%B7%AF%E7%94%B1%E5%A4%84%E7%90%86%EF%BC%8C%E8%B7%B3%E8%BD%AC%E5%88%B0www.abc.com/login%E4%BD%86%E6%98%AF%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2%E5%88%B7%E6%96%B0%E4%B9%8B%E5%90%8E%EF%BC%8C%E5%B0%B1%E6%98%BE%E7%A4%BA">www.abc.com/dashboard，点击logout退出系统，前端路由处理，跳转到www.abc.com/login但是登录页面刷新之后，就显示</a> nginx 404 了奇怪的地方就在于，为何退出的时候，重定向到&#x2F;login的时候，没有报404, 为何一刷新就 404 了呢?前端路由重定向到&#x2F;login逻辑：this.$router.push({name: ‘login’});<br>贴下前端路由配置 </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes</span>: [</span><br><span class="line"> &#123;</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;home&#x27;</span>,</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="title class_">Home</span>,</span><br><span class="line">      <span class="attr">meta</span>: &#123; <span class="attr">requiresAuth</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">      <span class="attr">name</span>: <span class="string">&#x27;login&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="title class_">Login</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="attr">path</span>: <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">      <span class="attr">component</span>: <span class="title class_">NotFound</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  ]</span><br><span class="line">现有nginx配置location / &#123;</span><br><span class="line">    <span class="attr">root</span>: <span class="regexp">/var/</span>data/<span class="keyword">static</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1、为何点击退出可以正常显示登录页面？"><a href="#1、为何点击退出可以正常显示登录页面？" class="headerlink" title="1、为何点击退出可以正常显示登录页面？"></a>1、为何点击退出可以正常显示登录页面？</h3><p>因为点击退出，前端路由this.$router.push({name: ‘login’});来实现跳转的，这时候已经有index.html 和相关的js了（也就是说这时候页面跳转的逻辑已经由 Vue-Router 或 React Router 接管了），可以直接使用前端路由跳转到&#x2F;login路由对应的组件</p><h3 id="2-为何刷新的时候显示-nginx-404"><a href="#2-为何刷新的时候显示-nginx-404" class="headerlink" title="2. 为何刷新的时候显示: nginx/404 ?"></a>2. 为何刷新的时候显示: <code>nginx/404</code> ?</h3><p>因为刷新的时候，会先向服务器请求<a href="http://www.abc.com/login%E8%BF%99%E6%97%B6%E5%80%99%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84nginx%E9%85%8D%E7%BD%AE%E4%B8%AD%E6%B2%A1%E6%9C%89%E5%85%B3%E4%BA%8E/login%E8%B7%AF%E5%BE%84%E7%9A%84%E9%85%8D%E7%BD%AE">www.abc.com/login这时候服务器的nginx配置中没有关于/login路径的配置</a>(即没有 location &#x2F;login {})，因此 nginx 会直接报错nginx&#x2F;4043. 如何解决？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">按照如下方式配置nginx</span><br><span class="line"> location / &#123;</span><br><span class="line">     root: /var/data/static;</span><br><span class="line">     # 意思是说，在nginx 没有找到 /login 路径的时候，不要报错，要把 index.html 返回给客户端</span><br><span class="line">     # 这样客户端（浏览器）就能加载到路由相关的js 文件了</span><br><span class="line">     # 这时候，路由由前端接管，前端路由会查看路由表里面是否由 /login 的配置，有的话，跳转即可</span><br><span class="line">     try_file: /index.html;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="3-更多解释"><a href="#3-更多解释" class="headerlink" title="3. 更多解释"></a>3. 更多解释</h3><ol><li>nginx进行匹配路径的时候，发现没有<code>/login</code>的路径，便会转到<code>/</code>路径处理。</li><li>发现<code>root</code>路径下(是静态文件的root目录，不是linux的root目录)没有<code>login</code>文件，就会<code>try_file</code>规则，返回index.html,</li><li>这样浏览器拿到index.html 之后，开始加载其中的前端路由部分</li><li>这时候&#x2F;login就会在前端路由中找到匹配规则。</li></ol><h3 id="4-同理／404也可以写在前端路由中了"><a href="#4-同理／404也可以写在前端路由中了" class="headerlink" title="4. 同理／404也可以写在前端路由中了"></a>4. 同理<code>／404</code>也可以写在前端路由中了</h3>]]></content>
      
      
      <categories>
          
          <category> vue2 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> vue2 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
